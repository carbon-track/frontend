import{u as B,Y,r as d,s as ue,j as t,I as M,B as k,w as J,F as ge,$ as je,v as ve,E as le,o as re,n as V,a0 as ee,a1 as be,R as ye,C as te,a2 as Ne}from"./index-DwFiEGTX.js";import{A as K,a as W,b as se}from"./Alert-AN47C-9Y.js";import{T as we}from"./Turnstile-Bo_2Xz2z.js";import{R as _e}from"./RegionSelector-7teiPJSD.js";import{u as Se}from"./useMutation-C-wyTXj4.js";import{C as Ce}from"./circle-check-big-BVILoGNA.js";import{u as Pe}from"./index.esm-6IFNN_7C.js";import{C as H,a as $,b as z,d as G}from"./Card-CY_1fKmq.js";const b="—",Ae=(e,s)=>t.jsxs("div",{className:"space-y-1",children:[t.jsx("p",{className:"text-sm font-medium text-gray-700",children:e}),t.jsx("div",{className:"rounded-md border border-dashed border-gray-200 bg-muted/40 px-3 py-2 text-sm text-gray-900",children:s??b})]},e),ke=(e,s=350)=>{const[o,n]=d.useState(e);return d.useEffect(()=>{const r=setTimeout(()=>n(e),s);return()=>clearTimeout(r)},[e,s]),o};function Ie({user:e}){const{t:s}=B(),o=Y(),n=d.useRef(null),[r,m]=d.useState(""),[a,x]=d.useState(e!=null&&e.school_id?{id:e.school_id,name:e.school_name||""}:null),[f,y]=d.useState([]),[Q,I]=d.useState(!1),[U,E]=d.useState(!1),[S,i]=d.useState(""),[N,h]=d.useState(null),[u,w]=d.useState((e==null?void 0:e.country_code)||""),[g,q]=d.useState((e==null?void 0:e.state_code)||""),O=ke(r.trim(),350),j=(e==null?void 0:e.school_id)??null,_=((e==null?void 0:e.school_name)||"").trim();d.useEffect(()=>{x(j?{id:j,name:_}:null)},[j,_]),d.useEffect(()=>{w((e==null?void 0:e.country_code)||""),q((e==null?void 0:e.state_code)||"")},[e==null?void 0:e.country_code,e==null?void 0:e.state_code]),d.useEffect(()=>{let l=!1;return I(!0),ue.getSchools({search:O||void 0,limit:8,page:1}).then(c=>{var C,P;if(l)return;const F=((P=(C=c.data)==null?void 0:C.data)==null?void 0:P.schools)??[];y(F)}).catch(()=>{l||y([])}).finally(()=>{l||I(!1)}),()=>{l=!0}},[O]);const L=d.useMemo(()=>r.trim(),[r]),T=d.useMemo(()=>{if(!e)return null;const l={};let c=!1;return a&&a.id!==j&&(l.school_id=a.id,c=!0),!a&&L&&L!==_&&(l.new_school_name=L,c=!0),(u!==(e.country_code||"")||g!==(e.state_code||""))&&u&&g&&(l.country_code=u,l.state_code=g,c=!0),c?l:null},[j,_,a,L,e,u,g]),ie=!T||U||!!T&&!S,oe=d.useMemo(()=>{if(!(e!=null&&e.updated_at))return b;const l=new Date(e.updated_at);return Number.isNaN(l.getTime())?e.updated_at:l.toLocaleString()},[e==null?void 0:e.updated_at]),ce=[{label:s("profile.userId","用户ID"),value:(e==null?void 0:e.id)??b},{label:s("profile.uuid","UUID"),value:(e==null?void 0:e.uuid)||b},{label:s("profile.points","积分"),value:(e==null?void 0:e.points)??0},{label:s("profile.lastUpdated","最后更新"),value:oe}],de=[{label:s("profile.username"),value:(e==null?void 0:e.username)||b},{label:s("profile.email"),value:(e==null?void 0:e.email)||b},{label:s("profile.region","Region"),value:(e==null?void 0:e.region_label)||b},{label:s("profile.school"),value:_||s("profile.schoolUnset","Not set")}],me=l=>{const{value:c}=l.target;m(c),h(null),a&&c.trim()!==(a.name||"").trim()&&x(null)},fe=l=>{x({id:l.id,name:l.name}),m(l.name||""),h(null)},xe=()=>{x(null),m(""),h(null)},he=()=>{var l,c;x(j?{id:j,name:_}:null),m(""),w((e==null?void 0:e.country_code)||""),q((e==null?void 0:e.state_code)||""),h(null),i(""),(c=(l=n.current)==null?void 0:l.reset)==null||c.call(l)},pe=async l=>{var c,F,C,P,X,R,Z;if(l.preventDefault(),!T){h({type:"error",message:s("profile.noChanges","No changes detected.")});return}E(!0),h(null);try{const D={...T,cf_turnstile_response:S||void 0},A=await je.updateProfile(D);if(!((c=A.data)!=null&&c.success))throw new Error(((F=A.data)==null?void 0:F.message)||"Failed to update profile");const v=(C=A.data)==null?void 0:C.data;v&&(ve.setUser(v),o.invalidateQueries("currentUser"),x(v.school_id?{id:v.school_id,name:v.school_name||""}:null),w(v.country_code||""),q(v.state_code||"")),m(""),h({type:"success",message:s("profile.updateSuccess","Profile updated successfully.")})}catch(D){const A=((X=(P=D.response)==null?void 0:P.data)==null?void 0:X.message)||D.message||s("profile.updateFailed","Unable to update profile.");h({type:"error",message:A})}finally{E(!1),i(""),(Z=(R=n.current)==null?void 0:R.reset)==null||Z.call(R)}};return t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"grid grid-cols-1 gap-4 rounded-lg border bg-muted/40 p-4 sm:grid-cols-2",children:ce.map(l=>t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:l.label}),t.jsx("p",{className:"break-words text-sm font-medium",children:l.value})]},l.label))}),t.jsx("div",{className:"space-y-4",children:de.map(({label:l,value:c})=>Ae(l,c))}),t.jsxs("section",{className:"rounded-lg border p-4",children:[t.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4",children:t.jsxs("div",{children:[t.jsx("h3",{className:"text-base font-semibold text-gray-900",children:s("profile.editProfile","Edit Profile")}),t.jsx("p",{className:"text-sm text-muted-foreground",children:s("profile.editDescription","Update your region and school information.")})]})}),t.jsxs("form",{className:"space-y-6",onSubmit:pe,children:[t.jsxs("div",{className:"space-y-4",children:[t.jsx("h4",{className:"text-sm font-medium text-gray-900 border-b pb-2",children:s("profile.regionSettings","Region Settings")}),t.jsx(_e,{countryCode:u,stateCode:g,onCountryChange:w,onStateChange:q})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:t.jsx("h4",{className:"text-sm font-medium text-gray-900 border-b pb-2 w-full",children:s("profile.schoolSettings","School Settings")})}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"schoolSearch",className:"block text-sm font-medium text-gray-700",children:s("auth.school","School")}),t.jsx(M,{id:"schoolSearch",className:"mt-2",placeholder:s("profile.schoolSearchPlaceholder","Search for a school or enter a new name"),value:r,onChange:me}),t.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:s("profile.schoolInputHint","Selecting an existing school keeps data consistent. Typing a new school name will create it after verification.")})]}),t.jsxs("div",{className:"rounded-md border bg-white",children:[t.jsxs("div",{className:"flex items-center justify-between border-b px-3 py-2",children:[t.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:s("profile.schoolSuggestions","Suggestions")}),t.jsx(k,{type:"button",variant:"ghost",size:"sm",onClick:xe,children:s("profile.clearSelection","Clear selection")})]}),t.jsx("div",{className:"max-h-48 overflow-y-auto",children:Q?t.jsxs("div",{className:"flex items-center gap-2 px-3 py-3 text-sm text-muted-foreground",children:[t.jsx(J,{className:"h-4 w-4 animate-spin"}),s("profile.loadingSchools","Loading schools...")]}):f.length>0?f.map(l=>{const c=(a==null?void 0:a.id)===l.id;return t.jsxs("button",{type:"button",onClick:()=>fe(l),className:`flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-muted ${c?"bg-green-50 text-green-700":""}`,children:[t.jsx("span",{children:l.name}),c&&t.jsx(ge,{variant:"outline",children:s("profile.selected","Selected")})]},l.id)}):t.jsx("div",{className:"px-3 py-3 text-sm text-muted-foreground",children:s("profile.schoolNoResults","No matching schools. Enter a new name above.")})})]})]}),N&&t.jsx(K,{variant:N.type==="error"?"destructive":"success",children:t.jsx(W,{children:N.message})}),t.jsxs("div",{className:"space-y-3",children:[t.jsx(we,{ref:n,className:"flex flex-col items-center",onVerify:i,onExpire:()=>i(""),onError:()=>i(""),require:!0}),t.jsx("p",{className:"text-xs text-muted-foreground text-center",children:s("profile.turnstileNotice","Verification is required to prevent automated updates.")})]}),t.jsxs("div",{className:"flex flex-wrap gap-3",children:[t.jsx(k,{type:"submit",className:"flex-1",loading:U,disabled:ie,children:s("profile.saveChanges","Save Changes")}),t.jsx(k,{type:"button",variant:"outline",className:"flex-1",onClick:he,children:s("profile.reset","Reset")})]})]})]})]})}const Ue=e=>/^https?:\/\//i.test(e),ae=e=>{if(typeof e!="string")return"";const s=e.trim();return s?s.replace(/^\/+/,""):""},p=e=>typeof e!="string"?"":e.trim()||"",Ee=e=>{if(!e||typeof e!="object")return{src:"",filePath:"",alt:""};const s=[p(e.icon_presigned_url),p(e.presigned_url),p(e.avatar_presigned_url),p(e.icon_url),p(e.url),p(e.avatar_url),p(e.image_url)];let o="",n="";for(const r of s)if(r){if(Ue(r)||r.startsWith("data:")){o=r;break}n||(n=ae(r))}if(!o){const r=[p(e.file_path),p(e.icon_path),p(e.avatar_path)];for(const m of r){if(!m)continue;const a=ae(m);if(a){n=a;break}}}return{src:o,filePath:n,alt:p(e.name||e.username||e.title||"")}},ne=e=>{const{src:s,filePath:o,alt:n}=Ee(e),r=n?n.charAt(0).toUpperCase():"";return{src:s,filePath:o,alt:n,fallbackInitial:r}};function qe({currentAvatarId:e,onAvatarChange:s}){var S;const{t:o}=B(),n=Y(),[r,m]=d.useState(e),{data:a,isLoading:x,error:f}=le("avatars",()=>ee.getAvatars()),y=Se(i=>ee.selectAvatar(i),{onSuccess:()=>{V.success(o("profile.avatarUpdateSuccess")),n.invalidateQueries("currentUser"),s(r)},onError:i=>{V.error(o("profile.avatarUpdateFailed")),console.error("Avatar update failed:",i)}}),Q=((S=a==null?void 0:a.data)==null?void 0:S.data)||[],I=({avatar:i})=>{const{src:N,filePath:h,alt:u,fallbackInitial:w}=ne(i),g=t.jsx("div",{className:"w-full aspect-square flex items-center justify-center text-xs text-gray-400 bg-gray-100 rounded-md",children:w||"IMG"});return t.jsx(re,{src:N||void 0,filePath:!N&&h?h:void 0,alt:u||(i==null?void 0:i.name),className:"w-full h-auto rounded-md object-cover",fallback:g})},U=i=>{m(i)},E=()=>{r&&r!==e&&y.mutate(r)};return x?t.jsx("div",{className:"flex justify-center items-center h-32",children:t.jsx(J,{className:"h-8 w-8 animate-spin text-green-500"})}):f?t.jsx("div",{className:"text-center text-red-500",children:o("profile.avatarLoadError")}):t.jsxs("div",{className:"space-y-4",children:[t.jsx("h3",{className:"text-lg font-semibold",children:o("profile.selectAvatar")}),t.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4",children:Q.map(i=>t.jsxs("div",{className:`relative p-2 border-2 rounded-lg cursor-pointer
              ${r===i.id?"border-green-500":"border-gray-200 hover:border-gray-300"}`,onClick:()=>U(i.id),children:[t.jsx(I,{avatar:i}),r===i.id&&t.jsx("div",{className:"absolute top-1 right-1 bg-green-500 rounded-full p-1",children:t.jsx(Ce,{className:"h-4 w-4 text-white"})}),t.jsx("p",{className:"text-center text-sm mt-1",children:i.name})]},i.id))}),t.jsx(k,{onClick:E,disabled:r===e||y.isLoading,className:"w-full",children:y.isLoading?o("common.saving"):o("common.save")})]})}function Le(){const{t:e}=B(),{register:s,handleSubmit:o,formState:{errors:n},reset:r,watch:m}=Pe(),a=async x=>{try{await be.post("/auth/change-password",x),V.success(e("profile.passwordChangeSuccess")),r()}catch(f){V.error(e("profile.passwordChangeFailed")),console.error("Password change failed:",f)}};return t.jsxs("div",{className:"space-y-4",children:[t.jsx("h3",{className:"text-lg font-semibold",children:e("profile.changePassword")}),t.jsxs("form",{onSubmit:o(a),className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:e("profile.currentPassword")}),t.jsx(M,{type:"password",...s("current_password",{required:e("validation.required")})}),n.current_password&&t.jsx("p",{className:"text-red-500 text-xs mt-1",children:n.current_password.message})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:e("profile.newPassword")}),t.jsx(M,{type:"password",...s("new_password",{required:e("validation.required"),minLength:{value:8,message:e("validation.minLength",{min:8})}})}),n.new_password&&t.jsx("p",{className:"text-red-500 text-xs mt-1",children:n.new_password.message})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:e("profile.confirmNewPassword")}),t.jsx(M,{type:"password",...s("confirm_new_password",{required:e("validation.required"),validate:x=>x===m("new_password")||e("validation.passwordMismatch")})}),n.confirm_new_password&&t.jsx("p",{className:"text-red-500 text-xs mt-1",children:n.confirm_new_password.message})]}),t.jsx(k,{type:"submit",children:e("profile.changePassword")})]})]})}function $e(){const{t:e}=B(),s=Y(),{data:o,isLoading:n,error:r}=le("currentUser",()=>Ne.getCurrentUser(),{staleTime:1/0}),m=(o==null?void 0:o.data)??null,a=(m==null?void 0:m.data)??m??null,x=()=>{s.invalidateQueries("currentUser")},f=ye.useMemo(()=>a?ne({...a,file_path:a.avatar_url,name:a.username}):{src:"",filePath:"",alt:"",fallbackInitial:""},[a]);return n?t.jsx("div",{className:"flex justify-center items-center h-screen",children:t.jsx(J,{className:"h-8 w-8 animate-spin text-green-500"})}):r?t.jsx("div",{className:"container mx-auto py-8 px-4",children:t.jsxs(K,{variant:"destructive",children:[t.jsx(te,{className:"h-4 w-4"}),t.jsx(se,{children:e("common.error")}),t.jsx(W,{children:e("profile.loadError")})]})}):a?t.jsxs("div",{className:"container mx-auto py-8 px-4",children:[t.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8",children:t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("div",{className:"relative",children:t.jsx("div",{className:"w-24 h-24 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center text-3xl font-semibold text-gray-400",children:f.src||f.filePath?t.jsx(re,{src:f.src||void 0,filePath:!f.src&&f.filePath?f.filePath:void 0,alt:f.alt||a.username,className:"w-full h-full object-cover"}):t.jsx("span",{children:f.fallbackInitial||(a.username?a.username.charAt(0).toUpperCase():"U")})})}),t.jsxs("div",{className:"space-y-1",children:[t.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:a.username}),a.email&&t.jsx("p",{className:"text-sm text-gray-500",children:a.email}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm text-gray-600",children:[t.jsxs("span",{children:[e("profile.points"),": ",a.points??0]}),a.school_name&&t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-green-400"}),a.school_name]})]})]})]})}),t.jsx("h1",{className:"text-3xl font-bold tracking-tight mb-8",children:e("profile.title")}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[t.jsxs(H,{children:[t.jsx($,{children:t.jsx(z,{children:e("profile.basicInfo")})}),t.jsx(G,{children:t.jsx(Ie,{user:a})})]}),t.jsxs(H,{children:[t.jsx($,{children:t.jsx(z,{children:e("profile.avatar")})}),t.jsx(G,{children:t.jsx(qe,{currentAvatarId:a==null?void 0:a.avatar_id,onAvatarChange:x})})]}),t.jsxs(H,{className:"lg:col-span-2",children:[t.jsx($,{children:t.jsx(z,{children:e("profile.changePassword")})}),t.jsx(G,{children:t.jsx(Le,{})})]})]})]}):t.jsx("div",{className:"container mx-auto py-8 px-4",children:t.jsxs(K,{variant:"warning",children:[t.jsx(te,{className:"h-4 w-4"}),t.jsx(se,{children:e("common.notice","提示")}),t.jsx(W,{children:e("profile.noUserData","暂未获取到个人资料，请稍后重试。")})]})})}export{$e as default};
