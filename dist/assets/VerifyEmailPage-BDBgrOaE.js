import{c as te,u as se,e as ae,t as ie,r as o,v as H,j as s,w as B,I as U,B as N,f as C,n as u,x as ne}from"./index-D2v4yG6T.js";import{u as re}from"./index.esm-BRoGCfmh.js";import{C as ce,a as oe,b as le,c as ue,d as de}from"./Card-DCtTO9ti.js";import{A as W,a as O}from"./Alert-Dt08zODj.js";import{T as me}from"./Turnstile-C3tjTu0k.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8",key:"12jkf8"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m16 19 2 2 4-4",key:"1b14m6"}]],ve=te("mail-check",fe),$=e=>{if(!e)return null;const m=Date.parse(e);return Number.isNaN(m)?null:m},je=()=>{const{t:e}=se(),m=ae(),[x]=ie(),p=x.get("token"),I=x.get("return"),T=t=>typeof window>"u"?null:sessionStorage.getItem(t),_=o.useMemo(()=>{var t;return x.get("email")||T("pending_verification_email")||((t=H.getUser())==null?void 0:t.email)||""},[x]),{register:A,handleSubmit:z,setValue:R,getValues:G,watch:J,formState:{errors:j}}=re({defaultValues:{email:_,code:""}});o.useEffect(()=>{_&&R("email",_)},[_,R]);const[b,f]=o.useState(!1),[E,K]=o.useState(!1),[Q,S]=o.useState(p?"pending":"idle"),[v,c]=o.useState(null),[h,V]=o.useState(()=>$(T("verification_resend_available_at"))),[X,k]=o.useState(0),q=o.useRef(null),[g,w]=o.useState(""),y=!0,Y=J("email"),M=t=>{const n=t==null?void 0:t.token,r=t==null?void 0:t.user;if(n&&ne.setToken(n),r&&H.setUser(r),typeof window<"u"){sessionStorage.removeItem("pending_verification_email"),sessionStorage.removeItem("verification_resend_available_at");const a=sessionStorage.getItem("verification_return_path");sessionStorage.removeItem("verification_return_path"),m(I||a||"/dashboard",{replace:!0})}else m(I||"/dashboard",{replace:!0})};o.useEffect(()=>{if(!h){k(0);return}const t=()=>{const r=h-Date.now();r<=0?(k(0),V(null),typeof window<"u"&&sessionStorage.removeItem("verification_resend_available_at")):k(r)};t();const n=window.setInterval(t,1e3);return()=>window.clearInterval(n)},[h]),o.useEffect(()=>{p&&!E&&(async()=>{var n,r;S("pending"),f(!0),c(null);try{const a=await C.verifyEmail({token:p});if(a.success)u.success(e("auth.verification.tokenSuccess")),M(a.data);else{S("failed");const i=a.message||e("auth.verification.tokenFailed");c({variant:"destructive",message:i}),u.error(i)}}catch(a){S("failed");const i=((r=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:r.message)||a.message||e("auth.verification.tokenFailed");c({variant:"destructive",message:i}),u.error(i)}finally{f(!1),K(!0)}})()},[p,E,e]);const F=()=>{if(y&&!g){const t=e("auth.verification.turnstileRequired");return c({variant:"warning",message:t}),u.error(t),!1}return!0},L=()=>{var t,n;w(""),(n=(t=q.current)==null?void 0:t.reset)==null||n.call(t)},Z=async t=>{var a,i;const n=t.email.trim(),r=t.code.trim();if(!n){c({variant:"warning",message:e("auth.verification.emailRequired")});return}if(!r){c({variant:"warning",message:e("auth.verification.codeRequired")});return}if(F()){f(!0),c(null);try{const l=await C.verifyEmail({email:n,code:r,cf_turnstile_response:g});if(l.success)u.success(e("auth.verification.codeSuccess")),M(l.data);else{const d=l.message||e("auth.verification.codeFailed");c({variant:"destructive",message:d}),u.error(d)}}catch(l){const d=((i=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:i.message)||l.message||e("auth.verification.codeFailed");c({variant:"destructive",message:d}),u.error(d)}finally{L(),f(!1)}}},ee=async()=>{var n,r;const t=G("email").trim();if(!t){c({variant:"warning",message:e("auth.verification.emailRequired")});return}if(F()){f(!0);try{const a=await C.sendVerificationCode({email:t,cf_turnstile_response:g});if(a.success){const i=a.data||{},l=$(i.verification_resend_available_at);typeof window<"u"&&(sessionStorage.setItem("pending_verification_email",t),i.verification_resend_available_at?sessionStorage.setItem("verification_resend_available_at",i.verification_resend_available_at):sessionStorage.removeItem("verification_resend_available_at")),V(l);const d=a.message||e("auth.verification.resendSuccess");c({variant:"info",message:d}),u.success(d)}else{const i=a.message||e("auth.verification.tokenFailed");c({variant:"destructive",message:i}),u.error(i)}}catch(a){const i=((r=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:r.message)||a.message||e("auth.verification.tokenFailed");c({variant:"destructive",message:i}),u.error(i)}finally{L(),f(!1)}}},P=b||h!==null&&h>Date.now()||y&&!g,D=Math.max(0,Math.ceil(X/1e3));return s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8",children:s.jsx("div",{className:"max-w-md w-full space-y-6",children:s.jsxs(ce,{children:[s.jsxs(oe,{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ve,{className:"h-6 w-6 text-green-600"}),s.jsx(le,{children:e("auth.verification.title")})]}),s.jsx(ue,{children:e("auth.verification.description",{email:Y||e("auth.verification.yourEmail")})})]}),s.jsxs(de,{className:"space-y-4",children:[Q==="pending"&&s.jsx(W,{variant:"info",children:s.jsxs(O,{className:"flex items-center gap-2",children:[s.jsx(B,{className:"h-4 w-4 animate-spin"}),e("auth.verification.tokenVerifying")]})}),(v==null?void 0:v.message)&&s.jsx(W,{variant:v.variant||"info",children:s.jsx(O,{children:v.message})}),s.jsxs("form",{onSubmit:z(Z),className:"space-y-4",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",htmlFor:"email",children:e("auth.verification.emailLabel")}),s.jsx(U,{id:"email",type:"email",autoComplete:"email",placeholder:e("auth.verification.emailPlaceholder"),...A("email",{required:e("auth.verification.emailRequired")})}),j.email&&s.jsx("p",{className:"text-sm text-red-600",children:j.email.message})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",htmlFor:"code",children:e("auth.verification.codeLabel")}),s.jsx(U,{id:"code",inputMode:"numeric",maxLength:6,placeholder:"123456",...A("code",{required:e("auth.verification.codeRequired"),pattern:{value:/^\d{6}$/,message:e("auth.verification.codePattern")}})}),j.code&&s.jsx("p",{className:"text-sm text-red-600",children:j.code.message})]}),s.jsx("div",{className:"space-y-2",children:s.jsx(me,{ref:q,className:"flex justify-center",require:y,onVerify:t=>w(t),onExpire:()=>w(""),onError:()=>w("")})}),s.jsx(N,{type:"submit",className:"w-full",disabled:b||y&&!g,children:b?s.jsxs("span",{className:"flex items-center justify-center gap-2",children:[s.jsx(B,{className:"h-4 w-4 animate-spin"}),e("auth.verification.submitting")]}):e("auth.verification.submit")})]}),s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[s.jsx(N,{variant:"outline",onClick:ee,disabled:P,children:P&&D>0?e("auth.verification.resendCountdown",{seconds:D}):e("auth.verification.resend")}),s.jsx(N,{variant:"ghost",onClick:()=>m("/auth/login"),children:e("auth.verification.backToLogin")})]}),s.jsx("p",{className:"text-sm text-gray-500",children:e("auth.verification.helper")})]})]})})})};export{je as default};
