import{c as Ie,u as te,r as o,j as e,F as G,I as k,B as b,E as Ae,a9 as O,K as Te,N as Re,O as Pe,Q as ze,T as Me,w as U,y as De,U as xe,aa as Q,t as Ee,n as y,A as Z,ab as Fe,l as He,a4 as de,o as ce}from"./index-9oiziVwF.js";import{C as M,a as D,b as E,d as F}from"./Card-DiZzX4G1.js";import{T as H}from"./textarea-BakiDkNo.js";import{S as K}from"./switch-BM59ftG1.js";import{T as Oe,a as oe}from"./toggle-group-DWGtUhYL.js";import{u as Ue}from"./r2Upload-DLUugcg9.js";import{B as Le}from"./BadgeBulkAwardDialog-RjwBC8cI.js";import{S as Y,a as X,b as ee,c as ae,d as se}from"./select-L0i8fx-o.js";import{T as ge}from"./trash-2-B-HyTeNA.js";import{P as qe}from"./plus-aUd7Bg61.js";import{P as Je}from"./Pagination-DogK4uhw.js";import{R as Ve}from"./refresh-cw-BMcL1E4q.js";import{S as Ge}from"./square-pen-C-8UoeAk.js";import{E as Ze}from"./eye-QkcRAVlH.js";import{U as We}from"./upload-DItaAgtm.js";import"./checkbox-CilTIFml.js";import"./scroll-area-DbMsHkSR.js";import"./index-BdQq_4o_.js";import"./user-plus-BeF-O73P.js";import"./chevron-down-ChSselTD.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72",key:"ul74o6"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]],Qe=Ie("wand-sparkles",$e),me=[{value:"total_carbon_saved",labelI18n:"admin.badges.ruleBuilder.metric.carbonSaved",fallback:"累计碳减排量 (kg)",hintI18n:"admin.badges.ruleBuilder.metric.carbonSavedHint",hintFallback:"用户通过审核的活动累计节省的碳排放量"},{value:"total_points_earned",labelI18n:"admin.badges.ruleBuilder.metric.pointsEarned",fallback:"累计获得积分",hintI18n:"admin.badges.ruleBuilder.metric.pointsEarnedHint",hintFallback:"所有通过审核的活动奖励积分总和"},{value:"total_points_balance",labelI18n:"admin.badges.ruleBuilder.metric.pointsBalance",fallback:"当前积分余额",hintI18n:"admin.badges.ruleBuilder.metric.pointsBalanceHint",hintFallback:"用户当前账户剩余积分"},{value:"total_approved_records",labelI18n:"admin.badges.ruleBuilder.metric.approvedRecords",fallback:"审核通过的记录数",hintI18n:"admin.badges.ruleBuilder.metric.approvedRecordsHint",hintFallback:"成功通过审核的碳减排活动数量"},{value:"total_records",labelI18n:"admin.badges.ruleBuilder.metric.totalRecords",fallback:"提交的记录总数",hintI18n:"admin.badges.ruleBuilder.metric.totalRecordsHint",hintFallback:"无论状态如何的活动提交总量"},{value:"days_since_registration",labelI18n:"admin.badges.ruleBuilder.metric.daysSinceRegistration",fallback:"注册天数",hintI18n:"admin.badges.ruleBuilder.metric.daysSinceRegistrationHint",hintFallback:"用户注册至今的天数"}],Ke=[{value:">=",labelI18n:"admin.badges.ruleBuilder.operator.gte",fallback:"≥"},{value:">",labelI18n:"admin.badges.ruleBuilder.operator.gt",fallback:">"},{value:"<=",labelI18n:"admin.badges.ruleBuilder.operator.lte",fallback:"≤"},{value:"<",labelI18n:"admin.badges.ruleBuilder.operator.lt",fallback:"<"},{value:"==",labelI18n:"admin.badges.ruleBuilder.operator.eq",fallback:"="},{value:"!=",labelI18n:"admin.badges.ruleBuilder.operator.neq",fallback:"≠"}],Ye=[{id:"carbon-champion",labelI18n:"admin.badges.ruleBuilder.templates.carbonChampion",fallback:"碳减排先锋",descriptionI18n:"admin.badges.ruleBuilder.templates.carbonChampionDesc",descriptionFallback:"累计碳减排 ≥ 100 kg 且审核通过记录 ≥ 10 条",value:{all:!0,rules:[{metric:"total_carbon_saved",operator:">=",value:100,label:"Carbon Saved",description:"累计碳减排 ≥ 100 kg"},{metric:"total_approved_records",operator:">=",value:10,label:"Approved Records",description:"审核通过记录 ≥ 10 条"}]}},{id:"points-master",labelI18n:"admin.badges.ruleBuilder.templates.pointsMaster",fallback:"积分达人",descriptionI18n:"admin.badges.ruleBuilder.templates.pointsMasterDesc",descriptionFallback:"累计获取积分 ≥ 5000 或积分余额 ≥ 2000",value:{all:!1,rules:[{metric:"total_points_earned",operator:">=",value:5e3,label:"Earned Points",description:"累计积分 ≥ 5000"},{metric:"total_points_balance",operator:">=",value:2e3,label:"Points Balance",description:"积分余额 ≥ 2000"}]}},{id:"veteran-member",labelI18n:"admin.badges.ruleBuilder.templates.veteran",fallback:"资深会员",descriptionI18n:"admin.badges.ruleBuilder.templates.veteranDesc",descriptionFallback:"注册超过 365 天并累计提交 50 条记录",value:{all:!0,rules:[{metric:"days_since_registration",operator:">=",value:365,label:"Membership Days",description:"注册天数 ≥ 365"},{metric:"total_records",operator:">=",value:50,label:"Total Submissions",description:"提交记录 ≥ 50 条"}]}}],Xe={metric:"total_carbon_saved",operator:">=",value:10,label:"",description:""},V=(a={})=>({metric:a.metric??"total_carbon_saved",operator:a.operator??">=",value:Number.isFinite(a.value)?a.value:Number(a.value??0)||0,label:a.label??"",description:a.description??""});function ea({value:a,onChange:m}){const{t:r}=te(),n=o.useMemo(()=>{if(!a||typeof a!="object")return{all:!0,rules:[]};const d=Array.isArray(a.rules)?a.rules.map(V):Array.isArray(a)?a.map(V):[];return{all:!!(a.all??a.all_required??a.requireAll??!0),rules:d}},[a]),h=d=>{m==null||m({all:!!(d.all??n.all),rules:Array.isArray(d.rules)?d.rules.map(V):n.rules})},_=d=>{h({...n,all:d})},j=(d,u)=>{const t=n.rules.map((i,c)=>c===d?V({...i,...u}):i);h({...n,rules:t})},S=d=>{const u=n.rules.filter((t,i)=>i!==d);h({...n,rules:u})},v=()=>{h({...n,rules:[...n.rules,Xe]})},A=d=>{h(d.value)},T=o.useMemo(()=>{const d=new Map;return me.forEach(u=>{d.set(u.value,u)}),d},[]);return e.jsxs("div",{className:"space-y-4 rounded-lg border bg-muted/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-semibold leading-none tracking-tight",children:[r("admin.badges.ruleBuilder.title","自动授予规则"),e.jsx(G,{variant:"secondary",className:"ml-2",children:n.all?r("admin.badges.ruleBuilder.modeAll","全部条件满足"):r("admin.badges.ruleBuilder.modeAny","任一条件满足")})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("admin.badges.ruleBuilder.description","通过可视化条件编辑器定义系统自动授予徽章的触发条件。")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:n.all?r("admin.badges.ruleBuilder.requireAllHint","所有条件都满足时授予"):r("admin.badges.ruleBuilder.requireAnyHint","满足任意条件即可授予")}),e.jsx(K,{checked:n.all,onCheckedChange:_})]})]}),e.jsxs("div",{className:"space-y-3",children:[n.rules.length===0&&e.jsx("div",{className:"rounded-md border border-dashed bg-background p-6 text-center text-sm text-muted-foreground",children:r("admin.badges.ruleBuilder.empty","还没有添加条件，点击下方按钮开始创建。")}),n.rules.map((d,u)=>{const t=T.get(d.metric);return e.jsxs("div",{className:"space-y-4 rounded-lg border bg-background p-4 shadow-sm",children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-12",children:[e.jsxs("div",{className:"md:col-span-5 space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:r("admin.badges.ruleBuilder.fields.metric","度量维度")}),e.jsxs(Y,{value:d.metric,onValueChange:i=>j(u,{metric:i}),children:[e.jsx(X,{className:"w-full justify-between",children:e.jsx(ee,{placeholder:r("admin.badges.ruleBuilder.selectMetric","选择指标")})}),e.jsx(ae,{children:me.map(i=>e.jsx(se,{value:i.value,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:r(i.labelI18n,i.fallback)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r(i.hintI18n,i.hintFallback)})]})},i.value))})]})]}),e.jsxs("div",{className:"md:col-span-2 space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:r("admin.badges.ruleBuilder.fields.operator","比较符")}),e.jsxs(Y,{value:d.operator,onValueChange:i=>j(u,{operator:i}),children:[e.jsx(X,{className:"w-full",children:e.jsx(ee,{})}),e.jsx(ae,{children:Ke.map(i=>e.jsx(se,{value:i.value,children:r(i.labelI18n,i.fallback)},i.value))})]})]}),e.jsxs("div",{className:"md:col-span-3 space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:r("admin.badges.ruleBuilder.fields.value","阈值")}),e.jsx(k,{type:"number",value:d.value??"",onChange:i=>j(u,{value:Number(i.target.value)})}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:t?r(t.hintI18n,t.hintFallback):r("admin.badges.ruleBuilder.valueHint","建议填写整数或带两位小数的数值")})]}),e.jsx("div",{className:"md:col-span-2 flex items-end justify-end",children:e.jsx(b,{type:"button",variant:"ghost",size:"icon",onClick:()=>S(u),children:e.jsx(ge,{className:"h-4 w-4"})})})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:r("admin.badges.ruleBuilder.fields.label","条件标签（可选）")}),e.jsx(k,{value:d.label??"",onChange:i=>j(u,{label:i.target.value}),placeholder:r("admin.badges.ruleBuilder.fields.labelPlaceholder","用于说明条件的简短标题")})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:r("admin.badges.ruleBuilder.fields.description","条件说明（可选）")}),e.jsx(k,{value:d.description??"",onChange:i=>j(u,{description:i.target.value}),placeholder:r("admin.badges.ruleBuilder.fields.descriptionPlaceholder","帮助其他管理员理解该条件")})]})]})]},u)})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(b,{type:"button",variant:"outline",onClick:v,children:[e.jsx(qe,{className:"mr-2 h-4 w-4"}),r("admin.badges.ruleBuilder.addRule","添加条件")]}),Ye.map(d=>e.jsxs(b,{type:"button",variant:"ghost",onClick:()=>A(d),children:[e.jsx(Qe,{className:"mr-2 h-4 w-4"}),r(d.labelI18n,d.fallback)]},d.id))]}),e.jsxs("div",{className:"rounded-lg border bg-background p-3",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:r("admin.badges.ruleBuilder.preview","生成的规则 JSON 预览（保存时自动写入）")}),e.jsx("pre",{className:"mt-2 max-h-48 overflow-auto text-xs leading-5",children:JSON.stringify(n,null,2)})]})]})}const W={current_page:1,per_page:10,total_items:0,total_pages:0},aa=[{value:"awarded",i18n:"admin.badges.recipients.status.awarded",fallback:"已授予"},{value:"revoked",i18n:"admin.badges.recipients.status.revoked",fallback:"已收回"},{value:"all",i18n:"admin.badges.recipients.status.all",fallback:"全部"}];function sa({open:a,onOpenChange:m,badge:r}){var t,i;const{t:n}=te(),[h,_]=o.useState({search:"",status:"awarded",page:1});o.useEffect(()=>{a||_({search:"",status:"awarded",page:1})},[a]);const j=Ae(["badgeRecipients",r==null?void 0:r.id,h],()=>O.getBadgeRecipients(Number(r==null?void 0:r.id),{page:h.page,per_page:10,status:h.status==="all"?void 0:h.status,search:h.search||void 0,include_revoked:h.status!=="awarded"}).then(c=>{var g;return(g=c.data)==null?void 0:g.data}),{enabled:a&&!!(r!=null&&r.id),keepPreviousData:!0,select:c=>c?{items:Array.isArray(c.items)?c.items:[],pagination:c.pagination||W,badge:c.badge||r||null}:{items:[],pagination:W,badge:null}}),S=((t=j.data)==null?void 0:t.items)||[],v=((i=j.data)==null?void 0:i.pagination)||W,A=c=>{const g=c.target.value;_(N=>({...N,search:g,page:1}))},T=c=>{_(g=>({...g,status:c,page:1}))},d=c=>{_(g=>({...g,page:c}))},u=o.useMemo(()=>r?n("admin.badges.recipients.titleWithName","徽章获奖用户：{{name}}",{name:r.name_zh||r.name_en||r.code||`#${r.id}`}):n("admin.badges.recipients.title","徽章获奖用户"),[r,n]);return e.jsx(Te,{open:a,onOpenChange:m,children:e.jsxs(Re,{className:"max-w-3xl",children:[e.jsxs(Pe,{children:[e.jsx(ze,{children:u}),e.jsx(Me,{children:n("admin.badges.recipients.subtitle","查看该徽章的授予记录、搜索用户并筛选状态")})]}),j.isLoading?e.jsxs("div",{className:"flex items-center justify-center py-8 text-sm text-muted-foreground",children:[e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}),n("common.loading","加载中...")]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(De,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(k,{value:h.search,onChange:A,placeholder:n("admin.badges.recipients.searchPlaceholder","按用户名或邮箱搜索"),className:"pl-9"})]}),e.jsxs(Y,{value:h.status,onValueChange:T,children:[e.jsx(X,{className:"w-[140px]",children:e.jsx(ee,{})}),e.jsx(ae,{children:aa.map(c=>e.jsx(se,{value:c.value,children:n(c.i18n,c.fallback)},c.value))})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx("span",{children:n("admin.badges.recipients.totalCount","共 {{count}} 人",{count:v.total_items||0})})]})]}),j.error?e.jsx("p",{className:"text-sm text-destructive",children:n("admin.badges.recipients.loadFailed","加载列表失败，请稍后再试")}):S.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wide",children:n("admin.badges.recipients.table.username","用户名")}),e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wide",children:n("admin.badges.recipients.table.email","邮箱")}),e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wide",children:n("admin.badges.recipients.table.status","状态")}),e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wide",children:n("admin.badges.recipients.table.awardedAt","授予时间")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:S.map(c=>{const g=c.user||{},N=c.user_badge||{},B=N.status||"awarded",R=N.awarded_at?Q(new Date(N.awarded_at),"yyyy-MM-dd HH:mm"):"--";return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 font-medium text-gray-900",children:g.username||"-"}),e.jsx("td",{className:"px-4 py-2 text-gray-600",children:g.email||"-"}),e.jsx("td",{className:"px-4 py-2",children:e.jsx(G,{variant:B==="awarded"?"success":"secondary",children:B==="awarded"?n("admin.badges.recipients.status.awarded","已授予"):n("admin.badges.recipients.status.revoked","已收回")})}),e.jsx("td",{className:"px-4 py-2 text-gray-600",children:R})]},`${g.id}-${N.awarded_at||N.status||"row"}`)})})]})}):e.jsx("p",{className:"py-6 text-center text-sm text-muted-foreground",children:n("admin.badges.recipients.empty","还没有授予记录")}),e.jsx(Je,{currentPage:v.current_page,totalPages:v.total_pages,onPageChange:d,itemsPerPage:v.per_page,totalItems:v.total_items})]})]})})}const $={id:null,name_zh:"",name_en:"",description_zh:"",description_en:"",icon_path:"",icon_thumbnail_path:"",icon_url:"",icon_presigned_url:"",sort_order:0,is_active:!0,auto_grant_enabled:!1,auto_grant_criteria:"",message_title_zh:"",message_title_en:"",message_body_zh:"",message_body_en:""},ta={total_records:0,awarded_records:0,awarded_users:0,last_awarded_at:null},L={all:!0,rules:[]},ue=a=>{if(!a)return L;let m=a;if(typeof a=="string")try{m=JSON.parse(a)}catch{return null}if(Array.isArray(m))return{all:!0,rules:m};if(typeof m=="object"){const r=Array.isArray(m.rules)?m.rules:Array.isArray(m.conditions)?m.conditions:[];return{all:!!(m.all??m.all_required??m.requireAll??!0),rules:r.map(h=>({...h}))}}return null};function la(){const{t:a}=te(),[m,r]=Ee(),[n,h]=o.useState([]),[_,j]=o.useState(!0),[S,v]=o.useState(!1),[A,T]=o.useState(!1),[d,u]=o.useState(!1),[t,i]=o.useState($),[c,g]=o.useState("builder"),[N,B]=o.useState(L),[R,z]=o.useState({open:!1,badgeIds:[],mode:"award",presetUsers:[]}),[le,re]=o.useState({open:!1,badge:null}),q=o.useRef(null),P=o.useCallback(async()=>{var s;try{j(!0);const l=await O.getBadges();(s=l.data)!=null&&s.success&&h(l.data.data||[])}catch{y.error(a("admin.badges.loadFailed","加载徽章列表失败"))}finally{j(!1)}},[a]);o.useEffect(()=>{P()},[P]),o.useEffect(()=>{m.get("create")==="1"&&(J(),r(s=>{const l=new URLSearchParams(s);return l.delete("create"),l},{replace:!0}))},[m,r]);const J=()=>{i($),B(L),g("builder"),q.current&&(q.current.value="")},pe=s=>{const l=ue(s==null?void 0:s.auto_grant_criteria);i({...$,...s,auto_grant_criteria:l?JSON.stringify(l,null,2):s.auto_grant_criteria?JSON.stringify(s.auto_grant_criteria,null,2):""}),l?(B(l),g("builder")):s.auto_grant_criteria?g("json"):(B(L),g("builder"))},w=s=>{const{name:l,value:x}=s.target;i(p=>({...p,[l]:x}))},ie=s=>l=>{i(x=>({...x,[s]:l}))},he=s=>{if(s)if(s==="builder"){const l=ue(t.auto_grant_criteria);l?(B(l),i(x=>({...x,auto_grant_criteria:JSON.stringify(l,null,2)})),g("builder")):y.error(a("admin.badges.ruleBuilder.parseFailed","当前 JSON 无法解析为可视化规则，请检查格式。"))}else g(s)},fe=s=>{B(s),i(l=>({...l,auto_grant_criteria:JSON.stringify(s,null,2)}))},be=async s=>{var x;const l=(x=s.target.files)==null?void 0:x[0];if(l){if(l.size>5*1024*1024){y.error(a("admin.badges.fileTooLarge","文件大小不能超过5MB")),s.target.value="";return}u(!0);try{const p=await Ue(l,{directory:"badges",entityType:"badge",entityId:t.id||void 0}),f=(p==null?void 0:p.data)||p;i(I=>({...I,icon_path:f.file_path||I.icon_path,icon_thumbnail_path:f.thumbnail_path||I.icon_thumbnail_path,icon_url:f.url||f.public_url||I.icon_url,icon_presigned_url:f.presigned_url||I.icon_presigned_url})),y.success(a("admin.badges.uploadSuccess","徽章图标上传成功"))}catch(p){y.error((p==null?void 0:p.message)||a("admin.badges.uploadFailed","徽章图标上传失败"))}finally{u(!1),s.target&&(s.target.value="")}}},je=async s=>{var x,p;s.preventDefault();const l={name_zh:t.name_zh,name_en:t.name_en,description_zh:t.description_zh,description_en:t.description_en,icon_path:t.icon_path,icon_thumbnail_path:t.icon_thumbnail_path,sort_order:Number(t.sort_order)||0,is_active:!!t.is_active,auto_grant_enabled:!!t.auto_grant_enabled,message_title_zh:t.message_title_zh,message_title_en:t.message_title_en,message_body_zh:t.message_body_zh,message_body_en:t.message_body_en};if(l.auto_grant_enabled)if(c==="builder")l.auto_grant_criteria=N;else if(t.auto_grant_criteria)try{l.auto_grant_criteria=JSON.parse(t.auto_grant_criteria)}catch{y.error(a("admin.badges.criteriaParseFailed","自动授予规则 JSON 解析失败"));return}else l.auto_grant_criteria=null;else l.auto_grant_criteria=null;try{v(!0),t.id?(await O.updateBadge(t.id,l),y.success(a("admin.badges.updateSuccess","徽章已更新"))):(await O.createBadge(l),y.success(a("admin.badges.createSuccess","徽章已创建"))),J(),P()}catch(f){y.error(((p=(x=f.response)==null?void 0:x.data)==null?void 0:p.message)||a("admin.badges.saveFailed","保存徽章失败"))}finally{v(!1)}},_e=({failed:s})=>{s||z(l=>({...l,open:!1})),P()},ne=s=>{z({open:!0,badgeIds:s?[s.id]:[],mode:"award",presetUsers:[]})},ye=s=>{z({open:!0,badgeIds:s?[s.id]:[],mode:"revoke",presetUsers:[]})},ve=s=>{s&&re({open:!0,badge:s})},Ne=s=>{re(l=>({open:s,badge:s?l.badge:null}))},we=async()=>{var s,l,x;try{T(!0);const f=(s=(await O.triggerBadgeAuto()).data)==null?void 0:s.data,I=f&&typeof f.awarded<"u"?f.awarded:0,Ce=f&&typeof f.users<"u"?f.users:0,Se=f?" ("+I+" / "+Ce+")":"";y.success(a("admin.badges.autoTriggered","已触发自动授予流程")+Se)}catch(p){y.error(((x=(l=p.response)==null?void 0:l.data)==null?void 0:x.message)||a("admin.badges.autoTriggerFailed","触发自动授予失败"))}finally{T(!1),P()}},C=o.useMemo(()=>n||[],[n]),ke=o.useMemo(()=>C.filter(s=>s.is_active),[C]),Be=o.useMemo(()=>C.filter(s=>s.auto_grant_enabled),[C]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(M,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(E,{className:"text-sm font-medium",children:a("admin.badges.metrics.total","徽章总数")}),e.jsx(Z,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl font-bold",children:C.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.badges.metrics.totalHint","已创建的所有成就徽章数量")})]})]}),e.jsxs(M,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(E,{className:"text-sm font-medium",children:a("admin.badges.metrics.active","启用中")}),e.jsx(Fe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl font-bold",children:ke.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.badges.metrics.activeHint","当前对用户可见并可获得的徽章数量")})]})]}),e.jsxs(M,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(E,{className:"text-sm font-medium",children:a("admin.badges.metrics.auto","自动授予")}),e.jsx(He,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl font-bold",children:Be.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.badges.metrics.autoHint","开启自动授予规则的徽章数量")})]})]})]}),e.jsxs(M,{children:[e.jsxs(D,{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"min-w-0 space-y-1",children:[e.jsx(E,{children:a("admin.badges.listTitle","成就徽章列表")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.badges.listHint","支持快速授予/收回、刷新与自动规则触发。")})]}),e.jsxs("div",{className:"flex w-full flex-col gap-2 sm:flex-row sm:flex-wrap sm:items-center sm:justify-end",children:[e.jsxs(b,{className:"w-full sm:w-auto",variant:"outline",onClick:P,disabled:_,children:[e.jsx(Ve,{className:"h-4 w-4 mr-2 "+(_?"animate-spin":"")}),a("common.refresh","刷新")]}),e.jsxs(b,{className:"w-full sm:w-auto",variant:"outline",onClick:we,disabled:A,children:[A?e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(de,{className:"h-4 w-4 mr-2"}),a("admin.badges.triggerAuto","触发自动授予")]}),e.jsxs(b,{className:"w-full sm:w-auto",variant:"outline",onClick:()=>ne(null),children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),a("admin.badges.bulkAward","批量授予")]}),e.jsx(b,{className:"w-full sm:w-auto",onClick:J,variant:"secondary",children:a("admin.badges.newBadge","新建徽章")})]})]}),e.jsx(F,{children:_?e.jsxs("div",{className:"flex items-center justify-center py-12 text-gray-500 text-sm",children:[e.jsx(U,{className:"h-5 w-5 mr-2 animate-spin"}),a("common.loading","加载中...")]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.badges.table.icon","图标")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.badges.table.name","名称")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.badges.table.status","状态")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.badges.table.stats","授予情况")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.badges.table.auto","自动授予")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.badges.table.sort","排序")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.badges.table.updated","更新时间")}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-gray-500 uppercase tracking-wider",children:a("common.actions","操作")})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[C.map(s=>{var p;const l=Array.isArray((p=s.auto_grant_criteria)==null?void 0:p.rules)?s.auto_grant_criteria.rules.length:Array.isArray(s.auto_grant_criteria)?s.auto_grant_criteria.length:0,x=s.stats||ta;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"w-12 h-12 rounded-full bg-gray-100 border overflow-hidden flex items-center justify-center",children:s.icon_path?e.jsx(ce,{src:s.icon_presigned_url||s.icon_url,filePath:!s.icon_presigned_url&&!s.icon_url?s.icon_path:void 0,alt:s.name_zh||s.name_en,className:"w-full h-full object-cover"}):e.jsx(Z,{className:"h-5 w-5 text-gray-400"})})}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.name_zh||s.name_en}),e.jsx("div",{className:"text-xs text-gray-500",children:s.name_en})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(G,{variant:s.is_active?"success":"secondary",children:s.is_active?a("admin.badges.active","启用"):a("admin.badges.inactive","停用")})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{children:a("admin.badges.stats.summary","{{awarded}} / {{total}}",{awarded:x.awarded_records||0,total:x.total_records||0})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a("admin.badges.stats.awardedUsers","{{count}} 位用户获得",{count:x.awarded_users||0})}),x.last_awarded_at?e.jsx("span",{className:"text-[10px] text-muted-foreground",children:a("admin.badges.stats.lastAwarded","最近：{{time}}",{time:Q(new Date(x.last_awarded_at),"yyyy-MM-dd HH:mm")})}):null]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(G,{variant:s.auto_grant_enabled?"outline":"secondary",children:s.auto_grant_enabled?a("admin.badges.autoEnabled","已开启"):a("admin.badges.autoDisabled","未开启")}),s.auto_grant_enabled&&l>0&&e.jsx("span",{className:"text-[10px] uppercase tracking-wide text-muted-foreground",children:a("admin.badges.ruleBuilder.ruleCount","{{count}} 条规则",{count:l})})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.sort_order}),e.jsx("td",{className:"px-4 py-3 text-xs text-gray-500",children:s.updated_at?Q(new Date(s.updated_at),"yyyy-MM-dd HH:mm"):"--"}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex flex-wrap justify-end gap-2",children:[e.jsxs(b,{className:"w-full sm:w-auto",variant:"ghost",size:"sm",onClick:()=>pe(s),children:[e.jsx(Ge,{className:"h-4 w-4 mr-1"}),a("common.edit","编辑")]}),e.jsxs(b,{className:"w-full sm:w-auto",variant:"ghost",size:"sm",onClick:()=>ve(s),children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),a("admin.badges.viewRecipients","获奖用户")]}),e.jsxs(b,{className:"w-full sm:w-auto",variant:"ghost",size:"sm",onClick:()=>ne(s),children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),a("admin.badges.award","授予")]}),e.jsxs(b,{className:"w-full sm:w-auto",variant:"ghost",size:"sm",onClick:()=>ye(s),children:[e.jsx(ge,{className:"h-4 w-4 mr-1"}),a("admin.badges.revoke","收回")]})]})})]},s.id)}),C.length===0&&!_&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-6 text-center text-sm text-gray-500",children:a("admin.badges.empty","还没有创建任何徽章")})})]})]})})})]}),e.jsxs(M,{children:[e.jsx(D,{children:e.jsx(E,{children:t.id?a("admin.badges.editTitle","编辑徽章"):a("admin.badges.createTitle","创建新徽章")})}),e.jsx(F,{children:e.jsxs("form",{onSubmit:je,className:"grid grid-cols-1 gap-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.nameZh","中文名称")}),e.jsx(k,{name:"name_zh",value:t.name_zh,onChange:w,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.nameEn","英文名称")}),e.jsx(k,{name:"name_en",value:t.name_en,onChange:w,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.descZh","中文描述")}),e.jsx(H,{name:"description_zh",value:t.description_zh,onChange:w,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.descEn","英文描述")}),e.jsx(H,{name:"description_en",value:t.description_en,onChange:w,rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.sort","排序权重")}),e.jsx(k,{type:"number",name:"sort_order",value:t.sort_order,onChange:w})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-md border p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.isActive","是否启用")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.badges.fields.isActiveHint","停用后用户将无法再获得该徽章")})]}),e.jsx(K,{checked:t.is_active,onCheckedChange:ie("is_active")})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.icon","徽章图标")}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-lg border bg-muted overflow-hidden flex items-center justify-center",children:t.icon_path?e.jsx(ce,{src:t.icon_presigned_url||t.icon_url,filePath:!t.icon_presigned_url&&!t.icon_url?t.icon_path:void 0,alt:t.name_zh||t.name_en,className:"w-full h-full object-cover"}):e.jsx(Z,{className:"h-8 w-8 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{type:"button",variant:"outline",disabled:d,onClick:()=>{var s;return(s=q.current)==null?void 0:s.click()},className:"flex items-center gap-2",children:[d?e.jsx(U,{className:"h-4 w-4 animate-spin"}):e.jsx(We,{className:"h-4 w-4"}),a("admin.badges.fields.uploadIcon","上传图标")]}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",ref:q,onChange:be}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.badges.fields.iconHint","建议使用 256x256 PNG / WebP，小于 5MB")})]})]})]}),e.jsxs("div",{className:"space-y-3 rounded-lg border bg-muted/40 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.autoGrantTitle","自动授予规则")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.badges.fields.autoGrantHint","开启后系统会按照规则定期评估并授予徽章")})]}),e.jsx(K,{checked:t.auto_grant_enabled,onCheckedChange:ie("auto_grant_enabled")})]}),t.auto_grant_enabled&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(Oe,{type:"single",value:c,onValueChange:he,variant:"outline",children:[e.jsx(oe,{value:"builder",children:a("admin.badges.ruleBuilder.toggle.visual","图形化编辑")}),e.jsx(oe,{value:"json",children:a("admin.badges.ruleBuilder.toggle.json","JSON 高级模式")})]}),c==="builder"?e.jsx(ea,{value:N,onChange:fe}):e.jsx(H,{className:"font-mono",rows:12,value:t.auto_grant_criteria,onChange:s=>i(l=>({...l,auto_grant_criteria:s.target.value})),placeholder:JSON.stringify(L,null,2)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.messageTitleZh","通知标题（中文）")}),e.jsx(k,{name:"message_title_zh",value:t.message_title_zh,onChange:w})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.messageTitleEn","通知标题（英文）")}),e.jsx(k,{name:"message_title_en",value:t.message_title_en,onChange:w})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.messageBodyZh","通知内容（中文）")}),e.jsx(H,{name:"message_body_zh",value:t.message_body_zh,onChange:w,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.badges.fields.messageBodyEn","通知内容（英文）")}),e.jsx(H,{name:"message_body_en",value:t.message_body_en,onChange:w,rows:3})]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-end gap-3",children:[e.jsx(b,{className:"w-full sm:w-auto",type:"button",variant:"ghost",onClick:J,children:a("common.reset","重置")}),e.jsxs(b,{className:"w-full sm:w-auto",type:"submit",disabled:S,children:[S&&e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}),t.id?a("common.saveChanges","保存修改"):a("common.create","创建")]})]})]})})]}),e.jsx(Le,{open:R.open,onOpenChange:s=>{z(s?l=>({...l,open:!0}):{open:!1,badgeIds:[],mode:"award",presetUsers:[]})},badges:C,defaultSelectedBadgeIds:R.badgeIds,presetUsers:R.presetUsers,onCompleted:_e,mode:R.mode}),e.jsx(sa,{open:le.open,onOpenChange:Ne,badge:le.badge})]})}function ka(){return e.jsx(la,{})}export{ka as default};
