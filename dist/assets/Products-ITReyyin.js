import{u as xe,af as he,r as m,a3 as te,aA as fe,n as D,j as e,Z as ye,I as O,B as I,X as M,z as ne,v as ae,P as Z,ay as R,a8 as je,a9 as be,aa as ve,ab as Ne,ac as _e,a0 as J,ae as we,a6 as ie,aB as ke}from"./index-BR4S2x3M.js";import{u as V}from"./useMutation-By-SFk_j.js";import{u as Ce}from"./r2Upload-CnV1d8WR.js";import{T as Pe}from"./textarea-DjVDANIf.js";import{A as Ae,b as Se,a as De}from"./Alert-Cn1DWQJN.js";import{A as Fe,a as Te,b as Ie,c as Oe,d as qe,e as Me,f as Ee,g as Le}from"./alert-dialog-MDstoSBa.js";import{P as Re}from"./Pagination-BFghxEqU.js";import{C as le}from"./circle-plus-BQu8dLf0.js";import{I as oe}from"./image-CvNvRdCe.js";import{S as ze}from"./square-pen-D141Xxt2.js";import{T as re}from"./trash-2-Bg2KFNd_.js";const H={name:"",description:"",category:null,points_required:0,stock:-1,status:"active",sort_order:0,image_path:"",image_url:"",image_presigned_url:"",images:[],tags:[]},de=[{value:"active",labelKey:"admin.products.statusActive"},{value:"inactive",labelKey:"admin.products.statusInactive"}],$=(s,i=0)=>{if(s==null||s==="")return i;const o=Number(s);return Number.isFinite(o)?o:i},G=s=>s?s.toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,60):"",X=()=>"tag-"+Math.random().toString(36).slice(2,8),E=s=>{if(!s)return null;if(typeof s=="string"){const i=s.trim();if(!i)return null;const o=i.trim().toLowerCase();return{id:null,name:i,slug:o||i}}if(typeof s=="object"){const i=s.id??s.category_id??s.value??s.key??null,o=i!=null&&i!==""&&!Number.isNaN(Number(i))?Number(i):null,a=s.name??s.category??s.label??s.value??"",x=typeof a=="string"?a.trim():String(a||"").trim(),c=s.slug??s.category_slug??s.value??"";let r=typeof c=="string"?c.trim():String(c||"").trim();!r&&x&&(r=x.trim()),r&&(r=r.toLowerCase()),r||(r=X());const u=typeof c=="string"?c.trim():String(c||"").trim(),p=x||u||r;return p?{id:o,name:p,slug:r}:null}return null},U=s=>Array.isArray(s)?s.map(i=>{const o=E(i);return o?{...o,product_count:(i==null?void 0:i.product_count)??(i==null?void 0:i.count)??(i==null?void 0:i.total)??0}:null}).filter(Boolean):[],ce=s=>{var x,c,r;if(!s)return null;if(typeof s=="string"){const u=s.trim();return u?{id:null,name:u,slug:G(u)||X()}:null}const i=((x=s.name)==null?void 0:x.trim())||((c=s.label)==null?void 0:c.trim())||((r=s.value)==null?void 0:r.trim())||"";if(!i)return null;const o=s.id!==void 0&&s.id!==null&&s.id!==""?Number(s.id):null,a=G(s.slug||i)||X();return{id:o,name:i,slug:a}},Be=s=>{const i=(s.name||"").trim(),o=E(s.category),a=(s.tags||[]).map(c=>ce(c)).filter(Boolean).reduce((c,r)=>(c.find(p=>p.id&&r.id?p.id===r.id:p.slug===r.slug)||c.push(r),c),[]),x=Array.isArray(s.images)?s.images.filter(Boolean):[];return{name:i,description:s.description||"",category:o?{id:o.id,name:o.name,slug:o.slug}:null,points_required:$(s.points_required),stock:$(s.stock,-1),status:s.status||"active",sort_order:$(s.sort_order,0),image_path:s.image_path||void 0,image_url:s.image_url||void 0,images:x.length?x:void 0,tags:a}};function Qe(){var W,Y;const{t:s}=xe(),i=he(),[o,a]=m.useState({search:"",category:"",status:"",page:1,limit:10}),[x,c]=m.useState(!1),[r,u]=m.useState(null),[p,w]=m.useState({open:!1,product:null}),C=te(["adminProducts",o],()=>R.getProducts(o).then(t=>t.data),{keepPreviousData:!0}),A=te("productCategories",()=>ie.getCategories().then(t=>t.data)),k=V(t=>R.createProduct(t)),S=V(({id:t,payload:b})=>R.updateProduct(t,b)),l=V(t=>R.deleteProduct(t)),h=k.isLoading||S.isLoading,P=((W=C.data)==null?void 0:W.data)||C.data||{},d=P.products||P.data||C.data||[],f=m.useMemo(()=>Array.isArray(d)?d:[],[d]),y=P.pagination||{page:o.page,limit:o.limit,total:f.length,pages:1,current_page:o.page,per_page:o.limit,total_items:f.length,total_pages:1},N=m.useMemo(()=>{var F,v;const t=(F=A.data)==null?void 0:F.data,b=Array.isArray(t==null?void 0:t.categories)?t.categories:Array.isArray(t)?t:((v=A.data)==null?void 0:v.categories)||[];return Array.isArray(b)?U(b):[]},[A.data]);m.useEffect(()=>{const t=f.map(b=>{const F=Array.isArray(b.images)?b.images:[],v=F.length>0?F[0]:null,Q=(()=>{if(!v)return null;if(typeof v=="string")return v.indexOf("http")===0?null:v;if(typeof v=="object"&&v!==null){if(v.file_path)return v.file_path;if(typeof v.url=="string"&&v.url.indexOf("http")!==0)return v.url}return null})(),g=b.image_path||Q||(typeof b.image_url=="string"&&b.image_url.indexOf("http")!==0?b.image_url:null),K=typeof b.image_presigned_url=="string"&&b.image_presigned_url||v&&typeof v=="object"&&v!==null&&typeof v.presigned_url=="string"&&v.presigned_url;return!g||K?null:g}).filter(Boolean);t.length&&fe(t).catch(()=>{})},[f]);const n=(t,b)=>{a(F=>({...F,[t]:b,page:1}))},j=t=>{a(b=>({...b,page:t}))},_=()=>{c(!1),u(null)},L=()=>{u(null),c(!0)},z=t=>{u(t),c(!0)},B=()=>{p.product&&l.mutate(p.product.id,{onSuccess:()=>{D.success(s("admin.products.deleteSuccess")),i.invalidateQueries("adminProducts")},onError:()=>{D.error(s("admin.products.deleteFailed"))},onSettled:()=>w({open:!1,product:null})})},q=m.useCallback(t=>{const b=Be(t);if(r){S.mutate({id:r.id,payload:b},{onSuccess:()=>{D.success(s("admin.products.updateSuccess")),i.invalidateQueries("adminProducts"),_()},onError:()=>{D.error(s("admin.products.updateFailed"))}});return}k.mutate(b,{onSuccess:()=>{D.success(s("admin.products.createSuccess")),i.invalidateQueries("adminProducts"),_()},onError:()=>{D.error(s("admin.products.createFailed"))}})},[k,r,i,s,S]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:s("admin.products.title")}),e.jsx("p",{className:"text-muted-foreground",children:s("admin.products.description")})]}),e.jsx("div",{className:"rounded-lg border bg-white p-6 shadow-sm",children:e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-end md:justify-between",children:[e.jsxs("div",{className:"grid flex-1 grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:s("common.search")}),e.jsxs("div",{className:"relative",children:[e.jsx(ye,{className:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"}),e.jsx(O,{value:o.search,onChange:t=>n("search",t.target.value),placeholder:s("admin.products.searchPlaceholder"),className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:s("admin.products.category")}),e.jsxs("select",{value:o.category,onChange:t=>n("category",t.target.value),className:"mt-0 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-emerald-500 focus:outline-none focus:ring-emerald-500",children:[e.jsx("option",{value:"",children:s("common.all")}),N.map(t=>e.jsx("option",{value:t.slug||t.id||t.name,children:t.name},t.slug||t.id||t.name))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:s("admin.products.status")}),e.jsxs("select",{value:o.status,onChange:t=>n("status",t.target.value),className:"mt-0 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-emerald-500 focus:outline-none focus:ring-emerald-500",children:[e.jsx("option",{value:"",children:s("common.all")}),de.map(t=>e.jsx("option",{value:t.value,children:s(t.labelKey)},t.value))]})]})]}),e.jsxs(I,{onClick:L,className:"shrink-0",children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),s("admin.products.addProduct")]})]})}),C.isLoading||C.isFetching?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx(M,{className:"h-8 w-8 animate-spin text-emerald-500"})}):C.error?e.jsxs(Ae,{variant:"destructive",children:[e.jsx(Se,{children:s("common.error")}),e.jsx(De,{children:s("errors.loadFailed")})]}):f.length===0?e.jsxs("div",{className:"rounded-lg border bg-white p-16 text-center shadow-sm",children:[e.jsx("h3",{className:"text-xl font-semibold",children:s("admin.products.noProductsFound")}),e.jsx("p",{className:"mt-2 text-muted-foreground",children:s("admin.products.tryDifferentFilters")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto rounded-lg border bg-white shadow-sm",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.image")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.name")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.category")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.price")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.stock")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.tags")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.status")}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:f.map(t=>{const b=t.points_required!==void 0&&t.points_required!==null?t.points_required:t.price||0,F=t.stock===0,v=t.stock===-1,Q=Array.isArray(t.images)?t.images:[],g=Q.length>0?Q[0]:null,K=(()=>{if(!g)return null;if(typeof g=="string")return g.indexOf("http")===0?null:g;if(typeof g=="object"&&g!==null){if(g.file_path)return g.file_path;if(typeof g.url=="string"&&g.url.indexOf("http")!==0)return g.url}return null})(),ue=t.image_path||K||(typeof t.image_url=="string"&&t.image_url.indexOf("http")!==0?t.image_url:null),me=typeof t.image_presigned_url=="string"&&t.image_presigned_url?t.image_presigned_url:null,ge=g&&typeof g=="object"&&g!==null&&typeof g.presigned_url=="string"&&g.presigned_url?g.presigned_url:null,ee=[me,ge,typeof t.image_url=="string"&&t.image_url.indexOf("http")===0?t.image_url:null,g&&typeof g=="string"&&g.indexOf("http")===0?g:null,g&&typeof g=="object"&&g!==null&&typeof g.url=="string"&&g.url.indexOf("http")===0?g.url:null].find(T=>typeof T=="string"&&T)||null,se=ue||null;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4",children:se||ee?e.jsx(ne,{filePath:se||void 0,src:ee||void 0,alt:t.name,className:"h-12 w-12 rounded-lg object-cover",fallback:e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-gray-100 text-xs text-gray-400",children:"IMG"})}):e.jsx(oe,{className:"h-10 w-10 text-gray-300"})}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500",children:t.description})]}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:t.category||s("admin.products.form.uncategorized")}),e.jsxs("td",{className:"px-6 py-4 text-sm font-semibold text-green-600",children:[ae(b,0)," ",s("common.points")]}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:v?s("admin.products.unlimited"):ae(t.stock,0)}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:e.jsx("div",{className:"flex flex-wrap gap-1",children:(t.tags||[]).map(T=>{const pe=String(t.id||"product")+"-"+String(T.id!==void 0&&T.id!==null?T.id:T.slug||T.name||"tag");return e.jsx(Z,{variant:"secondary",className:"uppercase",children:T.name},pe)})})}),e.jsx("td",{className:"px-6 py-4 text-sm",children:F?e.jsx("span",{className:"inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800",children:s("admin.products.statusOutOfStock")}):t.status==="active"?e.jsx("span",{className:"inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800",children:s("admin.products.statusActive")}):e.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800",children:s("admin.products.statusInactive")})}),e.jsxs("td",{className:"px-6 py-4 text-right text-sm font-medium",children:[e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>z(t),className:"mr-2",children:e.jsx(ze,{className:"h-4 w-4"})}),e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>w({open:!0,product:t}),className:"text-red-600 hover:text-red-800",children:e.jsx(re,{className:"h-4 w-4"})})]})]},t.id)})})]})}),e.jsx(Re,{currentPage:y.current_page||y.page,totalPages:y.total_pages||y.pages||1,onPageChange:j,itemsPerPage:y.per_page||y.limit,totalItems:y.total_items||y.total})]}),e.jsx(Fe,{open:p.open,onOpenChange:t=>t?null:w({open:!1,product:null}),children:e.jsxs(Te,{className:"sm:max-w-md",children:[e.jsxs(Ie,{children:[e.jsx(Oe,{children:s("admin.products.deleteTitle")}),e.jsx(qe,{children:s("admin.products.confirmDelete",{name:((Y=p.product)==null?void 0:Y.name)||s("admin.products.unnamed")})})]}),e.jsxs(Me,{children:[e.jsx(Ee,{onClick:()=>w({open:!1,product:null}),children:s("common.cancel")}),e.jsxs(Le,{onClick:B,className:"bg-red-600 hover:bg-red-700 focus-visible:ring-red-600",disabled:l.isLoading,children:[l.isLoading?e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(re,{className:"mr-2 h-4 w-4"}),s("common.confirm")]})]})]})}),x&&e.jsx(Ue,{isOpen:x,onClose:_,onSubmit:q,product:r,categories:N,isSubmitting:h,t:s})]})}function Ue({isOpen:s,onClose:i,onSubmit:o,product:a,categories:x,isSubmitting:c,t:r}){const[u,p]=m.useState(H),[w,C]=m.useState(!1),A=m.useRef(null);m.useEffect(()=>{if(!s){p(H);return}if(a){const n=Array.isArray(a.images)&&a.images.length?a.images[0]:null;p({name:a.name||"",description:a.description||"",category:E({id:a.category_id??a.categoryId??null,name:a.category??"",slug:a.category_slug??a.categorySlug??""}),points_required:a.points_required!==void 0&&a.points_required!==null?a.points_required:a.price||0,stock:a.stock!==void 0&&a.stock!==null?a.stock:-1,status:a.status||"active",sort_order:a.sort_order!==void 0&&a.sort_order!==null?a.sort_order:0,image_path:a.image_path||(typeof a.image_url=="string"&&a.image_url.indexOf("http")!==0?a.image_url:"")||(n==null?void 0:n.file_path)||"",image_url:typeof a.image_url=="string"?a.image_url:(n==null?void 0:n.url)||"",image_presigned_url:a.image_presigned_url||(n==null?void 0:n.presigned_url)||"",images:Array.isArray(a.images)?a.images:[],tags:Array.isArray(a.tags)?a.tags.map(j=>({id:j.id!==void 0?j.id:null,name:j.name,slug:j.slug||G(j.name)})):[]})}else p(H)},[s,a]);const k=n=>j=>{p(_=>({..._,[n]:j.target.value}))},S=n=>{p(j=>({...j,tags:n}))},l=n=>{p(j=>({...j,category:E(n)}))},h=async n=>{const j=n.target.files&&n.target.files[0];if(j){if(j.size>5*1024*1024){D.error(r("admin.products.form.fileTooLarge","图片大小不能超过 5MB")),n.target.value="";return}C(!0);try{const _=await Ce(j,{directory:"products",entityType:"product",entityId:a?a.id:void 0});let L=_.presigned_url||_.url||_.public_url||"";if(!L&&_.file_path)try{L=await ke(_.file_path,600)}catch(q){console.warn("Preview presign failed",q)}const z=_.public_url||_.url||"",B={file_path:_.file_path,url:z,presigned_url:_.presigned_url||L||null,thumbnail_path:_.thumbnail_path||null};p(q=>({...q,image_path:_.file_path||q.image_path,image_url:z,image_presigned_url:B.presigned_url||"",images:[B]})),D.success(r("admin.products.form.uploadSuccess","图片上传成功"))}catch{D.error(r("admin.products.form.uploadFailed","图片上传失败，请重试"))}finally{C(!1),n.target&&(n.target.value="")}}},P=()=>{p(n=>({...n,image_path:"",image_url:"",image_presigned_url:"",images:[]}))},d=n=>{n.preventDefault();const j=(u.name||"").trim();if(!j){D.error(r("validation.required"));return}const _=j===u.name?u:{...u,name:j};o(_)},f=u.image_presigned_url||u.image_url||"",y=u.image_path||(f&&f.indexOf("http")!==0?f:""),N=!y&&f&&f.indexOf("http")===0?f:"";return e.jsx(je,{open:s,onOpenChange:n=>n?null:i(),children:e.jsxs(be,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsx(Ne,{children:r(a?"admin.products.editProduct":"admin.products.addProduct")}),e.jsx(_e,{children:r("admin.products.formModal.description")})]}),e.jsxs("form",{onSubmit:d,className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"product-name",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.name")}),e.jsx(O,{id:"product-name",value:u.name,onChange:k("name"),required:!0})]}),e.jsx("div",{children:e.jsx(Ke,{value:u.category,onChange:l,initialCategories:x,t:r})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-status",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.status")}),e.jsx("select",{id:"product-status",value:u.status,onChange:k("status"),className:"mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-emerald-500 focus:outline-none focus:ring-emerald-500",children:de.map(n=>e.jsx("option",{value:n.value,children:r(n.labelKey)},n.value))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-points",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.pointsRequired")}),e.jsx(O,{id:"product-points",type:"number",min:0,value:u.points_required,onChange:k("points_required"),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-stock",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.stock")}),e.jsx(O,{id:"product-stock",type:"number",value:u.stock,onChange:k("stock")}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:r("admin.products.form.stockHint")})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-sort-order",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.sortOrder")}),e.jsx(O,{id:"product-sort-order",type:"number",value:u.sort_order,onChange:k("sort_order")})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-description",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.description")}),e.jsx(Pe,{id:"product-description",value:u.description,onChange:k("description"),className:"min-h-[120px]"})]}),e.jsx("div",{children:e.jsx(Ve,{value:u.tags,onChange:S,t:r})}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.image")}),e.jsxs("div",{className:"mt-2 flex items-center gap-4",children:[y||N?e.jsx(ne,{filePath:y||void 0,src:N||void 0,alt:u.name||"product",className:"h-20 w-20 rounded-lg object-cover",fallback:e.jsx("div",{className:"flex h-20 w-20 items-center justify-center rounded-lg bg-gray-100 text-xs text-gray-400",children:"IMG"})}):e.jsx("div",{className:"flex h-20 w-20 items-center justify-center rounded-lg border border-dashed border-gray-300 bg-gray-50 text-gray-400",children:e.jsx(oe,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(I,{type:"button",variant:"outline",onClick:()=>A.current&&A.current.click(),disabled:w||c,children:[w?e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(le,{className:"mr-2 h-4 w-4"}),r(w?"admin.products.form.uploading":"admin.products.form.chooseImage")]}),(y||N)&&e.jsxs(I,{type:"button",variant:"ghost",onClick:P,disabled:c,children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),r("admin.products.form.removeImage")]})]}),e.jsx("p",{className:"text-xs text-gray-500",children:r("admin.products.form.imageHint")})]})]}),e.jsx("input",{ref:A,type:"file",accept:"image/*",className:"hidden",onChange:h})]}),e.jsxs(we,{children:[e.jsx(I,{type:"button",variant:"outline",onClick:i,disabled:c||w,children:r("common.cancel")}),e.jsxs(I,{type:"submit",disabled:c||w,children:[c?e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}):null,r(c?"common.saving":"common.save")]})]})]})]})})}function Ke({value:s,onChange:i,initialCategories:o=[],t:a}){const[x,c]=m.useState(""),r=m.useMemo(()=>"product-category-input-"+Math.random().toString(36).slice(2,8),[]),[u,p]=m.useState(()=>U(o)),[w,C]=m.useState(!1),A=m.useRef(null),k=E(s);m.useEffect(()=>{const d=U(o);d.length&&p(f=>{const y=new Map;return d.forEach(N=>{const n=(N.slug||N.name||"").toLowerCase();n&&y.set(n,N)}),f.forEach(N=>{if(!N)return;const n=(N.slug||N.name||"").toLowerCase();n&&!y.has(n)&&y.set(n,N)}),Array.from(y.values())})},[o]);const S=m.useCallback(async d=>{var f,y;C(!0);try{const N=await ie.getCategories({search:d||"",limit:12}),n=(f=N.data)==null?void 0:f.data,j=Array.isArray(n==null?void 0:n.categories)?n.categories:Array.isArray(n)?n:((y=N.data)==null?void 0:y.categories)||[];p(U(j))}catch(N){console.error("Category search failed",N)}finally{C(!1)}},[]);m.useEffect(()=>{S("")},[S]),m.useEffect(()=>(A.current&&clearTimeout(A.current),A.current=setTimeout(()=>{S(x.trim())},250),()=>{A.current&&clearTimeout(A.current)}),[x,S]);const l=m.useCallback(d=>{const f=E(d);f&&(typeof i=="function"&&i(f),c(""))},[i]),h=m.useCallback(()=>{const d=x.trim();d&&l({name:d})},[x,l]),P=m.useCallback(()=>{typeof i=="function"&&i(null)},[i]);return e.jsxs("div",{children:[e.jsx("label",{htmlFor:r,className:"block text-sm font-medium text-gray-700",children:a("admin.products.form.category")}),e.jsx("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:k?e.jsxs(Z,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx("span",{children:k.name}),e.jsx("button",{type:"button",className:"rounded-full p-0.5 hover:bg-gray-200",onClick:P,"aria-label":a("admin.products.form.removeCategory","移除分类"),children:e.jsx(J,{className:"h-3 w-3"})})]}):e.jsx("span",{className:"text-xs text-gray-500",children:a("admin.products.form.categoryPlaceholder")})}),e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsx(O,{id:r,value:x,onChange:d=>c(d.target.value),onKeyDown:d=>{d.key==="Enter"&&(d.preventDefault(),h())},placeholder:a("admin.products.form.categorySearchPlaceholder","输入或搜索分类名称")}),e.jsx(I,{type:"button",variant:"outline",onClick:h,disabled:!x.trim(),children:a("admin.products.form.useCategory","使用分类")})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:a("admin.products.form.categoryHint","可选择已有分类或输入新分类，新分类会自动保存。")}),e.jsxs("div",{className:"mt-3 rounded-md border bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-3 py-2 text-xs font-medium uppercase tracking-wide text-gray-500",children:[e.jsx("span",{children:a("admin.products.form.suggestions")}),w?e.jsx(M,{className:"h-3.5 w-3.5 animate-spin text-emerald-500"}):null]}),e.jsx("div",{className:"max-h-44 overflow-y-auto",children:u.length===0&&!w?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:a("admin.products.form.noCategorySuggestions","暂无匹配的分类，按回车创建新的分类。")}):u.map(d=>{const f=`category-suggestion-${d.slug||d.id||d.name}`,y=k&&(k.slug===d.slug||k.name===d.name);return e.jsxs("button",{type:"button",onClick:()=>l(d),className:`flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-white ${y?"bg-white":""}`,children:[e.jsx("span",{children:d.name}),e.jsx("span",{className:"text-xs uppercase text-gray-400",children:d.product_count!==void 0&&d.product_count!==null?d.product_count:d.slug})]},f)})})]})]})}function Ve({value:s,onChange:i,t:o}){const[a,x]=m.useState(""),[c,r]=m.useState([]),[u,p]=m.useState(!1),w=m.useRef(null),C=m.useCallback(async l=>{var h,P;p(!0);try{const d=await R.searchProductTags({search:l||"",limit:12});r(((P=(h=d.data)==null?void 0:h.data)==null?void 0:P.tags)||[])}catch(d){console.error("Tag search failed",d)}finally{p(!1)}},[]);m.useEffect(()=>{C("")},[C]),m.useEffect(()=>(w.current&&clearTimeout(w.current),w.current=setTimeout(()=>{C(a.trim())},250),()=>{w.current&&clearTimeout(w.current)}),[a,C]);const A=l=>{const h=ce(l);if(!h)return;(s||[]).some(d=>d.id&&h.id?d.id===h.id:d.slug===h.slug)||i([].concat(s||[],[h]))},k=()=>{const l=a.trim();if(!l)return;const h=c.find(P=>(P.name||"").toLowerCase()===l.toLowerCase());A(h||l),x("")},S=l=>{const h=(s||[]).slice();h.splice(l,1),i(h)};return e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:o("admin.products.form.tags")}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:(s||[]).map((l,h)=>{const P="selected-tag-"+h+"-"+(l.id!==void 0&&l.id!==null?l.id:l.slug||l.name||"tag");return e.jsxs(Z,{variant:"secondary",className:"flex items-center gap-1 uppercase",children:[e.jsx("span",{children:l.name}),e.jsx("button",{type:"button",className:"rounded-full p-0.5 hover:bg-gray-200",onClick:()=>S(h),"aria-label":o("admin.products.form.removeTag","移除标签"),children:e.jsx(J,{className:"h-3 w-3"})})]},P)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{value:a,onChange:l=>x(l.target.value),onKeyDown:l=>{l.key==="Enter"&&(l.preventDefault(),k())},placeholder:o("admin.products.form.tagPlaceholder")}),e.jsx(I,{type:"button",variant:"outline",onClick:k,disabled:!a.trim(),children:o("admin.products.form.addTag")})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:o("admin.products.form.tagHint")})]}),e.jsxs("div",{className:"mt-3 rounded-md border bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-3 py-2 text-xs font-medium uppercase tracking-wide text-gray-500",children:[e.jsx("span",{children:o("admin.products.form.suggestions")}),u?e.jsx(M,{className:"h-3.5 w-3.5 animate-spin text-emerald-500"}):null]}),e.jsx("div",{className:"max-h-44 overflow-y-auto",children:c.length===0&&!u?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:o("admin.products.form.noSuggestions")}):c.map((l,h)=>{const P="suggestion-"+(l.id!==void 0&&l.id!==null?l.id:l.slug||l.name||"tag")+"-"+h;return e.jsxs("button",{type:"button",onClick:()=>{A(l),x("")},className:"flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-white",children:[e.jsx("span",{children:l.name}),l.slug?e.jsx("span",{className:"text-xs uppercase text-gray-400",children:l.slug}):null]},P)})})]})]})}function rs(){return e.jsx(Qe,{})}export{rs as default};
