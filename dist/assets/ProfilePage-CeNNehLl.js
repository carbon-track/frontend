import{j as s}from"./motion-vendor-C11-9Hm-.js";import{r as d,R as pe}from"./react-vendor-CFnAvB5y.js";import{u as B,a8 as O,s as ue,I as M,B as I,P as Z,J as ge,aa as je,O as ve,v as be,Z as ae,R as le,n as V,ab as ee,ac as ye,C as se,ad as Ne}from"./index-DTb_MiA2.js";import{A as J,a as K,b as te}from"./Alert-CAcIl8e7.js";import{T as we}from"./Turnstile-ZpObHXMA.js";import{R as _e}from"./RegionSelector-DbJNUVX9.js";import{u as Se}from"./useMutation-BO4YFseV.js";import{C as Ce}from"./circle-check-big-DY8MNPjT.js";import{u as Pe}from"./index.esm-Dwrm2jdL.js";import{C as z,a as H,b as $,d as G}from"./Card-COwhRA1q.js";import"./i18n-vendor-DK0x1_bH.js";import"./charts-vendor-DJkHj7pX.js";const b="—",Ae=(e,t)=>s.jsxs("div",{className:"space-y-1",children:[s.jsx("p",{className:"text-sm font-medium text-gray-700",children:e}),s.jsx("div",{className:"rounded-md border border-dashed border-gray-200 bg-muted/40 px-3 py-2 text-sm text-gray-900",children:t??b})]},e),Ie=(e,t=350)=>{const[n,i]=d.useState(e);return d.useEffect(()=>{const o=setTimeout(()=>i(e),t);return()=>clearTimeout(o)},[e,t]),n};function ke({user:e}){const{t}=B(),n=O(),i=d.useRef(null),[o,x]=d.useState(""),[l,h]=d.useState(e!=null&&e.school_id?{id:e.school_id,name:e.school_name||""}:null),[m,y]=d.useState([]),[Q,k]=d.useState(!1),[U,E]=d.useState(!1),[S,r]=d.useState(""),[N,f]=d.useState(null),[u,w]=d.useState((e==null?void 0:e.country_code)||""),[g,R]=d.useState((e==null?void 0:e.state_code)||""),W=Ie(o.trim(),350),j=(e==null?void 0:e.school_id)??null,_=((e==null?void 0:e.school_name)||"").trim();d.useEffect(()=>{h(j?{id:j,name:_}:null)},[j,_]),d.useEffect(()=>{w((e==null?void 0:e.country_code)||""),R((e==null?void 0:e.state_code)||"")},[e==null?void 0:e.country_code,e==null?void 0:e.state_code]),d.useEffect(()=>{let a=!1;return k(!0),ue.getSchools({search:W||void 0,limit:8,page:1}).then(c=>{var C,P;if(a)return;const T=((P=(C=c.data)==null?void 0:C.data)==null?void 0:P.schools)??[];y(T)}).catch(()=>{a||y([])}).finally(()=>{a||k(!1)}),()=>{a=!0}},[W]);const q=d.useMemo(()=>o.trim(),[o]),L=d.useMemo(()=>{if(!e)return null;const a={};let c=!1;return l&&l.id!==j&&(a.school_id=l.id,c=!0),!l&&q&&q!==_&&(a.new_school_name=q,c=!0),(u!==(e.country_code||"")||g!==(e.state_code||""))&&u&&g&&(a.country_code=u,a.state_code=g,c=!0),c?a:null},[j,_,l,q,e,u,g]),ne=!L||U||!!L&&!S,ie=d.useMemo(()=>{if(!(e!=null&&e.updated_at))return b;const a=new Date(e.updated_at);return Number.isNaN(a.getTime())?e.updated_at:a.toLocaleString()},[e==null?void 0:e.updated_at]),oe=[{label:t("profile.userId","用户ID"),value:(e==null?void 0:e.id)??b},{label:t("profile.uuid","UUID"),value:(e==null?void 0:e.uuid)||b},{label:t("profile.points","积分"),value:(e==null?void 0:e.points)??0},{label:t("profile.lastUpdated","最后更新"),value:ie}],ce=[{label:t("profile.username"),value:(e==null?void 0:e.username)||b},{label:t("profile.email"),value:(e==null?void 0:e.email)||b},{label:t("profile.region","Region"),value:(e==null?void 0:e.region_label)||b},{label:t("profile.school"),value:_||t("profile.schoolUnset","Not set")}],de=a=>{const{value:c}=a.target;x(c),f(null),l&&c.trim()!==(l.name||"").trim()&&h(null)},me=a=>{h({id:a.id,name:a.name}),x(a.name||""),f(null)},xe=()=>{h(null),x(""),f(null)},he=()=>{var a,c;h(j?{id:j,name:_}:null),x(""),w((e==null?void 0:e.country_code)||""),R((e==null?void 0:e.state_code)||""),f(null),r(""),(c=(a=i.current)==null?void 0:a.reset)==null||c.call(a)},fe=async a=>{var c,T,C,P,X,F,Y;if(a.preventDefault(),!L){f({type:"error",message:t("profile.noChanges","No changes detected.")});return}E(!0),f(null);try{const D={...L,cf_turnstile_response:S||void 0},A=await je.updateProfile(D);if(!((c=A.data)!=null&&c.success))throw new Error(((T=A.data)==null?void 0:T.message)||"Failed to update profile");const v=(C=A.data)==null?void 0:C.data;v&&(ve.setUser(v),n.invalidateQueries("currentUser"),h(v.school_id?{id:v.school_id,name:v.school_name||""}:null),w(v.country_code||""),R(v.state_code||"")),x(""),f({type:"success",message:t("profile.updateSuccess","Profile updated successfully.")})}catch(D){const A=((X=(P=D.response)==null?void 0:P.data)==null?void 0:X.message)||D.message||t("profile.updateFailed","Unable to update profile.");f({type:"error",message:A})}finally{E(!1),r(""),(Y=(F=i.current)==null?void 0:F.reset)==null||Y.call(F)}};return s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{className:"grid grid-cols-1 gap-4 rounded-lg border bg-muted/40 p-4 sm:grid-cols-2",children:oe.map(a=>s.jsxs("div",{className:"min-w-0",children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:a.label}),s.jsx("p",{className:"break-words text-sm font-medium",children:a.value})]},a.label))}),s.jsx("div",{className:"space-y-4",children:ce.map(({label:a,value:c})=>Ae(a,c))}),s.jsxs("section",{className:"rounded-lg border p-4",children:[s.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4",children:s.jsxs("div",{children:[s.jsx("h3",{className:"text-base font-semibold text-gray-900",children:t("profile.editProfile","Edit Profile")}),s.jsx("p",{className:"text-sm text-muted-foreground",children:t("profile.editDescription","Update your region and school information.")})]})}),s.jsxs("form",{className:"space-y-6",onSubmit:fe,children:[s.jsxs("div",{className:"space-y-4",children:[s.jsx("h4",{className:"text-sm font-medium text-gray-900 border-b pb-2",children:t("profile.regionSettings","Region Settings")}),s.jsx(_e,{countryCode:u,stateCode:g,onCountryChange:w,onStateChange:R})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:s.jsx("h4",{className:"text-sm font-medium text-gray-900 border-b pb-2 w-full",children:t("profile.schoolSettings","School Settings")})}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"schoolSearch",className:"block text-sm font-medium text-gray-700",children:t("auth.school","School")}),s.jsx(M,{id:"schoolSearch",className:"mt-2",placeholder:t("profile.schoolSearchPlaceholder","Search for a school or enter a new name"),value:o,onChange:de}),s.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:t("profile.schoolInputHint","Selecting an existing school keeps data consistent. Typing a new school name will create it after verification.")})]}),s.jsxs("div",{className:"rounded-md border bg-white",children:[s.jsxs("div",{className:"flex items-center justify-between border-b px-3 py-2",children:[s.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:t("profile.schoolSuggestions","Suggestions")}),s.jsx(I,{type:"button",variant:"ghost",size:"sm",onClick:xe,children:t("profile.clearSelection","Clear selection")})]}),s.jsx("div",{className:"max-h-48 overflow-y-auto",children:Q?s.jsxs("div",{className:"flex items-center gap-2 px-3 py-3 text-sm text-muted-foreground",children:[s.jsx(Z,{className:"h-4 w-4 animate-spin"}),t("profile.loadingSchools","Loading schools...")]}):m.length>0?m.map(a=>{const c=(l==null?void 0:l.id)===a.id;return s.jsxs("button",{type:"button",onClick:()=>me(a),className:`flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-muted ${c?"bg-green-50 text-green-700":""}`,children:[s.jsx("span",{children:a.name}),c&&s.jsx(ge,{variant:"outline",children:t("profile.selected","Selected")})]},a.id)}):s.jsx("div",{className:"px-3 py-3 text-sm text-muted-foreground",children:t("profile.schoolNoResults","No matching schools. Enter a new name above.")})})]})]}),N&&s.jsx(J,{variant:N.type==="error"?"destructive":"success",children:s.jsx(K,{children:N.message})}),s.jsxs("div",{className:"space-y-3",children:[s.jsx(we,{ref:i,className:"flex flex-col items-center",onVerify:r,onExpire:()=>r(""),onError:()=>r(""),require:!0}),s.jsx("p",{className:"text-xs text-muted-foreground text-center",children:t("profile.turnstileNotice","Verification is required to prevent automated updates.")})]}),s.jsxs("div",{className:"flex flex-wrap gap-3",children:[s.jsx(I,{type:"submit",className:"flex-1",loading:U,disabled:ne,children:t("profile.saveChanges","Save Changes")}),s.jsx(I,{type:"button",variant:"outline",className:"flex-1",onClick:he,children:t("profile.reset","Reset")})]})]})]})]})}const p=e=>typeof e!="string"?"":e.trim()||"",Ue=e=>{if(!e||typeof e!="object")return{src:"",filePath:"",alt:""};const{src:t,filePath:n}=be({urlCandidates:[p(e.icon_url),p(e.url),p(e.avatar_url),p(e.image_url),p(e.icon_presigned_url),p(e.presigned_url),p(e.avatar_presigned_url)],pathCandidates:[p(e.file_path),p(e.icon_path),p(e.avatar_path)]});return{src:t,filePath:n,alt:p(e.name||e.username||e.title||"")}},re=e=>{const{src:t,filePath:n,alt:i}=Ue(e),o=i?i.charAt(0).toUpperCase():"";return{src:t,filePath:n,alt:i,fallbackInitial:o}};function Ee({currentAvatarId:e,onAvatarChange:t}){var S;const{t:n}=B(),i=O(),[o,x]=d.useState(e),{data:l,isLoading:h,error:m}=ae("avatars",()=>ee.getAvatars()),y=Se(r=>ee.selectAvatar(r),{onSuccess:()=>{V.success(n("profile.avatarUpdateSuccess")),i.invalidateQueries("currentUser"),t(o)},onError:r=>{V.error(n("profile.avatarUpdateFailed")),console.error("Avatar update failed:",r)}}),Q=((S=l==null?void 0:l.data)==null?void 0:S.data)||[],k=({avatar:r})=>{const{src:N,filePath:f,alt:u,fallbackInitial:w}=re(r),g=s.jsx("div",{className:"w-full aspect-square flex items-center justify-center text-xs text-gray-400 bg-gray-100 rounded-md",children:w||"IMG"});return s.jsx(le,{src:N||void 0,filePath:!N&&f?f:void 0,alt:u||(r==null?void 0:r.name),className:"w-full h-auto rounded-md object-cover",fallback:g})},U=r=>{x(r)},E=()=>{o&&o!==e&&y.mutate(o)};return h?s.jsx("div",{className:"flex justify-center items-center h-32",children:s.jsx(Z,{className:"h-8 w-8 animate-spin text-green-500"})}):m?s.jsx("div",{className:"text-center text-red-500",children:n("profile.avatarLoadError")}):s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"text-lg font-semibold",children:n("profile.selectAvatar")}),s.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4",children:Q.map(r=>s.jsxs("div",{className:`relative p-2 border-2 rounded-lg cursor-pointer
              ${o===r.id?"border-green-500":"border-gray-200 hover:border-gray-300"}`,onClick:()=>U(r.id),children:[s.jsx(k,{avatar:r}),o===r.id&&s.jsx("div",{className:"absolute top-1 right-1 bg-green-500 rounded-full p-1",children:s.jsx(Ce,{className:"h-4 w-4 text-white"})}),s.jsx("p",{className:"text-center text-sm mt-1",children:r.name})]},r.id))}),s.jsx(I,{onClick:E,disabled:o===e||y.isLoading,className:"w-full",children:y.isLoading?n("common.saving"):n("common.save")})]})}function Re(){const{t:e}=B(),{register:t,handleSubmit:n,formState:{errors:i},reset:o,watch:x}=Pe(),l=async h=>{try{await ye.post("/auth/change-password",h),V.success(e("profile.passwordChangeSuccess")),o()}catch(m){V.error(e("profile.passwordChangeFailed")),console.error("Password change failed:",m)}};return s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"text-lg font-semibold",children:e("profile.changePassword")}),s.jsxs("form",{onSubmit:n(l),className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:e("profile.currentPassword")}),s.jsx(M,{type:"password",...t("current_password",{required:e("validation.required")})}),i.current_password&&s.jsx("p",{className:"text-red-500 text-xs mt-1",children:i.current_password.message})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:e("profile.newPassword")}),s.jsx(M,{type:"password",...t("new_password",{required:e("validation.required"),minLength:{value:8,message:e("validation.minLength",{min:8})}})}),i.new_password&&s.jsx("p",{className:"text-red-500 text-xs mt-1",children:i.new_password.message})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:e("profile.confirmNewPassword")}),s.jsx(M,{type:"password",...t("confirm_new_password",{required:e("validation.required"),validate:h=>h===x("new_password")||e("validation.passwordMismatch")})}),i.confirm_new_password&&s.jsx("p",{className:"text-red-500 text-xs mt-1",children:i.confirm_new_password.message})]}),s.jsx(I,{type:"submit",children:e("profile.changePassword")})]})]})}function Je(){const{t:e}=B(),t=O(),{data:n,isLoading:i,error:o}=ae("currentUser",()=>Ne.getCurrentUser(),{staleTime:1/0}),x=(n==null?void 0:n.data)??null,l=(x==null?void 0:x.data)??x??null,h=()=>{t.invalidateQueries("currentUser")},m=pe.useMemo(()=>l?re({...l,file_path:l.avatar_url,name:l.username}):{src:"",filePath:"",alt:"",fallbackInitial:""},[l]);return i?s.jsx("div",{className:"flex justify-center items-center h-screen",children:s.jsx(Z,{className:"h-8 w-8 animate-spin text-green-500"})}):o?s.jsx("div",{className:"container mx-auto py-8 px-4",children:s.jsxs(J,{variant:"destructive",children:[s.jsx(se,{className:"h-4 w-4"}),s.jsx(te,{children:e("common.error")}),s.jsx(K,{children:e("profile.loadError")})]})}):l?s.jsxs("div",{className:"container mx-auto py-8 px-4",children:[s.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8",children:s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx("div",{className:"relative",children:s.jsx("div",{className:"w-24 h-24 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center text-3xl font-semibold text-gray-400",children:m.src||m.filePath?s.jsx(le,{src:m.src||void 0,filePath:!m.src&&m.filePath?m.filePath:void 0,alt:m.alt||l.username,className:"w-full h-full object-cover"}):s.jsx("span",{children:m.fallbackInitial||(l.username?l.username.charAt(0).toUpperCase():"U")})})}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:l.username}),l.email&&s.jsx("p",{className:"text-sm text-gray-500",children:l.email}),s.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm text-gray-600",children:[s.jsxs("span",{children:[e("profile.points"),": ",l.points??0]}),l.school_name&&s.jsxs("span",{className:"inline-flex items-center gap-1",children:[s.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-green-400"}),l.school_name]})]})]})]})}),s.jsx("h1",{className:"text-3xl font-bold tracking-tight mb-8",children:e("profile.title")}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[s.jsxs(z,{children:[s.jsx(H,{children:s.jsx($,{children:e("profile.basicInfo")})}),s.jsx(G,{children:s.jsx(ke,{user:l})})]}),s.jsxs(z,{children:[s.jsx(H,{children:s.jsx($,{children:e("profile.avatar")})}),s.jsx(G,{children:s.jsx(Ee,{currentAvatarId:l==null?void 0:l.avatar_id,onAvatarChange:h})})]}),s.jsxs(z,{className:"lg:col-span-2",children:[s.jsx(H,{children:s.jsx($,{children:e("profile.changePassword")})}),s.jsx(G,{children:s.jsx(Re,{})})]})]})]}):s.jsx("div",{className:"container mx-auto py-8 px-4",children:s.jsxs(J,{variant:"warning",children:[s.jsx(se,{className:"h-4 w-4"}),s.jsx(te,{children:e("common.notice","提示")}),s.jsx(K,{children:e("profile.noUserData","暂未获取到个人资料，请稍后重试。")})]})})}export{Je as default};
