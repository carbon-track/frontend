import{c as te,u as Z,r as n,j as e,B as O,y as le,I as se,b as H,S as ye,p as K,C as Y,z as we,a as ee,X as _e,D as oe,w as Se,R as Ce}from"./index-Dmxyr4ej.js";import{C as $,a as W,b as V,d as T,c as X}from"./Card-E4DVRsrP.js";import{F as Ae}from"./funnel-BdwKJ_dO.js";import{u as ke}from"./index.esm-CLnIsvca.js";import{b as Fe}from"./r2Upload-ByTWtsnE.js";import{A as ae,a as re}from"./Alert-JuWBaUPN.js";import{F as De}from"./file-text-BP6h1Pwl.js";import{U as de}from"./upload-C4IH_8MI.js";import{T as Le}from"./textarea-BtFkp_um.js";import{C as me}from"./circle-check-big-D75Bx39c.js";import{A as ze}from"./arrow-left-T2j15AXI.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],Ee=te("calendar",Ie);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]],xe=te("car",Re);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M7 19H4.815a1.83 1.83 0 0 1-1.57-.881 1.785 1.785 0 0 1-.004-1.784L7.196 9.5",key:"x6z5xu"}],["path",{d:"M11 19h8.203a1.83 1.83 0 0 0 1.556-.89 1.784 1.784 0 0 0 0-1.775l-1.226-2.12",key:"1x4zh5"}],["path",{d:"m14 16-3 3 3 3",key:"f6jyew"}],["path",{d:"M8.293 13.596 7.196 9.5 3.1 10.598",key:"wf1obh"}],["path",{d:"m9.344 5.811 1.093-1.892A1.83 1.83 0 0 1 11.985 3a1.784 1.784 0 0 1 1.546.888l3.943 6.843",key:"9tzpgr"}],["path",{d:"m13.378 9.633 4.096 1.098 1.097-4.096",key:"1oe83g"}]],ue=te("recycle",Pe),$e={daily:H,transport:xe,consumption:ye,environmental:ue,lifestyle:H,energy:H,water:H,waste:ue,travel:xe};function Te({onActivitySelect:a,selectedActivity:m}){const{t:o,currentLanguage:k}=Z(),[F,A]=n.useState([]),[r,v]=n.useState([]),[N,D]=n.useState([]),[_,S]=n.useState("all"),[x,U]=n.useState(""),[E,q]=n.useState(!0),[z,I]=n.useState("");n.useEffect(()=>{(async()=>{var h,y,g;try{q(!0);const f=await K.getActivities();if((h=f==null?void 0:f.data)!=null&&h.success){const w=(y=f==null?void 0:f.data)==null?void 0:y.data,i=(Array.isArray(w==null?void 0:w.activities)?w.activities:Array.isArray(w)?w:[]).filter(c=>!(!c||c.deleted_at||Object.prototype.hasOwnProperty.call(c,"is_active")&&c.is_active===!1)).map(c=>({...c,carbon_factor:Number(c.carbon_factor??c.factor??0),sort_order:Number(c.sort_order??0)})).sort((c,j)=>{const B=(c.sort_order??0)-(j.sort_order??0);return B!==0?B:(c.name_zh||"").localeCompare(j.name_zh||"")});A(i),v(i);const u=Array.isArray(w==null?void 0:w.categories)?w.categories:[...new Set(i.map(c=>c.category).filter(Boolean))];D(u)}else I(((g=f==null?void 0:f.data)==null?void 0:g.message)||o("errors.loadFailed"))}catch(f){I(f.message||o("errors.network"))}finally{q(!1)}})()},[o]),n.useEffect(()=>{let s=F;if(_!=="all"&&(s=s.filter(h=>h.category===_)),x){const h=(x||"").toString().toLowerCase(),y=g=>(g??"").toString().toLowerCase();s=s.filter(g=>y(g.name_zh).includes(h)||y(g.name_en).includes(h)||y(g.description_zh).includes(h)||y(g.description_en).includes(h))}v(s)},[F,_,x]);const R=s=>{a(s)},P=s=>o(`activities.categories.${s}`)||s,b=s=>(k||"").toLowerCase().startsWith("en")?s.name_en||s.name_zh||s.name:s.name_zh||s.name_en||s.name,M=s=>(k||"").toLowerCase().startsWith("en")?s.description_en||s.description_zh||s.description:s.description_zh||s.description_en||s.description;return E?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"}),e.jsx("span",{className:"ml-2 text-gray-600",children:o("common.loading")})]}):z?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-red-600 mb-4",children:z}),e.jsx(O,{onClick:()=>window.location.reload(),children:o("common.retry")})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(le,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(se,{type:"text",placeholder:o("activities.searchPlaceholder"),value:x,onChange:s=>U(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-4 w-4 text-gray-400"}),e.jsxs("select",{value:_,onChange:s=>S(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500",children:[e.jsx("option",{value:"all",children:o("activities.categories.all")}),N.map(s=>e.jsx("option",{value:s,children:P(s)},s))]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:r.map(s=>{const h=$e[s.category]||H,y=(m==null?void 0:m.id)||(m==null?void 0:m.uuid),g=s.id||s.uuid,f=y&&g&&y===g;return e.jsxs($,{className:`cursor-pointer transition-all duration-200 hover:shadow-md ${f?"ring-2 ring-green-500 bg-green-50":"hover:bg-gray-50"}`,onClick:()=>R(s),children:[e.jsx(W,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${f?"bg-green-200":"bg-gray-100"}`,children:e.jsx(h,{className:`h-5 w-5 ${f?"text-green-700":"text-gray-600"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx(V,{className:"text-sm font-medium",children:b(s)}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:P(s.category)})]})]})}),e.jsxs(T,{className:"pt-0",children:[e.jsx(X,{className:"text-sm text-gray-600 mb-3",children:M(s)}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"text-gray-500",children:[o("activities.unit"),": ",o(`units.${s.unit}`,s.unit)]}),e.jsxs("div",{className:"text-green-600 font-medium",children:[s.carbon_factor," ",o("activities.carbonFactor")]})]}),s.points_per_unit&&e.jsxs("div",{className:"mt-2 text-xs text-blue-600",children:[s.points_per_unit," ",o("activities.pointsPerUnit")]})]})]},g)})}),r.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 mb-2",children:e.jsx(le,{className:"h-12 w-12 mx-auto"})}),e.jsx("p",{className:"text-gray-600",children:o("activities.noActivitiesFound")}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:o("activities.tryDifferentSearch")})]})]})}function Ue({activity:a,onCalculate:m,onSubmit:o,calculationResult:k,isSubmitting:F,initialData:A}){const{t:r,currentLanguage:v}=Z(),[N,D]=n.useState([]),[_,S]=n.useState(""),[x,U]=n.useState(!1),[E,q]=n.useState([]),[z,I]=n.useState([]),[R,P]=n.useState({done:0,total:0}),[b,M]=n.useState(!1),[s,h]=n.useState(!1),y=n.useRef(null),{register:g,handleSubmit:f,watch:w,setValue:l,formState:{errors:i}}=ke({defaultValues:{activity_date:new Date().toISOString().split("T")[0],description:""}});n.useEffect(()=>{A&&A.amount&&(l("data",A.amount),A.description&&l("description",A.description))},[A,l]);const u=w("data"),c=n.useRef(""),j=n.useRef(null);n.useEffect(()=>{const t=(a==null?void 0:a.id)||(a==null?void 0:a.uuid)||"",d=u;j.current&&(clearTimeout(j.current),j.current=null);const C=parseFloat(d);if(!t||!d||isNaN(C)||C<=0){M(!1);return}return j.current=setTimeout(()=>{const p=`${t}::${C}`;if(c.current===p){M(!0);return}c.current=p,m(C),M(!0)},300),()=>{j.current&&(clearTimeout(j.current),j.current=null)}},[a,u,m]);const B=async t=>{if(S(""),!N.length&&!E.length){S(r("activities.form.imageRequired")||"请至少选择一张图片");return}let d=E;if(!E.length&&N.length){try{U(!0);const p=N.length;P({done:0,total:p}),d=(await Fe(N,{directory:"activities",entityType:"carbon_record"},(L,Q)=>{P({done:L,total:Q})})).map(L=>({url:L.url,file_path:L.file_path,original_name:L.original_name,mime_type:L.mime_type,size:L.size})),q(d)}catch(p){S(p.message||"上传失败"),U(!1);return}U(!1)}const C={activity_id:a.id||a.uuid,amount:parseFloat(t.data),date:t.activity_date,description:t.description,images:(d||[]).map(p=>({url:p.url,file_path:p.file_path,original_name:p.original_name,mime_type:p.mime_type,size:p.size}))};o(C)},ie=t=>{S("");const d=5,C=5*1024*1024,p=[...N],J=[...z];if(p.length+t.length>d){S(r("activities.form.maxFilesReached")||"最多只能上传 5 张图片");return}const L=[],Q=[];for(const G of t){if(G.size>C){S(r("activities.form.fileTooLarge")||"文件过大");continue}p.some(ce=>ce.name===G.name&&ce.size===G.size)||(L.push(G),Q.push(URL.createObjectURL(G)))}D([...p,...L]),I([...J,...Q])},he=t=>{const d=Array.from(t.target.files||[]);ie(d),t.target.value=null},ge=t=>{t.preventDefault(),t.stopPropagation(),h(!0)},fe=t=>{t.preventDefault(),t.stopPropagation(),h(!1)},pe=t=>{t.preventDefault(),t.stopPropagation(),h(!1);const d=Array.from(t.dataTransfer.files||[]);ie(d)},je=()=>{var t;(t=y.current)==null||t.click()},ve=t=>{D(d=>d.filter((C,p)=>p!==t)),I(d=>{const C=d.filter((p,J)=>J!==t);return d[t]&&URL.revokeObjectURL(d[t]),C})};if(!a)return e.jsx($,{children:e.jsxs(T,{className:"py-12 text-center",children:[e.jsx(Y,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:r("activities.selectActivityFirst")})]})});const be=t=>(v||"").toLowerCase().startsWith("en")?t.name_en||t.name_zh||t.name:t.name_zh||t.name_en||t.name,Ne=t=>(v||"").toLowerCase().startsWith("en")?t.description_en||t.description_zh||t.description:t.description_zh||t.description_en||t.description,ne=b&&k?e.jsxs($,{className:"bg-green-50 border-green-200 shadow-sm",children:[e.jsxs(W,{className:"pb-3",children:[e.jsx(V,{className:"text-sm font-medium text-green-800",children:r("activities.form.calculationResult")}),e.jsx(X,{className:"text-xs",children:r("activities.form.previewAutoUpdate")||"实时预览"})]}),e.jsx(T,{className:"pt-0",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-lg p-3 border",children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1",children:[r("activities.carbonSaved")," (kg CO₂)"]}),e.jsx("div",{className:"text-2xl font-bold text-green-600 leading-none",children:(()=>{const t=k.carbon_saved,d=typeof t=="number"?t:Number(t);return Number.isFinite(d)?d.toFixed(2):"0.00"})()})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:r("activities.form.expectedPoints")}),e.jsx("div",{className:"text-2xl font-bold text-blue-600 leading-none",children:k.points_earned??0})]})]})})]}):null;return e.jsxs("div",{className:"space-y-6 md:space-y-0 md:grid md:grid-cols-12 md:gap-6",children:[e.jsxs("div",{className:"md:col-span-8 space-y-6",children:[e.jsxs($,{children:[e.jsxs(W,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"h-5 w-5 text-green-600"}),be(a)]}),e.jsx(X,{children:Ne(a)})]}),e.jsx(T,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.category"),":"]}),e.jsx("div",{className:"font-medium",children:r(`activities.categories.${a.category}`)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.unit"),":"]}),e.jsx("div",{className:"font-medium",children:r(`units.${a.unit}`,a.unit)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.carbonFactor"),":"]}),e.jsx("div",{className:"font-medium text-green-600",children:a.carbon_factor})]}),a.points_per_unit&&e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.pointsPerUnit"),":"]}),e.jsx("div",{className:"font-medium text-blue-600",children:a.points_per_unit})]})]})})]}),e.jsx("div",{className:"md:hidden",children:ne}),e.jsxs($,{children:[e.jsxs(W,{children:[e.jsx(V,{children:r("activities.form.dataInput")}),e.jsx(X,{children:r("activities.form.inputDescription")})]}),e.jsx(T,{children:e.jsxs("form",{onSubmit:f(B),className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("activities.form.dataValue")," (",r(`units.${a.unit}`,a.unit),")"]}),e.jsx(se,{type:"number",step:"0.01",min:"0",placeholder:r("activities.form.dataPlaceholder"),error:i.data,...g("data",{required:r("activities.form.dataRequired"),min:{value:.01,message:r("activities.form.dataMinimum")}})}),i.data&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.data.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(Ee,{className:"inline h-4 w-4 mr-1"}),r("activities.form.activityDate")]}),e.jsx(se,{type:"date",max:new Date().toISOString().split("T")[0],error:i.activity_date,...g("activity_date",{required:r("activities.form.dateRequired")})}),i.activity_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.activity_date.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(De,{className:"inline h-4 w-4 mr-1"}),r("activities.form.notes")]}),e.jsx("textarea",{rows:4,placeholder:r("activities.form.notesPlaceholder"),className:`flex w-full rounded-md border bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${i.description?"border-red-500 focus-visible:ring-red-500":"border-input ring-offset-background"}`,...g("description",{maxLength:{value:500,message:r("validation.maxLength",{max:500})}})}),i.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.description.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(de,{className:"inline h-4 w-4 mr-1"}),r("activities.form.uploadImage")]}),e.jsxs("div",{className:ee("border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center gap-3 transition-all duration-200 cursor-pointer",s?"border-green-500 bg-green-50 scale-[1.02]":"border-gray-300 hover:border-green-400 hover:bg-gray-50",_?"border-red-300 bg-red-50":""),onDragOver:ge,onDragLeave:fe,onDrop:pe,onClick:je,children:[e.jsx("input",{ref:y,type:"file",accept:"image/*",multiple:!0,onChange:he,className:"hidden"}),e.jsx("div",{className:ee("p-3 rounded-full transition-colors",s?"bg-green-100":"bg-gray-100"),children:e.jsx(de,{className:ee("h-6 w-6",s?"text-green-600":"text-gray-500")})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:s?r("activities.form.dropHere")||"释放以上传":r("activities.form.clickOrDrag")||"点击或拖拽上传图片"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r("activities.form.uploadHint")||"支持 JPG, PNG (最大 5MB)"})]})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[N.length>0&&e.jsx("ul",{className:"space-y-2 text-sm",children:N.map((t,d)=>e.jsxs("li",{className:"flex items-center justify-between bg-gray-50 px-3 py-2 rounded-md border border-gray-200 hover:border-gray-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[z[d]&&e.jsx("img",{src:z[d],alt:t.name,className:"h-10 w-10 object-cover rounded border border-gray-200"}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"truncate font-medium text-gray-700",children:t.name}),e.jsxs("span",{className:"text-xs text-gray-500",children:[(t.size/1024).toFixed(1)," KB"]})]})]}),e.jsx("button",{type:"button",onClick:C=>{C.stopPropagation(),ve(d)},className:"p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors",children:e.jsx(_e,{className:"h-4 w-4"})})]},d))}),x&&e.jsxs("div",{className:"text-xs text-blue-600 flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-2 border-blue-600 border-t-transparent"}),r("common.uploading")||"正在上传..."," ",R.total>0?`${R.done}/${R.total}`:""]}),_&&e.jsxs("p",{className:"text-xs text-red-600 flex items-center gap-1",children:[e.jsx(Y,{className:"h-3 w-3"}),_]})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(O,{type:"submit",className:"flex-1",loading:F||x,disabled:F||x||!b,children:F||x?r("activities.form.submitting")||"提交中...":r("activities.form.submit")}),e.jsx(O,{type:"button",variant:"outline",onClick:()=>window.location.reload(),children:r("common.reset")})]}),e.jsxs(ae,{variant:"info",children:[e.jsx(Y,{className:"h-4 w-4"}),e.jsx(re,{children:r("activities.form.submitHint")})]})]})})]})]}),e.jsx("div",{className:"hidden md:block md:col-span-4",children:e.jsx("div",{className:"sticky top-20 space-y-4",children:ne||e.jsxs($,{className:"border-dashed",children:[e.jsxs(W,{className:"pb-3",children:[e.jsx(V,{className:"text-sm text-gray-600",children:r("activities.form.calculationResult")}),e.jsx(X,{className:"text-xs",children:r("activities.form.enterDataToPreview")||"输入数值后出现"})]}),e.jsx(T,{className:"text-xs text-gray-400",children:r("activities.form.previewPlaceholder")||"填写数据以查看实时计算"})]})})})]})}function Me({onSuggestion:a}){const{t:m}=Z(),[o,k]=n.useState(""),[F,A]=n.useState(!1),[r,v]=n.useState(""),N=async D=>{var _,S;if(D.preventDefault(),!!o.trim()){A(!0),v("");try{const x=await K.suggestActivity(o);x.data.success?(a(x.data.prediction),k("")):v(x.data.error||"Failed to analyze input")}catch(x){v(((S=(_=x.response)==null?void 0:_.data)==null?void 0:S.error)||x.message||"Error communicating with AI assistant")}finally{A(!1)}}};return e.jsx($,{className:"bg-gradient-to-r from-green-50 to-blue-50 border-green-100 mb-8",children:e.jsxs(T,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4 text-green-800",children:[e.jsx(oe,{className:"h-5 w-5"}),e.jsx("h3",{className:"font-semibold",children:m("activities.smartAdd.title")||"Smart Add Activity"})]}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Le,{value:o,onChange:D=>k(D.target.value),placeholder:m("activities.smartAdd.placeholder")||"Describe your activity, e.g., 'I took a 5km bus ride'",className:"min-h-[80px] pr-12 bg-white/80 backdrop-blur-sm focus:bg-white transition-all",maxLength:500}),e.jsxs("div",{className:"absolute bottom-3 right-3 text-xs text-gray-400",children:[o.length,"/500"]})]}),r&&e.jsx(ae,{variant:"destructive",className:"py-2",children:e.jsx(re,{className:"text-xs",children:r})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(O,{type:"submit",disabled:!o.trim()||F,className:"bg-green-600 hover:bg-green-700 text-white shadow-md hover:shadow-lg transition-all",children:F?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"mr-2 h-4 w-4 animate-spin"}),m("common.processing")||"Analyzing..."]}):e.jsxs(e.Fragment,{children:[m("activities.smartAdd.button")||"Magic Fill",e.jsx(oe,{className:"ml-2 h-4 w-4"})]})})})]})]})})}function Oe(){const{t:a}=Z(),[m,o]=n.useState(1),[k,F]=n.useState([]),[A,r]=n.useState(!1),[v,N]=n.useState(null),[D,_]=n.useState(null),[S,x]=n.useState(null),[U,E]=n.useState(!1),[q,z]=n.useState(!1),[I,R]=n.useState(null),[P,b]=n.useState("");Ce.useEffect(()=>{(async()=>{var i,u;try{r(!0);const c=await K.getActivities();if((i=c==null?void 0:c.data)!=null&&i.success){const j=(u=c==null?void 0:c.data)==null?void 0:u.data,B=Array.isArray(j==null?void 0:j.activities)?j.activities:Array.isArray(j)?j:[];F(B)}}catch(c){console.error("Failed to fetch activities for smart matching",c)}finally{r(!1)}})()},[]);const M=l=>{if(!l||!l.activity_name)return;const i=l.activity_name.toLowerCase(),u=k.find(c=>c.name_en&&c.name_en.toLowerCase()===i||c.name_zh&&c.name_zh.toLowerCase()===i||c.name&&c.name.toLowerCase()===i);u?(N(u),_({amount:l.amount,description:l.description}),o(2),b("")):b(a("activities.smartAdd.notFound")||`Could not find activity type: ${l.activity_name}`)},s=[{id:1,title:a("activities.form.selectActivity"),description:a("activities.form.selectActivityDesc")},{id:2,title:a("activities.form.dataInput"),description:a("activities.form.dataInputDesc")},{id:3,title:a("activities.form.submit"),description:a("activities.form.submitDesc")}],h=l=>{N(l),x(null),b(""),o(2)},y=n.useCallback(async l=>{if(v){E(!0),b("");try{const i=v.id||v.uuid,u=await K.calculate(i,l);u.data.success?x(u.data.data):b(u.data.message||a("activities.form.calculationFailed"))}catch(i){const u=(i==null?void 0:i.message)||"";if((i==null?void 0:i.code)==="ERR_CANCELED"||/aborted|canceled/i.test(u))return;b(u||a("activities.form.calculationFailed"))}finally{E(!1)}}},[v,a]),g=async l=>{z(!0),b("");try{const i=await K.recordActivity({...l});if(i.data.success){const u=i.data.calculation||{};R({carbon_saved:u.carbon_saved||0,points_earned:u.points_earned||0,record_id:i.data.record_id}),o(3)}else b(i.data.message||a("activities.form.submitFailed"))}catch(i){b(i.message||a("activities.form.submitFailed"))}finally{z(!1)}},f=()=>{o(1),N(null),x(null),R(null),b("")},w=()=>{m>1&&(o(m-1),b(""))};return e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4",children:e.jsx(H,{className:"w-8 h-8 text-green-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:a("activities.title")}),e.jsx("p",{className:"text-gray-600",children:a("activities.description")})]}),e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-between",children:s.map((l,i)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-10 h-10 rounded-full border-2 ${m>=l.id?"bg-green-600 border-green-600 text-white":"border-gray-300 text-gray-500"}`,children:m>l.id?e.jsx(me,{className:"w-6 h-6"}):e.jsx("span",{className:"text-sm font-medium",children:l.id})}),e.jsxs("div",{className:"ml-3 hidden sm:block",children:[e.jsx("div",{className:`text-sm font-medium ${m>=l.id?"text-green-600":"text-gray-500"}`,children:l.title}),e.jsx("div",{className:"text-xs text-gray-500",children:l.description})]}),i<s.length-1&&e.jsx("div",{className:`flex-1 h-0.5 mx-4 ${m>l.id?"bg-green-600":"bg-gray-300"}`})]},l.id))})}),P&&e.jsx(ae,{variant:"destructive",className:"mb-6",children:e.jsx(re,{children:P})}),e.jsxs("div",{className:"space-y-6",children:[m===1&&e.jsxs(e.Fragment,{children:[e.jsx(Me,{onSuggestion:M}),e.jsx(Te,{onActivitySelect:h,selectedActivity:v})]}),m===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(O,{variant:"outline",onClick:w,className:"flex items-center gap-2",children:[e.jsx(ze,{className:"w-4 h-4"}),a("common.back")]}),e.jsx("div",{className:"text-sm text-gray-600",children:a("activities.form.step2Of3")})]}),e.jsx(Ue,{activity:v,onCalculate:y,onSubmit:g,calculationResult:S,isCalculating:U,isSubmitting:q,initialData:D})]}),m===3&&I&&e.jsxs($,{className:"bg-green-50 border-green-200",children:[e.jsxs(W,{className:"text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4 mx-auto",children:e.jsx(me,{className:"w-8 h-8 text-green-600"})}),e.jsx(V,{className:"text-green-800",children:a("activities.form.submitSuccess")}),e.jsx(X,{children:a("activities.form.submitSuccessDesc")})]}),e.jsxs(T,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:(()=>{const l=I.carbon_saved,i=typeof l=="number"?l:Number(l);return Number.isFinite(i)?i.toFixed(2):"0.00"})()}),e.jsxs("div",{className:"text-sm text-gray-600",children:[a("activities.carbonSaved")," (kg CO₂)"]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:I.points_earned||0}),e.jsx("div",{className:"text-sm text-gray-600",children:a("activities.pointsEarned")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:a("activities.status.pending")}),e.jsx("div",{className:"text-sm text-gray-600",children:a("activities.currentStatus")})]})]}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:a("activities.form.reviewNotice")}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx(O,{onClick:f,children:a("activities.form.recordAnother")}),e.jsx(O,{variant:"outline",onClick:()=>window.location.href="/dashboard",children:a("activities.form.goToDashboard")})]})]})]})]})]})]})}function Ye(){return e.jsx(Oe,{})}export{Ye as default};
