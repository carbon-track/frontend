import{c as _e,u as Xe,Z as Ye,r as l,t as Ze,F as C,ai as b,A as fe,D as Z,b as Je,j as e,y as Ke,I as J,w as A,U as We,B as x,m as es,N as K,O as W,Q as ee,T as se,V as ae,Y as je,aj as be,o as ss,G as te,n as j}from"./index-B5y9YgJx.js";import{u as re}from"./useMutation-DQLZQ408.js";import{A as as,b as ts,a as rs}from"./Alert-mrb6hanN.js";import{P as ns}from"./Pagination-CmYxg5F9.js";import{C as ye}from"./checkbox-CfxIg9Gg.js";import{S as is}from"./switch-DpyWcf_d.js";import{A as ds,a as ls,b as os,c as cs,d as ms,e as us,f as xs,g as ps}from"./alert-dialog-C7YNdYJT.js";import{L as w}from"./label-Drgh29-T.js";import{T as ve}from"./textarea-pBOXMTR7.js";import{B as gs}from"./BadgeBulkAwardDialog-BPCrGDHR.js";import{C as hs}from"./calendar-days-C6-OPc_O.js";import{C as fs}from"./circle-plus-Cfi-Daeo.js";import{E as js}from"./eye-CHCw7nTk.js";import{S as bs}from"./shield-D96tRX_4.js";import{T as ys}from"./trash-2-B-ZNlwnB.js";import{C as vs}from"./circle-check-big-CoCbPBPh.js";import{C as Ns}from"./circle-x-nR9ikam2.js";import"./index-KU4Tvt3e.js";import"./scroll-area-BSa3iENI.js";import"./index-BdQq_4o_.js";import"./user-plus-DN8xHR97.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ws=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]],_s=_e("ban",ws);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ks=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],Ss=_e("clipboard-list",ks),Cs={search:"",role:"",status:"",page:1,limit:10,sort:"created_at_desc"},ne=(a={})=>({...a,is_admin:a.is_admin===!0||a.is_admin===1||a.is_admin==="1"}),ke=(a={})=>({...a,id:a.id,badge:a.badge||{}}),As=(a={})=>ke(a),Ne=(a={})=>({total_points_earned:Number(a.total_points_earned??0),total_points_balance:Number(a.total_points_balance??0),total_carbon_saved:Number(a.total_carbon_saved??0),total_records:Number(a.total_records??0),total_approved_records:Number(a.total_approved_records??0)}),we=(a={})=>({awarded:Number(a.awarded??0),revoked:Number(a.revoked??0),total:Number(a.total??Number(a.awarded??0)+Number(a.revoked??0))});function Ds(a){var y;const g=((y=a==null?void 0:a.data)==null?void 0:y.data)||(a==null?void 0:a.data)||{};if(Array.isArray(g.users))return{users:g.users.map(ne),pagination:g.pagination||{}};const o=g.data||{};return{users:Array.isArray(o.users)?o.users.map(ne):[],pagination:o.pagination||{}}}function Us(){var ge;const{t:a}=Xe(),g=Ye(),[o,ie]=l.useState(Cs),[y,D]=Ze(),M=l.useRef(null),[i,de]=l.useState({open:!1,type:null,user:null,payload:null}),[h,U]=l.useState({open:!1,user:null,delta:"",reason:""}),[_,T]=l.useState(new Map),[le,E]=l.useState({open:!1,presetUsers:[]}),[c,L]=l.useState({open:!1,userId:null}),[R,k]=l.useState(!1),[u,S]=l.useState({open:!1,user:null,notes:"",groupId:"",quotaFlat:{}}),{data:z}=C("adminUserGroups",()=>b.getUserGroups().then(s=>{var t;return((t=s.data)==null?void 0:t.data)||[]})),oe=l.useMemo(()=>{const s={page:o.page,limit:o.limit,sort:o.sort},t=o.search.trim();return t&&(s.q=t),o.status&&(s.status=o.status),o.role==="admin"?s.is_admin=1:o.role==="user"&&(s.is_admin=0),s},[o]),v=C(["adminUsers",oe],()=>b.getUsers(oe),{keepPreviousData:!0}),I=C(["adminBadges","forAwarding"],()=>b.getBadges({limit:200}),{staleTime:6e4}),O=C(["adminUserOverview",c.userId],()=>b.getUserOverview(c.userId).then(s=>{var t;return(t=s.data)==null?void 0:t.data}),{enabled:c.open&&!!c.userId,select:s=>{if(!s)return null;const t=Ne(s.metrics||{}),r=we(s.badge_summary||{}),d=Array.isArray(s.recent_badges)?s.recent_badges.map(As):[];return{...s,metrics:t,badge_summary:r,recent_badges:d}}}),q=C(["adminUserBadges",c.userId,R],()=>b.getUserBadges(c.userId,{include_revoked:R}).then(s=>{var t;return(t=s.data)==null?void 0:t.data}),{enabled:c.open&&!!c.userId,select:s=>{if(!s)return null;const t=we(s.summary||{}),r=Ne(s.metrics||{}),d=Array.isArray(s.badges)?s.badges.map(ke):[];return{...s,summary:t,metrics:r,badges:d}}}),B=re(({id:s,data:t})=>b.updateUser(s,t),{onSuccess:()=>{g.invalidateQueries("adminUsers"),j.success(a("admin.users.updateSuccess"))},onError:()=>{j.error(a("admin.users.updateFailed"))}}),Se=re(s=>b.deleteUser(s),{onSuccess:()=>{g.invalidateQueries("adminUsers"),j.success(a("admin.users.deleteSuccess"))},onError:()=>{j.error(a("admin.users.deleteFailed"))}}),Q=re(({id:s,data:t})=>b.adjustUserPoints(s,t),{onSuccess:()=>{g.invalidateQueries("adminUsers"),j.success(a("admin.users.adjustSuccess"))},onError:()=>{j.error(a("admin.users.adjustFailed"))}});l.useEffect(()=>{y.get("focus")==="search"&&M.current&&(M.current.focus(),D(s=>{const t=new URLSearchParams(s);return t.delete("focus"),t},{replace:!0}))},[y,D]),l.useEffect(()=>{const s=y.get("userId");if(!s)return;const t=()=>{D(d=>{const he=new URLSearchParams(d);return he.delete("userId"),he},{replace:!0})},r=Number(s);if(!Number.isInteger(r)||r<=0){t();return}(!c.open||c.userId!==r)&&(L({open:!0,userId:r}),k(!1)),t()},[y,c.open,c.userId,D,k]);const{users:f,pagination:P}=l.useMemo(()=>Ds(v.data),[v.data]),Ce=v.isLoading&&!v.data,Ae=v.isFetching&&!!v.data,De=l.useMemo(()=>c.userId&&f.find(s=>s.id===c.userId)||null,[c.userId,f]),m=O.data||null,p=q.data||null,ce=Array.isArray(p==null?void 0:p.badges)?p.badges:Array.isArray(p==null?void 0:p.items)?p.items:[],H=(p==null?void 0:p.summary)||(m==null?void 0:m.badge_summary)||{awarded:0,revoked:0,total:0},Ue=l.useMemo(()=>m!=null&&m.user?ne(m.user):null,[m]),n=De??Ue,Ie=l.useMemo(()=>{if(!m&&!n)return[];const s=(m==null?void 0:m.metrics)||{};return[{key:"balance",label:a("admin.users.detail.pointsBalance","积分余额"),value:(n==null?void 0:n.points)??0,icon:fe},{key:"earned",label:a("admin.users.detail.pointsEarned","累计积分"),value:s.total_points_earned??0,icon:Z},{key:"carbon",label:a("admin.users.detail.carbonSaved","累计碳减排 (kg)"),value:s.total_carbon_saved??0,icon:Je},{key:"records",label:a("admin.users.detail.recordsApproved","审核通过记录"),value:s.total_approved_records??0,icon:Ss},{key:"days",label:a("admin.users.detail.daysSinceRegistration","注册天数"),value:(n==null?void 0:n.days_since_registration)??s.days_since_registration??0,icon:hs}]},[m,n,a]),G=l.useMemo(()=>Array.from(_.values()),[_]),V=l.useMemo(()=>{var t,r,d;const s=((r=(t=I.data)==null?void 0:t.data)==null?void 0:r.data)||((d=I.data)==null?void 0:d.data)||[];return Array.isArray(s)?s:[]},[I.data]),me=f.length>0&&f.every(s=>_.has(s.id)),Be=f.some(s=>_.has(s.id))&&!me,F=(s,t)=>{ie(r=>({...r,[s]:t,page:s==="page"?t:1}))},Pe=s=>{F("page",s)},Fe=(s,t)=>{T(r=>{const d=new Map(r);return t?d.set(s.id,s):d.delete(s.id),d})},Me=s=>{T(t=>{const r=new Map(t);return s?f.forEach(d=>r.set(d.id,d)):f.forEach(d=>r.delete(d.id)),r})},Te=s=>{const t=s.status!=="active";$({type:"status",user:s,payload:{nextStatus:t?"active":"inactive"}})},Ee=s=>{const t=!s.is_admin;$({type:"role",user:s,payload:{makeAdmin:t}})},Le=s=>{$({type:"delete",user:s,payload:null})},Re=s=>{s&&(L({open:!0,userId:s.id}),k(!1))},ze=()=>{L({open:!1,userId:null}),k(!1)},$=s=>{de({open:!0,...s})},N=()=>{de({open:!1,type:null,user:null,payload:null})},Oe=()=>{if(!i.user||!i.type){N();return}if(i.type==="status"){const s=i.payload.nextStatus;B.mutate({id:i.user.id,data:{status:s}},{onSettled:N})}else if(i.type==="role"){const s=i.payload.makeAdmin;B.mutate({id:i.user.id,data:{is_admin:s}},{onSettled:N})}else i.type==="delete"?Se.mutate(i.user.id,{onSettled:N}):N()},qe=s=>{U({open:!0,user:s,delta:"",reason:""})},X=()=>{U({open:!1,user:null,delta:"",reason:""})},Qe=()=>{if(!h.user)return;const s=Number(h.delta);if(!Number.isFinite(s)||s===0){j.error(a("admin.users.invalidDelta"));return}Q.mutate({id:h.user.id,data:{delta:s,reason:h.reason}},{onSettled:X})},He=s=>{S({open:!0,user:s,groupId:s.group_id||"",notes:s.admin_notes||"",quotaFlat:s.quota_flat||{}})},Y=()=>{S({open:!1,user:null,notes:"",groupId:"",quotaFlat:{}})},Ge=(s,t)=>{S(r=>({...r,quotaFlat:{...r.quotaFlat,[s]:t}}))},Ve=s=>{if(s.preventDefault(),!u.user)return;const t={group_id:u.groupId||"",admin_notes:u.notes,quota_flat:u.quotaFlat};B.mutate({id:u.user.id,data:t},{onSuccess:()=>{Y(),j.success(a("admin.users.updateSuccess"))}})},ue=s=>{if(!s||s.length===0){j.error(a("admin.users.selectUserHint","请先选择用户"));return}E({open:!0,presetUsers:s})},$e=()=>{T(new Map)},xe=s=>!s||!s.status?e.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600",children:a("common.unknown","未知")}):e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",children:s.status==="active"?e.jsxs("span",{className:"bg-green-100 text-green-800 flex items-center gap-1 px-2 py-0.5 rounded-full",children:[e.jsx(vs,{className:"h-3 w-3"}),a("admin.users.statusActive")]}):e.jsxs("span",{className:"bg-red-100 text-red-800 flex items-center gap-1 px-2 py-0.5 rounded-full",children:[e.jsx(Ns,{className:"h-3 w-3"}),a("admin.users.statusInactive")]})}),pe=s=>s?e.jsx(te,{variant:s.is_admin?"default":"outline",children:s.is_admin?a("admin.users.roleAdmin"):a("admin.users.roleUser")}):e.jsx(te,{variant:"outline",children:a("common.unknown","未知")});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:a("admin.users.title")}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.users.description")})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("common.search")}),e.jsxs("div",{className:"relative",children:[e.jsx(Ke,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(J,{ref:M,type:"text",value:o.search,onChange:s=>F("search",s.target.value),placeholder:a("admin.users.searchPlaceholder"),className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.users.role")}),e.jsxs("select",{value:o.role,onChange:s=>F("role",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:a("common.all")}),e.jsx("option",{value:"user",children:a("admin.users.roleUser")}),e.jsx("option",{value:"admin",children:a("admin.users.roleAdmin")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.users.status")}),e.jsxs("select",{value:o.status,onChange:s=>F("status",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:a("common.all")}),e.jsx("option",{value:"active",children:a("admin.users.statusActive")}),e.jsx("option",{value:"inactive",children:a("admin.users.statusInactive")})]})]})]}),Ae&&e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-muted-foreground",children:[e.jsx(A,{className:"h-3.5 w-3.5 animate-spin"}),a("admin.users.refreshing")]}),G.length>0&&e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 rounded-md border border-dashed bg-muted/60 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:a("admin.users.selectedCount","已选择 {{count}} 位用户",{count:G.length})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>ue(G),disabled:I.isLoading||V.length===0,children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),a("admin.users.bulkAwardBadges","批量授予徽章")]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:$e,children:a("common.clear","清空")})]})]})]}),Ce?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(A,{className:"h-8 w-8 animate-spin text-green-500"})}):v.error?e.jsxs(as,{variant:"destructive",children:[e.jsx(ts,{children:a("common.error")}),e.jsx(rs,{children:a("errors.loadFailed")})]}):f.length===0?e.jsxs("div",{className:"text-center py-16 bg-white rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"text-xl font-semibold",children:a("admin.users.noUsersFound")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:a("admin.users.tryDifferentFilters")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto bg-white rounded-lg shadow-sm border",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsx(ye,{checked:me?!0:Be?"indeterminate":!1,onCheckedChange:s=>Me(s===!0||s==="indeterminate"),"aria-label":a("admin.users.selectAll","选择当前页所有用户"),className:"translate-y-0.5"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.username")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.email")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.groups.title","用户组")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.role")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.status")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.badges","徽章")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.carbon","碳减排")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.points")}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:f.map(s=>{const t=_.has(s.id);return e.jsxs("tr",{className:t?"bg-emerald-50/40":"",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx(ye,{checked:t,onCheckedChange:r=>Fe(s,r===!0||r==="indeterminate"),"aria-label":a("admin.users.selectUser","选择用户 {{username}}",{username:s.username})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:s.username}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.email}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.group_name||"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:pe(s)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:xe(s)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:a("admin.users.badgesAwardedCount","{{count}} 枚",{count:s.badges_awarded||0})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a("admin.users.activeBadgesCount","激活 {{count}}",{count:s.active_badges||0})})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:Number(s.total_carbon_saved||0).toLocaleString(void 0,{maximumFractionDigits:2})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.points}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",onClick:()=>Te(s),title:a("admin.users.toggleStatusButton","切换用户状态"),children:[e.jsx(_s,{className:"h-4 w-4 mr-1"}),s.status==="active"?a("admin.users.disable"):a("admin.users.enable")]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>qe(s),title:a("admin.users.promptAdjustPoints",{username:s.username}),children:e.jsx(fs,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>Re(s),title:a("admin.users.viewDetailsButton","查看详情"),children:e.jsx(js,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>He(s),title:a("admin.users.editUser","编辑配置"),children:e.jsx(es,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>Ee(s),title:a("admin.users.toggleAdminButton","切换管理员权限"),children:e.jsx(bs,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>ue([s]),title:a("admin.users.awardBadgeButton","授予徽章"),disabled:V.length===0,children:e.jsx(Z,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>Le(s),className:"text-red-600 hover:text-red-800",title:a("admin.users.deleteButton","删除用户"),children:e.jsx(ys,{className:"h-4 w-4"})})]})]},s.id)})})]})}),e.jsx(ns,{currentPage:P.current_page,totalPages:P.total_pages,onPageChange:Pe,itemsPerPage:P.per_page,totalItems:P.total_items})]}),e.jsx(ds,{open:i.open,onOpenChange:s=>s?null:N(),children:e.jsxs(ls,{children:[e.jsxs(os,{children:[e.jsxs(cs,{children:[i.type==="status"&&a("admin.users.confirmToggleStatusTitle","确认修改状态"),i.type==="role"&&a("admin.users.confirmToggleAdminTitle","确认切换角色"),i.type==="delete"&&a("admin.users.confirmDeleteTitle","确认删除用户")]}),e.jsxs(ms,{children:[i.type==="status"&&i.user&&a("admin.users.confirmToggleStatus",{username:i.user.username,to:i.payload.nextStatus==="active"?a("admin.users.statusActive"):a("admin.users.statusInactive")}),i.type==="role"&&i.user&&a("admin.users.confirmToggleAdmin",{username:i.user.username}),i.type==="delete"&&i.user&&a("admin.users.confirmDelete",{username:i.user.username})]})]}),e.jsxs(us,{children:[e.jsx(xs,{onClick:N,children:a("common.cancel","取消")}),e.jsx(ps,{onClick:Oe,children:a("common.confirm","确认")})]})]})}),e.jsx(K,{open:h.open,onOpenChange:s=>s?null:X(),children:e.jsxs(W,{className:"max-w-md",children:[e.jsxs(ee,{children:[e.jsx(se,{children:a("admin.users.adjustPointsTitle","调整积分")}),e.jsx(ae,{children:h.user?a("admin.users.adjustPointsDescription",{username:h.user.username}):""})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"points-delta",children:a("admin.users.adjustPointsDelta","积分变动值")}),e.jsx(J,{id:"points-delta",type:"number",value:h.delta,onChange:s=>U(t=>({...t,delta:s.target.value})),placeholder:"100"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.users.adjustPointsHint","输入正数表示增加积分，负数表示扣减积分")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"points-reason",children:a("admin.users.adjustPointsReason","调整说明")}),e.jsx(ve,{id:"points-reason",rows:3,value:h.reason,onChange:s=>U(t=>({...t,reason:s.target.value})),placeholder:a("admin.users.adjustPointsReasonPlaceholder","请输入调整原因，便于审计记录")})]})]}),e.jsxs(je,{children:[e.jsx(x,{variant:"ghost",onClick:X,children:a("common.cancel","取消")}),e.jsxs(x,{onClick:Qe,disabled:Q.isLoading,children:[Q.isLoading&&e.jsx(A,{className:"mr-2 h-4 w-4 animate-spin"}),a("common.confirm","确认")]})]})]})}),e.jsx(K,{open:u.open,onOpenChange:s=>s?null:Y(),children:e.jsxs(W,{className:"max-w-lg",children:[e.jsxs(ee,{children:[e.jsx(se,{children:a("admin.users.editUser","编辑用户配置")}),e.jsx(ae,{children:(ge=u.user)==null?void 0:ge.username})]}),e.jsxs("form",{onSubmit:Ve,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(w,{children:a("admin.groups.title","用户组")}),e.jsxs("select",{className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:u.groupId,onChange:s=>S({...u,groupId:s.target.value}),children:[e.jsx("option",{value:"",children:a("common.none","无")}),z==null?void 0:z.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"space-y-3 border-t pt-3 border-b pb-3",children:[e.jsx(w,{className:"text-base font-semibold",children:a("admin.groups.quotaOverride","配额单独设置")}),Object.keys(u.quotaFlat||{}).length>0?Object.entries(u.quotaFlat).map(([s,t])=>e.jsxs("div",{children:[e.jsx(w,{className:"capitalize",children:a(`admin.quotas.${s}`,s.replace("."," "))}),e.jsx(J,{type:"number",value:t??"",onChange:r=>Ge(s,r.target.value),placeholder:a("common.default","默认")})]},s)):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.groups.noQuotasAvailable","暂无可配置的配额项目")})]}),e.jsxs("div",{children:[e.jsx(w,{children:a("admin.groups.notes","备注")}),e.jsx(ve,{value:u.notes,onChange:s=>S({...u,notes:s.target.value})})]}),e.jsxs(je,{children:[e.jsx(x,{type:"button",variant:"ghost",onClick:Y,children:a("common.cancel")}),e.jsx(x,{type:"submit",disabled:B.isLoading,children:a("common.save")})]})]})]})}),e.jsx(K,{open:c.open,onOpenChange:s=>s?null:ze(),children:e.jsxs(W,{className:"max-w-4xl",children:[e.jsxs(ee,{children:[e.jsx(se,{children:n?a("admin.users.detailTitle","用户详情：{{username}}",{username:n.username}):a("admin.users.detailTitleFallback","用户详情")}),e.jsx(ae,{children:(n==null?void 0:n.email)||""})]}),O.isLoading?e.jsxs("div",{className:"flex items-center justify-center py-8 text-sm text-muted-foreground",children:[e.jsx(A,{className:"mr-2 h-4 w-4 animate-spin"}),a("common.loading","加载中...")]}):O.error?e.jsx("p",{className:"text-sm text-destructive",children:a("admin.users.detailLoadFailed","无法加载用户详情")}):m?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.username","用户名")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:n==null?void 0:n.username})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.role","角色")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:pe(n)})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.status","状态")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:xe(n)})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.registrationDays","注册天数")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:(n==null?void 0:n.days_since_registration)??0})]}),(n==null?void 0:n.lastlgn)&&e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm sm:col-span-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.lastLogin","最近登录")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:be(new Date(n.lastlgn),"yyyy-MM-dd HH:mm")})]})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:Ie.map(s=>{const t=s.icon;return e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:s.label}),e.jsx(t,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:Number(s.value||0).toLocaleString(void 0,{maximumFractionDigits:2})})]},s.key)})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-base font-semibold",children:a("admin.users.badgeSummary","徽章概况")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.users.badgeSummaryHint","展示授予和回收的徽章统计")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(is,{checked:R,onCheckedChange:s=>k(!!s)}),e.jsx("span",{children:a("admin.users.showRevokedBadges","显示已收回的徽章")})]})]}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:a("admin.users.badgesAwarded","授予")}),e.jsx("p",{className:"mt-2 text-2xl font-semibold",children:H.awarded})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:a("admin.users.badgesRevoked","收回")}),e.jsx("p",{className:"mt-2 text-2xl font-semibold",children:H.revoked})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:a("admin.users.badgesTotal","总数")}),e.jsx("p",{className:"mt-2 text-2xl font-semibold",children:H.total})]})]}),q.isLoading?e.jsxs("div",{className:"flex items-center justify-center py-6 text-sm text-muted-foreground",children:[e.jsx(A,{className:"mr-2 h-4 w-4 animate-spin"}),a("common.loading","加载中...")]}):q.error?e.jsx("p",{className:"text-sm text-destructive",children:a("admin.users.badgesLoadFailed","无法加载徽章列表")}):ce.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500",children:a("admin.users.badgeTable.badge","徽章")}),e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500",children:a("admin.users.badgeTable.status","状态")}),e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500",children:a("admin.users.badgeTable.awardedAt","授予时间")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:ce.map((s,t)=>{const r=s.badge||{},d=s.user_badge||{};return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full border bg-muted",children:r.icon_url||r.icon_presigned_url||r.icon_path?e.jsx(ss,{src:r.icon_presigned_url||r.icon_url,filePath:!r.icon_presigned_url&&!r.icon_url?r.icon_path:void 0,alt:r.name_zh||r.name_en,className:"h-full w-full object-cover"}):e.jsx(fe,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:r.name_zh||r.name_en||"-"}),r.name_en&&e.jsx("p",{className:"text-xs text-muted-foreground",children:r.name_en})]})]})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx(te,{variant:d.status==="awarded"?"success":"secondary",children:d.status==="awarded"?a("admin.users.badgeStatusAwarded","已授予"):a("admin.users.badgeStatusRevoked","已收回")})}),e.jsx("td",{className:"px-4 py-2 text-sm text-muted-foreground",children:d.awarded_at?be(new Date(d.awarded_at),"yyyy-MM-dd HH:mm"):"--"})]},t)})})]})}):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.users.badgesEmpty","暂无徽章记录")})]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.users.detailEmpty","暂无详情数据")})]})}),e.jsx(gs,{open:le.open,onOpenChange:s=>s?null:E({open:!1,presetUsers:[]}),badges:V,defaultSelectedBadgeIds:[],presetUsers:le.presetUsers,onCompleted:()=>{E({open:!1,presetUsers:[]}),g.invalidateQueries("adminUsers")},mode:"award"})]})}function Ks(){return e.jsx(Us,{})}export{Ks as default};
