import{j as e}from"./motion-vendor-C11-9Hm-.js";import{h as D,r as o}from"./react-vendor-CFnAvB5y.js";import{u as M,O as v,s as N,I as U,B as C,aa as B}from"./index-CQ91Xfn2.js";import{C as L,a as O,b as Q,c as $,d as H}from"./Card-CvB_sIzW.js";import{A as w,a as I}from"./Alert-B9j1D3yi.js";import"./i18n-vendor-DK0x1_bH.js";import"./charts-vendor-DJkHj7pX.js";const R=(l,t=300)=>{let c;return(...h)=>{clearTimeout(c),c=setTimeout(()=>l(...h),t)}};function X(){const l=D(),{t}=M(),c=v.getUser(),[h,k]=o.useState([]),[d,A]=o.useState(""),[x,E]=o.useState(""),[f,p]=o.useState(!1),[b,u]=o.useState(""),[S,j]=o.useState("");o.useEffect(()=>{if(c!=null&&c.school_id){l("/dashboard",{replace:!0});return}y("")},[]);const y=async s=>{var i,r;try{const a=((r=(i=(await N.getSchools({search:s,limit:20,page:1})).data)==null?void 0:i.data)==null?void 0:r.schools)||[];k(a)}catch(n){console.error("Load schools failed:",n)}},P=o.useMemo(()=>R(y,300),[]);o.useEffect(()=>{P(d.trim())},[d]);const T=async s=>{var r,n,a;return s?/^\d+$/.test(String(s))?parseInt(String(s),10):((a=(n=(r=(await N.createOrFetchSchool({name:s})).data)==null?void 0:r.data)==null?void 0:n.school)==null?void 0:a.id)||null:null},F=async s=>{var i,r,n;s.preventDefault(),p(!0),u(""),j("");try{let a=x;!a&&d&&(a=await T(d));const m={};if(a&&(m.school_id=parseInt(a,10)),Object.keys(m).length===0){u(t("onboarding.leastOneField")),p(!1);return}const g=await B.updateProfile(m);if((i=g.data)!=null&&i.success){const _=(r=g.data)!=null&&r.data?g.data.data:{...c||{},...m};v.setUser(_);try{sessionStorage.removeItem("onboarding_skipped")}catch{}j(t("onboarding.saved")),setTimeout(()=>l("/dashboard",{replace:!0}),800)}else u(((n=g.data)==null?void 0:n.message)||t("common.error"))}catch(a){u((a==null?void 0:a.message)||t("common.error"))}finally{p(!1)}};return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-lg w-full space-y-6",children:e.jsxs(L,{children:[e.jsxs(O,{children:[e.jsx(Q,{children:t("onboarding.title")}),e.jsx($,{children:t("onboarding.subtitle")})]}),e.jsxs(H,{children:[b&&e.jsx(w,{variant:"destructive",className:"mb-4",children:e.jsx(I,{children:b})}),S&&e.jsx(w,{variant:"success",className:"mb-4",children:e.jsx(I,{children:S})}),e.jsxs("form",{onSubmit:F,className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"schoolSearch",className:"block text-sm font-medium text-gray-700 mb-1",children:t("auth.school")}),e.jsx(U,{id:"schoolSearch",placeholder:t("onboarding.schoolPlaceholder"),value:d,onChange:s=>A(s.target.value)}),e.jsxs("div",{className:"mt-2 max-h-40 overflow-auto border rounded",children:[h.map(s=>e.jsx("button",{type:"button",className:`w-full text-left px-3 py-2 hover:bg-gray-50 ${String(x)===String(s.id)?"bg-green-50":""}`,onClick:()=>E(String(s.id)),children:s.name},s.id)),h.length===0&&e.jsx("div",{className:"px-3 py-2 text-gray-500",children:t("onboarding.noSchoolMatches")})]})]}),e.jsx("div",{}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(C,{type:"submit",className:"flex-1",loading:f,disabled:f,children:t("onboarding.saveAndContinue")}),e.jsx(C,{type:"button",variant:"ghost",className:"flex-1",onClick:()=>{try{sessionStorage.setItem("onboarding_skipped","1")}catch{}l("/dashboard")},children:t("onboarding.skipForNow")})]})]})]})]})})})}export{X as default};
