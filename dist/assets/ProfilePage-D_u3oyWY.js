import{u as M,Y as G,r as d,s as xe,j as e,F as J,I as F,B as C,w as K,$ as ue,v as fe,E as se,o as te,n as D,a0 as O,a1 as pe,R as ge,C as X,a2 as je}from"./index-D6PSjNRY.js";import{A as $,a as z,b as Z}from"./Alert-BZp_vwU6.js";import{T as ve}from"./Turnstile-DUkXBG_i.js";import{u as be}from"./useMutation-BaV-PRmn.js";import{C as Ne}from"./circle-check-big-CJKIrQYk.js";import{u as ye}from"./index.esm-CYhyC0nH.js";import{C as V,a as B,b as Q,d as H}from"./Card-C4yeI-Li.js";const b="—",we=(s,t)=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:s}),e.jsx("div",{className:"rounded-md border border-dashed border-gray-200 bg-muted/40 px-3 py-2 text-sm text-gray-900",children:t??b})]},s),Se=(s,t=350)=>{const[o,n]=d.useState(s);return d.useEffect(()=>{const l=setTimeout(()=>n(s),t);return()=>clearTimeout(l)},[s,t]),o};function _e({user:s}){const{t}=M(),o=G(),n=d.useRef(null),[l,c]=d.useState(""),[a,x]=d.useState(s!=null&&s.school_id?{id:s.school_id,name:s.school_name||""}:null),[m,j]=d.useState([]),[R,A]=d.useState(!1),[P,k]=d.useState(!1),[N,i]=d.useState(""),[v,u]=d.useState(null),I=Se(l.trim(),350),p=(s==null?void 0:s.school_id)??null,g=((s==null?void 0:s.school_name)||"").trim();d.useEffect(()=>{x(p?{id:p,name:g}:null)},[p,g]),d.useEffect(()=>{let r=!1;return A(!0),xe.getSchools({search:I||void 0,limit:8,page:1}).then(h=>{var y,w;if(r)return;const L=((w=(y=h.data)==null?void 0:y.data)==null?void 0:w.schools)??[];j(L)}).catch(()=>{r||j([])}).finally(()=>{r||A(!1)}),()=>{r=!0}},[I]);const U=d.useMemo(()=>l.trim(),[l]),E=d.useMemo(()=>s?a&&a.id!==p?{school_id:a.id}:!a&&U&&U!==g?{new_school_name:U}:null:null,[p,g,a,U,s]),re=!E||P||!!E&&!N,le=d.useMemo(()=>{if(!(s!=null&&s.updated_at))return b;const r=new Date(s.updated_at);return Number.isNaN(r.getTime())?s.updated_at:r.toLocaleString()},[s==null?void 0:s.updated_at]),ne=[{label:t("profile.userId","用户ID"),value:(s==null?void 0:s.id)??b},{label:t("profile.uuid","UUID"),value:(s==null?void 0:s.uuid)||b},{label:t("profile.points","积分"),value:(s==null?void 0:s.points)??0},{label:t("profile.lastUpdated","最后更新"),value:le}],ie=[{label:t("profile.username"),value:(s==null?void 0:s.username)||b},{label:t("profile.email"),value:(s==null?void 0:s.email)||b},{label:t("profile.school"),value:g||t("profile.schoolUnset","Not set")}],oe=r=>{const{value:h}=r.target;c(h),u(null),a&&h.trim()!==(a.name||"").trim()&&x(null)},ce=r=>{x({id:r.id,name:r.name}),c(r.name||""),u(null)},de=()=>{x(null),c(""),u(null)},me=()=>{var r,h;x(p?{id:p,name:g}:null),c(""),u(null),i(""),(h=(r=n.current)==null?void 0:r.reset)==null||h.call(r)},he=async r=>{var h,L,y,w,W,T,Y;if(r.preventDefault(),!E){u({type:"error",message:t("profile.schoolNoChanges","No changes detected.")});return}k(!0),u(null);try{const q={...E,cf_turnstile_response:N||void 0},S=await ue.updateProfile(q);if(!((h=S.data)!=null&&h.success))throw new Error(((L=S.data)==null?void 0:L.message)||"Failed to update profile");const _=(y=S.data)==null?void 0:y.data;_&&(fe.setUser(_),o.invalidateQueries("currentUser"),x(_.school_id?{id:_.school_id,name:_.school_name||""}:null)),c(""),u({type:"success",message:t("profile.schoolUpdateSuccess","School updated successfully.")})}catch(q){const S=((W=(w=q.response)==null?void 0:w.data)==null?void 0:W.message)||q.message||t("profile.schoolUpdateFailed","Unable to update school information.");u({type:"error",message:S})}finally{k(!1),i(""),(Y=(T=n.current)==null?void 0:T.reset)==null||Y.call(T)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 gap-4 rounded-lg border bg-muted/40 p-4 sm:grid-cols-2",children:ne.map(r=>e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:r.label}),e.jsx("p",{className:"break-words text-sm font-medium",children:r.value})]},r.label))}),e.jsx("div",{className:"space-y-4",children:ie.map(({label:r,value:h})=>we(r,h))}),e.jsxs("section",{className:"rounded-lg border p-4",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:t("profile.schoolSectionTitle","School information")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t("profile.schoolEditDescription","Select an existing school or type a new one. New entries will be reviewed and saved after verification.")})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[t("profile.schoolCurrentLabel","Current:")," ",e.jsx(J,{variant:"secondary",children:g||t("profile.schoolUnset","Not set")})]})]}),e.jsxs("form",{className:"mt-4 space-y-4",onSubmit:he,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"schoolSearch",className:"block text-sm font-medium text-gray-700",children:t("auth.school","School")}),e.jsx(F,{id:"schoolSearch",className:"mt-2",placeholder:t("profile.schoolSearchPlaceholder","Search for a school or enter a new name"),value:l,onChange:oe}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:t("profile.schoolInputHint","Selecting an existing school keeps data consistent. Typing a new school name will create it after verification.")})]}),e.jsxs("div",{className:"rounded-md border bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-3 py-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:t("profile.schoolSuggestions","Suggestions")}),e.jsx(C,{type:"button",variant:"ghost",size:"sm",onClick:de,children:t("profile.clearSelection","Clear selection")})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:R?e.jsxs("div",{className:"flex items-center gap-2 px-3 py-3 text-sm text-muted-foreground",children:[e.jsx(K,{className:"h-4 w-4 animate-spin"}),t("profile.loadingSchools","Loading schools...")]}):m.length>0?m.map(r=>{const h=(a==null?void 0:a.id)===r.id;return e.jsxs("button",{type:"button",onClick:()=>ce(r),className:`flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-muted ${h?"bg-green-50 text-green-700":""}`,children:[e.jsx("span",{children:r.name}),h&&e.jsx(J,{variant:"outline",children:t("profile.selected","Selected")})]},r.id)}):e.jsx("div",{className:"px-3 py-3 text-sm text-muted-foreground",children:t("profile.schoolNoResults","No matching schools. Enter a new name above.")})})]}),v&&e.jsx($,{variant:v.type==="error"?"destructive":"success",children:e.jsx(z,{children:v.message})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(ve,{ref:n,className:"flex flex-col items-center",onVerify:i,onExpire:()=>i(""),onError:()=>i(""),require:!0}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:t("profile.turnstileNotice","Verification is required to prevent automated updates.")})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(C,{type:"submit",className:"flex-1",loading:P,disabled:re,children:t("profile.saveSchool","Save school")}),e.jsx(C,{type:"button",variant:"outline",className:"flex-1",onClick:me,children:t("profile.resetSchool","Reset")})]})]})]})]})}const Ce=s=>/^https?:\/\//i.test(s),ee=s=>{if(typeof s!="string")return"";const t=s.trim();return t?t.replace(/^\/+/,""):""},f=s=>typeof s!="string"?"":s.trim()||"",Ae=s=>{if(!s||typeof s!="object")return{src:"",filePath:"",alt:""};const t=[f(s.icon_presigned_url),f(s.presigned_url),f(s.avatar_presigned_url),f(s.icon_url),f(s.url),f(s.avatar_url),f(s.image_url)];let o="",n="";for(const l of t)if(l){if(Ce(l)||l.startsWith("data:")){o=l;break}n||(n=ee(l))}if(!o){const l=[f(s.file_path),f(s.icon_path),f(s.avatar_path)];for(const c of l){if(!c)continue;const a=ee(c);if(a){n=a;break}}}return{src:o,filePath:n,alt:f(s.name||s.username||s.title||"")}},ae=s=>{const{src:t,filePath:o,alt:n}=Ae(s),l=n?n.charAt(0).toUpperCase():"";return{src:t,filePath:o,alt:n,fallbackInitial:l}};function Pe({currentAvatarId:s,onAvatarChange:t}){var N;const{t:o}=M(),n=G(),[l,c]=d.useState(s),{data:a,isLoading:x,error:m}=se("avatars",()=>O.getAvatars()),j=be(i=>O.selectAvatar(i),{onSuccess:()=>{D.success(o("profile.avatarUpdateSuccess")),n.invalidateQueries("currentUser"),t(l)},onError:i=>{D.error(o("profile.avatarUpdateFailed")),console.error("Avatar update failed:",i)}}),R=((N=a==null?void 0:a.data)==null?void 0:N.data)||[],A=({avatar:i})=>{const{src:v,filePath:u,alt:I,fallbackInitial:p}=ae(i),g=e.jsx("div",{className:"w-full aspect-square flex items-center justify-center text-xs text-gray-400 bg-gray-100 rounded-md",children:p||"IMG"});return e.jsx(te,{src:v||void 0,filePath:!v&&u?u:void 0,alt:I||(i==null?void 0:i.name),className:"w-full h-auto rounded-md object-cover",fallback:g})},P=i=>{c(i)},k=()=>{l&&l!==s&&j.mutate(l)};return x?e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsx(K,{className:"h-8 w-8 animate-spin text-green-500"})}):m?e.jsx("div",{className:"text-center text-red-500",children:o("profile.avatarLoadError")}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:o("profile.selectAvatar")}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4",children:R.map(i=>e.jsxs("div",{className:`relative p-2 border-2 rounded-lg cursor-pointer
              ${l===i.id?"border-green-500":"border-gray-200 hover:border-gray-300"}`,onClick:()=>P(i.id),children:[e.jsx(A,{avatar:i}),l===i.id&&e.jsx("div",{className:"absolute top-1 right-1 bg-green-500 rounded-full p-1",children:e.jsx(Ne,{className:"h-4 w-4 text-white"})}),e.jsx("p",{className:"text-center text-sm mt-1",children:i.name})]},i.id))}),e.jsx(C,{onClick:k,disabled:l===s||j.isLoading,className:"w-full",children:j.isLoading?o("common.saving"):o("common.save")})]})}function ke(){const{t:s}=M(),{register:t,handleSubmit:o,formState:{errors:n},reset:l,watch:c}=ye(),a=async x=>{try{await pe.post("/auth/change-password",x),D.success(s("profile.passwordChangeSuccess")),l()}catch(m){D.error(s("profile.passwordChangeFailed")),console.error("Password change failed:",m)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:s("profile.changePassword")}),e.jsxs("form",{onSubmit:o(a),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:s("profile.currentPassword")}),e.jsx(F,{type:"password",...t("current_password",{required:s("validation.required")})}),n.current_password&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:n.current_password.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:s("profile.newPassword")}),e.jsx(F,{type:"password",...t("new_password",{required:s("validation.required"),minLength:{value:8,message:s("validation.minLength",{min:8})}})}),n.new_password&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:n.new_password.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:s("profile.confirmNewPassword")}),e.jsx(F,{type:"password",...t("confirm_new_password",{required:s("validation.required"),validate:x=>x===c("new_password")||s("validation.passwordMismatch")})}),n.confirm_new_password&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:n.confirm_new_password.message})]}),e.jsx(C,{type:"submit",children:s("profile.changePassword")})]})]})}function Me(){const{t:s}=M(),t=G(),{data:o,isLoading:n,error:l}=se("currentUser",()=>je.getCurrentUser(),{staleTime:1/0}),c=(o==null?void 0:o.data)??null,a=(c==null?void 0:c.data)??c??null,x=()=>{t.invalidateQueries("currentUser")},m=ge.useMemo(()=>a?ae({...a,file_path:a.avatar_url,name:a.username}):{src:"",filePath:"",alt:"",fallbackInitial:""},[a]);return n?e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(K,{className:"h-8 w-8 animate-spin text-green-500"})}):l?e.jsx("div",{className:"container mx-auto py-8 px-4",children:e.jsxs($,{variant:"destructive",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx(Z,{children:s("common.error")}),e.jsx(z,{children:s("profile.loadError")})]})}):a?e.jsxs("div",{className:"container mx-auto py-8 px-4",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"relative",children:e.jsx("div",{className:"w-24 h-24 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center text-3xl font-semibold text-gray-400",children:m.src||m.filePath?e.jsx(te,{src:m.src||void 0,filePath:!m.src&&m.filePath?m.filePath:void 0,alt:m.alt||a.username,className:"w-full h-full object-cover"}):e.jsx("span",{children:m.fallbackInitial||(a.username?a.username.charAt(0).toUpperCase():"U")})})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:a.username}),a.email&&e.jsx("p",{className:"text-sm text-gray-500",children:a.email}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm text-gray-600",children:[e.jsxs("span",{children:[s("profile.points"),": ",a.points??0]}),a.school_name&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-green-400"}),a.school_name]})]})]})]})}),e.jsx("h1",{className:"text-3xl font-bold tracking-tight mb-8",children:s("profile.title")}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs(V,{children:[e.jsx(B,{children:e.jsx(Q,{children:s("profile.basicInfo")})}),e.jsx(H,{children:e.jsx(_e,{user:a})})]}),e.jsxs(V,{children:[e.jsx(B,{children:e.jsx(Q,{children:s("profile.avatar")})}),e.jsx(H,{children:e.jsx(Pe,{currentAvatarId:a==null?void 0:a.avatar_id,onAvatarChange:x})})]}),e.jsxs(V,{className:"lg:col-span-2",children:[e.jsx(B,{children:e.jsx(Q,{children:s("profile.changePassword")})}),e.jsx(H,{children:e.jsx(ke,{})})]})]})]}):e.jsx("div",{className:"container mx-auto py-8 px-4",children:e.jsxs($,{variant:"warning",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx(Z,{children:s("common.notice","提示")}),e.jsx(z,{children:s("profile.noUserData","暂未获取到个人资料，请稍后重试。")})]})})}export{Me as default};
