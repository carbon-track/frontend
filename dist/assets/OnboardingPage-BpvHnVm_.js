import{e as D,u as M,v,r as o,s as N,j as e,I as U,B as C,$}from"./index-9oiziVwF.js";import{C as B,a as L,b as Q,c as H,d as O}from"./Card-DiZzX4G1.js";import{A as w,a as I}from"./Alert-DMTWhZOi.js";const R=(i,t=300)=>{let c;return(...h)=>{clearTimeout(c),c=setTimeout(()=>i(...h),t)}};function J(){const i=D(),{t}=M(),c=v.getUser(),[h,k]=o.useState([]),[d,A]=o.useState(""),[p,E]=o.useState(""),[b,x]=o.useState(!1),[f,u]=o.useState(""),[S,j]=o.useState("");o.useEffect(()=>{if(c!=null&&c.school_id){i("/dashboard",{replace:!0});return}y("")},[]);const y=async s=>{var l,r;try{const a=((r=(l=(await N.getSchools({search:s,limit:20,page:1})).data)==null?void 0:l.data)==null?void 0:r.schools)||[];k(a)}catch(n){console.error("Load schools failed:",n)}},P=o.useMemo(()=>R(y,300),[]);o.useEffect(()=>{P(d.trim())},[d]);const T=async s=>{var r,n,a;return s?/^\d+$/.test(String(s))?parseInt(String(s),10):((a=(n=(r=(await N.createOrFetchSchool({name:s})).data)==null?void 0:r.data)==null?void 0:n.school)==null?void 0:a.id)||null:null},F=async s=>{var l,r,n;s.preventDefault(),x(!0),u(""),j("");try{let a=p;!a&&d&&(a=await T(d));const m={};if(a&&(m.school_id=parseInt(a,10)),Object.keys(m).length===0){u(t("onboarding.leastOneField")),x(!1);return}const g=await $.updateProfile(m);if((l=g.data)!=null&&l.success){const _=(r=g.data)!=null&&r.data?g.data.data:{...c||{},...m};v.setUser(_);try{sessionStorage.removeItem("onboarding_skipped")}catch{}j(t("onboarding.saved")),setTimeout(()=>i("/dashboard",{replace:!0}),800)}else u(((n=g.data)==null?void 0:n.message)||t("common.error"))}catch(a){u((a==null?void 0:a.message)||t("common.error"))}finally{x(!1)}};return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-lg w-full space-y-6",children:e.jsxs(B,{children:[e.jsxs(L,{children:[e.jsx(Q,{children:t("onboarding.title")}),e.jsx(H,{children:t("onboarding.subtitle")})]}),e.jsxs(O,{children:[f&&e.jsx(w,{variant:"destructive",className:"mb-4",children:e.jsx(I,{children:f})}),S&&e.jsx(w,{variant:"success",className:"mb-4",children:e.jsx(I,{children:S})}),e.jsxs("form",{onSubmit:F,className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"schoolSearch",className:"block text-sm font-medium text-gray-700 mb-1",children:t("auth.school")}),e.jsx(U,{id:"schoolSearch",placeholder:t("onboarding.schoolPlaceholder"),value:d,onChange:s=>A(s.target.value)}),e.jsxs("div",{className:"mt-2 max-h-40 overflow-auto border rounded",children:[h.map(s=>e.jsx("button",{type:"button",className:`w-full text-left px-3 py-2 hover:bg-gray-50 ${String(p)===String(s.id)?"bg-green-50":""}`,onClick:()=>E(String(s.id)),children:s.name},s.id)),h.length===0&&e.jsx("div",{className:"px-3 py-2 text-gray-500",children:t("onboarding.noSchoolMatches")})]})]}),e.jsx("div",{}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(C,{type:"submit",className:"flex-1",loading:b,disabled:b,children:t("onboarding.saveAndContinue")}),e.jsx(C,{type:"button",variant:"ghost",className:"flex-1",onClick:()=>{try{sessionStorage.setItem("onboarding_skipped","1")}catch{}i("/dashboard")},children:t("onboarding.skipForNow")})]})]})]})]})})})}export{J as default};
