import{c as At,aN as Dt,r as p,aO as $t,a2 as Mt,F as nt,j as e,K as F,B as A,aB as it,aC as zt,aD as qt,ar as Ut,aV as Wt,ap as lt,aF as ct,at as me,aE as dt,aG as mt,aH as Ht,aW as Jt,aX as Bt,aY as Kt,aZ as Gt,a_ as Qt,aI as Vt,aJ as Yt,aK as Xt,a as he,u as Zt,I as R,w as es,N as ts,O as ss,Q as rs,T as as,V as os,G as Ce,X as ns}from"./index-Bx6Hir0b.js";import{s as is,J as we,f as ls,e as cs,R as ds}from"./JsonTreeViewer-CDqrw3ag.js";import{C as Y,a as ue,b as pe,c as ke,d as X,e as ms}from"./Card-NsXL1LY4.js";import{S as us}from"./scroll-area-CirA2kAM.js";import{S as ps}from"./switch-Cab152fI.js";import{L as ut}from"./label-Dv-tUw_I.js";import{T as Ye,a as V}from"./toggle-group-DAlWALFV.js";import{A as hs,b as xs,a as fs}from"./Alert-DNaW36tb.js";import{R as gs}from"./refresh-cw-BuGxtDy8.js";import{D as Xe}from"./download-qTCqUu4D.js";import"./chevron-down-CzX0Y-bP.js";import"./chevron-right-BJ2VXb6V.js";import"./index-BdQq_4o_.js";import"./index-CgbFjYnG.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ys=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M12 3v18",key:"108xh3"}]],vs=At("columns-2",ys);function Ze(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var et=Number.isNaN||function(s){return typeof s=="number"&&s!==s};function js(t,s){return!!(t===s||et(t)&&et(s))}function _s(t,s){if(t.length!==s.length)return!1;for(var r=0;r<t.length;r++)if(!js(t[r],s[r]))return!1;return!0}function Ee(t,s){s===void 0&&(s=_s);var r,o=[],n,c=!1;function d(){for(var a=[],u=0;u<arguments.length;u++)a[u]=arguments[u];return c&&r===this&&s(a,o)||(n=t.apply(this,a),c=!0,r=this,o=a),n}return d}var bs=typeof performance=="object"&&typeof performance.now=="function",tt=bs?function(){return performance.now()}:function(){return Date.now()};function st(t){cancelAnimationFrame(t.id)}function Ns(t,s){var r=tt();function o(){tt()-r>=s?t.call(null):n.id=requestAnimationFrame(o)}var n={id:requestAnimationFrame(o)};return n}var Fe=-1;function rt(t){if(t===void 0&&(t=!1),Fe===-1||t){var s=document.createElement("div"),r=s.style;r.width="50px",r.height="50px",r.overflow="scroll",document.body.appendChild(s),Fe=s.offsetWidth-s.clientWidth,document.body.removeChild(s)}return Fe}var ae=null;function at(t){if(t===void 0&&(t=!1),ae===null||t){var s=document.createElement("div"),r=s.style;r.width="50px",r.height="50px",r.overflow="scroll",r.direction="rtl";var o=document.createElement("div"),n=o.style;return n.width="100px",n.height="100px",s.appendChild(o),document.body.appendChild(s),s.scrollLeft>0?ae="positive-descending":(s.scrollLeft=1,s.scrollLeft===0?ae="negative":ae="positive-ascending"),document.body.removeChild(s),ae}return ae}var Ss=150,Cs=function(s,r){return s};function ws(t){var s,r=t.getItemOffset,o=t.getEstimatedTotalSize,n=t.getItemSize,c=t.getOffsetForIndexAndAlignment,d=t.getStartIndexForOffset,a=t.getStopIndexForStartIndex,u=t.initInstanceProps,h=t.shouldResetStyleCacheOnItemSizeChange,j=t.validateProps;return s=(function(y){Dt(_,y);function _(I){var l;return l=y.call(this,I)||this,l._instanceProps=u(l.props,Ze(l)),l._outerRef=void 0,l._resetIsScrollingTimeoutId=null,l.state={instance:Ze(l),isScrolling:!1,scrollDirection:"forward",scrollOffset:typeof l.props.initialScrollOffset=="number"?l.props.initialScrollOffset:0,scrollUpdateWasRequested:!1},l._callOnItemsRendered=void 0,l._callOnItemsRendered=Ee(function(f,x,b,C){return l.props.onItemsRendered({overscanStartIndex:f,overscanStopIndex:x,visibleStartIndex:b,visibleStopIndex:C})}),l._callOnScroll=void 0,l._callOnScroll=Ee(function(f,x,b){return l.props.onScroll({scrollDirection:f,scrollOffset:x,scrollUpdateWasRequested:b})}),l._getItemStyle=void 0,l._getItemStyle=function(f){var x=l.props,b=x.direction,C=x.itemSize,O=x.layout,N=l._getItemStyleCache(h&&C,h&&O,h&&b),w;if(N.hasOwnProperty(f))w=N[f];else{var P=r(l.props,f,l._instanceProps),$=n(l.props,f,l._instanceProps),M=b==="horizontal"||O==="horizontal",te=b==="rtl",se=M?P:0;N[f]=w={position:"absolute",left:te?void 0:se,right:te?se:void 0,top:M?0:P,height:M?"100%":$,width:M?$:"100%"}}return w},l._getItemStyleCache=void 0,l._getItemStyleCache=Ee(function(f,x,b){return{}}),l._onScrollHorizontal=function(f){var x=f.currentTarget,b=x.clientWidth,C=x.scrollLeft,O=x.scrollWidth;l.setState(function(N){if(N.scrollOffset===C)return null;var w=l.props.direction,P=C;if(w==="rtl")switch(at()){case"negative":P=-C;break;case"positive-descending":P=O-b-C;break}return P=Math.max(0,Math.min(P,O-b)),{isScrolling:!0,scrollDirection:N.scrollOffset<P?"forward":"backward",scrollOffset:P,scrollUpdateWasRequested:!1}},l._resetIsScrollingDebounced)},l._onScrollVertical=function(f){var x=f.currentTarget,b=x.clientHeight,C=x.scrollHeight,O=x.scrollTop;l.setState(function(N){if(N.scrollOffset===O)return null;var w=Math.max(0,Math.min(O,C-b));return{isScrolling:!0,scrollDirection:N.scrollOffset<w?"forward":"backward",scrollOffset:w,scrollUpdateWasRequested:!1}},l._resetIsScrollingDebounced)},l._outerRefSetter=function(f){var x=l.props.outerRef;l._outerRef=f,typeof x=="function"?x(f):x!=null&&typeof x=="object"&&x.hasOwnProperty("current")&&(x.current=f)},l._resetIsScrollingDebounced=function(){l._resetIsScrollingTimeoutId!==null&&st(l._resetIsScrollingTimeoutId),l._resetIsScrollingTimeoutId=Ns(l._resetIsScrolling,Ss)},l._resetIsScrolling=function(){l._resetIsScrollingTimeoutId=null,l.setState({isScrolling:!1},function(){l._getItemStyleCache(-1,null)})},l}_.getDerivedStateFromProps=function(l,f){return Ls(l,f),j(l),null};var v=_.prototype;return v.scrollTo=function(l){l=Math.max(0,l),this.setState(function(f){return f.scrollOffset===l?null:{scrollDirection:f.scrollOffset<l?"forward":"backward",scrollOffset:l,scrollUpdateWasRequested:!0}},this._resetIsScrollingDebounced)},v.scrollToItem=function(l,f){f===void 0&&(f="auto");var x=this.props,b=x.itemCount,C=x.layout,O=this.state.scrollOffset;l=Math.max(0,Math.min(l,b-1));var N=0;if(this._outerRef){var w=this._outerRef;C==="vertical"?N=w.scrollWidth>w.clientWidth?rt():0:N=w.scrollHeight>w.clientHeight?rt():0}this.scrollTo(c(this.props,l,f,O,this._instanceProps,N))},v.componentDidMount=function(){var l=this.props,f=l.direction,x=l.initialScrollOffset,b=l.layout;if(typeof x=="number"&&this._outerRef!=null){var C=this._outerRef;f==="horizontal"||b==="horizontal"?C.scrollLeft=x:C.scrollTop=x}this._callPropsCallbacks()},v.componentDidUpdate=function(){var l=this.props,f=l.direction,x=l.layout,b=this.state,C=b.scrollOffset,O=b.scrollUpdateWasRequested;if(O&&this._outerRef!=null){var N=this._outerRef;if(f==="horizontal"||x==="horizontal")if(f==="rtl")switch(at()){case"negative":N.scrollLeft=-C;break;case"positive-ascending":N.scrollLeft=C;break;default:var w=N.clientWidth,P=N.scrollWidth;N.scrollLeft=P-w-C;break}else N.scrollLeft=C;else N.scrollTop=C}this._callPropsCallbacks()},v.componentWillUnmount=function(){this._resetIsScrollingTimeoutId!==null&&st(this._resetIsScrollingTimeoutId)},v.render=function(){var l=this.props,f=l.children,x=l.className,b=l.direction,C=l.height,O=l.innerRef,N=l.innerElementType,w=l.innerTagName,P=l.itemCount,$=l.itemData,M=l.itemKey,te=M===void 0?Cs:M,se=l.layout,Ie=l.outerElementType,Oe=l.outerTagName,Pe=l.style,ie=l.useIsScrolling,Te=l.width,W=this.state.isScrolling,le=b==="horizontal"||se==="horizontal",fe=le?this._onScrollHorizontal:this._onScrollVertical,q=this._getRangeToRender(),T=q[0],D=q[1],ce=[];if(P>0)for(var H=T;H<=D;H++)ce.push(p.createElement(f,{data:$,key:te(H,$),index:H,isScrolling:ie?W:void 0,style:this._getItemStyle(H)}));var re=o(this.props,this._instanceProps);return p.createElement(Ie||Oe||"div",{className:x,onScroll:fe,ref:this._outerRefSetter,style:$t({position:"relative",height:C,width:Te,overflow:"auto",WebkitOverflowScrolling:"touch",willChange:"transform",direction:b},Pe)},p.createElement(N||w||"div",{children:ce,ref:O,style:{height:le?"100%":re,pointerEvents:W?"none":void 0,width:le?re:"100%"}}))},v._callPropsCallbacks=function(){if(typeof this.props.onItemsRendered=="function"){var l=this.props.itemCount;if(l>0){var f=this._getRangeToRender(),x=f[0],b=f[1],C=f[2],O=f[3];this._callOnItemsRendered(x,b,C,O)}}if(typeof this.props.onScroll=="function"){var N=this.state,w=N.scrollDirection,P=N.scrollOffset,$=N.scrollUpdateWasRequested;this._callOnScroll(w,P,$)}},v._getRangeToRender=function(){var l=this.props,f=l.itemCount,x=l.overscanCount,b=this.state,C=b.isScrolling,O=b.scrollDirection,N=b.scrollOffset;if(f===0)return[0,0,0,0];var w=d(this.props,N,this._instanceProps),P=a(this.props,w,N,this._instanceProps),$=!C||O==="backward"?Math.max(1,x):1,M=!C||O==="forward"?Math.max(1,x):1;return[Math.max(0,w-$),Math.max(0,Math.min(f-1,P+M)),w,P]},_})(p.PureComponent),s.defaultProps={direction:"ltr",itemData:void 0,layout:"vertical",overscanCount:2,useIsScrolling:!1},s}var Ls=function(s,r){s.children,s.direction,s.height,s.layout,s.innerTagName,s.outerTagName,s.width,r.instance},Is=ws({getItemOffset:function(s,r){var o=s.itemSize;return r*o},getItemSize:function(s,r){var o=s.itemSize;return o},getEstimatedTotalSize:function(s){var r=s.itemCount,o=s.itemSize;return o*r},getOffsetForIndexAndAlignment:function(s,r,o,n,c,d){var a=s.direction,u=s.height,h=s.itemCount,j=s.itemSize,y=s.layout,_=s.width,v=a==="horizontal"||y==="horizontal",I=v?_:u,l=Math.max(0,h*j-I),f=Math.min(l,r*j),x=Math.max(0,r*j-I+j+d);switch(o==="smart"&&(n>=x-I&&n<=f+I?o="auto":o="center"),o){case"start":return f;case"end":return x;case"center":{var b=Math.round(x+(f-x)/2);return b<Math.ceil(I/2)?0:b>l+Math.floor(I/2)?l:b}case"auto":default:return n>=x&&n<=f?n:n<x?x:f}},getStartIndexForOffset:function(s,r){var o=s.itemCount,n=s.itemSize;return Math.max(0,Math.min(o-1,Math.floor(r/n)))},getStopIndexForStartIndex:function(s,r,o){var n=s.direction,c=s.height,d=s.itemCount,a=s.itemSize,u=s.layout,h=s.width,j=n==="horizontal"||u==="horizontal",y=r*a,_=j?h:c,v=Math.ceil((_+o-y)/a);return Math.max(0,Math.min(d-1,r+v-1))},initInstanceProps:function(s){},shouldResetStyleCacheOnItemSizeChange:!0,validateProps:function(s){s.itemSize}});async function Os(t){return(await Mt.get(`/admin/system-logs/${t}`)).data}function Ps(t){return nt(["systemLog",t],()=>Os(t),{enabled:!!t})}function Ts(t,s=400){const[r,o]=p.useState(t);return p.useEffect(()=>{const n=setTimeout(()=>o(t),s);return()=>clearTimeout(n)},[t,s]),r}function Rs(t){const s=Ts(t.q||""),r={...t,q:s};return nt(["logSearch",r],()=>is(r),{keepPreviousData:!0})}const ks={req:"request_id",rid:"request_id",request_id:"request_id",user:"user_id",uid:"user_id",user_id:"user_id",dur:"duration_ms",time:"duration_ms",duration:"duration_ms",status:"status_code",code:"status_code",status_code:"status_code",path:"path",url:"path",method:"method",action:"action",astatus:"audit_status",audit_status:"audit_status",etype:"error_type",error_type:"error_type",model:"model",source:"source",actor:"actor_type",atype:"actor_type",actor_type:"actor_type",actor_id:"actor_id",aid:"actor_id",lstatus:"llm_status",llm_status:"llm_status"},Es=new Set(["duration_ms","status_code"]);function Z(t){const s={},r={},o=[],n=/("[^"]+"|\S+)/g,c=(t||"").match(n)||[];for(const d of c){const a=d.trim();if(!a)continue;const u=a.match(/^([^:!<>=]+)(!?=|>=|<=|>|<|:)(.+)$/);if(u){let[,h,j,y]=u;h=h.trim(),y=y.trim(),y.startsWith('"')&&y.endsWith('"')&&(y=y.slice(1,-1));const _=ks[h]||h;if(Es.has(_)&&/^(>=|<=|>|<)$/.test(j)){r[_]=r[_]||{},r[_][j]=y;continue}if(j==="!="){s[_]={value:y,negate:!0};continue}s[_]=y}else o.push(a.replace(/^"|"$/g,""))}return{tokens:s,free:o.join(" "),ranges:r,raw:t}}function pt({system:t=[],audit:s=[],error:r=[],llm:o=[],onSelectRequest:n,emptyLabel:c="No events"}){const d=p.useMemo(()=>{const a=(u,h)=>{let j=u.created_at||u.error_time||u.time||u.timestamp;return{...u,__type:h,__ts:j&&Date.parse(j)||0}};return[...t.map(u=>a(u,"system")),...s.map(u=>a(u,"audit")),...r.map(u=>a(u,"error")),...o.map(u=>a(u,"llm"))].sort((u,h)=>h.__ts-u.__ts).slice(0,500)},[t,s,r,o]);return e.jsxs("div",{className:"space-y-3",children:[d.map(a=>e.jsxs("div",{className:"flex items-start gap-2 text-xs",children:[e.jsx("div",{className:`w-20 text-right pr-2 font-mono ${Ds(a.__type)}`,children:a.__type}),e.jsxs("div",{className:"flex-1 border-l pl-3 pb-3 relative",children:[e.jsx("div",{className:"absolute -left-[5px] top-1 w-2 h-2 rounded-full bg-green-500"}),e.jsxs("div",{className:"flex flex-wrap gap-x-3 gap-y-1",children:[a.request_id&&e.jsx(U,{asButton:!0,onClick:()=>n==null?void 0:n(a.request_id),children:$s(a.request_id)}),a.method&&e.jsx(U,{children:a.method}),a.status_code&&e.jsx(U,{tone:Fs(a.status_code),children:a.status_code}),a.duration_ms!==void 0&&e.jsxs(U,{tone:As(a.duration_ms),children:[a.duration_ms,"ms"]}),a.error_type&&e.jsx(U,{tone:"red",children:a.error_type}),a.action&&e.jsx(U,{children:a.action}),a.model&&e.jsx(U,{tone:"blue",children:a.model}),a.status&&a.__type==="llm"&&e.jsx(U,{tone:a.status==="failed"?"red":"green",children:a.status}),a.total_tokens!==void 0&&a.__type==="llm"&&e.jsx(U,{tone:"orange",children:a.total_tokens})]}),a.path&&e.jsx("div",{className:"font-mono text-[10px] mt-1 break-all text-gray-600",children:a.path}),a.error_message&&e.jsx("div",{className:"font-mono text-[10px] mt-1 text-rose-600 break-all",title:a.error_message,children:a.error_message.slice(0,180)}),a.prompt&&a.__type==="llm"&&e.jsx("div",{className:"font-mono text-[10px] mt-1 text-gray-600 break-all",title:a.prompt,children:String(a.prompt).slice(0,180)}),e.jsx("div",{className:"text-[10px] text-gray-400 mt-1",children:a.created_at||a.error_time})]})]},`${a.__type}-${a.id||a.request_id||a.__ts}`)),d.length===0&&e.jsx("div",{className:"text-xs text-gray-400",children:c})]})}function U({children:t,tone:s="gray",onClick:r,asButton:o=!1}){const n={gray:"bg-gray-200 text-gray-700",green:"bg-green-200 text-green-800",yellow:"bg-yellow-200 text-yellow-800",red:"bg-red-200 text-red-800",blue:"bg-blue-200 text-blue-800",orange:"bg-orange-200 text-orange-800"},c=`px-1.5 py-0.5 rounded ${r?"cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-400":"cursor-default"} ${n[s]||n.gray} text-[10px] inline-flex items-center`;return o||r?e.jsx("button",{type:"button",className:c,onClick:r,children:t}):e.jsx("span",{className:c,children:t})}U.propTypes={children:F.node,tone:F.string,onClick:F.func,asButton:F.bool};function Fs(t){return t>=500?"red":t>=400?"orange":t>=300?"yellow":t>=200?"green":"gray"}function As(t){return t>=1500?"red":t>=1e3?"orange":t>=500?"yellow":"green"}function Ds(t){switch(t){case"system":return"text-green-600";case"audit":return"text-blue-600";case"error":return"text-red-600";case"llm":return"text-indigo-600";default:return"text-gray-500"}}function $s(t){return t&&t.length>10?t.slice(0,6)+"…"+t.slice(-4):t}pt.propTypes={system:F.array,audit:F.array,error:F.array,llm:F.array,onSelectRequest:F.func,emptyLabel:F.string};const Ms={copy:"Copy NDJSON",exportNdjson:"Export NDJSON",exportCsv:"Export CSV",records:"records",maxHint:"(max 1000)"};function ht({system:t=[],audit:s=[],error:r=[],llm:o=[],onExportCsv:n,onExportNdjson:c,labels:d={}}){const a=p.useMemo(()=>[...t.map(y=>({...y,__type:"system"})),...s.map(y=>({...y,__type:"audit"})),...r.map(y=>({...y,__type:"error"})),...o.map(y=>({...y,__type:"llm"}))].sort((y,_)=>{const v=Date.parse(y.created_at||y.error_time||y.time||y.timestamp||0)||0;return(Date.parse(_.created_at||_.error_time||_.time||_.timestamp||0)||0)-v}).slice(0,1e3),[t,s,r,o]),u={...Ms,...d},h=p.useMemo(()=>a.map(y=>JSON.stringify(y)).join(`
`),[a]),j=()=>{h&&navigator.clipboard.writeText(h).catch(()=>{})};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs",children:[e.jsx(A,{size:"sm",variant:"outline",className:"h-8 px-3",onClick:j,children:u.copy}),e.jsx(A,{size:"sm",variant:"outline",className:"h-8 px-3",onClick:c,children:u.exportNdjson}),e.jsx(A,{size:"sm",variant:"outline",className:"h-8 px-3",onClick:n,children:u.exportCsv}),e.jsxs("div",{className:"text-muted-foreground",children:[a.length," ",u.records," ",u.maxHint]})]}),e.jsx("pre",{className:"max-h-[60vh] overflow-auto whitespace-pre rounded bg-black p-3 text-[10px] leading-tight text-green-300",children:h})]})}ht.propTypes={system:F.array,audit:F.array,error:F.array,llm:F.array,onExportCsv:F.func,onExportNdjson:F.func,labels:F.object};function ot(t){if(t==null)return null;if(typeof t=="object")return t;try{return JSON.parse(t)}catch{return t}}function xt(t,s,r=[]){if(Object.is(t,s))return[];if(typeof t!=="object"||typeof s!=="object"||t===null||s===null)return[{path:r.join("."),old:t,new:s}];const c=Array.from(new Set([...Object.keys(t),...Object.keys(s)])),d=[];for(const a of c)d.push(...xt(t[a],s[a],r.concat(a)));return d.filter(a=>a.old!==a.new)}function zs({oldData:t,newData:s}){const[r,o]=p.useState("inline"),n=p.useMemo(()=>ot(t),[t]),c=p.useMemo(()=>ot(s),[s]),d=p.useMemo(()=>xt(n||{},c||{}),[n,c]);return e.jsxs("div",{className:"border rounded bg-white text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2 p-2 border-b bg-gray-50",children:[e.jsx("strong",{children:"变更 Diff"}),e.jsx("div",{className:"ml-auto flex gap-1",children:["inline","side","tree"].map(a=>e.jsx("button",{onClick:()=>o(a),className:`px-2 py-0.5 rounded ${r===a?"bg-blue-600 text-white":"bg-gray-200"}`,children:a},a))})]}),r==="tree"&&e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-1",children:"旧"}),e.jsx(we,{value:n,collapsed:!0})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-1",children:"新"}),e.jsx(we,{value:c,collapsed:!0})]})]}),r==="side"&&e.jsx("div",{className:"p-2 overflow-auto",children:e.jsxs("table",{className:"w-full text-[11px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"p-1 text-left",children:"字段"}),e.jsx("th",{className:"p-1 text-left",children:"旧"}),e.jsx("th",{className:"p-1 text-left",children:"新"})]})}),e.jsxs("tbody",{children:[d.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"p-2 text-center text-gray-500",children:"无差异"})}),d.map(a=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-1 align-top font-mono",children:a.path||"(root)"}),e.jsx("td",{className:"p-1 text-red-600 break-all font-mono",children:JSON.stringify(a.old)}),e.jsx("td",{className:"p-1 text-green-700 break-all font-mono",children:JSON.stringify(a.new)})]},a.path))]})]})}),r==="inline"&&e.jsxs("div",{className:"p-2 space-y-1 max-h-80 overflow-auto",children:[d.length===0&&e.jsx("div",{className:"text-gray-500",children:"无差异"}),d.map(a=>e.jsxs("div",{className:"border rounded p-1 bg-gray-50",children:[e.jsx("div",{className:"font-mono text-[10px] mb-1 text-gray-600",children:a.path||"(root)"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-2",children:[e.jsxs("div",{className:"flex-1 bg-red-50 p-1 rounded",children:[e.jsx("span",{className:"text-red-700",children:"旧:"})," ",e.jsx("code",{className:"break-all",children:JSON.stringify(a.old)})]}),e.jsxs("div",{className:"flex-1 bg-green-50 p-1 rounded",children:[e.jsx("span",{className:"text-green-700",children:"新:"})," ",e.jsx("code",{className:"break-all",children:JSON.stringify(a.new)})]})]})]},a.path))]})]})}var Le="Popover",[ft]=Ut(Le,[it]),xe=it(),[qs,G]=ft(Le),gt=t=>{const{__scopePopover:s,children:r,open:o,defaultOpen:n,onOpenChange:c,modal:d=!1}=t,a=xe(s),u=p.useRef(null),[h,j]=p.useState(!1),[y,_]=zt({prop:o,defaultProp:n??!1,onChange:c,caller:Le});return e.jsx(qt,{...a,children:e.jsx(qs,{scope:s,contentId:Wt(),triggerRef:u,open:y,onOpenChange:_,onOpenToggle:p.useCallback(()=>_(v=>!v),[_]),hasCustomAnchor:h,onCustomAnchorAdd:p.useCallback(()=>j(!0),[]),onCustomAnchorRemove:p.useCallback(()=>j(!1),[]),modal:d,children:r})})};gt.displayName=Le;var yt="PopoverAnchor",Us=p.forwardRef((t,s)=>{const{__scopePopover:r,...o}=t,n=G(yt,r),c=xe(r),{onCustomAnchorAdd:d,onCustomAnchorRemove:a}=n;return p.useEffect(()=>(d(),()=>a()),[d,a]),e.jsx(dt,{...c,...o,ref:s})});Us.displayName=yt;var vt="PopoverTrigger",jt=p.forwardRef((t,s)=>{const{__scopePopover:r,...o}=t,n=G(vt,r),c=xe(r),d=lt(s,n.triggerRef),a=e.jsx(ct.button,{type:"button","aria-haspopup":"dialog","aria-expanded":n.open,"aria-controls":n.contentId,"data-state":Ct(n.open),...o,ref:d,onClick:me(t.onClick,n.onOpenToggle)});return n.hasCustomAnchor?a:e.jsx(dt,{asChild:!0,...c,children:a})});jt.displayName=vt;var Me="PopoverPortal",[Ws,Hs]=ft(Me,{forceMount:void 0}),_t=t=>{const{__scopePopover:s,forceMount:r,children:o,container:n}=t,c=G(Me,s);return e.jsx(Ws,{scope:s,forceMount:r,children:e.jsx(mt,{present:r||c.open,children:e.jsx(Ht,{asChild:!0,container:n,children:o})})})};_t.displayName=Me;var oe="PopoverContent",bt=p.forwardRef((t,s)=>{const r=Hs(oe,t.__scopePopover),{forceMount:o=r.forceMount,...n}=t,c=G(oe,t.__scopePopover);return e.jsx(mt,{present:o||c.open,children:c.modal?e.jsx(Bs,{...n,ref:s}):e.jsx(Ks,{...n,ref:s})})});bt.displayName=oe;var Js=Kt("PopoverContent.RemoveScroll"),Bs=p.forwardRef((t,s)=>{const r=G(oe,t.__scopePopover),o=p.useRef(null),n=lt(s,o),c=p.useRef(!1);return p.useEffect(()=>{const d=o.current;if(d)return Jt(d)},[]),e.jsx(Bt,{as:Js,allowPinchZoom:!0,children:e.jsx(Nt,{...t,ref:n,trapFocus:r.open,disableOutsidePointerEvents:!0,onCloseAutoFocus:me(t.onCloseAutoFocus,d=>{var a;d.preventDefault(),c.current||(a=r.triggerRef.current)==null||a.focus()}),onPointerDownOutside:me(t.onPointerDownOutside,d=>{const a=d.detail.originalEvent,u=a.button===0&&a.ctrlKey===!0,h=a.button===2||u;c.current=h},{checkForDefaultPrevented:!1}),onFocusOutside:me(t.onFocusOutside,d=>d.preventDefault(),{checkForDefaultPrevented:!1})})})}),Ks=p.forwardRef((t,s)=>{const r=G(oe,t.__scopePopover),o=p.useRef(!1),n=p.useRef(!1);return e.jsx(Nt,{...t,ref:s,trapFocus:!1,disableOutsidePointerEvents:!1,onCloseAutoFocus:c=>{var d,a;(d=t.onCloseAutoFocus)==null||d.call(t,c),c.defaultPrevented||(o.current||(a=r.triggerRef.current)==null||a.focus(),c.preventDefault()),o.current=!1,n.current=!1},onInteractOutside:c=>{var u,h;(u=t.onInteractOutside)==null||u.call(t,c),c.defaultPrevented||(o.current=!0,c.detail.originalEvent.type==="pointerdown"&&(n.current=!0));const d=c.target;((h=r.triggerRef.current)==null?void 0:h.contains(d))&&c.preventDefault(),c.detail.originalEvent.type==="focusin"&&n.current&&c.preventDefault()}})}),Nt=p.forwardRef((t,s)=>{const{__scopePopover:r,trapFocus:o,onOpenAutoFocus:n,onCloseAutoFocus:c,disableOutsidePointerEvents:d,onEscapeKeyDown:a,onPointerDownOutside:u,onFocusOutside:h,onInteractOutside:j,...y}=t,_=G(oe,r),v=xe(r);return Gt(),e.jsx(Qt,{asChild:!0,loop:!0,trapped:o,onMountAutoFocus:n,onUnmountAutoFocus:c,children:e.jsx(Vt,{asChild:!0,disableOutsidePointerEvents:d,onInteractOutside:j,onEscapeKeyDown:a,onPointerDownOutside:u,onFocusOutside:h,onDismiss:()=>_.onOpenChange(!1),children:e.jsx(Yt,{"data-state":Ct(_.open),role:"dialog",id:_.contentId,...v,...y,ref:s,style:{...y.style,"--radix-popover-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-popover-content-available-width":"var(--radix-popper-available-width)","--radix-popover-content-available-height":"var(--radix-popper-available-height)","--radix-popover-trigger-width":"var(--radix-popper-anchor-width)","--radix-popover-trigger-height":"var(--radix-popper-anchor-height)"}})})})}),St="PopoverClose",Gs=p.forwardRef((t,s)=>{const{__scopePopover:r,...o}=t,n=G(St,r);return e.jsx(ct.button,{type:"button",...o,ref:s,onClick:me(t.onClick,()=>n.onOpenChange(!1))})});Gs.displayName=St;var Qs="PopoverArrow",Vs=p.forwardRef((t,s)=>{const{__scopePopover:r,...o}=t,n=xe(r);return e.jsx(Xt,{...n,...o,ref:s})});Vs.displayName=Qs;function Ct(t){return t?"open":"closed"}var Ys=gt,Xs=jt,Zs=_t,er=bt;function tr({...t}){return e.jsx(Ys,{"data-slot":"popover",...t})}function sr({...t}){return e.jsx(Xs,{"data-slot":"popover-trigger",...t})}function rr({className:t,align:s="center",sideOffset:r=4,...o}){return e.jsx(Zs,{children:e.jsx(er,{"data-slot":"popover-content",align:s,sideOffset:r,className:he("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",t),...o})})}const wt=["id","method","path","status_code","user_id","duration_ms","created_at","ops"],Lt=["id","actor_type","action","operation_category","status","user_id","ip_address","created_at","ops"],It=["id","error_type","error_message","error_file","error_line","error_time","ops"],Ot=["id","actor_type","actor_id","source","model","llm_status","total_tokens","latency_ms","created_at","ops"],K={system:"logCols_system",audit:"logCols_audit",error:"logCols_error",llm:"logCols_llm"};function Ne(t,s){try{const r=localStorage.getItem(t),o=r?JSON.parse(r):null;return Array.isArray(o)&&o.length?o:s}catch(r){return console.warn("Failed to load stored columns",r),s}}function Ir(){var Ue,We,He,Je,Be,Ke,Ge,Qe,Ve;const{t}=Zt(),[s,r]=p.useState(""),[o,n]=p.useState(""),[c,d]=p.useState(""),[a,u]=p.useState(["system","audit","error","llm"]),[h,j]=p.useState(50),[y,_]=p.useState(null),[v,I]=p.useState("table"),[l,f]=p.useState(!1),[x,b]=p.useState(null),[C,O]=p.useState({system:[],audit:[],error:[],llm:[]}),[N,w]=p.useState(!1),[P,$]=p.useState(!1),[M,te]=p.useState(()=>Ne(K.system,wt)),[se,Ie]=p.useState(()=>Ne(K.audit,Lt)),[Oe,Pe]=p.useState(()=>Ne(K.error,It)),[ie,Te]=p.useState(()=>Ne(K.llm,Ot)),W=p.useRef(0),[le,fe]=p.useState(new Set),q=p.useMemo(()=>Z(s||""),[s]),T=p.useMemo(()=>{var g;const i={},m=q.tokens||{};if(["method","status_code","user_id","request_id","path","action","audit_status","error_type","model","source","actor_type","actor_id","llm_status"].forEach(S=>{m[S]&&(i[S]=m[S])}),(g=q.ranges)!=null&&g.duration_ms){const S=q.ranges.duration_ms;(S[">"]||S[">="])&&(i.min_duration=S[">"]||S[">="]),(S["<"]||S["<="])&&(i.max_duration=S["<"]||S["<="])}return i},[q]),{data:D,isLoading:ce,isError:H,error:re,refetch:Re,isFetching:ze}=Rs({q:q.free||s,date_from:o,date_to:c,types:a,limit_per_type:h,...T}),{data:k,isLoading:Tt}=Ps(y);p.useEffect(()=>{if(!l)return;const i=setInterval(()=>{Re()},8e3);return()=>clearInterval(i)},[l,Re]);const ge=p.useCallback(i=>{if(i!=null)try{const m=typeof i=="string"?i:JSON.stringify(i,null,2);navigator.clipboard.writeText(m)}catch(m){console.warn("Failed to copy content",m)}},[]),J=((We=(Ue=D==null?void 0:D.data)==null?void 0:Ue.system)==null?void 0:We.items)||[],ye=((Je=(He=D==null?void 0:D.data)==null?void 0:He.audit)==null?void 0:Je.items)||[],ve=((Ke=(Be=D==null?void 0:D.data)==null?void 0:Be.error)==null?void 0:Ke.items)||[],je=((Qe=(Ge=D==null?void 0:D.data)==null?void 0:Ge.llm)==null?void 0:Qe.items)||[];p.useEffect(()=>{if(!J.length)return;const i=Math.max(...J.map(m=>m.id));if(W.current===0){W.current=i;return}if(i>W.current){const m=J.filter(S=>S.id>W.current).map(S=>S.id);fe(new Set(m)),W.current=i;const g=setTimeout(()=>fe(new Set),4e3);return()=>clearTimeout(g)}},[J]);const Rt=p.useCallback(i=>{i&&u(i)},[]),de=p.useCallback((i,m)=>{try{localStorage.setItem(i,JSON.stringify(m))}catch(g){console.warn("Failed to persist selected columns",g)}},[]),kt=p.useCallback((i,m)=>{m==="id"||m==="ops"||(i==="system"?te(g=>{const S=g.includes(m)?g.filter(Q=>Q!==m):[...g,m];return de(K.system,S),S}):i==="audit"?Ie(g=>{const S=g.includes(m)?g.filter(Q=>Q!==m):[...g,m];return de(K.audit,S),S}):i==="error"?Pe(g=>{const S=g.includes(m)?g.filter(Q=>Q!==m):[...g,m];return de(K.error,S),S}):i==="llm"&&Te(g=>{const S=g.includes(m)?g.filter(Q=>Q!==m):[...g,m];return de(K.llm,S),S}))},[de]),_e=p.useCallback(async i=>{b(i),w(!0);try{const m=await ls(i);O((m==null?void 0:m.data)||m||{system:[],audit:[],error:[],llm:[]})}finally{w(!1)}},[]),be=p.useCallback(async i=>{$(!0);try{const m=await cs({q:s,date_from:o,date_to:c,types:a,limit_per_type:h,...T},i),g=URL.createObjectURL(m),S=document.createElement("a");S.href=g,S.download=`logs_${Date.now()}.${i==="csv"?"csv":"ndjson"}`,S.click(),setTimeout(()=>URL.revokeObjectURL(g),2e3)}finally{$(!1)}},[s,o,c,a,h,T]),Et=J.length+ye.length+ve.length+je.length>0,Ft=Object.entries(q.tokens||{}).filter(([,i])=>i&&typeof i!="object").length>0||!!q.free,B=p.useCallback(i=>t(`admin.systemLogs.columns.${i}`,{defaultValue:i}),[t]),qe=p.useMemo(()=>ie.filter(i=>i!=="ops"),[ie]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Y,{children:[e.jsxs(ue,{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(pe,{children:t("admin.systemLogs.title")}),e.jsx(ke,{children:t("admin.systemLogs.subtitle")})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(Ye,{type:"single",value:v,onValueChange:i=>i&&I(i),variant:"outline",size:"sm",children:[e.jsx(V,{value:"table",children:t("admin.systemLogs.views.table")}),e.jsx(V,{value:"timeline",children:t("admin.systemLogs.views.timeline")}),e.jsx(V,{value:"raw",children:t("admin.systemLogs.views.raw")})]}),e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>Re(),disabled:ze,children:[e.jsx(gs,{className:he("mr-2 h-4 w-4",ze&&"animate-spin")}),t("admin.systemLogs.refresh")]}),e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>be("csv"),disabled:P,children:[e.jsx(Xe,{className:"mr-2 h-4 w-4"}),t("admin.systemLogs.exportCsv")]}),e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>be("ndjson"),disabled:P,children:[e.jsx(Xe,{className:"mr-2 h-4 w-4"}),t("admin.systemLogs.exportNdjson")]}),e.jsx(ar,{systemCols:M,auditCols:se,errorCols:Oe,llmCols:ie,onToggle:kt,columnLabel:B,t})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ps,{id:"logs-auto-refresh",checked:l,onCheckedChange:f}),e.jsx(ut,{htmlFor:"logs-auto-refresh",className:"text-sm text-muted-foreground",children:t("admin.systemLogs.autoRefresh")})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{children:t("admin.systemLogs.perTypeLimit")}),e.jsx(R,{id:"limit-per-type",type:"number",min:1,max:200,value:h,onChange:i=>{const m=Number(i.target.value);j(Number.isNaN(m)?50:m)},className:"h-9 w-24"})]}),e.jsxs(Ye,{type:"multiple",value:a,onValueChange:Rt,variant:"outline",size:"sm",className:"flex-wrap",children:[e.jsx(V,{value:"system",children:t("admin.systemLogs.types.system")}),e.jsx(V,{value:"audit",children:t("admin.systemLogs.types.audit")}),e.jsx(V,{value:"error",children:t("admin.systemLogs.types.error")}),e.jsx(V,{value:"llm",children:t("admin.systemLogs.types.llm")})]})]})]}),e.jsx(X,{className:"pt-0",children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4",children:[e.jsx(E,{label:t("admin.systemLogs.filters.keyword"),htmlFor:"log-search",children:e.jsx(R,{id:"log-search",value:s,onChange:i=>r(i.target.value),placeholder:t("admin.systemLogs.searchPlaceholder"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.method"),htmlFor:"log-method",children:e.jsx(R,{id:"log-method",value:T.method||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"method",m))},placeholder:t("admin.systemLogs.placeholders.method"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.status"),htmlFor:"log-status",children:e.jsx(R,{id:"log-status",value:T.status_code||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"status",m))},placeholder:t("admin.systemLogs.placeholders.status"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.userId"),htmlFor:"log-user-id",children:e.jsx(R,{id:"log-user-id",value:T.user_id||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"user",m))},placeholder:t("admin.systemLogs.placeholders.userId"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.requestId"),htmlFor:"log-request-id",children:e.jsx(R,{id:"log-request-id",value:T.request_id||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"rid",m))},placeholder:t("admin.systemLogs.placeholders.requestId"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.path"),htmlFor:"log-path",children:e.jsx(R,{id:"log-path",value:T.path||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"path",m))},placeholder:t("admin.systemLogs.placeholders.path"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.durationMin"),htmlFor:"log-duration-min",children:e.jsx(R,{id:"log-duration-min",value:T.min_duration||"",onChange:i=>r(m=>Pt(m,"dur",">=",i.target.value)),placeholder:t("admin.systemLogs.placeholders.duration"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.durationMax"),htmlFor:"log-duration-max",children:e.jsx(R,{id:"log-duration-max",value:T.max_duration||"",onChange:i=>r(m=>mr(m,i.target.value)),placeholder:t("admin.systemLogs.placeholders.duration"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.auditAction"),htmlFor:"log-audit-action",children:e.jsx(R,{id:"log-audit-action",value:T.action||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"action",m))},placeholder:t("admin.systemLogs.placeholders.auditAction"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.auditStatus"),htmlFor:"log-audit-status",children:e.jsx(R,{id:"log-audit-status",value:T.audit_status||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"astatus",m))},placeholder:t("admin.systemLogs.placeholders.auditStatus"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.errorType"),htmlFor:"log-error-type",children:e.jsx(R,{id:"log-error-type",value:T.error_type||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"etype",m))},placeholder:t("admin.systemLogs.placeholders.errorType"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.model"),htmlFor:"log-model",children:e.jsx(R,{id:"log-model",value:T.model||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"model",m))},placeholder:t("admin.systemLogs.placeholders.model"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.source"),htmlFor:"log-source",children:e.jsx(R,{id:"log-source",value:T.source||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"source",m))},placeholder:t("admin.systemLogs.placeholders.source"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.actorType"),htmlFor:"log-actor-type",children:e.jsx(R,{id:"log-actor-type",value:T.actor_type||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"actor",m))},placeholder:t("admin.systemLogs.placeholders.actorType"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.filters.llmStatus"),htmlFor:"log-llm-status",children:e.jsx(R,{id:"log-llm-status",value:T.llm_status||"",onChange:i=>{const m=i.target.value;r(g=>z(g,"lstatus",m))},placeholder:t("admin.systemLogs.placeholders.llmStatus"),className:"font-mono"})}),e.jsx(E,{label:t("admin.systemLogs.dateFrom"),htmlFor:"log-date-from",children:e.jsx(R,{id:"log-date-from",type:"date",value:o,onChange:i=>n(i.target.value)})}),e.jsx(E,{label:t("admin.systemLogs.dateTo"),htmlFor:"log-date-to",children:e.jsx(R,{id:"log-date-to",type:"date",value:c,onChange:i=>d(i.target.value)})})]})}),Ft&&e.jsx(ms,{className:"pt-0",children:e.jsx(or,{parsed:q,onRemove:i=>r(m=>ur(m,i)),t})})]}),ce&&e.jsx(Y,{children:e.jsxs(X,{className:"flex items-center gap-2 py-8 text-sm text-muted-foreground",children:[e.jsx(es,{className:"h-4 w-4 animate-spin"}),t("common.loading")]})}),H&&e.jsxs(hs,{variant:"destructive",children:[e.jsx(xs,{children:t("common.error")}),e.jsx(fs,{children:(re==null?void 0:re.message)||t("errors.loadFailed")})]}),!ce&&!H&&e.jsxs(e.Fragment,{children:[v==="table"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx(nr,{title:t("admin.systemLogs.sections.system"),items:J,emptyText:t("admin.systemLogs.empty.system"),columns:M,highlightIds:le,onDetail:_,onCopyReq:ge,onRelated:_e,columnLabel:B,t}),e.jsx(Ae,{title:t("admin.systemLogs.sections.llm"),items:je,emptyText:t("admin.systemLogs.empty.llm"),headers:qe,columnLabel:B,renderItem:i=>e.jsx(De,{summaryCells:qe.map(m=>dr(i,m)),detail:e.jsx(cr,{log:i,columnLabel:B,onRelated:_e,t}),t},`llm-${i.id}`)}),e.jsx(Ae,{title:t("admin.systemLogs.sections.audit"),items:ye,emptyText:t("admin.systemLogs.empty.audit"),headers:["id","actor_type","action","operation_category","status","user_id","ip_address","created_at"],columnLabel:B,renderItem:i=>e.jsx(De,{summaryCells:[i.id,i.actor_type,i.action,i.operation_category||"- ",i.status,i.user_id||"-",i.ip_address||"-",i.created_at],detail:e.jsx(ir,{log:i,columnLabel:B}),t},`audit-${i.id}`)}),e.jsx(Ae,{title:t("admin.systemLogs.sections.error"),items:ve,emptyText:t("admin.systemLogs.empty.error"),headers:["id","error_type","error_message","error_file","error_line","error_time"],columnLabel:B,renderItem:i=>{var m;return e.jsx(De,{summaryCells:[i.id,i.error_type,e.jsx("span",{className:"font-mono text-[11px] max-w-[240px] truncate",title:i.error_message,children:i.error_message},"message"),((m=i.error_file)==null?void 0:m.split("/").pop())||"-",i.error_line,i.error_time],detail:e.jsx(lr,{log:i,columnLabel:B}),t},`error-${i.id}`)}}),!Et&&e.jsx(Y,{children:e.jsx(X,{className:"py-12 text-center text-sm text-muted-foreground",children:t("admin.systemLogs.noEvents")})})]}),v==="timeline"&&e.jsxs(Y,{children:[e.jsxs(ue,{children:[e.jsx(pe,{className:"text-lg",children:t("admin.systemLogs.views.timeline")}),e.jsx(ke,{children:t("admin.systemLogs.timelineDescription")})]}),e.jsx(X,{children:e.jsx(pt,{system:J,audit:ye,error:ve,llm:je,onSelectRequest:_e,emptyLabel:t("admin.systemLogs.noEvents")})})]}),v==="raw"&&e.jsxs(Y,{children:[e.jsxs(ue,{children:[e.jsx(pe,{className:"text-lg",children:t("admin.systemLogs.views.raw")}),e.jsx(ke,{children:t("admin.systemLogs.rawDescription")})]}),e.jsx(X,{children:e.jsx(ht,{system:J,audit:ye,error:ve,llm:je,onExportCsv:()=>be("csv"),onExportNdjson:()=>be("ndjson"),labels:{copy:t("admin.systemLogs.copyNdjson"),exportNdjson:t("admin.systemLogs.exportNdjson"),exportCsv:t("admin.systemLogs.exportCsv"),records:t("admin.systemLogs.records"),maxHint:t("admin.systemLogs.maxRecords")}})})]})]}),e.jsx(ts,{open:!!y,onOpenChange:i=>!i&&_(null),children:e.jsxs(ss,{className:"max-w-4xl",children:[e.jsxs(rs,{children:[e.jsx(as,{children:y?t("admin.systemLogs.dialog.titleWithId",{id:y}):t("admin.systemLogs.dialog.title")}),e.jsx(os,{children:t("admin.systemLogs.dialog.requestId",{id:((Ve=k==null?void 0:k.data)==null?void 0:Ve.request_id)||t("common.none")})})]}),Tt&&e.jsx("div",{className:"py-4 text-sm text-muted-foreground",children:t("admin.systemLogs.dialog.loading")}),(k==null?void 0:k.data)&&e.jsx(us,{className:"max-h-[70vh] pr-2",children:e.jsxs("div",{className:"space-y-6 text-sm",children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsx(L,{label:t("admin.systemLogs.columns.request_id"),value:k.data.request_id}),e.jsx(L,{label:t("admin.systemLogs.columns.method"),value:k.data.method}),e.jsx(L,{label:t("admin.systemLogs.columns.path"),value:k.data.path,className:"md:col-span-2"}),e.jsx(L,{label:t("admin.systemLogs.columns.status_code"),value:k.data.status_code}),e.jsx(L,{label:t("admin.systemLogs.columns.user_id"),value:k.data.user_id||t("common.none")}),e.jsx(L,{label:t("admin.systemLogs.columns.duration_ms"),value:`${k.data.duration_ms} ms`}),e.jsx(L,{label:t("admin.systemLogs.columns.created_at"),value:k.data.created_at,className:"md:col-span-2"})]}),e.jsx($e,{title:t("admin.systemLogs.requestBody"),value:k.data.request_body,onCopy:ge,copyLabel:t("common.copy")}),e.jsx($e,{title:t("admin.systemLogs.responseBody"),value:k.data.response_body,onCopy:ge,copyLabel:t("common.copy")}),k.data.server_meta&&e.jsx($e,{title:t("admin.systemLogs.serverMeta"),value:k.data.server_meta,onCopy:ge,copyLabel:t("common.copy")})]})})]})}),e.jsx(ds,{open:!!x,requestId:x,onClose:()=>b(null),loading:N,data:C,onRefresh:()=>x&&_e(x)})]})}function E({label:t,htmlFor:s,children:r}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(ut,{htmlFor:s,className:"text-xs font-medium uppercase tracking-wide text-muted-foreground",children:t}),r]})}function ar({systemCols:t,auditCols:s,errorCols:r,llmCols:o,onToggle:n,columnLabel:c,t:d}){return e.jsxs(tr,{children:[e.jsx(sr,{asChild:!0,children:e.jsxs(A,{size:"sm",variant:"outline",children:[e.jsx(vs,{className:"mr-2 h-4 w-4"}),d("admin.systemLogs.columnSettings")]})}),e.jsxs(rr,{className:"w-64 space-y-4",align:"end",children:[e.jsx(Se,{title:d("admin.systemLogs.types.system"),columns:wt,active:t,onToggle:a=>n("system",a),columnLabel:c}),e.jsx(Se,{title:d("admin.systemLogs.types.audit"),columns:Lt,active:s,onToggle:a=>n("audit",a),columnLabel:c}),e.jsx(Se,{title:d("admin.systemLogs.types.error"),columns:It,active:r,onToggle:a=>n("error",a),columnLabel:c}),e.jsx(Se,{title:d("admin.systemLogs.types.llm"),columns:Ot,active:o,onToggle:a=>n("llm",a),columnLabel:c})]})]})}function Se({title:t,columns:s,active:r,onToggle:o,columnLabel:n}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase text-muted-foreground",children:t}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.map(c=>e.jsx(A,{size:"sm",variant:r.includes(c)?"default":"outline",onClick:()=>o(c),className:"h-8 text-xs",children:n(c)},c))})]})}function or({parsed:t,onRemove:s,t:r}){const o=Object.entries(t.tokens||{}).filter(([,n])=>n&&typeof n!="object");return o.length===0&&!t.free?null:e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs",children:[o.map(([n,c])=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(Ce,{variant:"secondary",className:"font-mono",children:[n,":",String(c)]}),e.jsx(A,{type:"button",size:"icon",variant:"ghost",className:"h-6 w-6 text-muted-foreground",onClick:()=>s(n),"aria-label":r("admin.systemLogs.activeFilters.remove",{key:n}),children:e.jsx(ns,{className:"h-3 w-3"})})]},n)),t.free&&e.jsx(Ce,{variant:"outline",className:"font-mono",children:t.free})]})}function nr({title:t,items:s,emptyText:r,columns:o,highlightIds:n,onDetail:c,onCopyReq:d,onRelated:a,columnLabel:u,t:h}){const j=s.length>120,y=e.jsx("thead",{className:"bg-muted/60",children:e.jsxs("tr",{children:[o.includes("id")&&e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:u("id")}),o.includes("method")&&e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:u("method")}),o.includes("path")&&e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:u("path")}),o.includes("status_code")&&e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:u("status_code")}),o.includes("user_id")&&e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:u("user_id")}),o.includes("duration_ms")&&e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:u("duration_ms")}),o.includes("created_at")&&e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:u("created_at")}),o.includes("ops")&&e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:u("ops")})]})}),_=v=>{const I=n.has(v.id);return e.jsxs("tr",{className:he("border-b text-xs transition-colors hover:bg-muted/30",I&&"bg-amber-50"),children:[o.includes("id")&&e.jsx("td",{className:"px-3 py-2 font-medium",children:v.id}),o.includes("method")&&e.jsx("td",{className:"px-3 py-2 uppercase",children:v.method}),o.includes("path")&&e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"font-mono text-[11px]",title:v.path,children:v.path})}),o.includes("status_code")&&e.jsx("td",{className:"px-3 py-2",children:v.status_code}),o.includes("user_id")&&e.jsx("td",{className:"px-3 py-2",children:v.user_id||"-"}),o.includes("duration_ms")&&e.jsx("td",{className:"px-3 py-2",children:v.duration_ms}),o.includes("created_at")&&e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:v.created_at}),o.includes("ops")&&e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs",children:[e.jsx(A,{variant:"link",className:"h-auto p-0",onClick:()=>c(v.id),children:h("admin.systemLogs.details")}),e.jsx(A,{variant:"link",className:"h-auto p-0 text-muted-foreground",onClick:()=>d(v.request_id),children:h("admin.systemLogs.copyReqId")}),v.request_id&&e.jsx(A,{variant:"link",className:"h-auto p-0 text-indigo-600",onClick:()=>a(v.request_id),children:h("admin.systemLogs.related")})]})})]},v.id)};return e.jsxs(Y,{children:[e.jsx(ue,{className:"flex flex-row items-center justify-between space-y-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(pe,{className:"text-lg",children:t}),e.jsx(Ce,{variant:"outline",className:"text-xs",children:h("admin.systemLogs.recordCount",{count:s.length})})]})}),e.jsx(X,{className:"p-0",children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full border-t text-xs",children:[y,!j&&e.jsxs("tbody",{children:[s.map(v=>_(v)),s.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-center text-muted-foreground",colSpan:o.length,children:r})})]})]}),j&&e.jsx(Is,{height:480,itemCount:s.length,itemSize:44,width:"100%",children:({index:v,style:I})=>e.jsx("table",{style:{...I,width:"100%"},className:"table-fixed text-xs",children:e.jsx("tbody",{children:_(s[v])})},s[v].id)})]})})]})}function Ae({title:t,items:s,emptyText:r,renderItem:o,headers:n,columnLabel:c}){return e.jsxs(Y,{children:[e.jsx(ue,{className:"flex flex-row items-center justify-between space-y-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(pe,{className:"text-lg",children:t}),e.jsx(Ce,{variant:"outline",className:"text-xs",children:s.length})]})}),e.jsx(X,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-t text-xs",children:[e.jsx("thead",{className:"bg-muted/60",children:e.jsxs("tr",{children:[n.map(d=>e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold uppercase text-muted-foreground",children:c(d)},d)),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-semibold uppercase text-muted-foreground",children:c("ops")})]})}),e.jsxs("tbody",{children:[s.map(o),s.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-center text-muted-foreground",colSpan:n.length+1,children:r})})]})]})})})]})}function De({summaryCells:t,detail:s,t:r}){const[o,n]=p.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:he("border-b",o&&"bg-muted/40"),children:[t.map((c,d)=>e.jsx("td",{className:"px-3 py-2 align-top",children:c},d)),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsx(A,{variant:"link",className:"h-auto p-0 text-xs",onClick:()=>n(c=>!c),children:r(o?"admin.systemLogs.actions.collapse":"admin.systemLogs.actions.expand")})})]}),o&&e.jsx("tr",{className:"border-b bg-muted/30",children:e.jsx("td",{colSpan:t.length+1,className:"px-3 py-3",children:s})})]})}function ir({log:t,columnLabel:s}){return e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsx(L,{label:s("id"),value:t.id}),e.jsx(L,{label:s("action"),value:t.action}),e.jsx(L,{label:s("operation_category"),value:t.operation_category||"-"}),e.jsx(L,{label:s("actor_type"),value:t.actor_type}),e.jsx(L,{label:s("status"),value:t.status}),t.details_raw&&e.jsx(ne,{title:"details_raw",value:ee(t.details_raw)}),t.summary&&e.jsx(ne,{title:"summary",value:ee(t.summary)}),(t.old_data||t.new_data)&&e.jsx("div",{className:"space-y-1",children:e.jsx(zs,{oldData:t.old_data,newData:t.new_data})})]})}function lr({log:t,columnLabel:s}){return e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsx(L,{label:s("id"),value:t.id}),e.jsx(L,{label:s("error_type"),value:t.error_type}),e.jsx(L,{label:s("error_file"),value:t.error_file}),e.jsx(L,{label:s("error_line"),value:t.error_line}),e.jsx(ne,{title:"message",value:ee(t.error_message)}),t.stack_trace&&e.jsx("pre",{className:"max-h-64 overflow-auto whitespace-pre-wrap rounded bg-slate-900 p-3 font-mono text-[11px] text-green-300",children:t.stack_trace}),t.context_json&&e.jsx(ne,{title:"context",value:ee(t.context_json)})]})}function cr({log:t,columnLabel:s,onRelated:r,t:o}){return e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(L,{label:s("request_id"),value:t.request_id||"-"}),t.request_id&&e.jsx(A,{variant:"link",className:"h-auto p-0 text-xs",onClick:()=>r==null?void 0:r(t.request_id),children:o("admin.systemLogs.related")})]}),e.jsx(L,{label:s("actor_type"),value:t.actor_type}),e.jsx(L,{label:s("actor_id"),value:t.actor_id||"-"}),e.jsx(L,{label:s("source"),value:t.source||"-"}),e.jsx(L,{label:s("model"),value:t.model||"-"}),e.jsx(L,{label:s("llm_status"),value:t.status||"-"}),e.jsx(L,{label:s("response_id"),value:t.response_id||"-"}),e.jsx(L,{label:s("total_tokens"),value:t.total_tokens??"-"}),e.jsx(L,{label:s("latency_ms"),value:t.latency_ms??"-"}),t.prompt&&e.jsx(ne,{title:"prompt",value:ee(t.prompt)}),t.error_message&&e.jsx(ne,{title:"error_message",value:ee(t.error_message)})]})}function $e({title:t,value:s,onCopy:r,copyLabel:o}){return s?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold",children:t}),e.jsx(A,{variant:"link",className:"h-auto p-0 text-xs",onClick:()=>r(s),children:o})]}),e.jsx(we,{value:ee(s)})]}):null}function ne({title:t,value:s}){return s?e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:t}),e.jsx(we,{value:s})]}):null}function L({label:t,value:s,className:r}){return e.jsxs("div",{className:he("space-x-2",r),children:[e.jsxs("span",{className:"font-semibold",children:[t,":"]}),e.jsx("span",{className:"font-mono break-all text-xs",children:String(s??"-")})]})}function ee(t){if(t==null)return null;if(typeof t=="object")return t;try{return JSON.parse(t)}catch{return t}}function dr(t,s){switch(s){case"id":return t.id;case"actor_type":return t.actor_type;case"actor_id":return t.actor_id??"-";case"source":return t.source||"-";case"model":return t.model||"-";case"llm_status":return t.status||"-";case"total_tokens":return t.total_tokens??"-";case"latency_ms":return t.latency_ms??"-";case"created_at":return t.created_at;default:return t[s]??"-"}}function z(t,s,r){const o=Z(t||""),c=Z(`${s}:${r!==void 0&&r!==""?r:"__probe__"}`),d=Object.keys(c.tokens||{})[0]||s;r?(o.tokens=o.tokens||{},o.tokens[d]=r):o.tokens&&delete o.tokens[d];const a=[];return Object.entries(o.tokens||{}).forEach(([u,h])=>{h&&typeof h=="object"?h.negate?a.push(`${u}!=${h.value}`):a.push(`${u}:${h.value}`):a.push(`${u}:${h}`)}),Object.entries(o.ranges||{}).forEach(([u,h])=>{Object.entries(h).forEach(([j,y])=>{a.push(`${u}${j}${y}`)})}),o.free&&a.push(o.free),a.join(" ").trim()}function Pt(t,s,r,o){const n=Z(t||""),d=Z(`${s}${r}${o!==void 0&&o!==""?o:"__probe__"}`),a=Object.keys(d.ranges||{})[0]||Object.keys(d.tokens||{})[0]||s;n.ranges=n.ranges||{},o?(n.ranges[a]=n.ranges[a]||{},n.ranges[a][r]=o):n.ranges[a]&&(delete n.ranges[a][r],Object.keys(n.ranges[a]).length===0&&delete n.ranges[a]);const u=[];return Object.entries(n.tokens||{}).forEach(([h,j])=>{j&&typeof j=="object"?j.negate?u.push(`${h}!=${j.value}`):u.push(`${h}:${j.value}`):u.push(`${h}:${j}`)}),Object.entries(n.ranges||{}).forEach(([h,j])=>{Object.entries(j).forEach(([y,_])=>{u.push(`${h}${y}${_}`)})}),n.free&&u.push(n.free),u.join(" ").trim()}function mr(t,s){return Pt(t,"dur","<=",s)}function ur(t,s){const r=Z(t||""),o=Z(`${s}:__probe__`),n=Object.keys(o.tokens||{})[0]||s;r.tokens&&delete r.tokens[n];const c=[];return Object.entries(r.tokens||{}).forEach(([d,a])=>{a&&typeof a=="object"?a.negate?c.push(`${d}!=${a.value}`):c.push(`${d}:${a.value}`):c.push(`${d}:${a}`)}),Object.entries(r.ranges||{}).forEach(([d,a])=>{Object.entries(a).forEach(([u,h])=>{c.push(`${d}${u}${h}`)})}),r.free&&c.push(r.free),c.join(" ").trim()}export{Ir as default};
