import{j as e}from"./motion-vendor-C11-9Hm-.js";import{r as c,l as we,R as _e}from"./react-vendor-CFnAvB5y.js";import{c as le,u as ae,B as O,T as me,I as ce,L as V,S as Se,K as J,C as ie,V as Ce,a as ne,X as ke,W as xe,P as Ae}from"./index-CQ91Xfn2.js";import{C as U,a as K,b as X,d as M,c as G}from"./Card-CvB_sIzW.js";import{F as Fe}from"./funnel-Bu-95anb.js";import{u as Le}from"./index.esm-Dwrm2jdL.js";import{b as ze}from"./r2Upload-C1d0O0L4.js";import{A as se,a as te}from"./Alert-B9j1D3yi.js";import{F as De}from"./file-text-Daj9RXZa.js";import{U as ue}from"./upload-oMvU4NIq.js";import{T as Ie}from"./textarea-B3Xlgutj.js";import{C as he}from"./circle-check-big-BEnwQz6W.js";import{A as Ee}from"./arrow-left-BEO8G-T9.js";import"./i18n-vendor-DK0x1_bH.js";import"./charts-vendor-DJkHj7pX.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],Re=le("calendar",Pe);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]],ge=le("car",Te);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=[["path",{d:"M7 19H4.815a1.83 1.83 0 0 1-1.57-.881 1.785 1.785 0 0 1-.004-1.784L7.196 9.5",key:"x6z5xu"}],["path",{d:"M11 19h8.203a1.83 1.83 0 0 0 1.556-.89 1.784 1.784 0 0 0 0-1.775l-1.226-2.12",key:"1x4zh5"}],["path",{d:"m14 16-3 3 3 3",key:"f6jyew"}],["path",{d:"M8.293 13.596 7.196 9.5 3.1 10.598",key:"wf1obh"}],["path",{d:"m9.344 5.811 1.093-1.892A1.83 1.83 0 0 1 11.985 3a1.784 1.784 0 0 1 1.546.888l3.943 6.843",key:"9tzpgr"}],["path",{d:"m13.378 9.633 4.096 1.098 1.097-4.096",key:"1oe83g"}]],fe=le("recycle",$e),Ue={daily:V,transport:ge,consumption:Se,environmental:fe,lifestyle:V,energy:V,water:V,waste:fe,travel:ge};function Me({onActivitySelect:t,selectedActivity:h}){const{t:o,currentLanguage:g}=ae(),[w,N]=c.useState([]),[A,r]=c.useState([]),[E,u]=c.useState([]),[_,L]=c.useState("all"),[j,F]=c.useState(""),[P,R]=c.useState(!0),[q,T]=c.useState("");c.useEffect(()=>{(async()=>{var d,y,v;try{R(!0);const m=await J.getActivities();if((d=m==null?void 0:m.data)!=null&&d.success){const S=(y=m==null?void 0:m.data)==null?void 0:y.data,D=(Array.isArray(S==null?void 0:S.activities)?S.activities:Array.isArray(S)?S:[]).filter(f=>!(!f||f.deleted_at||Object.prototype.hasOwnProperty.call(f,"is_active")&&f.is_active===!1)).map(f=>({...f,carbon_factor:Number(f.carbon_factor??f.factor??0),sort_order:Number(f.sort_order??0)})).sort((f,i)=>{const n=(f.sort_order??0)-(i.sort_order??0);return n!==0?n:(f.name_zh||"").localeCompare(i.name_zh||"")});N(D),r(D);const k=Array.isArray(S==null?void 0:S.categories)?S.categories:[...new Set(D.map(f=>f.category).filter(Boolean))];u(k)}else T(((v=m==null?void 0:m.data)==null?void 0:v.message)||o("errors.loadFailed"))}catch(m){T(m.message||o("errors.network"))}finally{R(!1)}})()},[o]),c.useEffect(()=>{let s=w;if(_!=="all"&&(s=s.filter(d=>d.category===_)),j){const d=(j||"").toString().toLowerCase(),y=v=>(v??"").toString().toLowerCase();s=s.filter(v=>y(v.name_zh).includes(d)||y(v.name_en).includes(d)||y(v.description_zh).includes(d)||y(v.description_en).includes(d))}r(s)},[w,_,j]);const B=s=>{t(s)},z=s=>o(`activities.categories.${s}`)||s,H=s=>(g||"").toLowerCase().startsWith("en")?s.name_en||s.name_zh||s.name:s.name_zh||s.name_en||s.name,W=s=>(g||"").toLowerCase().startsWith("en")?s.description_en||s.description_zh||s.description:s.description_zh||s.description_en||s.description;return P?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"}),e.jsx("span",{className:"ml-2 text-gray-600",children:o("common.loading")})]}):q?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-red-600 mb-4",children:q}),e.jsx(O,{onClick:()=>window.location.reload(),children:o("common.retry")})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(me,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(ce,{type:"text",placeholder:o("activities.searchPlaceholder"),value:j,onChange:s=>F(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-4 w-4 text-gray-400"}),e.jsxs("select",{value:_,onChange:s=>L(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500",children:[e.jsx("option",{value:"all",children:o("activities.categories.all")}),E.map(s=>e.jsx("option",{value:s,children:z(s)},s))]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:A.map(s=>{const d=Ue[s.category]||V,y=(h==null?void 0:h.id)||(h==null?void 0:h.uuid),v=s.id||s.uuid,m=y&&v&&y===v;return e.jsxs(U,{className:`cursor-pointer transition-all duration-200 hover:shadow-md ${m?"ring-2 ring-green-500 bg-green-50":"hover:bg-gray-50"}`,onClick:()=>B(s),children:[e.jsx(K,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${m?"bg-green-200":"bg-gray-100"}`,children:e.jsx(d,{className:`h-5 w-5 ${m?"text-green-700":"text-gray-600"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx(X,{className:"text-sm font-medium",children:H(s)}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:z(s.category)})]})]})}),e.jsxs(M,{className:"pt-0",children:[e.jsx(G,{className:"text-sm text-gray-600 mb-3",children:W(s)}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"text-gray-500",children:[o("activities.unit"),": ",o(`units.${s.unit}`,s.unit)]}),e.jsxs("div",{className:"text-green-600 font-medium",children:[s.carbon_factor," ",o("activities.carbonFactor")]})]}),s.points_per_unit&&e.jsxs("div",{className:"mt-2 text-xs text-blue-600",children:[s.points_per_unit," ",o("activities.pointsPerUnit")]})]})]},v)})}),A.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 mb-2",children:e.jsx(me,{className:"h-12 w-12 mx-auto"})}),e.jsx("p",{className:"text-gray-600",children:o("activities.noActivitiesFound")}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:o("activities.tryDifferentSearch")})]})]})}function Oe({activity:t,onCalculate:h,onSubmit:o,calculationResult:g,isSubmitting:w,initialData:N,checkinDate:A}){const{t:r,currentLanguage:E}=ae(),[u,_]=c.useState([]),[L,j]=c.useState(""),[F,P]=c.useState(!1),[R,q]=c.useState([]),[T,B]=c.useState([]),[z,H]=c.useState({done:0,total:0}),[W,s]=c.useState(!1),[d,y]=c.useState(!1),v=c.useRef(null),{register:m,handleSubmit:S,watch:Q,setValue:D,formState:{errors:k}}=Le({defaultValues:{activity_date:new Date().toISOString().split("T")[0],description:""}});c.useEffect(()=>{N&&N.amount&&(D("data",N.amount),N.description&&D("description",N.description),N.activity_date&&D("activity_date",N.activity_date))},[N,D]);const f=Q("data"),i=c.useRef(""),n=c.useRef(null);c.useEffect(()=>{const a=(t==null?void 0:t.id)||(t==null?void 0:t.uuid)||"",l=f;n.current&&(clearTimeout(n.current),n.current=null);const C=parseFloat(l);if(!a||!l||isNaN(C)||C<=0){s(!1);return}return n.current=setTimeout(()=>{const p=`${a}::${C}`;if(i.current===p){s(!0);return}i.current=p,h(C),s(!0)},300),()=>{n.current&&(clearTimeout(n.current),n.current=null)}},[t,f,h]);const x=async a=>{if(j(""),!u.length&&!R.length){j(r("activities.form.imageRequired")||"请至少选择一张图片");return}let l=R;if(!R.length&&u.length){try{P(!0);const p=u.length;H({done:0,total:p}),l=(await ze(u,{directory:"activities",entityType:"carbon_record"},(I,ee)=>{H({done:I,total:ee})})).map(I=>({url:I.url,file_path:I.file_path,original_name:I.original_name,mime_type:I.mime_type,size:I.size})),q(l)}catch(p){j(p.message||"上传失败"),P(!1);return}P(!1)}const C={activity_id:t.id||t.uuid,amount:parseFloat(a.data),date:a.activity_date,description:a.description,images:(l||[]).map(p=>({url:p.url,file_path:p.file_path,original_name:p.original_name,mime_type:p.mime_type,size:p.size}))};A&&(C.checkin_date=A),o(C)},b=a=>{j("");const l=5,C=5*1024*1024,p=[...u],Y=[...T];if(p.length+a.length>l){j(r("activities.form.maxFilesReached")||"最多只能上传 5 张图片");return}const I=[],ee=[];for(const Z of a){if(Z.size>C){j(r("activities.form.fileTooLarge")||"文件过大");continue}p.some(de=>de.name===Z.name&&de.size===Z.size)||(I.push(Z),ee.push(URL.createObjectURL(Z)))}_([...p,...I]),B([...Y,...ee])},$=a=>{const l=Array.from(a.target.files||[]);b(l),a.target.value=null},re=a=>{a.preventDefault(),a.stopPropagation(),y(!0)},pe=a=>{a.preventDefault(),a.stopPropagation(),y(!1)},je=a=>{a.preventDefault(),a.stopPropagation(),y(!1);const l=Array.from(a.dataTransfer.files||[]);b(l)},ve=()=>{var a;(a=v.current)==null||a.click()},be=a=>{_(l=>l.filter((C,p)=>p!==a)),B(l=>{const C=l.filter((p,Y)=>Y!==a);return l[a]&&URL.revokeObjectURL(l[a]),C})};if(!t)return e.jsx(U,{children:e.jsxs(M,{className:"py-12 text-center",children:[e.jsx(ie,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:r("activities.selectActivityFirst")})]})});const Ne=a=>(E||"").toLowerCase().startsWith("en")?a.name_en||a.name_zh||a.name:a.name_zh||a.name_en||a.name,ye=a=>(E||"").toLowerCase().startsWith("en")?a.description_en||a.description_zh||a.description:a.description_zh||a.description_en||a.description,oe=W&&g?e.jsxs(U,{className:"bg-green-50 border-green-200 shadow-sm",children:[e.jsxs(K,{className:"pb-3",children:[e.jsx(X,{className:"text-sm font-medium text-green-800",children:r("activities.form.calculationResult")}),e.jsx(G,{className:"text-xs",children:r("activities.form.previewAutoUpdate")||"实时预览"})]}),e.jsx(M,{className:"pt-0",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-lg p-3 border",children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1",children:[r("activities.carbonSaved")," (kg CO₂)"]}),e.jsx("div",{className:"text-2xl font-bold text-green-600 leading-none",children:(()=>{const a=g.carbon_saved,l=typeof a=="number"?a:Number(a);return Number.isFinite(l)?l.toFixed(2):"0.00"})()})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:r("activities.form.expectedPoints")}),e.jsx("div",{className:"text-2xl font-bold text-blue-600 leading-none",children:g.points_earned??0})]})]})})]}):null;return e.jsxs("div",{className:"space-y-6 md:space-y-0 md:grid md:grid-cols-12 md:gap-6",children:[e.jsxs("div",{className:"md:col-span-8 space-y-6",children:[e.jsxs(U,{children:[e.jsxs(K,{children:[e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5 text-green-600"}),Ne(t)]}),e.jsx(G,{children:ye(t)})]}),e.jsx(M,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.category"),":"]}),e.jsx("div",{className:"font-medium",children:r(`activities.categories.${t.category}`)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.unit"),":"]}),e.jsx("div",{className:"font-medium",children:r(`units.${t.unit}`,t.unit)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.carbonFactor"),":"]}),e.jsx("div",{className:"font-medium text-green-600",children:t.carbon_factor})]}),t.points_per_unit&&e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.pointsPerUnit"),":"]}),e.jsx("div",{className:"font-medium text-blue-600",children:t.points_per_unit})]})]})})]}),e.jsx("div",{className:"md:hidden",children:oe}),e.jsxs(U,{children:[e.jsxs(K,{children:[e.jsx(X,{children:r("activities.form.dataInput")}),e.jsx(G,{children:r("activities.form.inputDescription")})]}),e.jsx(M,{children:e.jsxs("form",{onSubmit:S(x),className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("activities.form.dataValue")," (",r(`units.${t.unit}`,t.unit),")"]}),e.jsx(ce,{type:"number",step:"0.01",min:"0",placeholder:r("activities.form.dataPlaceholder"),error:k.data,...m("data",{required:r("activities.form.dataRequired"),min:{value:.01,message:r("activities.form.dataMinimum")}})}),k.data&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:k.data.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(Re,{className:"inline h-4 w-4 mr-1"}),r("activities.form.activityDate")]}),e.jsx(ce,{type:"date",max:new Date().toISOString().split("T")[0],error:k.activity_date,...m("activity_date",{required:r("activities.form.dateRequired")})}),k.activity_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:k.activity_date.message}),A&&e.jsx("p",{className:"mt-2 text-xs text-emerald-600",children:r("activities.checkin.makeupHelper","补打卡日期：{{date}}（不影响活动发生时间）",{date:A})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(De,{className:"inline h-4 w-4 mr-1"}),r("activities.form.notes")]}),e.jsx("textarea",{rows:4,placeholder:r("activities.form.notesPlaceholder"),className:`flex w-full rounded-md border bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${k.description?"border-red-500 focus-visible:ring-red-500":"border-input ring-offset-background"}`,...m("description",{maxLength:{value:500,message:r("validation.maxLength",{max:500})}})}),k.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:k.description.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(ue,{className:"inline h-4 w-4 mr-1"}),r("activities.form.uploadImage")]}),e.jsxs("div",{className:ne("border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center gap-3 transition-all duration-200 cursor-pointer",d?"border-green-500 bg-green-50 scale-[1.02]":"border-gray-300 hover:border-green-400 hover:bg-gray-50",L?"border-red-300 bg-red-50":""),onDragOver:re,onDragLeave:pe,onDrop:je,onClick:ve,children:[e.jsx("input",{ref:v,type:"file",accept:"image/*",multiple:!0,onChange:$,className:"hidden"}),e.jsx("div",{className:ne("p-3 rounded-full transition-colors",d?"bg-green-100":"bg-gray-100"),children:e.jsx(ue,{className:ne("h-6 w-6",d?"text-green-600":"text-gray-500")})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:d?r("activities.form.dropHere")||"释放以上传":r("activities.form.clickOrDrag")||"点击或拖拽上传图片"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r("activities.form.uploadHint")||"支持 JPG, PNG (最大 5MB)"})]})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[u.length>0&&e.jsx("ul",{className:"space-y-2 text-sm",children:u.map((a,l)=>e.jsxs("li",{className:"flex items-center justify-between bg-gray-50 px-3 py-2 rounded-md border border-gray-200 hover:border-gray-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[T[l]&&e.jsx("img",{src:T[l],alt:a.name,className:"h-10 w-10 object-cover rounded border border-gray-200"}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"truncate font-medium text-gray-700",children:a.name}),e.jsxs("span",{className:"text-xs text-gray-500",children:[(a.size/1024).toFixed(1)," KB"]})]})]}),e.jsx("button",{type:"button",onClick:C=>{C.stopPropagation(),be(l)},className:"p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors",children:e.jsx(ke,{className:"h-4 w-4"})})]},l))}),F&&e.jsxs("div",{className:"text-xs text-blue-600 flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-2 border-blue-600 border-t-transparent"}),r("common.uploading")||"正在上传..."," ",z.total>0?`${z.done}/${z.total}`:""]}),L&&e.jsxs("p",{className:"text-xs text-red-600 flex items-center gap-1",children:[e.jsx(ie,{className:"h-3 w-3"}),L]})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(O,{type:"submit",className:"flex-1",loading:w||F,disabled:w||F||!W,children:w||F?r("activities.form.submitting")||"提交中...":r("activities.form.submit")}),e.jsx(O,{type:"button",variant:"outline",onClick:()=>window.location.reload(),children:r("common.reset")})]}),e.jsxs(se,{variant:"info",children:[e.jsx(ie,{className:"h-4 w-4"}),e.jsx(te,{children:r("activities.form.submitHint")})]})]})})]})]}),e.jsx("div",{className:"hidden md:block md:col-span-4",children:e.jsx("div",{className:"sticky top-20 space-y-4",children:oe||e.jsxs(U,{className:"border-dashed",children:[e.jsxs(K,{className:"pb-3",children:[e.jsx(X,{className:"text-sm text-gray-600",children:r("activities.form.calculationResult")}),e.jsx(G,{className:"text-xs",children:r("activities.form.enterDataToPreview")||"输入数值后出现"})]}),e.jsx(M,{className:"text-xs text-gray-400",children:r("activities.form.previewPlaceholder")||"填写数据以查看实时计算"})]})})})]})}function qe({onSuggestion:t}){const{t:h}=ae(),[o,g]=c.useState(""),[w,N]=c.useState(!1),[A,r]=c.useState(""),E=async u=>{var _,L;if(u.preventDefault(),!!o.trim()){N(!0),r("");try{const j=Intl.DateTimeFormat().resolvedOptions().timeZone,F=await J.suggestActivity(o,{client_time:new Date().toISOString(),client_timezone:j,entry:"smart-activity-input"});F.data.success?(t(F.data.prediction),g("")):r(F.data.error||"Failed to analyze input")}catch(j){r(((L=(_=j.response)==null?void 0:_.data)==null?void 0:L.error)||j.message||"Error communicating with AI assistant")}finally{N(!1)}}};return e.jsx(U,{className:"bg-gradient-to-r from-green-50 to-blue-50 border-green-100 mb-8",children:e.jsxs(M,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4 text-green-800",children:[e.jsx(xe,{className:"h-5 w-5"}),e.jsx("h3",{className:"font-semibold",children:h("activities.smartAdd.title")||"Smart Add Activity"})]}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ie,{value:o,onChange:u=>g(u.target.value),placeholder:h("activities.smartAdd.placeholder")||"Describe your activity, e.g., 'I took a 5km bus ride'",className:"min-h-[80px] pr-12 bg-white/80 backdrop-blur-sm focus:bg-white transition-all",maxLength:500}),e.jsxs("div",{className:"absolute bottom-3 right-3 text-xs text-gray-400",children:[o.length,"/500"]})]}),A&&e.jsx(se,{variant:"destructive",className:"py-2",children:e.jsx(te,{className:"text-xs",children:A})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(O,{type:"submit",disabled:!o.trim()||w,className:"bg-green-600 hover:bg-green-700 text-white shadow-md hover:shadow-lg transition-all",children:w?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"mr-2 h-4 w-4 animate-spin"}),h("common.processing")||"Analyzing..."]}):e.jsxs(e.Fragment,{children:[h("activities.smartAdd.button")||"Magic Fill",e.jsx(xe,{className:"ml-2 h-4 w-4"})]})})})]})]})})}function Be(){const{t}=ae(),[h,o]=we(),[g,w]=c.useState(1),[N,A]=c.useState([]),[r,E]=c.useState(!1),[u,_]=c.useState(null),[L,j]=c.useState(null),[F,P]=c.useState(null),[R,q]=c.useState(!1),[T,B]=c.useState(!1),[z,H]=c.useState(null),[W,s]=c.useState(""),d=c.useMemo(()=>{const i=h.get("checkin_date");if(!i)return null;const n=String(i).trim();return/^\d{4}-\d{2}-\d{2}$/.test(n)?n:null},[h]),y=c.useCallback(()=>{const i=new URLSearchParams(h);i.delete("checkin_date"),o(i,{replace:!0})},[h,o]);_e.useEffect(()=>{(async()=>{var n,x;try{E(!0);const b=await J.getActivities();if((n=b==null?void 0:b.data)!=null&&n.success){const $=(x=b==null?void 0:b.data)==null?void 0:x.data,re=Array.isArray($==null?void 0:$.activities)?$.activities:Array.isArray($)?$:[];A(re)}}catch(b){console.error("Failed to fetch activities for smart matching",b)}finally{E(!1)}})()},[]);const v=i=>{if(!i)return;let n=null;if(i.activity_uuid&&(n=N.find(x=>String(x.id)===String(i.activity_uuid)||String(x.uuid||"")===String(i.activity_uuid))),!n&&i.activity_name){const x=i.activity_name.toLowerCase();n=N.find(b=>b.name_en&&b.name_en.toLowerCase()===x||b.name_zh&&b.name_zh.toLowerCase()===x||b.name&&b.name.toLowerCase()===x)}n?(_(n),j({amount:i.amount,unit:i.unit,description:i.notes||i.description,activity_date:i.activity_date||null}),w(2),s("")):s(t("activities.smartAdd.notFound")||`Could not find activity type: ${i.activity_name}`)},m=[{id:1,title:t("activities.form.selectActivity"),description:t("activities.form.selectActivityDesc")},{id:2,title:t("activities.form.dataInput"),description:t("activities.form.dataInputDesc")},{id:3,title:t("activities.form.submit"),description:t("activities.form.submitDesc")}],S=i=>{_(i),P(null),s(""),w(2)},Q=c.useCallback(async i=>{if(u){q(!0),s("");try{const n=u.id||u.uuid,x=await J.calculate(n,i);x.data.success?P(x.data.data):s(x.data.message||t("activities.form.calculationFailed"))}catch(n){const x=(n==null?void 0:n.message)||"";if((n==null?void 0:n.code)==="ERR_CANCELED"||/aborted|canceled/i.test(x))return;s(x||t("activities.form.calculationFailed"))}finally{q(!1)}}},[u,t]),D=async i=>{B(!0),s("");try{const n=await J.recordActivity({...i});if(n.data.success){const x=n.data.calculation||{};H({carbon_saved:x.carbon_saved||0,points_earned:x.points_earned||0,record_id:n.data.record_id}),w(3)}else s(n.data.message||t("activities.form.submitFailed"))}catch(n){s(n.message||t("activities.form.submitFailed"))}finally{B(!1)}},k=()=>{w(1),_(null),P(null),H(null),s("")},f=()=>{g>1&&(w(g-1),s(""))};return e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4",children:e.jsx(V,{className:"w-8 h-8 text-green-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:t("activities.title")}),e.jsx("p",{className:"text-gray-600",children:t("activities.description")})]}),e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-between",children:m.map((i,n)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-10 h-10 rounded-full border-2 ${g>=i.id?"bg-green-600 border-green-600 text-white":"border-gray-300 text-gray-500"}`,children:g>i.id?e.jsx(he,{className:"w-6 h-6"}):e.jsx("span",{className:"text-sm font-medium",children:i.id})}),e.jsxs("div",{className:"ml-3 hidden sm:block",children:[e.jsx("div",{className:`text-sm font-medium ${g>=i.id?"text-green-600":"text-gray-500"}`,children:i.title}),e.jsx("div",{className:"text-xs text-gray-500",children:i.description})]}),n<m.length-1&&e.jsx("div",{className:`flex-1 h-0.5 mx-4 ${g>i.id?"bg-green-600":"bg-gray-300"}`})]},i.id))})}),W&&e.jsx(se,{variant:"destructive",className:"mb-6",children:e.jsx(te,{children:W})}),d&&e.jsx(se,{className:"mb-6 border-emerald-200 bg-emerald-50 text-emerald-800",children:e.jsxs(te,{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("span",{children:t("activities.checkin.makeupNotice","补打卡日期：{{date}}，提交记录后将计入该日",{date:d})}),e.jsx(O,{variant:"ghost",size:"sm",onClick:y,children:t("activities.checkin.clear","取消补打卡")})]})}),e.jsxs("div",{className:"space-y-6",children:[g===1&&e.jsxs(e.Fragment,{children:[e.jsx(qe,{onSuggestion:v}),e.jsx(Me,{onActivitySelect:S,selectedActivity:u})]}),g===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(O,{variant:"outline",onClick:f,className:"flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),t("common.back")]}),e.jsx("div",{className:"text-sm text-gray-600",children:t("activities.form.step2Of3")})]}),e.jsx(Oe,{activity:u,onCalculate:Q,onSubmit:D,calculationResult:F,isCalculating:R,isSubmitting:T,initialData:L,checkinDate:d})]}),g===3&&z&&e.jsxs(U,{className:"bg-green-50 border-green-200",children:[e.jsxs(K,{className:"text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4 mx-auto",children:e.jsx(he,{className:"w-8 h-8 text-green-600"})}),e.jsx(X,{className:"text-green-800",children:t("activities.form.submitSuccess")}),e.jsx(G,{children:t("activities.form.submitSuccessDesc")})]}),e.jsxs(M,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:(()=>{const i=z.carbon_saved,n=typeof i=="number"?i:Number(i);return Number.isFinite(n)?n.toFixed(2):"0.00"})()}),e.jsxs("div",{className:"text-sm text-gray-600",children:[t("activities.carbonSaved")," (kg CO₂)"]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:z.points_earned||0}),e.jsx("div",{className:"text-sm text-gray-600",children:t("activities.pointsEarned")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:t("activities.status.pending")}),e.jsx("div",{className:"text-sm text-gray-600",children:t("activities.currentStatus")})]})]}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:t("activities.form.reviewNotice")}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx(O,{onClick:k,children:t("activities.form.recordAnother")}),e.jsx(O,{variant:"outline",onClick:()=>window.location.href="/dashboard",children:t("activities.form.goToDashboard")})]})]})]})]})]})]})}function is(){return e.jsx(Be,{})}export{is as default};
