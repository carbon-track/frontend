import{c as oe,j as e,a as me,u as xe,E,r as u,a3 as f,B as he,A as _,a4 as C,i as Z,o as I,D as G,q as J,p as ge}from"./index-9oiziVwF.js";import{C as d,a as o,b as m,d as x,c as h}from"./Card-DiZzX4G1.js";import{A as ue,a as pe}from"./Alert-DMTWhZOi.js";import{R as je}from"./refresh-cw-BMcL1E4q.js";import{L as H}from"./lock-zRD_BSpU.js";import{C as ye}from"./calendar-days-B_7_WWfo.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M6 9H4.5a2.5 2.5 0 0 1 0-5H6",key:"17hqa7"}],["path",{d:"M18 9h1.5a2.5 2.5 0 0 0 0-5H18",key:"lmptdp"}],["path",{d:"M4 22h16",key:"57wxv0"}],["path",{d:"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22",key:"1nw9bq"}],["path",{d:"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22",key:"1np0yb"}],["path",{d:"M18 2H6v7a6 6 0 0 0 12 0V2Z",key:"u46fv3"}]],K=oe("trophy",fe);function p({className:a,...B}){return e.jsx("div",{"data-slot":"skeleton",className:me("bg-accent animate-pulse rounded-md",a),...B})}const N=600,z=a=>a==null?null:String(a),L=a=>typeof a=="string"&&/^https?:\/\//i.test(a);function Be(){const{t:a}=xe(),{data:B,isLoading:O,isFetching:W,error:X,refetch:F}=E(["badges","all"],async()=>{var t,r;const s=await J.list({include_inactive:!0});if(!((t=s.data)!=null&&t.success))throw new Error(((r=s.data)==null?void 0:r.message)||a("achievements.loadError","成就数据加载失败"));return Array.isArray(s.data.data)?s.data.data:[]},{staleTime:N*1e3}),{data:Y,isLoading:ee,isFetching:se,error:te,refetch:T}=E(["badges","mine"],async()=>{var t,r;const s=await J.myBadges();if(!((t=s.data)!=null&&t.success))throw new Error(((r=s.data)==null?void 0:r.message)||a("achievements.loadError","成就数据加载失败"));return Array.isArray(s.data.data)?s.data.data:[]},{staleTime:N*1e3}),{data:c,isLoading:ae,isFetching:re,error:ne,refetch:S}=E(["user","stats","achievements"],async()=>{var t,r;const s=await ge.getUserStats();if(!((t=s.data)!=null&&t.success))throw new Error(((r=s.data)==null?void 0:r.message)||a("achievements.loadError","成就数据加载失败"));return s.data.data||{}},{staleTime:N*1e3}),w=B||[],P=Y||[],j=u.useMemo(()=>{const s=new Map;return w.forEach(t=>{const r=z((t==null?void 0:t.id)??(t==null?void 0:t.badge_id));r&&s.set(r,t)}),s},[w]),D=u.useMemo(()=>{const s=new Map,t=[];return P.forEach(r=>{if(!r)return;const n=r.user_badge||r;if(!n)return;const l=r.badge||n.badge||null,i=z(n.badge_id??(l==null?void 0:l.id)??r.badge_id);if(!i)return;const v=n.awarded_at||n.created_at||n.updated_at||null,y={badgeId:i,record:n,badge:l||j.get(i)||null,awardedAt:v,progress:n.progress??null,status:n.status||"unlocked",entry:r};t.push(y);const Q=s.get(i);if(Q){const de=f(Q.awardedAt)||new Date(0);(f(v)||new Date(0))>de&&s.set(i,y)}else s.set(i,y)}),{entries:t,latest:s}},[P,j]),b=D.latest,A=u.useMemo(()=>Array.from(b.values()).map(s=>({...s,badge:s.badge||j.get(s.badgeId)||null})).sort((s,t)=>{const r=f(s.awardedAt)||new Date(0);return(f(t.awardedAt)||new Date(0)).getTime()-r.getTime()}),[b,j]),R=u.useMemo(()=>w.filter(s=>{const t=z((s==null?void 0:s.id)??(s==null?void 0:s.badge_id));return t?!b.has(t)&&(s==null?void 0:s.is_deleted)!==!0:!1}),[w,b]),$=u.useMemo(()=>D.entries.map((s,t)=>{var r,n,l,i,v,y;return{id:`${s.badgeId}-${s.awardedAt||t}`,badge:s.badge||j.get(s.badgeId)||null,awardedAt:s.awardedAt,points:((r=s.record)==null?void 0:r.points_earned)??((n=s.entry)==null?void 0:n.points)??((l=s.badge)==null?void 0:l.points)??null,description:((i=s.record)==null?void 0:i.notes)||((v=s.record)==null?void 0:v.description)||((y=s.badge)==null?void 0:y.description)||""}}).filter(s=>s.awardedAt).sort((s,t)=>{const r=f(s.awardedAt)||new Date(0);return(f(t.awardedAt)||new Date(0)).getTime()-r.getTime()}),[D.entries,j]),k=w.length,M=b.size,le=k-M,ce=k>0?Math.round(M/k*100):0,q=u.useMemo(()=>A.reduce((s,t)=>{var n,l;const r=Number(((n=t.record)==null?void 0:n.points_earned)??((l=t.badge)==null?void 0:l.points)??0);return s+(Number.isFinite(r)?r:0)},0),[A]),g=O||ee||ae,U=W||se||re,V=X||te||ne,ie=u.useCallback(async()=>{await Promise.all([F(),T(),S()])},[F,T,S]);return e.jsxs("div",{className:"max-w-6xl mx-auto px-6 py-8 space-y-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(K,{className:"h-8 w-8 text-yellow-500"}),a("achievements.title","我的成就")]}),e.jsx("p",{className:"text-gray-600 mt-2",children:a("achievements.subtitle","查看您已经解锁的徽章和解锁进度。")})]}),e.jsxs(he,{variant:"outline",onClick:ie,disabled:U,className:"self-start md:self-auto",children:[e.jsx(je,{className:`h-4 w-4 mr-2 ${U?"animate-spin":""}`}),a("achievements.refresh","刷新")]})]}),V&&e.jsx(ue,{variant:"destructive",children:e.jsx(pe,{children:V.message||a("achievements.loadError","成就数据加载失败")})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs(d,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(m,{className:"text-sm font-medium text-gray-500",children:a("achievements.summary.totalBadges","徽章总数")}),e.jsx(_,{className:"h-4 w-4 text-yellow-500"})]}),e.jsxs(x,{children:[g?e.jsx(p,{className:"h-7 w-20"}):e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:k}),e.jsx(h,{className:"text-xs text-gray-500 mt-1",children:a("achievements.summary.totalBadgesHint","平台目前提供的全部成就徽章数量。")})]})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(m,{className:"text-sm font-medium text-gray-500",children:a("achievements.summary.unlocked","已解锁")}),e.jsx(C,{className:"h-4 w-4 text-green-500"})]}),e.jsxs(x,{children:[g?e.jsx(p,{className:"h-7 w-20"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:M}),q>0&&e.jsx("p",{className:"text-xs text-green-600 mt-2",children:a("achievements.summary.pointsFromBadges","{{points}} 积分",{points:Z(q,0)})})]}),e.jsx(h,{className:"text-xs text-gray-500 mt-1",children:a("achievements.summary.unlockedHint","您已经达成的徽章数量。")})]})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(m,{className:"text-sm font-medium text-gray-500",children:a("achievements.summary.locked","待解锁")}),e.jsx(H,{className:"h-4 w-4 text-gray-400"})]}),e.jsxs(x,{children:[g?e.jsx(p,{className:"h-7 w-20"}):e.jsx("div",{className:"text-2xl font-bold text-gray-700",children:Math.max(le,0)}),e.jsx(h,{className:"text-xs text-gray-500 mt-1",children:a("achievements.summary.lockedHint","继续完成环保行动即可解锁更多徽章。")})]})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(m,{className:"text-sm font-medium text-gray-500",children:a("achievements.summary.completion","完成度")}),e.jsx(ye,{className:"h-4 w-4 text-blue-500"})]}),e.jsxs(x,{children:[g?e.jsx(p,{className:"h-7 w-24"}):e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[ce,"%"]}),e.jsx(h,{className:"text-xs text-gray-500 mt-1",children:a("achievements.summary.completionHint","当前徽章解锁进度百分比。")})]})]})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"pb-4",children:[e.jsxs(m,{className:"text-lg font-semibold flex items-center gap-2 text-gray-900",children:[e.jsx(_,{className:"h-5 w-5 text-yellow-500"}),a("achievements.unlocked.title","已获得徽章")]}),e.jsx(h,{className:"text-sm text-gray-500",children:a("achievements.unlocked.description","恭喜，您已经解锁了以下成就徽章。")})]}),e.jsx(x,{children:g?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:Array.from({length:6}).map((s,t)=>e.jsx(p,{className:"h-28 rounded-lg"},t))}):A.length===0?e.jsx("div",{className:"text-sm text-gray-500 bg-gray-50 border rounded-md p-6 text-center",children:a("achievements.unlocked.empty","暂时还没有解锁任何徽章，快去参与环保行动吧！")}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:A.map(s=>{var l;const t=s.badge||{},r=L(t.icon_presigned_url)?t.icon_presigned_url:t.icon_url,n=r?void 0:t.icon_path||t.icon_thumbnail_path;return e.jsxs("div",{className:"border rounded-lg p-4 flex gap-4 bg-white hover:shadow-md transition",children:[e.jsx("div",{className:"w-16 h-16 rounded-full border bg-white flex items-center justify-center overflow-hidden",children:r||n?e.jsx(I,{src:r,filePath:n,alt:t.name_zh||t.name_en||t.name||"badge-icon",className:"w-full h-full object-cover",expiresIn:N}):e.jsx(_,{className:"h-8 w-8 text-yellow-500"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("div",{className:"text-base font-semibold text-gray-900",children:t.name_zh||t.name_en||t.name||a("achievements.labels.unnamedBadge","未命名徽章")}),e.jsx("div",{className:"text-xs text-gray-500",children:t.name_en}),s.awardedAt&&e.jsxs("div",{className:"text-xs text-green-600",children:[a("achievements.unlocked.awardedAt","解锁时间"),": ",G(s.awardedAt,"yyyy-MM-dd HH:mm")]}),t.description_zh||t.description_en?e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.description_zh||t.description_en}):null,(l=s.record)!=null&&l.points_earned?e.jsxs("div",{className:"text-xs text-blue-600",children:["+",s.record.points_earned," ",a("common.points","积分")]}):null]})]},s.badgeId)})})})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"pb-4",children:[e.jsxs(m,{className:"text-lg font-semibold flex items-center gap-2 text-gray-900",children:[e.jsx(H,{className:"h-5 w-5 text-gray-500"}),a("achievements.locked.title","待解锁徽章")]}),e.jsx(h,{className:"text-sm text-gray-500",children:a("achievements.locked.description","完成更多环保行动来解锁这些徽章。")})]}),e.jsx(x,{children:g?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:Array.from({length:6}).map((s,t)=>e.jsx(p,{className:"h-28 rounded-lg"},t))}):R.length===0?e.jsx("div",{className:"text-sm text-gray-500 bg-green-50 border border-green-100 rounded-md p-6 text-center",children:a("achievements.locked.empty","太棒了，您已经解锁了所有徽章！")}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:R.map(s=>{const t=L(s.icon_presigned_url)?s.icon_presigned_url:s.icon_url,r=t?void 0:s.icon_path||s.icon_thumbnail_path;return e.jsxs("div",{className:"border rounded-lg p-4 bg-gray-50 hover:bg-gray-100 transition",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-14 h-14 rounded-full border border-dashed border-gray-300 bg-white flex items-center justify-center overflow-hidden",children:t||r?e.jsx(I,{src:t,filePath:r,alt:s.name_zh||s.name_en||s.name||"badge-icon",className:"w-full h-full object-cover opacity-60",expiresIn:N}):e.jsx(H,{className:"h-6 w-6 text-gray-300"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:s.name_zh||s.name_en||s.name||a("achievements.labels.unnamedBadge","未命名徽章")}),e.jsx("div",{className:"text-xs text-gray-500",children:s.name_en})]})]}),s.description_zh||s.description_en?e.jsx("p",{className:"text-sm text-gray-600 mt-3",children:s.description_zh||s.description_en}):null,s.auto_grant_criteria_description?e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[a("achievements.locked.requirements","解锁条件"),": ",s.auto_grant_criteria_description]}):null]},s.id||s.badge_id)})})})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"pb-4",children:[e.jsxs(m,{className:"text-lg font-semibold flex items-center gap-2 text-gray-900",children:[e.jsx(C,{className:"h-5 w-5 text-purple-500"}),a("achievements.timeline.title","成就时间线")]}),e.jsx(h,{className:"text-sm text-gray-500",children:a("achievements.timeline.description","回顾每一次重要的成就时刻。")})]}),e.jsx(x,{children:g?e.jsx("div",{className:"space-y-4",children:Array.from({length:4}).map((s,t)=>e.jsx(p,{className:"h-20 rounded-lg"},t))}):$.length===0?e.jsx("div",{className:"text-sm text-gray-500 bg-gray-50 border rounded-md p-6 text-center",children:a("achievements.timeline.empty","暂时还没有成就记录，先去完成一些环保行动吧。")}):e.jsx("ol",{className:"relative border-l border-gray-200 pl-6 space-y-6",children:$.map(s=>{const t=s.badge||{},r=L(t.icon_presigned_url)?t.icon_presigned_url:t.icon_url,n=r?void 0:t.icon_path||t.icon_thumbnail_path;return e.jsxs("li",{className:"relative",children:[e.jsx("span",{className:"absolute -left-[11px] top-1 flex h-5 w-5 items-center justify-center rounded-full bg-white border border-green-400",children:e.jsx(C,{className:"h-3 w-3 text-green-500"})}),e.jsx("div",{className:"bg-white border rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden border bg-white flex items-center justify-center",children:r||n?e.jsx(I,{src:r,filePath:n,alt:t.name_zh||t.name_en||t.name||"badge-icon",className:"w-full h-full object-cover",expiresIn:N}):e.jsx(_,{className:"h-5 w-5 text-yellow-500"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:t.name_zh||t.name_en||t.name||a("achievements.labels.unnamedBadge","未命名徽章")}),e.jsx("div",{className:"text-xs text-gray-500",children:G(s.awardedAt,"yyyy-MM-dd HH:mm")})]}),s.points?e.jsxs("div",{className:"text-xs text-blue-600",children:["+",Z(s.points,0)," ",a("common.points","积分")]}):null,s.description?e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed",children:s.description}):null]})]})})]},s.id)})})})]}),c&&(c.monthly_achievements||c.leaderboard)&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[Array.isArray(c.monthly_achievements)&&c.monthly_achievements.length>0&&e.jsxs(d,{className:"bg-gradient-to-r from-yellow-50 via-orange-50 to-pink-50 border-yellow-100",children:[e.jsxs(o,{className:"pb-4",children:[e.jsxs(m,{className:"flex items-center gap-2 text-yellow-800",children:[e.jsx(_,{className:"h-5 w-5"}),a("dashboard.monthlyAchievements","本月成就")]}),e.jsx(h,{className:"text-sm text-yellow-700",children:a("achievements.monthly.description","本月新增的徽章与积分奖励。")})]}),e.jsx(x,{className:"space-y-3",children:c.monthly_achievements.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-3 text-sm text-yellow-800",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-yellow-500"}),e.jsx("span",{className:"flex-1",children:s.name||s.title||""}),s.points?e.jsxs("span",{className:"font-semibold text-yellow-700",children:["+",s.points," ",a("common.points","积分")]}):null]},`${s.id||t}`))})]}),Array.isArray(c.leaderboard)&&c.leaderboard.length>0&&e.jsxs(d,{className:"bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 border-blue-100",children:[e.jsxs(o,{className:"pb-4",children:[e.jsxs(m,{className:"flex items-center gap-2 text-blue-900",children:[e.jsx(K,{className:"h-5 w-5"}),a("dashboard.leaderboard","排行榜")]}),e.jsx(h,{className:"text-sm text-blue-800",children:a("achievements.leaderboard.description","看看社区中的优秀环保达人。")})]}),e.jsx(x,{className:"space-y-3",children:c.leaderboard.slice(0,5).map((s,t)=>e.jsxs("div",{className:"flex items-center gap-3 text-sm text-blue-900",children:[e.jsx("div",{className:`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${t===0?"bg-yellow-500 text-white":t===1?"bg-gray-400 text-white":t===2?"bg-orange-500 text-white":"bg-blue-200 text-blue-900"}`,children:t+1}),e.jsx("span",{className:"flex-1 truncate",children:s.username||s.name}),s.total_points?e.jsxs("span",{className:"text-xs font-medium text-blue-800",children:[s.total_points," ",a("common.points","积分")]}):null]},s.id||t))})]})]})]})}export{Be as default};
