import{u as ie,r as d,az as h,n as c,z as ne,j as e,B as o,Y as w,D as L,Q as U,G as le,I as k}from"./index-CUFwAzZ6.js";import{C as $,a as q,b as G,d as O}from"./Card-r7cmfhD9.js";import{T as ce}from"./textarea-YUKlOJOp.js";import{S as V}from"./switch-DX6ZXUrP.js";import{A as de,a as oe,b as me,c as ue,d as xe,e as pe,f as he,g as fe}from"./alert-dialog-DVJpUkm1.js";import{u as ge}from"./r2Upload-CemvpVmP.js";import{R as ve}from"./refresh-cw-D5PjY9Sq.js";import{I as J}from"./image-DZkVgmT6.js";import{S as ye}from"./square-pen-CjAnf8iM.js";import{S as je}from"./star-aSemSzML.js";import{R as _e}from"./rotate-ccw-BNokg1DV.js";import{T as Q}from"./trash-2-DSStjKy2.js";import{U as Ne}from"./upload-CLWaG9HD.js";import"./index-CJRIEbcJ.js";const S={id:null,name:"",description:"",category:"default",file_path:"",icon_url:"",icon_presigned_url:"",sort_order:0,is_active:!0,is_default:!1},j=a=>{const m=(typeof a=="string"?a:"").trim();return m&&m.replace(/[^A-Za-z0-9_-]+/g,"-").replace(/-+/g,"-").replace(/^[-_]+|[-_]+$/g,"").toLowerCase()||"default"},W=(a={})=>{if(!a||typeof a!="object")return{...S};const v=typeof a.file_path=="string"&&a.file_path?a.file_path:"",m=typeof a.icon_path=="string"?a.icon_path.replace(/^[/]+/,""):"",u=v||(m?`/${m}`:""),f=a.icon_url||a.url||a.image_url||"",_=j(a.category);return{...a,category:_,file_path:u,icon_path:m||u.replace(/^[/]+/,""),icon_url:f,icon_presigned_url:a.icon_presigned_url||"",image_url:a.image_url||f||"",url:a.url||f||""}},Y=(a={})=>ne({urlCandidates:[a.icon_url,a.icon_presigned_url],pathCandidates:[a.file_path]});function be(){var H;const{t:a}=ie(),[v,m]=d.useState([]),[u,f]=d.useState(!0),[_,z]=d.useState(!1),[F,I]=d.useState(!1),[r,g]=d.useState(S),[y,P]=d.useState({open:!1,avatar:null}),[T,C]=d.useState(!1),R=d.useRef(null),p=d.useCallback(async()=>{var s;try{f(!0);const t=await h.getAvatars({include_inactive:!0});if((s=t.data)!=null&&s.success){const i=(t.data.data||[]).map(l=>W(l));m(i)}}catch(t){console.error("Avatar list fetch failed:",t),c.error(a("admin.avatars.loadFailed","加载头像列表失败"))}finally{f(!1)}},[a]);d.useEffect(()=>{p()},[p]);const A=()=>{g({...S})},Z=s=>{const t=W(s);g({id:t.id,name:t.name||"",description:t.description||"",category:j(t.category),file_path:t.file_path||"",icon_url:t.icon_url||t.image_url||"",icon_presigned_url:t.icon_presigned_url||"",sort_order:t.sort_order||0,is_active:t.is_active===void 0?!0:!!t.is_active,is_default:!!t.is_default})},N=s=>{const{name:t,value:i}=s.target;g(l=>({...l,[t]:t==="category"?j(i):i}))},M=s=>t=>{g(i=>({...i,[s]:t}))},K=async s=>{var l;const t=(l=s.target.files)==null?void 0:l[0];if(!t)return;if(t.size>5*1024*1024){c.error(a("admin.avatars.fileTooLarge","文件大小不能超过5MB")),s.target.value="";return}I(!0);const i=j(r.category);try{const n=await ge(t,{directory:`avatars/${i}`,entityType:"avatar",entityId:r.id||void 0}),x=(n==null?void 0:n.data)||n;g(b=>({...b,file_path:x.file_path||b.file_path,icon_url:x.url||x.public_url||b.icon_url,icon_presigned_url:x.presigned_url||b.icon_presigned_url})),c.success(a("admin.avatars.uploadSuccess","头像文件上传成功"))}catch(n){c.error((n==null?void 0:n.message)||a("admin.avatars.uploadFailed","头像文件上传失败"))}finally{I(!1),s.target&&(s.target.value="")}},X=async s=>{var i,l;if(s.preventDefault(),!r.file_path){c.error(a("admin.avatars.fileRequired","请先上传头像文件"));return}const t={name:r.name,description:r.description,category:j(r.category),file_path:r.file_path,sort_order:Number(r.sort_order)||0,is_active:!!r.is_active,is_default:!!r.is_default};try{z(!0),r.id?(await h.updateAvatar(r.id,t),c.success(a("admin.avatars.updateSuccess","头像已更新"))):(await h.createAvatar(t),c.success(a("admin.avatars.createSuccess","头像已创建"))),A(),p()}catch(n){c.error(((l=(i=n.response)==null?void 0:i.data)==null?void 0:l.message)||a("admin.avatars.saveFailed","保存头像失败"))}finally{z(!1)}},ee=async s=>{var i,l;const t=!s.is_active;try{await h.updateAvatar(s.id,{is_active:t}),c.success(t?a("admin.avatars.enabled","头像已启用"):a("admin.avatars.disabled","头像已停用")),m(n=>n.map(x=>x.id===s.id?{...x,is_active:t}:x)),g(n=>n.id!==s.id?n:{...n,is_active:t})}catch(n){c.error(((l=(i=n.response)==null?void 0:i.data)==null?void 0:l.message)||a("admin.avatars.toggleFailed","更新头像状态失败"))}},ae=async s=>{var t,i;try{await h.setDefaultAvatar(s),c.success(a("admin.avatars.setDefaultSuccess","已设为默认头像")),p()}catch(l){c.error(((i=(t=l.response)==null?void 0:t.data)==null?void 0:i.message)||a("admin.avatars.setDefaultFailed","设置默认头像失败"))}},D=()=>{P({open:!1,avatar:null}),C(!1)},se=s=>{P({open:!0,avatar:s})},te=async()=>{var s,t;if(y.avatar)try{C(!0),await h.deleteAvatar(y.avatar.id),c.success(a("admin.avatars.deleteSuccess","头像已删除")),D(),p()}catch(i){c.error(((t=(s=i.response)==null?void 0:s.data)==null?void 0:t.message)||a("admin.avatars.deleteFailed","删除头像失败"))}finally{C(!1)}},re=async s=>{var t,i;try{await h.restoreAvatar(s),c.success(a("admin.avatars.restoreSuccess","头像已恢复")),p()}catch(l){c.error(((i=(t=l.response)==null?void 0:t.data)==null?void 0:i.message)||a("admin.avatars.restoreFailed","恢复头像失败"))}},B=d.useMemo(()=>v||[],[v]),E=Y(r);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs($,{children:[e.jsxs(q,{className:"flex items-center justify-between",children:[e.jsx(G,{children:a("admin.avatars.listTitle","头像库")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(o,{variant:"outline",onClick:p,disabled:u,children:[e.jsx(ve,{className:`h-4 w-4 mr-2 ${u?"animate-spin":""}`}),a("common.refresh","刷新")]}),e.jsx(o,{variant:"secondary",onClick:A,children:a("admin.avatars.newAvatar","新建头像")})]})]}),e.jsx(O,{children:u?e.jsxs("div",{className:"flex items-center justify-center py-12 text-gray-500 text-sm",children:[e.jsx(w,{className:"h-5 w-5 mr-2 animate-spin"}),a("common.loading","加载中...")]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.icon","图标")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.name","名称")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.category","分类")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.status","状态")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.sort","排序")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.updated","更新时间")}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-gray-500 uppercase tracking-wider",children:a("common.actions","操作")})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[B.map(s=>{const t=Y(s);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden border bg-gray-100 flex items-center justify-center",children:t.src||t.filePath?e.jsx(L,{src:t.src||void 0,filePath:t.filePath||void 0,alt:s.name,className:"w-full h-full object-cover"}):e.jsx(J,{className:"h-5 w-5 text-gray-400"})})}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500 truncate max-w-[180px]",children:s.description})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.category||"default"}),e.jsxs("td",{className:"px-4 py-3 space-x-2",children:[e.jsx(U,{variant:s.is_active?"success":"secondary",children:s.is_active?a("admin.avatars.active","启用"):a("admin.avatars.inactive","停用")}),s.is_default&&e.jsx(U,{variant:"outline",children:a("admin.avatars.default","默认")})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.sort_order}),e.jsx("td",{className:"px-4 py-3 text-xs text-gray-500",children:s.updated_at?le(new Date(s.updated_at),"yyyy-MM-dd HH:mm"):"--"}),e.jsxs("td",{className:"px-4 py-3 text-right space-x-2",children:[e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>Z(s),children:[e.jsx(ye,{className:"h-4 w-4 mr-1"}),a("common.edit","编辑")]}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>ee(s),children:s.is_active?a("admin.avatars.disable","停用"):a("admin.avatars.enable","启用")}),e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>ae(s.id),disabled:s.is_default,children:[e.jsx(je,{className:"h-4 w-4 mr-1"}),a("admin.avatars.setDefault","设为默认")]}),s.deleted_at?e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>re(s.id),children:[e.jsx(_e,{className:"h-4 w-4 mr-1"}),a("admin.avatars.restore","恢复")]}):e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>se(s),children:[e.jsx(Q,{className:"h-4 w-4 mr-1"}),a("admin.avatars.delete","删除")]})]})]},s.id)}),B.length===0&&!u&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-6 text-center text-sm text-gray-500",children:a("admin.avatars.empty","还没有头像数据")})})]})]})})})]}),e.jsxs($,{children:[e.jsx(q,{children:e.jsx(G,{children:r.id?a("admin.avatars.editTitle","编辑头像"):a("admin.avatars.createTitle","创建新头像")})}),e.jsx(O,{children:e.jsxs("form",{onSubmit:X,className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.name","显示名称")}),e.jsx(k,{name:"name",value:r.name,onChange:N,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.description","描述")}),e.jsx(ce,{name:"description",value:r.description,onChange:N,rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.category","分类")}),e.jsx(k,{name:"category",value:r.category,onChange:N,placeholder:"default"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.icon","上传头像图片")}),e.jsx("input",{ref:R,type:"file",accept:"image/*",className:"hidden",onChange:K}),e.jsxs(o,{type:"button",variant:"outline",onClick:()=>{var s;return(s=R.current)==null?void 0:s.click()},disabled:F,className:"flex items-center gap-2",children:[F?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(Ne,{className:"h-4 w-4"}),a("admin.avatars.selectFile","选择图片并上传")]}),e.jsx("p",{className:"text-xs text-gray-500",children:a("admin.avatars.uploadHint","支持 JPG/PNG/WebP，单个不超过5MB。")}),(r.icon_presigned_url||r.icon_url||r.file_path)&&e.jsx("div",{className:"mt-2 w-20 h-20 rounded-full overflow-hidden border",children:e.jsx(L,{src:E.src||void 0,filePath:E.filePath||void 0,alt:r.name,className:"w-full h-full object-cover"})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.sortOrder","排序")}),e.jsx(k,{type:"number",name:"sort_order",value:r.sort_order,onChange:N})]}),e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 border rounded-md px-3 py-2",children:[e.jsx("span",{className:"text-sm text-gray-700",children:a("admin.avatars.fields.active","是否启用")}),e.jsx(V,{checked:r.is_active,onCheckedChange:M("is_active"),"aria-label":a("admin.avatars.fields.active","是否启用")})]}),e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 border rounded-md px-3 py-2",children:[e.jsx("span",{className:"text-sm text-gray-700",children:a("admin.avatars.fields.default","设为默认")}),e.jsx(V,{checked:r.is_default,onCheckedChange:M("is_default"),"aria-label":a("admin.avatars.fields.default","设为默认")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(o,{type:"submit",disabled:_,children:[_?e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(J,{className:"h-4 w-4 mr-2"}),r.id?a("admin.avatars.updateAction","保存修改"):a("admin.avatars.createAction","创建头像")]}),e.jsx(o,{type:"button",variant:"outline",onClick:A,children:a("common.cancel","取消")})]})]})]})})]}),e.jsx(de,{open:y.open,onOpenChange:s=>s?null:D(),children:e.jsxs(oe,{className:"sm:max-w-md",children:[e.jsxs(me,{children:[e.jsx(ue,{children:a("admin.avatars.deleteTitle","移除头像")}),e.jsxs(xe,{children:[a("admin.avatars.deleteConfirm","确定要停用并移除该头像吗？"),(H=y.avatar)!=null&&H.name?` (${y.avatar.name})`:""]})]}),e.jsxs(pe,{children:[e.jsx(he,{onClick:D,children:a("common.cancel","取消")}),e.jsxs(fe,{onClick:te,className:"bg-red-600 hover:bg-red-700 focus-visible:ring-red-600",disabled:T,children:[T?e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Q,{className:"mr-2 h-4 w-4"}),a("common.confirm","确认")]})]})]})})]})}function Ee(){return e.jsx(be,{})}export{Ee as default};
