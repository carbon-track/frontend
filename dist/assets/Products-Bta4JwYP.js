import{u as xe,ag as he,r as g,a4 as te,aB as fe,n as D,j as e,$ as ye,I as O,B as I,Y as M,D as ne,v as ae,Q as Y,az as R,a9 as je,aa as be,ab as ve,ac as Ne,ad as _e,a1 as J,af as we,a7 as ie,aC as ke}from"./index-CUFwAzZ6.js";import{u as V}from"./useMutation-2MMTcq-v.js";import{u as Ce}from"./r2Upload-CemvpVmP.js";import{T as Pe}from"./textarea-YUKlOJOp.js";import{A as Se,b as Ae,a as De}from"./Alert-DK8cqnXb.js";import{A as Fe,a as Te,b as Ie,c as Oe,d as qe,e as Me,f as Ee,g as Le}from"./alert-dialog-DVJpUkm1.js";import{P as Re}from"./Pagination-CZ9bGkk4.js";import{C as le}from"./circle-plus-CZfmVAwD.js";import{I as oe}from"./image-DZkVgmT6.js";import{S as ze}from"./square-pen-CjAnf8iM.js";import{T as re}from"./trash-2-DSStjKy2.js";const H={name:"",description:"",category:null,points_required:0,stock:-1,status:"active",sort_order:0,image_path:"",image_url:"",image_presigned_url:"",images:[],tags:[]},de=[{value:"active",labelKey:"admin.products.statusActive"},{value:"inactive",labelKey:"admin.products.statusInactive"}],$=(s,i=0)=>{if(s==null||s==="")return i;const o=Number(s);return Number.isFinite(o)?o:i},G=s=>s?s.toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,60):"",X=()=>"tag-"+Math.random().toString(36).slice(2,8),E=s=>{if(!s)return null;if(typeof s=="string"){const i=s.trim();if(!i)return null;const o=i.trim().toLowerCase();return{id:null,name:i,slug:o||i}}if(typeof s=="object"){const i=s.id??s.category_id??s.value??s.key??null,o=i!=null&&i!==""&&!Number.isNaN(Number(i))?Number(i):null,a=s.name??s.category??s.label??s.value??"",h=typeof a=="string"?a.trim():String(a||"").trim(),c=s.slug??s.category_slug??s.value??"";let r=typeof c=="string"?c.trim():String(c||"").trim();!r&&h&&(r=h.trim()),r&&(r=r.toLowerCase()),r||(r=X());const u=typeof c=="string"?c.trim():String(c||"").trim(),x=h||u||r;return x?{id:o,name:x,slug:r}:null}return null},U=s=>Array.isArray(s)?s.map(i=>{const o=E(i);return o?{...o,product_count:(i==null?void 0:i.product_count)??(i==null?void 0:i.count)??(i==null?void 0:i.total)??0}:null}).filter(Boolean):[],ce=s=>{var h,c,r;if(!s)return null;if(typeof s=="string"){const u=s.trim();return u?{id:null,name:u,slug:G(u)||X()}:null}const i=((h=s.name)==null?void 0:h.trim())||((c=s.label)==null?void 0:c.trim())||((r=s.value)==null?void 0:r.trim())||"";if(!i)return null;const o=s.id!==void 0&&s.id!==null&&s.id!==""?Number(s.id):null,a=G(s.slug||i)||X();return{id:o,name:i,slug:a}},Qe=s=>{const i=(s.name||"").trim(),o=E(s.category),a=(s.tags||[]).map(c=>ce(c)).filter(Boolean).reduce((c,r)=>(c.find(x=>x.id&&r.id?x.id===r.id:x.slug===r.slug)||c.push(r),c),[]),h=Array.isArray(s.images)?s.images.filter(Boolean):[];return{name:i,description:s.description||"",category:o?{id:o.id,name:o.name,slug:o.slug}:null,points_required:$(s.points_required),stock:$(s.stock,-1),status:s.status||"active",sort_order:$(s.sort_order,0),image_path:s.image_path||void 0,image_url:s.image_url||void 0,images:h.length?h:void 0,tags:a}};function Be(){var W,Z;const{t:s}=xe(),i=he(),[o,a]=g.useState({search:"",category:"",status:"",page:1,limit:10}),[h,c]=g.useState(!1),[r,u]=g.useState(null),[x,w]=g.useState({open:!1,product:null}),C=te(["adminProducts",o],()=>R.getProducts(o).then(t=>t.data),{keepPreviousData:!0}),S=te("productCategories",()=>ie.getCategories().then(t=>t.data)),k=V(t=>R.createProduct(t)),A=V(({id:t,payload:y})=>R.updateProduct(t,y)),l=V(t=>R.deleteProduct(t)),f=k.isLoading||A.isLoading,P=((W=C.data)==null?void 0:W.data)||C.data||{},d=P.products||P.data||C.data||[],j=g.useMemo(()=>Array.isArray(d)?d:[],[d]),b=P.pagination||{page:o.page,limit:o.limit,total:j.length,pages:1,current_page:o.page,per_page:o.limit,total_items:j.length,total_pages:1},N=g.useMemo(()=>{var F,m;const t=(F=S.data)==null?void 0:F.data,y=Array.isArray(t==null?void 0:t.categories)?t.categories:Array.isArray(t)?t:((m=S.data)==null?void 0:m.categories)||[];return Array.isArray(y)?U(y):[]},[S.data]);g.useEffect(()=>{const t=j.map(y=>{const F=Array.isArray(y.images)?y.images:[],m=F.length>0?F[0]:null,B=(()=>{if(!m)return null;if(typeof m=="string")return m.indexOf("http")===0?null:m;if(typeof m=="object"&&m!==null){if(m.file_path)return m.file_path;if(typeof m.url=="string"&&m.url.indexOf("http")!==0)return m.url}return null})(),p=y.image_path||B||(typeof y.image_url=="string"&&y.image_url.indexOf("http")!==0?y.image_url:null),K=typeof y.image_url=="string"&&y.image_url.indexOf("http")===0&&y.image_url||typeof y.image_presigned_url=="string"&&y.image_presigned_url||m&&typeof m=="string"&&m.indexOf("http")===0&&m||m&&typeof m=="object"&&m!==null&&typeof m.url=="string"&&m.url.indexOf("http")===0&&m.url||m&&typeof m=="object"&&m!==null&&typeof m.presigned_url=="string"&&m.presigned_url;return!p||K?null:p}).filter(Boolean);t.length&&fe(t).catch(()=>{})},[j]);const n=(t,y)=>{a(F=>({...F,[t]:y,page:1}))},v=t=>{a(y=>({...y,page:t}))},_=()=>{c(!1),u(null)},L=()=>{u(null),c(!0)},z=t=>{u(t),c(!0)},Q=()=>{x.product&&l.mutate(x.product.id,{onSuccess:()=>{D.success(s("admin.products.deleteSuccess")),i.invalidateQueries("adminProducts")},onError:()=>{D.error(s("admin.products.deleteFailed"))},onSettled:()=>w({open:!1,product:null})})},q=g.useCallback(t=>{const y=Qe(t);if(r){A.mutate({id:r.id,payload:y},{onSuccess:()=>{D.success(s("admin.products.updateSuccess")),i.invalidateQueries("adminProducts"),_()},onError:()=>{D.error(s("admin.products.updateFailed"))}});return}k.mutate(y,{onSuccess:()=>{D.success(s("admin.products.createSuccess")),i.invalidateQueries("adminProducts"),_()},onError:()=>{D.error(s("admin.products.createFailed"))}})},[k,r,i,s,A]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:s("admin.products.title")}),e.jsx("p",{className:"text-muted-foreground",children:s("admin.products.description")})]}),e.jsx("div",{className:"rounded-lg border bg-white p-6 shadow-sm",children:e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-end md:justify-between",children:[e.jsxs("div",{className:"grid flex-1 grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:s("common.search")}),e.jsxs("div",{className:"relative",children:[e.jsx(ye,{className:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"}),e.jsx(O,{value:o.search,onChange:t=>n("search",t.target.value),placeholder:s("admin.products.searchPlaceholder"),className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:s("admin.products.category")}),e.jsxs("select",{value:o.category,onChange:t=>n("category",t.target.value),className:"mt-0 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-emerald-500 focus:outline-none focus:ring-emerald-500",children:[e.jsx("option",{value:"",children:s("common.all")}),N.map(t=>e.jsx("option",{value:t.slug||t.id||t.name,children:t.name},t.slug||t.id||t.name))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:s("admin.products.status")}),e.jsxs("select",{value:o.status,onChange:t=>n("status",t.target.value),className:"mt-0 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-emerald-500 focus:outline-none focus:ring-emerald-500",children:[e.jsx("option",{value:"",children:s("common.all")}),de.map(t=>e.jsx("option",{value:t.value,children:s(t.labelKey)},t.value))]})]})]}),e.jsxs(I,{onClick:L,className:"shrink-0",children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),s("admin.products.addProduct")]})]})}),C.isLoading||C.isFetching?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx(M,{className:"h-8 w-8 animate-spin text-emerald-500"})}):C.error?e.jsxs(Se,{variant:"destructive",children:[e.jsx(Ae,{children:s("common.error")}),e.jsx(De,{children:s("errors.loadFailed")})]}):j.length===0?e.jsxs("div",{className:"rounded-lg border bg-white p-16 text-center shadow-sm",children:[e.jsx("h3",{className:"text-xl font-semibold",children:s("admin.products.noProductsFound")}),e.jsx("p",{className:"mt-2 text-muted-foreground",children:s("admin.products.tryDifferentFilters")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto rounded-lg border bg-white shadow-sm",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.image")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.name")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.category")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.price")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.stock")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.tags")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.status")}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500",children:s("admin.products.table.actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:j.map(t=>{const y=t.points_required!==void 0&&t.points_required!==null?t.points_required:t.price||0,F=t.stock===0,m=t.stock===-1,B=Array.isArray(t.images)?t.images:[],p=B.length>0?B[0]:null,K=(()=>{if(!p)return null;if(typeof p=="string")return p.indexOf("http")===0?null:p;if(typeof p=="object"&&p!==null){if(p.file_path)return p.file_path;if(typeof p.url=="string"&&p.url.indexOf("http")!==0)return p.url}return null})(),ue=t.image_path||K||(typeof t.image_url=="string"&&t.image_url.indexOf("http")!==0?t.image_url:null),me=typeof t.image_presigned_url=="string"&&t.image_presigned_url?t.image_presigned_url:null,ge=p&&typeof p=="object"&&p!==null&&typeof p.presigned_url=="string"&&p.presigned_url?p.presigned_url:null,ee=[typeof t.image_url=="string"&&t.image_url.indexOf("http")===0?t.image_url:null,p&&typeof p=="string"&&p.indexOf("http")===0?p:null,p&&typeof p=="object"&&p!==null&&typeof p.url=="string"&&p.url.indexOf("http")===0?p.url:null,me,ge].find(T=>typeof T=="string"&&T)||null,se=ue||null;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4",children:se||ee?e.jsx(ne,{filePath:se||void 0,src:ee||void 0,alt:t.name,className:"h-12 w-12 rounded-lg object-cover",fallback:e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-gray-100 text-xs text-gray-400",children:"IMG"})}):e.jsx(oe,{className:"h-10 w-10 text-gray-300"})}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500",children:t.description})]}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:t.category||s("admin.products.form.uncategorized")}),e.jsxs("td",{className:"px-6 py-4 text-sm font-semibold text-green-600",children:[ae(y,0)," ",s("common.points")]}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:m?s("admin.products.unlimited"):ae(t.stock,0)}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:e.jsx("div",{className:"flex flex-wrap gap-1",children:(t.tags||[]).map(T=>{const pe=String(t.id||"product")+"-"+String(T.id!==void 0&&T.id!==null?T.id:T.slug||T.name||"tag");return e.jsx(Y,{variant:"secondary",className:"uppercase",children:T.name},pe)})})}),e.jsx("td",{className:"px-6 py-4 text-sm",children:F?e.jsx("span",{className:"inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800",children:s("admin.products.statusOutOfStock")}):t.status==="active"?e.jsx("span",{className:"inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800",children:s("admin.products.statusActive")}):e.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800",children:s("admin.products.statusInactive")})}),e.jsxs("td",{className:"px-6 py-4 text-right text-sm font-medium",children:[e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>z(t),className:"mr-2",children:e.jsx(ze,{className:"h-4 w-4"})}),e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>w({open:!0,product:t}),className:"text-red-600 hover:text-red-800",children:e.jsx(re,{className:"h-4 w-4"})})]})]},t.id)})})]})}),e.jsx(Re,{currentPage:b.current_page||b.page,totalPages:b.total_pages||b.pages||1,onPageChange:v,itemsPerPage:b.per_page||b.limit,totalItems:b.total_items||b.total})]}),e.jsx(Fe,{open:x.open,onOpenChange:t=>t?null:w({open:!1,product:null}),children:e.jsxs(Te,{className:"sm:max-w-md",children:[e.jsxs(Ie,{children:[e.jsx(Oe,{children:s("admin.products.deleteTitle")}),e.jsx(qe,{children:s("admin.products.confirmDelete",{name:((Z=x.product)==null?void 0:Z.name)||s("admin.products.unnamed")})})]}),e.jsxs(Me,{children:[e.jsx(Ee,{onClick:()=>w({open:!1,product:null}),children:s("common.cancel")}),e.jsxs(Le,{onClick:Q,className:"bg-red-600 hover:bg-red-700 focus-visible:ring-red-600",disabled:l.isLoading,children:[l.isLoading?e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(re,{className:"mr-2 h-4 w-4"}),s("common.confirm")]})]})]})}),h&&e.jsx(Ue,{isOpen:h,onClose:_,onSubmit:q,product:r,categories:N,isSubmitting:f,t:s})]})}function Ue({isOpen:s,onClose:i,onSubmit:o,product:a,categories:h,isSubmitting:c,t:r}){const[u,x]=g.useState(H),[w,C]=g.useState(!1),S=g.useRef(null);g.useEffect(()=>{if(!s){x(H);return}if(a){const n=Array.isArray(a.images)&&a.images.length?a.images[0]:null;x({name:a.name||"",description:a.description||"",category:E({id:a.category_id??a.categoryId??null,name:a.category??"",slug:a.category_slug??a.categorySlug??""}),points_required:a.points_required!==void 0&&a.points_required!==null?a.points_required:a.price||0,stock:a.stock!==void 0&&a.stock!==null?a.stock:-1,status:a.status||"active",sort_order:a.sort_order!==void 0&&a.sort_order!==null?a.sort_order:0,image_path:a.image_path||(typeof a.image_url=="string"&&a.image_url.indexOf("http")!==0?a.image_url:"")||(n==null?void 0:n.file_path)||"",image_url:typeof a.image_url=="string"?a.image_url:(n==null?void 0:n.url)||"",image_presigned_url:a.image_presigned_url||(n==null?void 0:n.presigned_url)||"",images:Array.isArray(a.images)?a.images:[],tags:Array.isArray(a.tags)?a.tags.map(v=>({id:v.id!==void 0?v.id:null,name:v.name,slug:v.slug||G(v.name)})):[]})}else x(H)},[s,a]);const k=n=>v=>{x(_=>({..._,[n]:v.target.value}))},A=n=>{x(v=>({...v,tags:n}))},l=n=>{x(v=>({...v,category:E(n)}))},f=async n=>{const v=n.target.files&&n.target.files[0];if(v){if(v.size>5*1024*1024){D.error(r("admin.products.form.fileTooLarge","图片大小不能超过 5MB")),n.target.value="";return}C(!0);try{const _=await Ce(v,{directory:"products",entityType:"product",entityId:a?a.id:void 0});let L=_.url||_.public_url||_.presigned_url||"";if(!L&&_.file_path)try{L=await ke(_.file_path,600)}catch(q){console.warn("Preview presign failed",q)}const z=_.public_url||_.url||"",Q={file_path:_.file_path,url:z,presigned_url:_.presigned_url||L||null,thumbnail_path:_.thumbnail_path||null};x(q=>({...q,image_path:_.file_path||q.image_path,image_url:z,image_presigned_url:Q.presigned_url||"",images:[Q]})),D.success(r("admin.products.form.uploadSuccess","图片上传成功"))}catch{D.error(r("admin.products.form.uploadFailed","图片上传失败，请重试"))}finally{C(!1),n.target&&(n.target.value="")}}},P=()=>{x(n=>({...n,image_path:"",image_url:"",image_presigned_url:"",images:[]}))},d=n=>{n.preventDefault();const v=(u.name||"").trim();if(!v){D.error(r("validation.required"));return}const _=v===u.name?u:{...u,name:v};o(_)},j=u.image_url||u.image_presigned_url||"",b=u.image_path||(j&&j.indexOf("http")!==0?j:""),N=!b&&j&&j.indexOf("http")===0?j:"";return e.jsx(je,{open:s,onOpenChange:n=>n?null:i(),children:e.jsxs(be,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsx(Ne,{children:r(a?"admin.products.editProduct":"admin.products.addProduct")}),e.jsx(_e,{children:r("admin.products.formModal.description")})]}),e.jsxs("form",{onSubmit:d,className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"product-name",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.name")}),e.jsx(O,{id:"product-name",value:u.name,onChange:k("name"),required:!0})]}),e.jsx("div",{children:e.jsx(Ke,{value:u.category,onChange:l,initialCategories:h,t:r})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-status",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.status")}),e.jsx("select",{id:"product-status",value:u.status,onChange:k("status"),className:"mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-emerald-500 focus:outline-none focus:ring-emerald-500",children:de.map(n=>e.jsx("option",{value:n.value,children:r(n.labelKey)},n.value))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-points",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.pointsRequired")}),e.jsx(O,{id:"product-points",type:"number",min:0,value:u.points_required,onChange:k("points_required"),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-stock",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.stock")}),e.jsx(O,{id:"product-stock",type:"number",value:u.stock,onChange:k("stock")}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:r("admin.products.form.stockHint")})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-sort-order",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.sortOrder")}),e.jsx(O,{id:"product-sort-order",type:"number",value:u.sort_order,onChange:k("sort_order")})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"product-description",className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.description")}),e.jsx(Pe,{id:"product-description",value:u.description,onChange:k("description"),className:"min-h-[120px]"})]}),e.jsx("div",{children:e.jsx(Ve,{value:u.tags,onChange:A,t:r})}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700",children:r("admin.products.form.image")}),e.jsxs("div",{className:"mt-2 flex items-center gap-4",children:[b||N?e.jsx(ne,{filePath:b||void 0,src:N||void 0,alt:u.name||"product",className:"h-20 w-20 rounded-lg object-cover",fallback:e.jsx("div",{className:"flex h-20 w-20 items-center justify-center rounded-lg bg-gray-100 text-xs text-gray-400",children:"IMG"})}):e.jsx("div",{className:"flex h-20 w-20 items-center justify-center rounded-lg border border-dashed border-gray-300 bg-gray-50 text-gray-400",children:e.jsx(oe,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(I,{type:"button",variant:"outline",onClick:()=>S.current&&S.current.click(),disabled:w||c,children:[w?e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(le,{className:"mr-2 h-4 w-4"}),r(w?"admin.products.form.uploading":"admin.products.form.chooseImage")]}),(b||N)&&e.jsxs(I,{type:"button",variant:"ghost",onClick:P,disabled:c,children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),r("admin.products.form.removeImage")]})]}),e.jsx("p",{className:"text-xs text-gray-500",children:r("admin.products.form.imageHint")})]})]}),e.jsx("input",{ref:S,type:"file",accept:"image/*",className:"hidden",onChange:f})]}),e.jsxs(we,{children:[e.jsx(I,{type:"button",variant:"outline",onClick:i,disabled:c||w,children:r("common.cancel")}),e.jsxs(I,{type:"submit",disabled:c||w,children:[c?e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}):null,r(c?"common.saving":"common.save")]})]})]})]})})}function Ke({value:s,onChange:i,initialCategories:o=[],t:a}){const[h,c]=g.useState(""),r=g.useMemo(()=>"product-category-input-"+Math.random().toString(36).slice(2,8),[]),[u,x]=g.useState(()=>U(o)),[w,C]=g.useState(!1),S=g.useRef(null),k=E(s);g.useEffect(()=>{const d=U(o);d.length&&x(j=>{const b=new Map;return d.forEach(N=>{const n=(N.slug||N.name||"").toLowerCase();n&&b.set(n,N)}),j.forEach(N=>{if(!N)return;const n=(N.slug||N.name||"").toLowerCase();n&&!b.has(n)&&b.set(n,N)}),Array.from(b.values())})},[o]);const A=g.useCallback(async d=>{var j,b;C(!0);try{const N=await ie.getCategories({search:d||"",limit:12}),n=(j=N.data)==null?void 0:j.data,v=Array.isArray(n==null?void 0:n.categories)?n.categories:Array.isArray(n)?n:((b=N.data)==null?void 0:b.categories)||[];x(U(v))}catch(N){console.error("Category search failed",N)}finally{C(!1)}},[]);g.useEffect(()=>{A("")},[A]),g.useEffect(()=>(S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{A(h.trim())},250),()=>{S.current&&clearTimeout(S.current)}),[h,A]);const l=g.useCallback(d=>{const j=E(d);j&&(typeof i=="function"&&i(j),c(""))},[i]),f=g.useCallback(()=>{const d=h.trim();d&&l({name:d})},[h,l]),P=g.useCallback(()=>{typeof i=="function"&&i(null)},[i]);return e.jsxs("div",{children:[e.jsx("label",{htmlFor:r,className:"block text-sm font-medium text-gray-700",children:a("admin.products.form.category")}),e.jsx("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:k?e.jsxs(Y,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx("span",{children:k.name}),e.jsx("button",{type:"button",className:"rounded-full p-0.5 hover:bg-gray-200",onClick:P,"aria-label":a("admin.products.form.removeCategory","移除分类"),children:e.jsx(J,{className:"h-3 w-3"})})]}):e.jsx("span",{className:"text-xs text-gray-500",children:a("admin.products.form.categoryPlaceholder")})}),e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsx(O,{id:r,value:h,onChange:d=>c(d.target.value),onKeyDown:d=>{d.key==="Enter"&&(d.preventDefault(),f())},placeholder:a("admin.products.form.categorySearchPlaceholder","输入或搜索分类名称")}),e.jsx(I,{type:"button",variant:"outline",onClick:f,disabled:!h.trim(),children:a("admin.products.form.useCategory","使用分类")})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:a("admin.products.form.categoryHint","可选择已有分类或输入新分类，新分类会自动保存。")}),e.jsxs("div",{className:"mt-3 rounded-md border bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-3 py-2 text-xs font-medium uppercase tracking-wide text-gray-500",children:[e.jsx("span",{children:a("admin.products.form.suggestions")}),w?e.jsx(M,{className:"h-3.5 w-3.5 animate-spin text-emerald-500"}):null]}),e.jsx("div",{className:"max-h-44 overflow-y-auto",children:u.length===0&&!w?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:a("admin.products.form.noCategorySuggestions","暂无匹配的分类，按回车创建新的分类。")}):u.map(d=>{const j=`category-suggestion-${d.slug||d.id||d.name}`,b=k&&(k.slug===d.slug||k.name===d.name);return e.jsxs("button",{type:"button",onClick:()=>l(d),className:`flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-white ${b?"bg-white":""}`,children:[e.jsx("span",{children:d.name}),e.jsx("span",{className:"text-xs uppercase text-gray-400",children:d.product_count!==void 0&&d.product_count!==null?d.product_count:d.slug})]},j)})})]})]})}function Ve({value:s,onChange:i,t:o}){const[a,h]=g.useState(""),[c,r]=g.useState([]),[u,x]=g.useState(!1),w=g.useRef(null),C=g.useCallback(async l=>{var f,P;x(!0);try{const d=await R.searchProductTags({search:l||"",limit:12});r(((P=(f=d.data)==null?void 0:f.data)==null?void 0:P.tags)||[])}catch(d){console.error("Tag search failed",d)}finally{x(!1)}},[]);g.useEffect(()=>{C("")},[C]),g.useEffect(()=>(w.current&&clearTimeout(w.current),w.current=setTimeout(()=>{C(a.trim())},250),()=>{w.current&&clearTimeout(w.current)}),[a,C]);const S=l=>{const f=ce(l);if(!f)return;(s||[]).some(d=>d.id&&f.id?d.id===f.id:d.slug===f.slug)||i([].concat(s||[],[f]))},k=()=>{const l=a.trim();if(!l)return;const f=c.find(P=>(P.name||"").toLowerCase()===l.toLowerCase());S(f||l),h("")},A=l=>{const f=(s||[]).slice();f.splice(l,1),i(f)};return e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:o("admin.products.form.tags")}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:(s||[]).map((l,f)=>{const P="selected-tag-"+f+"-"+(l.id!==void 0&&l.id!==null?l.id:l.slug||l.name||"tag");return e.jsxs(Y,{variant:"secondary",className:"flex items-center gap-1 uppercase",children:[e.jsx("span",{children:l.name}),e.jsx("button",{type:"button",className:"rounded-full p-0.5 hover:bg-gray-200",onClick:()=>A(f),"aria-label":o("admin.products.form.removeTag","移除标签"),children:e.jsx(J,{className:"h-3 w-3"})})]},P)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{value:a,onChange:l=>h(l.target.value),onKeyDown:l=>{l.key==="Enter"&&(l.preventDefault(),k())},placeholder:o("admin.products.form.tagPlaceholder")}),e.jsx(I,{type:"button",variant:"outline",onClick:k,disabled:!a.trim(),children:o("admin.products.form.addTag")})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:o("admin.products.form.tagHint")})]}),e.jsxs("div",{className:"mt-3 rounded-md border bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-3 py-2 text-xs font-medium uppercase tracking-wide text-gray-500",children:[e.jsx("span",{children:o("admin.products.form.suggestions")}),u?e.jsx(M,{className:"h-3.5 w-3.5 animate-spin text-emerald-500"}):null]}),e.jsx("div",{className:"max-h-44 overflow-y-auto",children:c.length===0&&!u?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:o("admin.products.form.noSuggestions")}):c.map((l,f)=>{const P="suggestion-"+(l.id!==void 0&&l.id!==null?l.id:l.slug||l.name||"tag")+"-"+f;return e.jsxs("button",{type:"button",onClick:()=>{S(l),h("")},className:"flex w-full items-center justify-between px-3 py-2 text-left text-sm hover:bg-white",children:[e.jsx("span",{children:l.name}),l.slug?e.jsx("span",{className:"text-xs uppercase text-gray-400",children:l.slug}):null]},P)})})]})]})}function rs(){return e.jsx(Be,{})}export{rs as default};
