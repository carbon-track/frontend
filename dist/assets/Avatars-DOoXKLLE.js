import{u as te,r as d,aj as h,n as c,j as e,B as o,w,o as H,G as L,ak as ie,I as k}from"./index-Q2ufERwv.js";import{C as U,a as $,b as q,d as G}from"./Card-Di9kSeqW.js";import{T as re}from"./textarea-C0p0rEN5.js";import{S as O}from"./switch-U-EKeIJH.js";import{A as ne,a as le,b as ce,c as de,d as oe,e as me,f as ue,g as xe}from"./alert-dialog-BFYgQkLR.js";import{u as pe}from"./r2Upload-BS-MAFTD.js";import{R as he}from"./refresh-cw-ChKhx_FH.js";import{I as V}from"./image-DR_5eD-h.js";import{S as fe}from"./square-pen-CSmwqwZq.js";import{S as ge}from"./star-B5Q309D-.js";import{R as ye}from"./rotate-ccw-CbVvGU9b.js";import{T as J}from"./trash-2-Bau3YyKn.js";import{U as ve}from"./upload-ChFLbmfM.js";import"./index-B2g8qkjK.js";const S={id:null,name:"",description:"",category:"default",file_path:"",icon_url:"",icon_presigned_url:"",sort_order:0,is_active:!0,is_default:!1},j=a=>{const m=(typeof a=="string"?a:"").trim();return m&&m.replace(/[^A-Za-z0-9_-]+/g,"-").replace(/-+/g,"-").replace(/^[-_]+|[-_]+$/g,"").toLowerCase()||"default"},W=(a={})=>{if(!a||typeof a!="object")return{...S};const y=typeof a.file_path=="string"&&a.file_path?a.file_path:"",m=typeof a.icon_path=="string"?a.icon_path.replace(/^[/]+/,""):"",u=y||(m?`/${m}`:""),f=a.icon_url||a.url||a.image_url||"",_=j(a.category);return{...a,category:_,file_path:u,icon_path:m||u.replace(/^[/]+/,""),icon_url:f,icon_presigned_url:a.icon_presigned_url||"",image_url:a.image_url||f||"",url:a.url||f||""}};function je(){var E;const{t:a}=te(),[y,m]=d.useState([]),[u,f]=d.useState(!0),[_,z]=d.useState(!1),[F,T]=d.useState(!1),[i,g]=d.useState(S),[v,P]=d.useState({open:!1,avatar:null}),[I,A]=d.useState(!1),R=d.useRef(null),p=d.useCallback(async()=>{var s;try{f(!0);const t=await h.getAvatars({include_inactive:!0});if((s=t.data)!=null&&s.success){const r=(t.data.data||[]).map(l=>W(l));m(r)}}catch(t){console.error("Avatar list fetch failed:",t),c.error(a("admin.avatars.loadFailed","加载头像列表失败"))}finally{f(!1)}},[a]);d.useEffect(()=>{p()},[p]);const C=()=>{g({...S})},Z=s=>{const t=W(s);g({id:t.id,name:t.name||"",description:t.description||"",category:j(t.category),file_path:t.file_path||"",icon_url:t.icon_url||t.image_url||"",icon_presigned_url:t.icon_presigned_url||"",sort_order:t.sort_order||0,is_active:t.is_active===void 0?!0:!!t.is_active,is_default:!!t.is_default})},N=s=>{const{name:t,value:r}=s.target;g(l=>({...l,[t]:t==="category"?j(r):r}))},M=s=>t=>{g(r=>({...r,[s]:t}))},K=async s=>{var l;const t=(l=s.target.files)==null?void 0:l[0];if(!t)return;if(t.size>5*1024*1024){c.error(a("admin.avatars.fileTooLarge","文件大小不能超过5MB")),s.target.value="";return}T(!0);const r=j(i.category);try{const n=await pe(t,{directory:`avatars/${r}`,entityType:"avatar",entityId:i.id||void 0}),x=(n==null?void 0:n.data)||n;g(b=>({...b,file_path:x.file_path||b.file_path,icon_url:x.url||x.public_url||b.icon_url,icon_presigned_url:x.presigned_url||b.icon_presigned_url})),c.success(a("admin.avatars.uploadSuccess","头像文件上传成功"))}catch(n){c.error((n==null?void 0:n.message)||a("admin.avatars.uploadFailed","头像文件上传失败"))}finally{T(!1),s.target&&(s.target.value="")}},Q=async s=>{var r,l;if(s.preventDefault(),!i.file_path){c.error(a("admin.avatars.fileRequired","请先上传头像文件"));return}const t={name:i.name,description:i.description,category:j(i.category),file_path:i.file_path,sort_order:Number(i.sort_order)||0,is_active:!!i.is_active,is_default:!!i.is_default};try{z(!0),i.id?(await h.updateAvatar(i.id,t),c.success(a("admin.avatars.updateSuccess","头像已更新"))):(await h.createAvatar(t),c.success(a("admin.avatars.createSuccess","头像已创建"))),C(),p()}catch(n){c.error(((l=(r=n.response)==null?void 0:r.data)==null?void 0:l.message)||a("admin.avatars.saveFailed","保存头像失败"))}finally{z(!1)}},X=async s=>{var r,l;const t=!s.is_active;try{await h.updateAvatar(s.id,{is_active:t}),c.success(t?a("admin.avatars.enabled","头像已启用"):a("admin.avatars.disabled","头像已停用")),m(n=>n.map(x=>x.id===s.id?{...x,is_active:t}:x)),g(n=>n.id!==s.id?n:{...n,is_active:t})}catch(n){c.error(((l=(r=n.response)==null?void 0:r.data)==null?void 0:l.message)||a("admin.avatars.toggleFailed","更新头像状态失败"))}},Y=async s=>{var t,r;try{await h.setDefaultAvatar(s),c.success(a("admin.avatars.setDefaultSuccess","已设为默认头像")),p()}catch(l){c.error(((r=(t=l.response)==null?void 0:t.data)==null?void 0:r.message)||a("admin.avatars.setDefaultFailed","设置默认头像失败"))}},D=()=>{P({open:!1,avatar:null}),A(!1)},ee=s=>{P({open:!0,avatar:s})},ae=async()=>{var s,t;if(v.avatar)try{A(!0),await h.deleteAvatar(v.avatar.id),c.success(a("admin.avatars.deleteSuccess","头像已删除")),D(),p()}catch(r){c.error(((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.message)||a("admin.avatars.deleteFailed","删除头像失败"))}finally{A(!1)}},se=async s=>{var t,r;try{await h.restoreAvatar(s),c.success(a("admin.avatars.restoreSuccess","头像已恢复")),p()}catch(l){c.error(((r=(t=l.response)==null?void 0:t.data)==null?void 0:r.message)||a("admin.avatars.restoreFailed","恢复头像失败"))}},B=d.useMemo(()=>y||[],[y]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(U,{children:[e.jsxs($,{className:"flex items-center justify-between",children:[e.jsx(q,{children:a("admin.avatars.listTitle","头像库")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(o,{variant:"outline",onClick:p,disabled:u,children:[e.jsx(he,{className:`h-4 w-4 mr-2 ${u?"animate-spin":""}`}),a("common.refresh","刷新")]}),e.jsx(o,{variant:"secondary",onClick:C,children:a("admin.avatars.newAvatar","新建头像")})]})]}),e.jsx(G,{children:u?e.jsxs("div",{className:"flex items-center justify-center py-12 text-gray-500 text-sm",children:[e.jsx(w,{className:"h-5 w-5 mr-2 animate-spin"}),a("common.loading","加载中...")]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.icon","图标")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.name","名称")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.category","分类")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.status","状态")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.sort","排序")}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-500 uppercase tracking-wider",children:a("admin.avatars.table.updated","更新时间")}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-gray-500 uppercase tracking-wider",children:a("common.actions","操作")})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[B.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden border bg-gray-100 flex items-center justify-center",children:s.file_path?e.jsx(H,{src:s.icon_presigned_url||s.icon_url,filePath:!s.icon_presigned_url&&!s.icon_url?s.file_path:void 0,alt:s.name,className:"w-full h-full object-cover"}):e.jsx(V,{className:"h-5 w-5 text-gray-400"})})}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500 truncate max-w-[180px]",children:s.description})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.category||"default"}),e.jsxs("td",{className:"px-4 py-3 space-x-2",children:[e.jsx(L,{variant:s.is_active?"success":"secondary",children:s.is_active?a("admin.avatars.active","启用"):a("admin.avatars.inactive","停用")}),s.is_default&&e.jsx(L,{variant:"outline",children:a("admin.avatars.default","默认")})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.sort_order}),e.jsx("td",{className:"px-4 py-3 text-xs text-gray-500",children:s.updated_at?ie(new Date(s.updated_at),"yyyy-MM-dd HH:mm"):"--"}),e.jsxs("td",{className:"px-4 py-3 text-right space-x-2",children:[e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>Z(s),children:[e.jsx(fe,{className:"h-4 w-4 mr-1"}),a("common.edit","编辑")]}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>X(s),children:s.is_active?a("admin.avatars.disable","停用"):a("admin.avatars.enable","启用")}),e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>Y(s.id),disabled:s.is_default,children:[e.jsx(ge,{className:"h-4 w-4 mr-1"}),a("admin.avatars.setDefault","设为默认")]}),s.deleted_at?e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>se(s.id),children:[e.jsx(ye,{className:"h-4 w-4 mr-1"}),a("admin.avatars.restore","恢复")]}):e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>ee(s),children:[e.jsx(J,{className:"h-4 w-4 mr-1"}),a("admin.avatars.delete","删除")]})]})]},s.id)),B.length===0&&!u&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-6 text-center text-sm text-gray-500",children:a("admin.avatars.empty","还没有头像数据")})})]})]})})})]}),e.jsxs(U,{children:[e.jsx($,{children:e.jsx(q,{children:i.id?a("admin.avatars.editTitle","编辑头像"):a("admin.avatars.createTitle","创建新头像")})}),e.jsx(G,{children:e.jsxs("form",{onSubmit:Q,className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.name","显示名称")}),e.jsx(k,{name:"name",value:i.name,onChange:N,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.description","描述")}),e.jsx(re,{name:"description",value:i.description,onChange:N,rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.category","分类")}),e.jsx(k,{name:"category",value:i.category,onChange:N,placeholder:"default"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.icon","上传头像图片")}),e.jsx("input",{ref:R,type:"file",accept:"image/*",className:"hidden",onChange:K}),e.jsxs(o,{type:"button",variant:"outline",onClick:()=>{var s;return(s=R.current)==null?void 0:s.click()},disabled:F,className:"flex items-center gap-2",children:[F?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(ve,{className:"h-4 w-4"}),a("admin.avatars.selectFile","选择图片并上传")]}),e.jsx("p",{className:"text-xs text-gray-500",children:a("admin.avatars.uploadHint","支持 JPG/PNG/WebP，单个不超过5MB。")}),(i.icon_presigned_url||i.icon_url||i.file_path)&&e.jsx("div",{className:"mt-2 w-20 h-20 rounded-full overflow-hidden border",children:e.jsx(H,{src:i.icon_presigned_url||i.icon_url,filePath:!i.icon_presigned_url&&!i.icon_url?i.file_path:void 0,alt:i.name,className:"w-full h-full object-cover"})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:a("admin.avatars.fields.sortOrder","排序")}),e.jsx(k,{type:"number",name:"sort_order",value:i.sort_order,onChange:N})]}),e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 border rounded-md px-3 py-2",children:[e.jsx("span",{className:"text-sm text-gray-700",children:a("admin.avatars.fields.active","是否启用")}),e.jsx(O,{checked:i.is_active,onCheckedChange:M("is_active"),"aria-label":a("admin.avatars.fields.active","是否启用")})]}),e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 border rounded-md px-3 py-2",children:[e.jsx("span",{className:"text-sm text-gray-700",children:a("admin.avatars.fields.default","设为默认")}),e.jsx(O,{checked:i.is_default,onCheckedChange:M("is_default"),"aria-label":a("admin.avatars.fields.default","设为默认")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(o,{type:"submit",disabled:_,children:[_?e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(V,{className:"h-4 w-4 mr-2"}),i.id?a("admin.avatars.updateAction","保存修改"):a("admin.avatars.createAction","创建头像")]}),e.jsx(o,{type:"button",variant:"outline",onClick:C,children:a("common.cancel","取消")})]})]})]})})]}),e.jsx(ne,{open:v.open,onOpenChange:s=>s?null:D(),children:e.jsxs(le,{className:"sm:max-w-md",children:[e.jsxs(ce,{children:[e.jsx(de,{children:a("admin.avatars.deleteTitle","移除头像")}),e.jsxs(oe,{children:[a("admin.avatars.deleteConfirm","确定要停用并移除该头像吗？"),(E=v.avatar)!=null&&E.name?` (${v.avatar.name})`:""]})]}),e.jsxs(me,{children:[e.jsx(ue,{onClick:D,children:a("common.cancel","取消")}),e.jsxs(xe,{onClick:ae,className:"bg-red-600 hover:bg-red-700 focus-visible:ring-red-600",disabled:I,children:[I?e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(J,{className:"mr-2 h-4 w-4"}),a("common.confirm","确认")]})]})]})})]})}function Re(){return e.jsx(je,{})}export{Re as default};
