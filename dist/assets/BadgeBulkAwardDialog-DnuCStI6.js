import{c as ne,r as m,j as e,al as ie,a as U,u as re,F as oe,aj as E,N as ce,O as le,Q as de,T as me,V as ue,B as p,I as xe,w as K,U as he,X as ge,A as V,G as Q,n as S}from"./index-C4ClwSHN.js";import{C as fe}from"./checkbox-DF8OYBwY.js";import{S as q}from"./scroll-area-DVcjV-4P.js";import{U as je}from"./user-plus-BFDT8f2v.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Ne=ne("user-minus",pe);var ye="Separator",G="horizontal",ve=["horizontal","vertical"],X=m.forwardRef((r,o)=>{const{decorative:c,orientation:l=G,...u}=r,f=we(l)?l:G,t=c?{role:"none"}:{"aria-orientation":f==="vertical"?f:void 0,role:"separator"};return e.jsx(ie.div,{"data-orientation":f,...t,...u,ref:o})});X.displayName=ye;function we(r){return ve.includes(r)}var Se=X;function ke({className:r,orientation:o="horizontal",decorative:c=!0,...l}){return e.jsx(Se,{"data-slot":"separator-root",decorative:c,orientation:o,className:U("bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",r),...l})}function be(r,o=400){const[c,l]=m.useState(r);return m.useEffect(()=>{const u=setTimeout(()=>l(r),o);return()=>clearTimeout(u)},[r,o]),c}const Ae=r=>{var c,l;const o=((c=r==null?void 0:r.data)==null?void 0:c.data)??(r==null?void 0:r.data)??{};return Array.isArray(o==null?void 0:o.users)?o.users:Array.isArray((l=o==null?void 0:o.data)==null?void 0:l.users)?o.data.users:[]},De=(r,o,c)=>r(c,"{{count}} 个",{count:o});function Ie({open:r,onOpenChange:o,badges:c=[],defaultSelectedBadgeIds:l=[],presetUsers:u=[],onCompleted:f,mode:z="award"}){const{t}=re(),d=z==="revoke",n=["admin","badges",d?"bulkRevokeDialog":"bulkAwardDialog"],[j,w]=m.useState(()=>new Set(l)),[N,k]=m.useState(""),[g,b]=m.useState(u),[A,I]=m.useState(!1),[y,D]=m.useState(null),B=be(N.trim(),400);m.useEffect(()=>{r?(w(new Set(l)),u!=null&&u.length&&b(s=>{const a=new Map;return[...u,...s].forEach(i=>{i&&typeof i.id<"u"&&a.set(i.id,i)}),Array.from(a.values())})):(D(null),k(""))},[r,l,u]);const T=m.useMemo(()=>new Map(c.map(s=>[s.id,s])),[c]),v=m.useMemo(()=>[...c].sort((s,a)=>((a==null?void 0:a.sort_order)??0)-((s==null?void 0:s.sort_order)??0)),[c]),$=m.useMemo(()=>{const s=Array.from(j);if(!s.length)return t([...n,"noBadgeSelected"].join("."),d?"未选择需收回的徽章":"未选择徽章");if(s.length===1){const a=T.get(s[0]);return(a==null?void 0:a.name_zh)||(a==null?void 0:a.name_en)||"#"+s[0]}return De(t,s.length,[...n,"badgeCountSummary"].join("."))},[T,j,t,n]),{data:J,isLoading:C,isFetching:P}=oe(["admin","users",d?"badge-revoke-search":"badge-award-search",B],async()=>{const s=await E.getUsers({search:B,limit:20});return Ae(s)},{enabled:r&&B.length>=1,keepPreviousData:!0}),R=J||[],_=s=>{w(a=>{const i=new Set(a);return i.has(s)?i.delete(s):i.add(s),i})},W=()=>{j.size===v.length?w(new Set):w(new Set(v.map(s=>s.id)))},Y=s=>{!s||typeof s.id>"u"||b(a=>a.some(i=>i.id===s.id)?a:[...a,s])},M=s=>{b(a=>a.filter(i=>i.id!==s))},Z=d?E.revokeBadge:E.awardBadge,ee=async()=>{var F,L;const s=Array.from(j);if(!s.length){S.error(t([...n,"selectBadgeError"].join("."),"请至少选择一个徽章"));return}if(!g.length){S.error(t([...n,"selectUserError"].join("."),"请至少选择一个用户"));return}I(!0),D({processed:0,total:s.length*g.length,success:0,failed:0});let a=0,i=0;const x=[];for(const O of s)for(const H of g)try{await Z(O,{user_id:H.id}),a+=1}catch(h){i+=1,x.push({badgeId:O,user:H,message:((L=(F=h==null?void 0:h.response)==null?void 0:F.data)==null?void 0:L.message)||(h==null?void 0:h.message)||"Unknown error"})}finally{D(h=>({processed:((h==null?void 0:h.processed)??0)+1,total:s.length*g.length,success:a,failed:i}))}I(!1),a&&S.success(t([...n,"success"].join("."),d?"已成功收回 {{count}} 次徽章":"已成功授予 {{count}} 次徽章",{count:a})),i&&S.error(t([...n,"partialFailed"].join("."),"{{failed}} 条操作失败",{failed:i})),f==null||f({success:a,failed:i,failures:x}),i||o(!1)},se=s=>{const a=j.has(s.id),i=x=>{(x.key==="Enter"||x.key===" ")&&(x.preventDefault(),_(s.id))};return e.jsxs("div",{role:"button",tabIndex:0,"aria-pressed":a,className:U("flex w-full flex-col items-start gap-2 rounded-lg border p-4 text-left transition hover:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40",a?"border-primary bg-primary/5":"border-border"),onClick:()=>_(s.id),onKeyDown:i,children:[e.jsxs("div",{className:"flex w-full items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:U("h-5 w-5",a?"text-primary":"text-muted-foreground")}),e.jsx("span",{className:"font-medium leading-tight",children:s.name_zh||s.name_en})]}),e.jsx(fe,{checked:a,onCheckedChange:()=>_(s.id),onClick:x=>x.stopPropagation(),onKeyDown:x=>x.stopPropagation()})]}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:s.description_zh||s.description_en||t([...n,"noDescription"].join("."),"暂无描述")}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(Q,{variant:s.is_active?"success":"secondary",children:s.is_active?t("admin.badges.active","启用"):t("admin.badges.inactive","停用")}),s.auto_grant_enabled?e.jsx(Q,{variant:"outline",children:t("admin.badges.autoEnabled","自动授予")}):null]})]},s.id)},te=s=>{const a=g.some(i=>i.id===s.id);return e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-md border px-3 py-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium leading-tight",children:s.username||s.email||"#"+s.id}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.email||t([...n,"noEmail"].join("."),"无邮箱")," · ID: ",s.id]})]}),e.jsx(p,{type:"button",size:"sm",variant:a?"secondary":"outline",onClick:()=>a?M(s.id):Y(s),children:a?t("common.remove","移除"):t("common.add",d?"加入收回列表":"加入授予列表")})]},s.id)},ae=d?Ne:je;return e.jsx(ce,{open:r,onOpenChange:o,children:e.jsxs(le,{className:"max-w-4xl",children:[e.jsxs(de,{children:[e.jsx(me,{children:t([...n,"dialogTitle"].join("."),d?"批量收回徽章":"批量授予徽章")}),e.jsx(ue,{children:t([...n,"dialogDescription"].join("."),d?"选择徽章与用户，系统会逐一收回并记录日志。":"选择徽章与用户，系统会逐一授予并记录日志。")})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold leading-none tracking-tight",children:t([...n,"badgeSelection"].join("."),d?"选择需要收回的徽章":"选择要授予的徽章")}),e.jsx(p,{variant:"ghost",size:"sm",onClick:W,children:j.size===v.length?t([...n,"clearAllBadges"].join("."),"清空选择"):t([...n,"selectAllBadges"].join("."),"全选徽章")})]}),e.jsx(q,{className:"h-72 rounded-lg border",children:e.jsxs("div",{className:"grid gap-3 p-3",children:[v.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t([...n,"noBadges"].join("."),"暂无可用徽章，请先创建。")}),v.map(se)]})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t([...n,"selectedSummary"].join("."),"已选择：{{summary}}",{summary:$})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold leading-none tracking-tight",children:t([...n,"userSelection"].join("."),d?"选择需要收回的用户":"选择要授予的用户")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t([...n,"userSelectionHint"].join("."),"支持通过用户名或邮箱搜索，或从下方列表移除。")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{value:N,onChange:s=>k(s.target.value),placeholder:t([...n,"userSearchPlaceholder"].join("."),"搜索用户名、邮箱或ID")}),e.jsx(p,{type:"button",variant:"outline",onClick:()=>k(""),children:t("common.reset","重置")})]}),e.jsx(q,{className:"h-32 rounded-lg border",children:e.jsxs("div",{className:"space-y-2 p-3",children:[!!N&&(C||P)&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(K,{className:"h-4 w-4 animate-spin"}),t("common.loading","加载中...")]}),!!N&&!C&&!P&&R.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:t([...n,"noUserFound"].join("."),"未找到匹配的用户")}),R.map(te),!N&&g.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:t([...n,"startSearchHint"].join("."),"输入关键词以搜索目标用户。")})]})}),e.jsx(ke,{}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("h3",{className:"text-sm font-semibold leading-none tracking-tight",children:t([...n,"selectedUsers"].join("."),"已选择的用户")})]}),e.jsxs("div",{className:"mt-3 grid gap-2",children:[g.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:t([...n,"noUserSelected"].join("."),"暂未选择用户")}),g.map(s=>e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-md border px-3 py-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium leading-tight",children:s.username||s.email||"#"+s.id}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["ID: ",s.id]})]}),e.jsx(p,{type:"button",size:"icon",variant:"ghost",onClick:()=>M(s.id),children:e.jsx(ge,{className:"h-4 w-4"})})]},s.id))]})]})]})]}),e.jsxs("div",{className:"flex flex-col gap-3 border-t pt-4",children:[y&&e.jsx("p",{className:"text-xs text-muted-foreground",children:t([...n,"progress"].join("."),"处理进度：{{processed}} / {{total}} · 成功 {{success}} · 失败 {{failed}}",{processed:y.processed,total:y.total,success:y.success,failed:y.failed})}),e.jsxs("div",{className:"flex flex-col gap-2 text-xs text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx(ae,{className:"mr-1 inline-block h-3 w-3"}),t([...n,"tipUsers"].join("."),d?"可多选用户，系统会逐一收回并记录操作日志。":"可多选用户，系统会逐一授予并记录操作日志。")]}),e.jsxs("p",{children:[e.jsx(V,{className:"mr-1 inline-block h-3 w-3"}),t([...n,"tipBadges"].join("."),"徽章选择支持单选或多选，将逐个执行。")]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:[e.jsx(p,{variant:"ghost",onClick:()=>o(!1),disabled:A,children:t("common.cancel","取消")}),e.jsxs(p,{onClick:ee,disabled:A,children:[A&&e.jsx(K,{className:"mr-2 h-4 w-4 animate-spin"}),t([...n,"confirm"].join("."),d?"开始收回":"开始授予")]})]})]})]})})}export{Ie as B};
