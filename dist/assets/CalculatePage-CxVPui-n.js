import{c as te,u as Q,r as c,j as e,B as O,y as le,I as se,b as H,S as ye,p as K,C as Y,z as we,a as ee,X as _e,D as oe,w as Se,R as Ce}from"./index-Q2ufERwv.js";import{C as $,a as W,b as V,d as U,c as X}from"./Card-Di9kSeqW.js";import{F as Ae}from"./funnel-Bmh45i1V.js";import{u as ke}from"./index.esm-DjovsZr0.js";import{b as Fe}from"./r2Upload-BS-MAFTD.js";import{A as ae,a as re}from"./Alert-D_808RnX.js";import{F as De}from"./file-text-As-p7tUQ.js";import{U as de}from"./upload-ChFLbmfM.js";import{T as ze}from"./textarea-C0p0rEN5.js";import{C as me}from"./circle-check-big-CGb8GKrL.js";import{A as Le}from"./arrow-left-wOiP2Nkm.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],Ee=te("calendar",Ie);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]],xe=te("car",Re);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M7 19H4.815a1.83 1.83 0 0 1-1.57-.881 1.785 1.785 0 0 1-.004-1.784L7.196 9.5",key:"x6z5xu"}],["path",{d:"M11 19h8.203a1.83 1.83 0 0 0 1.556-.89 1.784 1.784 0 0 0 0-1.775l-1.226-2.12",key:"1x4zh5"}],["path",{d:"m14 16-3 3 3 3",key:"f6jyew"}],["path",{d:"M8.293 13.596 7.196 9.5 3.1 10.598",key:"wf1obh"}],["path",{d:"m9.344 5.811 1.093-1.892A1.83 1.83 0 0 1 11.985 3a1.784 1.784 0 0 1 1.546.888l3.943 6.843",key:"9tzpgr"}],["path",{d:"m13.378 9.633 4.096 1.098 1.097-4.096",key:"1oe83g"}]],ue=te("recycle",Pe),Te={daily:H,transport:xe,consumption:ye,environmental:ue,lifestyle:H,energy:H,water:H,waste:ue,travel:xe};function $e({onActivitySelect:a,selectedActivity:m}){const{t:o,currentLanguage:k}=Q(),[F,w]=c.useState([]),[r,j]=c.useState([]),[N,z]=c.useState([]),[S,C]=c.useState("all"),[p,D]=c.useState(""),[R,q]=c.useState(!0),[I,E]=c.useState("");c.useEffect(()=>{(async()=>{var u,y,h;try{q(!0);const g=await K.getActivities();if((u=g==null?void 0:g.data)!=null&&u.success){const _=(y=g==null?void 0:g.data)==null?void 0:y.data,i=(Array.isArray(_==null?void 0:_.activities)?_.activities:Array.isArray(_)?_:[]).filter(l=>!(!l||l.deleted_at||Object.prototype.hasOwnProperty.call(l,"is_active")&&l.is_active===!1)).map(l=>({...l,carbon_factor:Number(l.carbon_factor??l.factor??0),sort_order:Number(l.sort_order??0)})).sort((l,v)=>{const B=(l.sort_order??0)-(v.sort_order??0);return B!==0?B:(l.name_zh||"").localeCompare(v.name_zh||"")});w(i),j(i);const x=Array.isArray(_==null?void 0:_.categories)?_.categories:[...new Set(i.map(l=>l.category).filter(Boolean))];z(x)}else E(((h=g==null?void 0:g.data)==null?void 0:h.message)||o("errors.loadFailed"))}catch(g){E(g.message||o("errors.network"))}finally{q(!1)}})()},[o]),c.useEffect(()=>{let s=F;if(S!=="all"&&(s=s.filter(u=>u.category===S)),p){const u=(p||"").toString().toLowerCase(),y=h=>(h??"").toString().toLowerCase();s=s.filter(h=>y(h.name_zh).includes(u)||y(h.name_en).includes(u)||y(h.description_zh).includes(u)||y(h.description_en).includes(u))}j(s)},[F,S,p]);const P=s=>{a(s)},T=s=>o(`activities.categories.${s}`)||s,b=s=>(k||"").toLowerCase().startsWith("en")?s.name_en||s.name_zh||s.name:s.name_zh||s.name_en||s.name,M=s=>(k||"").toLowerCase().startsWith("en")?s.description_en||s.description_zh||s.description:s.description_zh||s.description_en||s.description;return R?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"}),e.jsx("span",{className:"ml-2 text-gray-600",children:o("common.loading")})]}):I?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-red-600 mb-4",children:I}),e.jsx(O,{onClick:()=>window.location.reload(),children:o("common.retry")})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(le,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(se,{type:"text",placeholder:o("activities.searchPlaceholder"),value:p,onChange:s=>D(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-4 w-4 text-gray-400"}),e.jsxs("select",{value:S,onChange:s=>C(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500",children:[e.jsx("option",{value:"all",children:o("activities.categories.all")}),N.map(s=>e.jsx("option",{value:s,children:T(s)},s))]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:r.map(s=>{const u=Te[s.category]||H,y=(m==null?void 0:m.id)||(m==null?void 0:m.uuid),h=s.id||s.uuid,g=y&&h&&y===h;return e.jsxs($,{className:`cursor-pointer transition-all duration-200 hover:shadow-md ${g?"ring-2 ring-green-500 bg-green-50":"hover:bg-gray-50"}`,onClick:()=>P(s),children:[e.jsx(W,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${g?"bg-green-200":"bg-gray-100"}`,children:e.jsx(u,{className:`h-5 w-5 ${g?"text-green-700":"text-gray-600"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx(V,{className:"text-sm font-medium",children:b(s)}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:T(s.category)})]})]})}),e.jsxs(U,{className:"pt-0",children:[e.jsx(X,{className:"text-sm text-gray-600 mb-3",children:M(s)}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"text-gray-500",children:[o("activities.unit"),": ",o(`units.${s.unit}`,s.unit)]}),e.jsxs("div",{className:"text-green-600 font-medium",children:[s.carbon_factor," ",o("activities.carbonFactor")]})]}),s.points_per_unit&&e.jsxs("div",{className:"mt-2 text-xs text-blue-600",children:[s.points_per_unit," ",o("activities.pointsPerUnit")]})]})]},h)})}),r.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 mb-2",children:e.jsx(le,{className:"h-12 w-12 mx-auto"})}),e.jsx("p",{className:"text-gray-600",children:o("activities.noActivitiesFound")}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:o("activities.tryDifferentSearch")})]})]})}function Ue({activity:a,onCalculate:m,onSubmit:o,calculationResult:k,isSubmitting:F,initialData:w}){const{t:r,currentLanguage:j}=Q(),[N,z]=c.useState([]),[S,C]=c.useState(""),[p,D]=c.useState(!1),[R,q]=c.useState([]),[I,E]=c.useState([]),[P,T]=c.useState({done:0,total:0}),[b,M]=c.useState(!1),[s,u]=c.useState(!1),y=c.useRef(null),{register:h,handleSubmit:g,watch:_,setValue:n,formState:{errors:i}}=ke({defaultValues:{activity_date:new Date().toISOString().split("T")[0],description:""}});c.useEffect(()=>{w&&w.amount&&(n("data",w.amount),w.description&&n("description",w.description),w.activity_date&&n("activity_date",w.activity_date))},[w,n]);const x=_("data"),l=c.useRef(""),v=c.useRef(null);c.useEffect(()=>{const t=(a==null?void 0:a.id)||(a==null?void 0:a.uuid)||"",d=x;v.current&&(clearTimeout(v.current),v.current=null);const A=parseFloat(d);if(!t||!d||isNaN(A)||A<=0){M(!1);return}return v.current=setTimeout(()=>{const f=`${t}::${A}`;if(l.current===f){M(!0);return}l.current=f,m(A),M(!0)},300),()=>{v.current&&(clearTimeout(v.current),v.current=null)}},[a,x,m]);const B=async t=>{if(C(""),!N.length&&!R.length){C(r("activities.form.imageRequired")||"请至少选择一张图片");return}let d=R;if(!R.length&&N.length){try{D(!0);const f=N.length;T({done:0,total:f}),d=(await Fe(N,{directory:"activities",entityType:"carbon_record"},(L,J)=>{T({done:L,total:J})})).map(L=>({url:L.url,file_path:L.file_path,original_name:L.original_name,mime_type:L.mime_type,size:L.size})),q(d)}catch(f){C(f.message||"上传失败"),D(!1);return}D(!1)}const A={activity_id:a.id||a.uuid,amount:parseFloat(t.data),date:t.activity_date,description:t.description,images:(d||[]).map(f=>({url:f.url,file_path:f.file_path,original_name:f.original_name,mime_type:f.mime_type,size:f.size}))};o(A)},ie=t=>{C("");const d=5,A=5*1024*1024,f=[...N],Z=[...I];if(f.length+t.length>d){C(r("activities.form.maxFilesReached")||"最多只能上传 5 张图片");return}const L=[],J=[];for(const G of t){if(G.size>A){C(r("activities.form.fileTooLarge")||"文件过大");continue}f.some(ce=>ce.name===G.name&&ce.size===G.size)||(L.push(G),J.push(URL.createObjectURL(G)))}z([...f,...L]),E([...Z,...J])},he=t=>{const d=Array.from(t.target.files||[]);ie(d),t.target.value=null},ge=t=>{t.preventDefault(),t.stopPropagation(),u(!0)},fe=t=>{t.preventDefault(),t.stopPropagation(),u(!1)},pe=t=>{t.preventDefault(),t.stopPropagation(),u(!1);const d=Array.from(t.dataTransfer.files||[]);ie(d)},ve=()=>{var t;(t=y.current)==null||t.click()},je=t=>{z(d=>d.filter((A,f)=>f!==t)),E(d=>{const A=d.filter((f,Z)=>Z!==t);return d[t]&&URL.revokeObjectURL(d[t]),A})};if(!a)return e.jsx($,{children:e.jsxs(U,{className:"py-12 text-center",children:[e.jsx(Y,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:r("activities.selectActivityFirst")})]})});const be=t=>(j||"").toLowerCase().startsWith("en")?t.name_en||t.name_zh||t.name:t.name_zh||t.name_en||t.name,Ne=t=>(j||"").toLowerCase().startsWith("en")?t.description_en||t.description_zh||t.description:t.description_zh||t.description_en||t.description,ne=b&&k?e.jsxs($,{className:"bg-green-50 border-green-200 shadow-sm",children:[e.jsxs(W,{className:"pb-3",children:[e.jsx(V,{className:"text-sm font-medium text-green-800",children:r("activities.form.calculationResult")}),e.jsx(X,{className:"text-xs",children:r("activities.form.previewAutoUpdate")||"实时预览"})]}),e.jsx(U,{className:"pt-0",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-lg p-3 border",children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-1",children:[r("activities.carbonSaved")," (kg CO₂)"]}),e.jsx("div",{className:"text-2xl font-bold text-green-600 leading-none",children:(()=>{const t=k.carbon_saved,d=typeof t=="number"?t:Number(t);return Number.isFinite(d)?d.toFixed(2):"0.00"})()})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:r("activities.form.expectedPoints")}),e.jsx("div",{className:"text-2xl font-bold text-blue-600 leading-none",children:k.points_earned??0})]})]})})]}):null;return e.jsxs("div",{className:"space-y-6 md:space-y-0 md:grid md:grid-cols-12 md:gap-6",children:[e.jsxs("div",{className:"md:col-span-8 space-y-6",children:[e.jsxs($,{children:[e.jsxs(W,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"h-5 w-5 text-green-600"}),be(a)]}),e.jsx(X,{children:Ne(a)})]}),e.jsx(U,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.category"),":"]}),e.jsx("div",{className:"font-medium",children:r(`activities.categories.${a.category}`)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.unit"),":"]}),e.jsx("div",{className:"font-medium",children:r(`units.${a.unit}`,a.unit)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.carbonFactor"),":"]}),e.jsx("div",{className:"font-medium text-green-600",children:a.carbon_factor})]}),a.points_per_unit&&e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-500",children:[r("activities.pointsPerUnit"),":"]}),e.jsx("div",{className:"font-medium text-blue-600",children:a.points_per_unit})]})]})})]}),e.jsx("div",{className:"md:hidden",children:ne}),e.jsxs($,{children:[e.jsxs(W,{children:[e.jsx(V,{children:r("activities.form.dataInput")}),e.jsx(X,{children:r("activities.form.inputDescription")})]}),e.jsx(U,{children:e.jsxs("form",{onSubmit:g(B),className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[r("activities.form.dataValue")," (",r(`units.${a.unit}`,a.unit),")"]}),e.jsx(se,{type:"number",step:"0.01",min:"0",placeholder:r("activities.form.dataPlaceholder"),error:i.data,...h("data",{required:r("activities.form.dataRequired"),min:{value:.01,message:r("activities.form.dataMinimum")}})}),i.data&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.data.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(Ee,{className:"inline h-4 w-4 mr-1"}),r("activities.form.activityDate")]}),e.jsx(se,{type:"date",max:new Date().toISOString().split("T")[0],error:i.activity_date,...h("activity_date",{required:r("activities.form.dateRequired")})}),i.activity_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.activity_date.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(De,{className:"inline h-4 w-4 mr-1"}),r("activities.form.notes")]}),e.jsx("textarea",{rows:4,placeholder:r("activities.form.notesPlaceholder"),className:`flex w-full rounded-md border bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${i.description?"border-red-500 focus-visible:ring-red-500":"border-input ring-offset-background"}`,...h("description",{maxLength:{value:500,message:r("validation.maxLength",{max:500})}})}),i.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.description.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(de,{className:"inline h-4 w-4 mr-1"}),r("activities.form.uploadImage")]}),e.jsxs("div",{className:ee("border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center gap-3 transition-all duration-200 cursor-pointer",s?"border-green-500 bg-green-50 scale-[1.02]":"border-gray-300 hover:border-green-400 hover:bg-gray-50",S?"border-red-300 bg-red-50":""),onDragOver:ge,onDragLeave:fe,onDrop:pe,onClick:ve,children:[e.jsx("input",{ref:y,type:"file",accept:"image/*",multiple:!0,onChange:he,className:"hidden"}),e.jsx("div",{className:ee("p-3 rounded-full transition-colors",s?"bg-green-100":"bg-gray-100"),children:e.jsx(de,{className:ee("h-6 w-6",s?"text-green-600":"text-gray-500")})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:s?r("activities.form.dropHere")||"释放以上传":r("activities.form.clickOrDrag")||"点击或拖拽上传图片"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r("activities.form.uploadHint")||"支持 JPG, PNG (最大 5MB)"})]})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[N.length>0&&e.jsx("ul",{className:"space-y-2 text-sm",children:N.map((t,d)=>e.jsxs("li",{className:"flex items-center justify-between bg-gray-50 px-3 py-2 rounded-md border border-gray-200 hover:border-gray-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[I[d]&&e.jsx("img",{src:I[d],alt:t.name,className:"h-10 w-10 object-cover rounded border border-gray-200"}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"truncate font-medium text-gray-700",children:t.name}),e.jsxs("span",{className:"text-xs text-gray-500",children:[(t.size/1024).toFixed(1)," KB"]})]})]}),e.jsx("button",{type:"button",onClick:A=>{A.stopPropagation(),je(d)},className:"p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors",children:e.jsx(_e,{className:"h-4 w-4"})})]},d))}),p&&e.jsxs("div",{className:"text-xs text-blue-600 flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-2 border-blue-600 border-t-transparent"}),r("common.uploading")||"正在上传..."," ",P.total>0?`${P.done}/${P.total}`:""]}),S&&e.jsxs("p",{className:"text-xs text-red-600 flex items-center gap-1",children:[e.jsx(Y,{className:"h-3 w-3"}),S]})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(O,{type:"submit",className:"flex-1",loading:F||p,disabled:F||p||!b,children:F||p?r("activities.form.submitting")||"提交中...":r("activities.form.submit")}),e.jsx(O,{type:"button",variant:"outline",onClick:()=>window.location.reload(),children:r("common.reset")})]}),e.jsxs(ae,{variant:"info",children:[e.jsx(Y,{className:"h-4 w-4"}),e.jsx(re,{children:r("activities.form.submitHint")})]})]})})]})]}),e.jsx("div",{className:"hidden md:block md:col-span-4",children:e.jsx("div",{className:"sticky top-20 space-y-4",children:ne||e.jsxs($,{className:"border-dashed",children:[e.jsxs(W,{className:"pb-3",children:[e.jsx(V,{className:"text-sm text-gray-600",children:r("activities.form.calculationResult")}),e.jsx(X,{className:"text-xs",children:r("activities.form.enterDataToPreview")||"输入数值后出现"})]}),e.jsx(U,{className:"text-xs text-gray-400",children:r("activities.form.previewPlaceholder")||"填写数据以查看实时计算"})]})})})]})}function Me({onSuggestion:a}){const{t:m}=Q(),[o,k]=c.useState(""),[F,w]=c.useState(!1),[r,j]=c.useState(""),N=async z=>{var S,C;if(z.preventDefault(),!!o.trim()){w(!0),j("");try{const p=Intl.DateTimeFormat().resolvedOptions().timeZone,D=await K.suggestActivity(o,{client_time:new Date().toISOString(),client_timezone:p});D.data.success?(a(D.data.prediction),k("")):j(D.data.error||"Failed to analyze input")}catch(p){j(((C=(S=p.response)==null?void 0:S.data)==null?void 0:C.error)||p.message||"Error communicating with AI assistant")}finally{w(!1)}}};return e.jsx($,{className:"bg-gradient-to-r from-green-50 to-blue-50 border-green-100 mb-8",children:e.jsxs(U,{className:"pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4 text-green-800",children:[e.jsx(oe,{className:"h-5 w-5"}),e.jsx("h3",{className:"font-semibold",children:m("activities.smartAdd.title")||"Smart Add Activity"})]}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ze,{value:o,onChange:z=>k(z.target.value),placeholder:m("activities.smartAdd.placeholder")||"Describe your activity, e.g., 'I took a 5km bus ride'",className:"min-h-[80px] pr-12 bg-white/80 backdrop-blur-sm focus:bg-white transition-all",maxLength:500}),e.jsxs("div",{className:"absolute bottom-3 right-3 text-xs text-gray-400",children:[o.length,"/500"]})]}),r&&e.jsx(ae,{variant:"destructive",className:"py-2",children:e.jsx(re,{className:"text-xs",children:r})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(O,{type:"submit",disabled:!o.trim()||F,className:"bg-green-600 hover:bg-green-700 text-white shadow-md hover:shadow-lg transition-all",children:F?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"mr-2 h-4 w-4 animate-spin"}),m("common.processing")||"Analyzing..."]}):e.jsxs(e.Fragment,{children:[m("activities.smartAdd.button")||"Magic Fill",e.jsx(oe,{className:"ml-2 h-4 w-4"})]})})})]})]})})}function Oe(){const{t:a}=Q(),[m,o]=c.useState(1),[k,F]=c.useState([]),[w,r]=c.useState(!1),[j,N]=c.useState(null),[z,S]=c.useState(null),[C,p]=c.useState(null),[D,R]=c.useState(!1),[q,I]=c.useState(!1),[E,P]=c.useState(null),[T,b]=c.useState("");Ce.useEffect(()=>{(async()=>{var i,x;try{r(!0);const l=await K.getActivities();if((i=l==null?void 0:l.data)!=null&&i.success){const v=(x=l==null?void 0:l.data)==null?void 0:x.data,B=Array.isArray(v==null?void 0:v.activities)?v.activities:Array.isArray(v)?v:[];F(B)}}catch(l){console.error("Failed to fetch activities for smart matching",l)}finally{r(!1)}})()},[]);const M=n=>{if(!n)return;let i=null;if(n.activity_uuid&&(i=k.find(x=>String(x.id)===String(n.activity_uuid)||String(x.uuid||"")===String(n.activity_uuid))),!i&&n.activity_name){const x=n.activity_name.toLowerCase();i=k.find(l=>l.name_en&&l.name_en.toLowerCase()===x||l.name_zh&&l.name_zh.toLowerCase()===x||l.name&&l.name.toLowerCase()===x)}i?(N(i),S({amount:n.amount,unit:n.unit,description:n.notes||n.description,activity_date:n.activity_date||null}),o(2),b("")):b(a("activities.smartAdd.notFound")||`Could not find activity type: ${n.activity_name}`)},s=[{id:1,title:a("activities.form.selectActivity"),description:a("activities.form.selectActivityDesc")},{id:2,title:a("activities.form.dataInput"),description:a("activities.form.dataInputDesc")},{id:3,title:a("activities.form.submit"),description:a("activities.form.submitDesc")}],u=n=>{N(n),p(null),b(""),o(2)},y=c.useCallback(async n=>{if(j){R(!0),b("");try{const i=j.id||j.uuid,x=await K.calculate(i,n);x.data.success?p(x.data.data):b(x.data.message||a("activities.form.calculationFailed"))}catch(i){const x=(i==null?void 0:i.message)||"";if((i==null?void 0:i.code)==="ERR_CANCELED"||/aborted|canceled/i.test(x))return;b(x||a("activities.form.calculationFailed"))}finally{R(!1)}}},[j,a]),h=async n=>{I(!0),b("");try{const i=await K.recordActivity({...n});if(i.data.success){const x=i.data.calculation||{};P({carbon_saved:x.carbon_saved||0,points_earned:x.points_earned||0,record_id:i.data.record_id}),o(3)}else b(i.data.message||a("activities.form.submitFailed"))}catch(i){b(i.message||a("activities.form.submitFailed"))}finally{I(!1)}},g=()=>{o(1),N(null),p(null),P(null),b("")},_=()=>{m>1&&(o(m-1),b(""))};return e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4",children:e.jsx(H,{className:"w-8 h-8 text-green-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:a("activities.title")}),e.jsx("p",{className:"text-gray-600",children:a("activities.description")})]}),e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-between",children:s.map((n,i)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-10 h-10 rounded-full border-2 ${m>=n.id?"bg-green-600 border-green-600 text-white":"border-gray-300 text-gray-500"}`,children:m>n.id?e.jsx(me,{className:"w-6 h-6"}):e.jsx("span",{className:"text-sm font-medium",children:n.id})}),e.jsxs("div",{className:"ml-3 hidden sm:block",children:[e.jsx("div",{className:`text-sm font-medium ${m>=n.id?"text-green-600":"text-gray-500"}`,children:n.title}),e.jsx("div",{className:"text-xs text-gray-500",children:n.description})]}),i<s.length-1&&e.jsx("div",{className:`flex-1 h-0.5 mx-4 ${m>n.id?"bg-green-600":"bg-gray-300"}`})]},n.id))})}),T&&e.jsx(ae,{variant:"destructive",className:"mb-6",children:e.jsx(re,{children:T})}),e.jsxs("div",{className:"space-y-6",children:[m===1&&e.jsxs(e.Fragment,{children:[e.jsx(Me,{onSuggestion:M}),e.jsx($e,{onActivitySelect:u,selectedActivity:j})]}),m===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(O,{variant:"outline",onClick:_,className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4"}),a("common.back")]}),e.jsx("div",{className:"text-sm text-gray-600",children:a("activities.form.step2Of3")})]}),e.jsx(Ue,{activity:j,onCalculate:y,onSubmit:h,calculationResult:C,isCalculating:D,isSubmitting:q,initialData:z})]}),m===3&&E&&e.jsxs($,{className:"bg-green-50 border-green-200",children:[e.jsxs(W,{className:"text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4 mx-auto",children:e.jsx(me,{className:"w-8 h-8 text-green-600"})}),e.jsx(V,{className:"text-green-800",children:a("activities.form.submitSuccess")}),e.jsx(X,{children:a("activities.form.submitSuccessDesc")})]}),e.jsxs(U,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:(()=>{const n=E.carbon_saved,i=typeof n=="number"?n:Number(n);return Number.isFinite(i)?i.toFixed(2):"0.00"})()}),e.jsxs("div",{className:"text-sm text-gray-600",children:[a("activities.carbonSaved")," (kg CO₂)"]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:E.points_earned||0}),e.jsx("div",{className:"text-sm text-gray-600",children:a("activities.pointsEarned")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:a("activities.status.pending")}),e.jsx("div",{className:"text-sm text-gray-600",children:a("activities.currentStatus")})]})]}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:a("activities.form.reviewNotice")}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx(O,{onClick:g,children:a("activities.form.recordAnother")}),e.jsx(O,{variant:"outline",onClick:()=>window.location.href="/dashboard",children:a("activities.form.goToDashboard")})]})]})]})]})]})]})}function Ye(){return e.jsx(Oe,{})}export{Ye as default};
