import{j as e}from"./motion-vendor-C11-9Hm-.js";import{r as o,l as Ke}from"./react-vendor-CFnAvB5y.js";import{c as Ae,u as Ye,a8 as es,Z as I,aj as y,A as be,W as Y,L as ss,T as as,I as ee,P,U as ts,B as x,r as ns,a1 as se,a2 as ae,a3 as te,a4 as ne,a5 as re,a7 as ye,y as Ne,v as rs,R as is,J as ie,n as j}from"./index-CQ91Xfn2.js";import{u as de}from"./useMutation-BV6CLrgj.js";import{A as ds,b as ls,a as os}from"./Alert-B9j1D3yi.js";import{P as cs}from"./Pagination-BI4yWnKG.js";import{C as ve}from"./checkbox-CU656Qiu.js";import{S as ms}from"./switch-DPZXEupI.js";import{A as us,a as xs,b as ps,c as hs,d as gs,e as fs,f as js,g as bs}from"./alert-dialog-BQxvLDd_.js";import{L as _}from"./label-DlUKBhBt.js";import{T as we}from"./textarea-B3Xlgutj.js";import{B as ys}from"./BadgeBulkAwardDialog-Buyj_DZ-.js";import{C as ke}from"./calendar-days-DPoO41qq.js";import{F as _e,R as Ns}from"./refresh-ccw-BKO5Q_sO.js";import{C as vs}from"./circle-plus-DvnwMpqS.js";import{E as ws}from"./eye-CeJ4BZLb.js";import{S as ks}from"./shield-DyJzZEp0.js";import{T as _s}from"./trash-2-5w0t3MZ_.js";import{C as Ss}from"./circle-check-big-BEnwQz6W.js";import{C as Cs}from"./circle-x-B1nSIdDN.js";import"./i18n-vendor-DK0x1_bH.js";import"./charts-vendor-DJkHj7pX.js";import"./index-YbUg3LVs.js";import"./scroll-area-CVgIHlKF.js";import"./index-BdQq_4o_.js";import"./user-plus-vS6ZlqpZ.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const As=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]],Ds=Ae("ban",As);/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],Ps=Ae("clipboard-list",Is),Bs={search:"",role:"",status:"",page:1,limit:10,sort:"created_at_desc"},le=(a={})=>{const p=c=>{const S=Number(c);return Number.isFinite(S)?S:0};return{...a,is_admin:a.is_admin===!0||a.is_admin===1||a.is_admin==="1",checkin_days:p(a.checkin_days),makeup_checkins:p(a.makeup_checkins)}},De=(a={})=>({...a,id:a.id,badge:a.badge||{}}),Fs=(a={})=>De(a),Se=(a={})=>({total_points_earned:Number(a.total_points_earned??0),total_points_balance:Number(a.total_points_balance??0),total_carbon_saved:Number(a.total_carbon_saved??0),total_records:Number(a.total_records??0),total_approved_records:Number(a.total_approved_records??0)}),Ce=(a={})=>({awarded:Number(a.awarded??0),revoked:Number(a.revoked??0),total:Number(a.total??Number(a.awarded??0)+Number(a.revoked??0))});function Us(a){var N;const p=((N=a==null?void 0:a.data)==null?void 0:N.data)||(a==null?void 0:a.data)||{};if(Array.isArray(p.users))return{users:p.users.map(le),pagination:p.pagination||{}};const c=p.data||{};return{users:Array.isArray(c.users)?c.users.map(le):[],pagination:c.pagination||{}}}function Ms(){var je;const{t:a}=Ye(),p=es(),[c,S]=o.useState(Bs),[N,B]=Ke(),R=o.useRef(null),[i,oe]=o.useState({open:!1,type:null,user:null,payload:null}),[g,F]=o.useState({open:!1,user:null,delta:"",reason:""}),[C,E]=o.useState(new Map),[ce,z]=o.useState({open:!1,presetUsers:[]}),[m,q]=o.useState({open:!1,userId:null}),[O,A]=o.useState(!1),[u,D]=o.useState({open:!1,user:null,notes:"",groupId:"",quotaFlat:{}}),{data:Q}=I("adminUserGroups",()=>y.getUserGroups().then(s=>{var t;return((t=s.data)==null?void 0:t.data)||[]})),me=o.useMemo(()=>{const s={page:c.page,limit:c.limit,sort:c.sort},t=c.search.trim();return t&&(s.q=t),c.status&&(s.status=c.status),c.role==="admin"?s.is_admin=1:c.role==="user"&&(s.is_admin=0),s},[c]),v=I(["adminUsers",me],()=>y.getUsers(me),{keepPreviousData:!0}),U=I(["adminBadges","forAwarding"],()=>y.getBadges({limit:200}),{staleTime:6e4}),H=I(["adminUserOverview",m.userId],()=>y.getUserOverview(m.userId).then(s=>{var t;return(t=s.data)==null?void 0:t.data}),{enabled:m.open&&!!m.userId,select:s=>{if(!s)return null;const t=Se(s.metrics||{}),r=Ce(s.badge_summary||{}),d=Array.isArray(s.recent_badges)?s.recent_badges.map(Fs):[];return{...s,metrics:t,badge_summary:r,recent_badges:d}}}),G=I(["adminUserBadges",m.userId,O],()=>y.getUserBadges(m.userId,{include_revoked:O}).then(s=>{var t;return(t=s.data)==null?void 0:t.data}),{enabled:m.open&&!!m.userId,select:s=>{if(!s)return null;const t=Ce(s.summary||{}),r=Se(s.metrics||{}),d=Array.isArray(s.badges)?s.badges.map(De):[];return{...s,summary:t,metrics:r,badges:d}}}),M=de(({id:s,data:t})=>y.updateUser(s,t),{onSuccess:()=>{p.invalidateQueries("adminUsers"),j.success(a("admin.users.updateSuccess"))},onError:()=>{j.error(a("admin.users.updateFailed"))}}),Ie=de(s=>y.deleteUser(s),{onSuccess:()=>{p.invalidateQueries("adminUsers"),j.success(a("admin.users.deleteSuccess"))},onError:()=>{j.error(a("admin.users.deleteFailed"))}}),V=de(({id:s,data:t})=>y.adjustUserPoints(s,t),{onSuccess:()=>{p.invalidateQueries("adminUsers"),j.success(a("admin.users.adjustSuccess"))},onError:()=>{j.error(a("admin.users.adjustFailed"))}});o.useEffect(()=>{N.get("focus")==="search"&&R.current&&(R.current.focus(),B(s=>{const t=new URLSearchParams(s);return t.delete("focus"),t},{replace:!0}))},[N,B]),o.useEffect(()=>{const s=N.get("userId");if(!s)return;const t=()=>{B(d=>{const k=new URLSearchParams(d);return k.delete("userId"),k},{replace:!0})},r=Number(s);if(!Number.isInteger(r)||r<=0){t();return}(!m.open||m.userId!==r)&&(q({open:!0,userId:r}),A(!1)),t()},[N,m.open,m.userId,B,A]);const{users:f,pagination:T}=o.useMemo(()=>Us(v.data),[v.data]),Pe=v.isLoading&&!v.data,Be=v.isFetching&&!!v.data,Fe=o.useMemo(()=>m.userId&&f.find(s=>s.id===m.userId)||null,[m.userId,f]),l=H.data||null,h=G.data||null,ue=Array.isArray(h==null?void 0:h.badges)?h.badges:Array.isArray(h==null?void 0:h.items)?h.items:[],$=(h==null?void 0:h.summary)||(l==null?void 0:l.badge_summary)||{awarded:0,revoked:0,total:0},Ue=o.useMemo(()=>l!=null&&l.user?le(l.user):null,[l]),n=Fe??Ue,b=(l==null?void 0:l.checkin_stats)||{},Me=o.useMemo(()=>{if(!l&&!n)return[];const s=(l==null?void 0:l.metrics)||{};return[{key:"balance",label:a("admin.users.detail.pointsBalance","积分余额"),value:(n==null?void 0:n.points)??0,icon:be},{key:"earned",label:a("admin.users.detail.pointsEarned","累计积分"),value:s.total_points_earned??0,icon:Y},{key:"carbon",label:a("admin.users.detail.carbonSaved","累计碳减排 (kg)"),value:s.total_carbon_saved??0,icon:ss},{key:"records",label:a("admin.users.detail.recordsApproved","审核通过记录"),value:s.total_approved_records??0,icon:Ps},{key:"days",label:a("admin.users.detail.daysSinceRegistration","注册天数"),value:(n==null?void 0:n.days_since_registration)??s.days_since_registration??0,icon:ke}]},[l,n,a]),xe=o.useMemo(()=>!l&&!n?[]:[{key:"current",label:a("admin.users.checkins.currentStreak","当前连击"),value:b.current_streak??0,icon:_e},{key:"longest",label:a("admin.users.checkins.longestStreak","历史最长"),value:b.longest_streak??0,icon:_e},{key:"total",label:a("admin.users.checkins.totalDays","累计打卡"),value:b.total_days??(n==null?void 0:n.checkin_days)??0,icon:ke},{key:"makeup",label:a("admin.users.checkins.makeupDays","补打卡"),value:b.makeup_days??(n==null?void 0:n.makeup_checkins)??0,icon:Ns}],[l,n,b,a]),J=o.useMemo(()=>Array.from(C.values()),[C]),W=o.useMemo(()=>{var t,r,d;const s=((r=(t=U.data)==null?void 0:t.data)==null?void 0:r.data)||((d=U.data)==null?void 0:d.data)||[];return Array.isArray(s)?s:[]},[U.data]),pe=f.length>0&&f.every(s=>C.has(s.id)),Te=f.some(s=>C.has(s.id))&&!pe,L=(s,t)=>{S(r=>({...r,[s]:t,page:s==="page"?t:1}))},Le=s=>{L("page",s)},Re=(s,t)=>{E(r=>{const d=new Map(r);return t?d.set(s.id,s):d.delete(s.id),d})},Ee=s=>{E(t=>{const r=new Map(t);return s?f.forEach(d=>r.set(d.id,d)):f.forEach(d=>r.delete(d.id)),r})},ze=s=>{const t=s.status!=="active";X({type:"status",user:s,payload:{nextStatus:t?"active":"inactive"}})},qe=s=>{const t=!s.is_admin;X({type:"role",user:s,payload:{makeAdmin:t}})},Oe=s=>{X({type:"delete",user:s,payload:null})},Qe=s=>{s&&(q({open:!0,userId:s.id}),A(!1))},He=()=>{q({open:!1,userId:null}),A(!1)},X=s=>{oe({open:!0,...s})},w=()=>{oe({open:!1,type:null,user:null,payload:null})},Ge=()=>{if(!i.user||!i.type){w();return}if(i.type==="status"){const s=i.payload.nextStatus;M.mutate({id:i.user.id,data:{status:s}},{onSettled:w})}else if(i.type==="role"){const s=i.payload.makeAdmin;M.mutate({id:i.user.id,data:{is_admin:s}},{onSettled:w})}else i.type==="delete"?Ie.mutate(i.user.id,{onSettled:w}):w()},Ve=s=>{F({open:!0,user:s,delta:"",reason:""})},Z=()=>{F({open:!1,user:null,delta:"",reason:""})},$e=()=>{if(!g.user)return;const s=Number(g.delta);if(!Number.isFinite(s)||s===0){j.error(a("admin.users.invalidDelta"));return}V.mutate({id:g.user.id,data:{delta:s,reason:g.reason}},{onSettled:Z})},Je=s=>{D({open:!0,user:s,groupId:s.group_id||"",notes:s.admin_notes||"",quotaFlat:s.quota_flat||{}})},K=()=>{D({open:!1,user:null,notes:"",groupId:"",quotaFlat:{}})},We=(s,t)=>{D(r=>({...r,quotaFlat:{...r.quotaFlat,[s]:t}}))},Xe=s=>{if(s.preventDefault(),!u.user)return;const t={group_id:u.groupId||"",admin_notes:u.notes,quota_flat:u.quotaFlat};M.mutate({id:u.user.id,data:t},{onSuccess:()=>{K(),j.success(a("admin.users.updateSuccess"))}})},he=s=>{if(!s||s.length===0){j.error(a("admin.users.selectUserHint","请先选择用户"));return}z({open:!0,presetUsers:s})},Ze=()=>{E(new Map)},ge=s=>!s||!s.status?e.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600",children:a("common.unknown","未知")}):e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",children:s.status==="active"?e.jsxs("span",{className:"bg-green-100 text-green-800 flex items-center gap-1 px-2 py-0.5 rounded-full",children:[e.jsx(Ss,{className:"h-3 w-3"}),a("admin.users.statusActive")]}):e.jsxs("span",{className:"bg-red-100 text-red-800 flex items-center gap-1 px-2 py-0.5 rounded-full",children:[e.jsx(Cs,{className:"h-3 w-3"}),a("admin.users.statusInactive")]})}),fe=s=>s?e.jsx(ie,{variant:s.is_admin?"default":"outline",children:s.is_admin?a("admin.users.roleAdmin"):a("admin.users.roleUser")}):e.jsx(ie,{variant:"outline",children:a("common.unknown","未知")});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:a("admin.users.title")}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.users.description")})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("common.search")}),e.jsxs("div",{className:"relative",children:[e.jsx(as,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(ee,{ref:R,type:"text",value:c.search,onChange:s=>L("search",s.target.value),placeholder:a("admin.users.searchPlaceholder"),className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.users.role")}),e.jsxs("select",{value:c.role,onChange:s=>L("role",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:a("common.all")}),e.jsx("option",{value:"user",children:a("admin.users.roleUser")}),e.jsx("option",{value:"admin",children:a("admin.users.roleAdmin")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.users.status")}),e.jsxs("select",{value:c.status,onChange:s=>L("status",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:a("common.all")}),e.jsx("option",{value:"active",children:a("admin.users.statusActive")}),e.jsx("option",{value:"inactive",children:a("admin.users.statusInactive")})]})]})]}),Be&&e.jsxs("div",{className:"flex items-center justify-end gap-2 text-xs text-muted-foreground",children:[e.jsx(P,{className:"h-3.5 w-3.5 animate-spin"}),a("admin.users.refreshing")]}),J.length>0&&e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 rounded-md border border-dashed bg-muted/60 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ts,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:a("admin.users.selectedCount","已选择 {{count}} 位用户",{count:J.length})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>he(J),disabled:U.isLoading||W.length===0,children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),a("admin.users.bulkAwardBadges","批量授予徽章")]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:Ze,children:a("common.clear","清空")})]})]})]}),Pe?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(P,{className:"h-8 w-8 animate-spin text-green-500"})}):v.error?e.jsxs(ds,{variant:"destructive",children:[e.jsx(ls,{children:a("common.error")}),e.jsx(os,{children:a("errors.loadFailed")})]}):f.length===0?e.jsxs("div",{className:"text-center py-16 bg-white rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"text-xl font-semibold",children:a("admin.users.noUsersFound")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:a("admin.users.tryDifferentFilters")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto bg-white rounded-lg shadow-sm border",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsx(ve,{checked:pe?!0:Te?"indeterminate":!1,onCheckedChange:s=>Ee(s===!0||s==="indeterminate"),"aria-label":a("admin.users.selectAll","选择当前页所有用户"),className:"translate-y-0.5"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.username")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.email")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.groups.title","用户组")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.role")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.status")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.badges","徽章")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.checkins","打卡")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.carbon","碳减排")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.points")}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:a("admin.users.table.actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:f.map(s=>{const t=C.has(s.id);return e.jsxs("tr",{className:t?"bg-emerald-50/40":"",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx(ve,{checked:t,onCheckedChange:r=>Re(s,r===!0||r==="indeterminate"),"aria-label":a("admin.users.selectUser","选择用户 {{username}}",{username:s.username})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:s.username}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.email}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.group_name||"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:fe(s)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:ge(s)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:a("admin.users.badgesAwardedCount","{{count}} 枚",{count:s.badges_awarded||0})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a("admin.users.activeBadgesCount","激活 {{count}}",{count:s.active_badges||0})})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:a("admin.users.checkins.totalDaysLabel","累计 {{count}} 天",{count:s.checkin_days||0})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a("admin.users.checkins.makeupDaysLabel","补打卡 {{count}}",{count:s.makeup_checkins||0})}),s.last_checkin_date&&e.jsx("span",{className:"text-xs text-muted-foreground",children:a("admin.users.checkins.lastDate","最近 {{date}}",{date:s.last_checkin_date})})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:Number(s.total_carbon_saved||0).toLocaleString(void 0,{maximumFractionDigits:2})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.points}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-1",children:[e.jsxs(x,{variant:"ghost",size:"sm",onClick:()=>ze(s),title:a("admin.users.toggleStatusButton","切换用户状态"),children:[e.jsx(Ds,{className:"h-4 w-4 mr-1"}),s.status==="active"?a("admin.users.disable"):a("admin.users.enable")]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>Ve(s),title:a("admin.users.promptAdjustPoints",{username:s.username}),children:e.jsx(vs,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>Qe(s),title:a("admin.users.viewDetailsButton","查看详情"),children:e.jsx(ws,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>Je(s),title:a("admin.users.editUser","编辑配置"),children:e.jsx(ns,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>qe(s),title:a("admin.users.toggleAdminButton","切换管理员权限"),children:e.jsx(ks,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>he([s]),title:a("admin.users.awardBadgeButton","授予徽章"),disabled:W.length===0,children:e.jsx(Y,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>Oe(s),className:"text-red-600 hover:text-red-800",title:a("admin.users.deleteButton","删除用户"),children:e.jsx(_s,{className:"h-4 w-4"})})]})]},s.id)})})]})}),e.jsx(cs,{currentPage:T.current_page,totalPages:T.total_pages,onPageChange:Le,itemsPerPage:T.per_page,totalItems:T.total_items})]}),e.jsx(us,{open:i.open,onOpenChange:s=>s?null:w(),children:e.jsxs(xs,{children:[e.jsxs(ps,{children:[e.jsxs(hs,{children:[i.type==="status"&&a("admin.users.confirmToggleStatusTitle","确认修改状态"),i.type==="role"&&a("admin.users.confirmToggleAdminTitle","确认切换角色"),i.type==="delete"&&a("admin.users.confirmDeleteTitle","确认删除用户")]}),e.jsxs(gs,{children:[i.type==="status"&&i.user&&a("admin.users.confirmToggleStatus",{username:i.user.username,to:i.payload.nextStatus==="active"?a("admin.users.statusActive"):a("admin.users.statusInactive")}),i.type==="role"&&i.user&&a("admin.users.confirmToggleAdmin",{username:i.user.username}),i.type==="delete"&&i.user&&a("admin.users.confirmDelete",{username:i.user.username})]})]}),e.jsxs(fs,{children:[e.jsx(js,{onClick:w,children:a("common.cancel","取消")}),e.jsx(bs,{onClick:Ge,children:a("common.confirm","确认")})]})]})}),e.jsx(se,{open:g.open,onOpenChange:s=>s?null:Z(),children:e.jsxs(ae,{className:"max-w-md",children:[e.jsxs(te,{children:[e.jsx(ne,{children:a("admin.users.adjustPointsTitle","调整积分")}),e.jsx(re,{children:g.user?a("admin.users.adjustPointsDescription",{username:g.user.username}):""})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"points-delta",children:a("admin.users.adjustPointsDelta","积分变动值")}),e.jsx(ee,{id:"points-delta",type:"number",value:g.delta,onChange:s=>F(t=>({...t,delta:s.target.value})),placeholder:"100"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.users.adjustPointsHint","输入正数表示增加积分，负数表示扣减积分")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"points-reason",children:a("admin.users.adjustPointsReason","调整说明")}),e.jsx(we,{id:"points-reason",rows:3,value:g.reason,onChange:s=>F(t=>({...t,reason:s.target.value})),placeholder:a("admin.users.adjustPointsReasonPlaceholder","请输入调整原因，便于审计记录")})]})]}),e.jsxs(ye,{children:[e.jsx(x,{variant:"ghost",onClick:Z,children:a("common.cancel","取消")}),e.jsxs(x,{onClick:$e,disabled:V.isLoading,children:[V.isLoading&&e.jsx(P,{className:"mr-2 h-4 w-4 animate-spin"}),a("common.confirm","确认")]})]})]})}),e.jsx(se,{open:u.open,onOpenChange:s=>s?null:K(),children:e.jsxs(ae,{className:"max-w-lg",children:[e.jsxs(te,{children:[e.jsx(ne,{children:a("admin.users.editUser","编辑用户配置")}),e.jsx(re,{children:(je=u.user)==null?void 0:je.username})]}),e.jsxs("form",{onSubmit:Xe,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(_,{children:a("admin.groups.title","用户组")}),e.jsxs("select",{className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:u.groupId,onChange:s=>D({...u,groupId:s.target.value}),children:[e.jsx("option",{value:"",children:a("common.none","无")}),Q==null?void 0:Q.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"space-y-3 border-t pt-3 border-b pb-3",children:[e.jsx(_,{className:"text-base font-semibold",children:a("admin.groups.quotaOverride","配额单独设置")}),Object.keys(u.quotaFlat||{}).length>0?Object.entries(u.quotaFlat).map(([s,t])=>e.jsxs("div",{children:[e.jsx(_,{className:"capitalize",children:a(`admin.quotas.${s}`,s.replace("."," "))}),e.jsx(ee,{type:"number",value:t??"",onChange:r=>We(s,r.target.value),placeholder:a("common.default","默认")})]},s)):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.groups.noQuotasAvailable","暂无可配置的配额项目")})]}),e.jsxs("div",{children:[e.jsx(_,{children:a("admin.groups.notes","备注")}),e.jsx(we,{value:u.notes,onChange:s=>D({...u,notes:s.target.value})})]}),e.jsxs(ye,{children:[e.jsx(x,{type:"button",variant:"ghost",onClick:K,children:a("common.cancel")}),e.jsx(x,{type:"submit",disabled:M.isLoading,children:a("common.save")})]})]})]})}),e.jsx(se,{open:m.open,onOpenChange:s=>s?null:He(),children:e.jsxs(ae,{className:"max-w-4xl",children:[e.jsxs(te,{children:[e.jsx(ne,{children:n?a("admin.users.detailTitle","用户详情：{{username}}",{username:n.username}):a("admin.users.detailTitleFallback","用户详情")}),e.jsx(re,{children:(n==null?void 0:n.email)||""})]}),H.isLoading?e.jsxs("div",{className:"flex items-center justify-center py-8 text-sm text-muted-foreground",children:[e.jsx(P,{className:"mr-2 h-4 w-4 animate-spin"}),a("common.loading","加载中...")]}):H.error?e.jsx("p",{className:"text-sm text-destructive",children:a("admin.users.detailLoadFailed","无法加载用户详情")}):l?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.username","用户名")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:n==null?void 0:n.username})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.role","角色")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:fe(n)})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.status","状态")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:ge(n)})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.registrationDays","注册天数")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:(n==null?void 0:n.days_since_registration)??0})]}),(n==null?void 0:n.lastlgn)&&e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm sm:col-span-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:a("admin.users.detail.lastLogin","最近登录")}),e.jsx("p",{className:"mt-1 text-sm font-medium text-gray-900",children:Ne(new Date(n.lastlgn),"yyyy-MM-dd HH:mm")})]})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:Me.map(s=>{const t=s.icon;return e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:s.label}),e.jsx(t,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:Number(s.value||0).toLocaleString(void 0,{maximumFractionDigits:2})})]},s.key)})}),xe.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-base font-semibold",children:a("admin.users.checkins.title","打卡概况")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.users.checkins.subtitle","查看用户连击与补打卡情况")})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:xe.map(s=>{const t=s.icon;return e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:s.label}),e.jsx(t,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:Number(s.value||0).toLocaleString(void 0,{maximumFractionDigits:2})})]},s.key)})}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[b.active_today?a("admin.users.checkins.activeToday","今日已打卡"):a("admin.users.checkins.inactiveToday","今日未打卡"),b.last_checkin_date||n!=null&&n.last_checkin_date?e.jsxs(e.Fragment,{children:[" · ",a("admin.users.checkins.lastDateLong","最近打卡 {{date}}",{date:b.last_checkin_date||(n==null?void 0:n.last_checkin_date)})]}):null]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-base font-semibold",children:a("admin.users.badgeSummary","徽章概况")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.users.badgeSummaryHint","展示授予和回收的徽章统计")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ms,{checked:O,onCheckedChange:s=>A(!!s)}),e.jsx("span",{children:a("admin.users.showRevokedBadges","显示已收回的徽章")})]})]}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:a("admin.users.badgesAwarded","授予")}),e.jsx("p",{className:"mt-2 text-2xl font-semibold",children:$.awarded})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:a("admin.users.badgesRevoked","收回")}),e.jsx("p",{className:"mt-2 text-2xl font-semibold",children:$.revoked})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:a("admin.users.badgesTotal","总数")}),e.jsx("p",{className:"mt-2 text-2xl font-semibold",children:$.total})]})]}),G.isLoading?e.jsxs("div",{className:"flex items-center justify-center py-6 text-sm text-muted-foreground",children:[e.jsx(P,{className:"mr-2 h-4 w-4 animate-spin"}),a("common.loading","加载中...")]}):G.error?e.jsx("p",{className:"text-sm text-destructive",children:a("admin.users.badgesLoadFailed","无法加载徽章列表")}):ue.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500",children:a("admin.users.badgeTable.badge","徽章")}),e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500",children:a("admin.users.badgeTable.status","状态")}),e.jsx("th",{className:"px-4 py-2 text-left font-medium text-gray-500",children:a("admin.users.badgeTable.awardedAt","授予时间")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:ue.map((s,t)=>{const r=s.badge||{},d=s.user_badge||{},k=rs({urlCandidates:[r.icon_url,r.icon_presigned_url],pathCandidates:[r.icon_path]});return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full border bg-muted",children:k.src||k.filePath?e.jsx(is,{src:k.src||void 0,filePath:k.filePath||void 0,alt:r.name_zh||r.name_en,className:"h-full w-full object-cover"}):e.jsx(be,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:r.name_zh||r.name_en||"-"}),r.name_en&&e.jsx("p",{className:"text-xs text-muted-foreground",children:r.name_en})]})]})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx(ie,{variant:d.status==="awarded"?"success":"secondary",children:d.status==="awarded"?a("admin.users.badgeStatusAwarded","已授予"):a("admin.users.badgeStatusRevoked","已收回")})}),e.jsx("td",{className:"px-4 py-2 text-sm text-muted-foreground",children:d.awarded_at?Ne(new Date(d.awarded_at),"yyyy-MM-dd HH:mm"):"--"})]},t)})})]})}):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.users.badgesEmpty","暂无徽章记录")})]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.users.detailEmpty","暂无详情数据")})]})}),e.jsx(ys,{open:ce.open,onOpenChange:s=>s?null:z({open:!1,presetUsers:[]}),badges:W,defaultSelectedBadgeIds:[],presetUsers:ce.presetUsers,onCompleted:()=>{z({open:!1,presetUsers:[]}),p.invalidateQueries("adminUsers")},mode:"award"})]})}function la(){return e.jsx(Ms,{})}export{la as default};
