import{u as B,Z as F,r as m,F as M,j as e,w as j,B as p,n as f,a3 as y}from"./index-zNwHnw2L.js";import{u as b}from"./useMutation-IpvuyI4-.js";import{C as H,a as J,b as O,c as R,d as V}from"./Card-DW8DioWX.js";import{S as _}from"./switch-B0DP16LS.js";import{A as C,a as w}from"./Alert-BWw1ndU8.js";import"./index-BkVhWiUE.js";const K=()=>{const{t:n}=B(),E=F(),[g,u]=m.useState([]),[r,x]=m.useState(null),[h,c]=m.useState(null),[k,v]=m.useState(null),o=M(["notification-preferences"],async()=>{var t,a;return((a=(t=(await y.getNotificationPreferences()).data)==null?void 0:t.data)==null?void 0:a.preferences)??[]},{onSuccess:s=>{u(s)}}),N=b(async s=>{var a,i;return((i=(a=(await y.updateNotificationPreferences({preferences:s})).data)==null?void 0:a.data)==null?void 0:i.preferences)??[]},{onSuccess:s=>{f.success(n("settings.notifications.saveSuccess")),x({variant:"success",message:n("settings.notifications.saveSuccess")}),u(s),E.setQueryData(["notification-preferences"],s)},onError:s=>{var a,i;const t=((i=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:i.message)||(s==null?void 0:s.message)||n("settings.notifications.saveFailed");f.error(t),x({variant:"destructive",message:t})}}),T=b(async s=>{v(s);const t=await y.sendNotificationTestEmail(s);return{category:s,payload:t.data}},{onSuccess:({category:s,payload:t})=>{const a=(t==null?void 0:t.message)||n("settings.notifications.testEmail.success");f.success(a),c({category:s,variant:"success",message:a})},onError:(s,t)=>{var i,l;const a=((l=(i=s==null?void 0:s.response)==null?void 0:i.data)==null?void 0:l.message)||(s==null?void 0:s.message)||n("settings.notifications.testEmail.error");f.error(a),c({category:t,variant:"destructive",message:a})},onSettled:()=>{v(null)}}),P=o.isLoading,d=N.isLoading,S=m.useMemo(()=>o.data?JSON.stringify(g)!==JSON.stringify(o.data):!1,[g,o.data]),A=(s,t)=>a=>{t||(u(i=>i.map(l=>l.category===s?{...l,email_enabled:!!a}:l)),x(null),c(null))},D=()=>{o.data&&u(o.data),x(null),c(null)},L=()=>{c(null),N.mutate(g.map(({category:s,email_enabled:t})=>({category:s,email_enabled:t})))},Q=s=>{c(null),T.mutate(s)};return e.jsxs("div",{className:"max-w-3xl mx-auto px-4 py-10",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight text-gray-900",children:n("settings.notifications.title")}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:n("settings.notifications.subtitle")})]}),e.jsxs(H,{children:[e.jsxs(J,{children:[e.jsx(O,{children:n("settings.notifications.emailHeading")}),e.jsx(R,{children:n("settings.notifications.emailDescription")})]}),e.jsx(V,{className:"space-y-5",children:P?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(j,{className:"h-4 w-4 animate-spin"}),n("common.loading")]}):e.jsxs(e.Fragment,{children:[(r==null?void 0:r.message)&&e.jsx(C,{variant:r.variant||"info",children:e.jsx(w,{children:r.message})}),e.jsx("div",{className:"space-y-4",children:g.map(s=>{const t=k===s.category,a=h&&h.category===s.category?h:null;return e.jsxs("div",{className:"rounded-lg border border-gray-100 bg-gray-50 px-4 py-3",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:n(`settings.notifications.categories.${s.category}.label`,{defaultValue:s.label})}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:n(`settings.notifications.categories.${s.category}.description`,{defaultValue:s.label})}),s.locked&&e.jsx("p",{className:"text-xs text-amber-600 mt-2",children:n("settings.notifications.locked")})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2 sm:flex-row sm:items-center",children:[e.jsx(_,{checked:s.email_enabled,onCheckedChange:A(s.category,s.locked),disabled:s.locked||d}),e.jsx(p,{type:"button",variant:"outline",size:"sm",onClick:()=>Q(s.category),disabled:d||t,children:t?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(j,{className:"h-4 w-4 animate-spin"}),n("settings.notifications.testEmail.sending")]}):n("settings.notifications.testEmail.button")})]})]}),a&&e.jsx(C,{variant:a.variant||"info",className:"mt-3",children:e.jsx(w,{children:a.message})})]},s.category)})}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-end gap-3 pt-2",children:[e.jsx(p,{type:"button",variant:"outline",onClick:D,disabled:!S||d,children:n("settings.notifications.reset")}),e.jsx(p,{type:"button",onClick:L,disabled:!S||d,children:d?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(j,{className:"h-4 w-4 animate-spin"}),n("settings.notifications.saving")]}):n("settings.notifications.save")})]})]})})]})]})};export{K as default};
