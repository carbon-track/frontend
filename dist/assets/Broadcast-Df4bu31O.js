import{r as c,aQ as ms,aR as Ws,j as e,aG as Gs,aS as Ys,aT as Xs,aU as Qs,aI as H,aV as us,aW as Zs,aE as Js,aX as ea,aY as sa,aZ as aa,a as re,u as ta,e as ra,a3 as Xe,ay as ae,n as C,I as Q,B as N,P as W}from"./index-DoLe7CiU.js";import{u as Qe}from"./useMutation-SMLqdJ9j.js";import{T as na}from"./textarea-DFwvIABQ.js";import{A as I,b as L,a as D}from"./Alert-B1BB1_HT.js";import{S as ia}from"./switch-23S2pTLQ.js";import{C as oa}from"./checkbox-BkTJwor1.js";import{P as ca}from"./Pagination-DmB8J-hl.js";import{R as Ze,C as Je,X as es,Y as ss,T as as,a as ts,L as rs,B as ns,b as da}from"./generateCategoricalChart-CLLVoT79.js";import{L as la}from"./LineChart-Df9SejQm.js";import{B as ma}from"./BarChart-BKE9rOb8.js";import"./index-BrCWIb03.js";var Te,fe="HoverCard",[hs]=Gs(fe,[ms]),ge=ms(),[ua,be]=hs(fe),xs=a=>{const{__scopeHoverCard:u,children:x,open:o,defaultOpen:j,onOpenChange:p,openDelay:A=700,closeDelay:_=300}=a,y=ge(u),b=c.useRef(0),k=c.useRef(0),v=c.useRef(!1),M=c.useRef(!1),[U,g]=Ws({prop:o,defaultProp:j??!1,onChange:p,caller:fe}),O=c.useCallback(()=>{clearTimeout(k.current),b.current=window.setTimeout(()=>g(!0),A)},[A,g]),B=c.useCallback(()=>{clearTimeout(b.current),!v.current&&!M.current&&(k.current=window.setTimeout(()=>g(!1),_))},[_,g]),F=c.useCallback(()=>g(!1),[g]);return c.useEffect(()=>()=>{clearTimeout(b.current),clearTimeout(k.current)},[]),e.jsx(ua,{scope:u,open:U,onOpenChange:g,onOpen:O,onClose:B,onDismiss:F,hasSelectionRef:v,isPointerDownOnContentRef:M,children:e.jsx(Ys,{...y,children:x})})};xs.displayName=fe;var ps="HoverCardTrigger",fs=c.forwardRef((a,u)=>{const{__scopeHoverCard:x,...o}=a,j=be(ps,x),p=ge(x);return e.jsx(Xs,{asChild:!0,...p,children:e.jsx(Qs.a,{"data-state":j.open?"open":"closed",...o,ref:u,onPointerEnter:H(a.onPointerEnter,pe(j.onOpen)),onPointerLeave:H(a.onPointerLeave,pe(j.onClose)),onFocus:H(a.onFocus,j.onOpen),onBlur:H(a.onBlur,j.onClose),onTouchStart:H(a.onTouchStart,A=>A.preventDefault())})})});fs.displayName=ps;var Ie="HoverCardPortal",[ha,xa]=hs(Ie,{forceMount:void 0}),gs=a=>{const{__scopeHoverCard:u,forceMount:x,children:o,container:j}=a,p=be(Ie,u);return e.jsx(ha,{scope:u,forceMount:x,children:e.jsx(us,{present:x||p.open,children:e.jsx(Zs,{asChild:!0,container:j,children:o})})})};gs.displayName=Ie;var xe="HoverCardContent",bs=c.forwardRef((a,u)=>{const x=xa(xe,a.__scopeHoverCard),{forceMount:o=x.forceMount,...j}=a,p=be(xe,a.__scopeHoverCard);return e.jsx(us,{present:o||p.open,children:e.jsx(pa,{"data-state":p.open?"open":"closed",...j,onPointerEnter:H(a.onPointerEnter,pe(p.onOpen)),onPointerLeave:H(a.onPointerLeave,pe(p.onClose)),ref:u})})});bs.displayName=xe;var pa=c.forwardRef((a,u)=>{const{__scopeHoverCard:x,onEscapeKeyDown:o,onPointerDownOutside:j,onFocusOutside:p,onInteractOutside:A,..._}=a,y=be(xe,x),b=ge(x),k=c.useRef(null),v=Js(u,k),[M,U]=c.useState(!1);return c.useEffect(()=>{if(M){const g=document.body;return Te=g.style.userSelect||g.style.webkitUserSelect,g.style.userSelect="none",g.style.webkitUserSelect="none",()=>{g.style.userSelect=Te,g.style.webkitUserSelect=Te}}},[M]),c.useEffect(()=>{if(k.current){const g=()=>{U(!1),y.isPointerDownOnContentRef.current=!1,setTimeout(()=>{var B;((B=document.getSelection())==null?void 0:B.toString())!==""&&(y.hasSelectionRef.current=!0)})};return document.addEventListener("pointerup",g),()=>{document.removeEventListener("pointerup",g),y.hasSelectionRef.current=!1,y.isPointerDownOnContentRef.current=!1}}},[y.isPointerDownOnContentRef,y.hasSelectionRef]),c.useEffect(()=>{k.current&&ba(k.current).forEach(O=>O.setAttribute("tabindex","-1"))}),e.jsx(ea,{asChild:!0,disableOutsidePointerEvents:!1,onInteractOutside:A,onEscapeKeyDown:o,onPointerDownOutside:j,onFocusOutside:H(p,g=>{g.preventDefault()}),onDismiss:y.onDismiss,children:e.jsx(sa,{...b,..._,onPointerDown:H(_.onPointerDown,g=>{g.currentTarget.contains(g.target)&&U(!0),y.hasSelectionRef.current=!1,y.isPointerDownOnContentRef.current=!0}),ref:v,style:{..._.style,userSelect:M?"text":void 0,WebkitUserSelect:M?"text":void 0,"--radix-hover-card-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-hover-card-content-available-width":"var(--radix-popper-available-width)","--radix-hover-card-content-available-height":"var(--radix-popper-available-height)","--radix-hover-card-trigger-width":"var(--radix-popper-anchor-width)","--radix-hover-card-trigger-height":"var(--radix-popper-anchor-height)"}})})}),fa="HoverCardArrow",ga=c.forwardRef((a,u)=>{const{__scopeHoverCard:x,...o}=a,j=ge(x);return e.jsx(aa,{...j,...o,ref:u})});ga.displayName=fa;function pe(a){return u=>u.pointerType==="touch"?void 0:a()}function ba(a){const u=[],x=document.createTreeWalker(a,NodeFilter.SHOW_ELEMENT,{acceptNode:o=>o.tabIndex>=0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});for(;x.nextNode();)u.push(x.currentNode);return u}var ja=xs,va=fs,ya=gs,Na=bs;function js({...a}){return e.jsx(ja,{"data-slot":"hover-card",...a})}function vs({...a}){return e.jsx(va,{"data-slot":"hover-card-trigger",...a})}function ys({className:a,align:u="center",sideOffset:x=4,...o}){return e.jsx(ya,{"data-slot":"hover-card-portal",children:e.jsx(Na,{"data-slot":"hover-card-content",align:u,sideOffset:x,className:re("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-64 origin-(--radix-hover-card-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",a),...o})})}const he=["low","normal","high","urgent"],is={urgent:"#ef4444",high:"#f97316",normal:"#3b82f6",low:"#10b981",default:"#6b7280"},os={title:"",content:"",priority:"normal",scope:"all",target_users_text:""},_a=20,Ca={page:1,limit:20},cs={search:"",priority:"any",scope:"any",unreadOnly:!1},te={search:"",fields:"username,email,school,location",school:"",emailSuffix:"",status:"any",isAdmin:"any",limit:25},Sa=a=>{if(!a)return[];const u=a.split(/[\s,]+/).map(o=>o.trim()).filter(Boolean),x=new Set;return u.forEach(o=>{const j=Number(o);Number.isInteger(j)&&j>0&&x.add(j)}),Array.from(x)},wa=a=>{if(!a)return"";const u=new Date(a);return Number.isNaN(u.getTime())?a:u.toLocaleString()},ds=(a,u=_a)=>Array.isArray(a)?a.length<=u?{list:a,more:0}:{list:a.slice(0,u),more:a.length-u}:{list:[],more:0};function S({label:a,value:u,tone:x="default"}){return e.jsxs("div",{className:"rounded-md border px-4 py-3",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a}),e.jsx("p",{className:re("mt-1 text-xl font-semibold",x==="success"&&"text-green-600",x==="warning"&&"text-yellow-600",x==="danger"&&"text-red-600"),children:u})]})}function ls({users:a,onViewUser:u,t:x}){return!Array.isArray(a)||a.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:x("admin.broadcast.result.none")}):e.jsx("div",{className:"space-y-2",children:a.map((o,j)=>{const p=Number((o==null?void 0:o.user_id)??(o==null?void 0:o.id)??j);if(!Number.isFinite(p)||p<=0)return null;const A=(o==null?void 0:o.username)??(o==null?void 0:o.email)??`#${p}`,_=(o==null?void 0:o.email)??(o==null?void 0:o.user_email)??null,y=typeof(o==null?void 0:o.status)=="string"?o.status.toLowerCase():"",b=y==="active"?x("admin.users.statusActive"):y==="inactive"?x("admin.users.statusInactive"):y==="suspended"?x("admin.users.statusSuspended","Suspended"):y||null,k=(o==null?void 0:o.is_admin)!==void 0&&(o==null?void 0:o.is_admin)!==null&&`${o.is_admin}`!="",v=(o==null?void 0:o.is_admin)===!0||(o==null?void 0:o.is_admin)===1||(o==null?void 0:o.is_admin)==="1"||(o==null?void 0:o.is_admin)==="true",M=U=>{u&&u(U,{...o,id:p})};return e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-md border border-gray-200 bg-gray-50 px-3 py-2",children:[e.jsxs(js,{children:[e.jsx(vs,{asChild:!0,children:e.jsx("span",{className:"cursor-help text-sm font-medium text-gray-900 hover:text-green-600",children:A})}),e.jsxs(ys,{className:"w-64 space-y-1 text-xs text-muted-foreground",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:x("admin.broadcast.recipientSearch.hover.userId","用户ID")})," ","#",p]}),_&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:x("common.email","邮箱")})," ",_]}),b&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:x("admin.broadcast.recipientSearch.hover.status","状态")})," ",b]}),k&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-700",children:x("admin.broadcast.recipientSearch.hover.role","角色")})," ",x(v?"admin.users.roleAdmin":"admin.users.roleUser")]})]})]}),e.jsx(N,{type:"button",size:"sm",variant:"outline",onClick:M,children:x("admin.broadcast.recipientSearch.viewProfile","查看用户")})]},`${p}-${j}`)})})}function Ra(){var Ge,Ye;const{t:a}=ta(),u=c.useMemo(()=>new Intl.NumberFormat,[]),x=c.useMemo(()=>new Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:1}),[]),o=c.useMemo(()=>new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"}),[]),j=ra(),[p,A]=c.useState(os),[_,y]=c.useState(null),[b,k]=c.useState(null),[v,M]=c.useState({}),[U,g]=c.useState({}),[O,B]=c.useState(Ca),[F,Le]=c.useState(cs),[m,De]=c.useState(te),[Aa,Oe]=c.useState(1),[P,je]=c.useState({items:[],pagination:{page:1,has_more:!1,limit:te.limit}}),[z,$e]=c.useState(!1),[He,ve]=c.useState(null),[ye,Z]=c.useState(()=>new Map),[V,ne]=c.useState([]),ie=c.useMemo(()=>!!(m.search.trim()||m.school.trim()||m.emailSuffix.trim()||m.status&&m.status!=="any"||m.isAdmin&&m.isAdmin!=="any"),[m]),G=c.useMemo(()=>p.scope!=="custom"?[]:Sa(p.target_users_text),[p.scope,p.target_users_text]),Ne=c.useMemo(()=>Array.from(ye.values()),[ye]),q=c.useMemo(()=>Ne.map(s=>Number((s==null?void 0:s.id)??0)).filter(s=>Number.isInteger(s)&&s>0),[Ne]),{data:E,isLoading:Ns,isFetching:Ue,isError:_s,error:_e,refetch:Cs}=Xe(["admin-message-stats"],()=>ae.getStats().then(s=>{var t;return((t=s.data)==null?void 0:t.data)??{}}),{staleTime:6e4,refetchOnWindowFocus:!1}),{data:Y,isLoading:oe,isFetching:Ss,error:Be,refetch:Ce}=Xe(["admin-broadcast-history",O],()=>ae.getBroadcasts(O).then(s=>s.data),{keepPreviousData:!0,staleTime:6e4}),Se=(Y==null?void 0:Y.data)??[],ce=(Y==null?void 0:Y.pagination)??{},J=c.useMemo(()=>{const s=(E==null?void 0:E.messages)??{},t=Number((s==null?void 0:s.total_messages)??0),r=Number((s==null?void 0:s.unread_messages)??0);let n=Number((s==null?void 0:s.read_messages)??0);const h=Number.isFinite(t)?Math.max(0,t):0,d=Number.isFinite(r)?Math.max(0,r):0;(!Number.isFinite(n)||n===0&&h>=d)&&(n=h-d);const l=Math.max(0,Number.isFinite(n)?n:h-d),i=Number((s==null?void 0:s.unread_ratio)??(h>0?d/Math.max(h,1):0)),f=Math.min(Math.max(Number.isFinite(i)?i:0,0),1);return{total:h,unread:d,read:l,unreadRatio:f}},[E]),de=c.useMemo(()=>{var t;const s=(t=E==null?void 0:E.messages)==null?void 0:t.priority_breakdown;return Array.isArray(s)?s.map(r=>{const h=(typeof(r==null?void 0:r.priority)=="string"?r.priority:"normal").toLowerCase()||"normal",d=Number((r==null?void 0:r.total)??0),l=Number((r==null?void 0:r.unread)??0);let i=Number((r==null?void 0:r.read)??0);const f=Number.isFinite(d)?Math.max(0,d):0,R=Number.isFinite(l)?Math.max(0,l):0;(!Number.isFinite(i)||i===0&&f>=R)&&(i=f-R);const se=Math.max(0,Number.isFinite(i)?i:f-R),T=Number((r==null?void 0:r.unread_ratio)??(f>0?R/Math.max(f,1):0)),Me=Math.min(Math.max(Number.isFinite(T)?T:0,0),1);return{priority:h,total:f,unread:R,read:se,unreadRatio:Me}}):[]},[E]),we=c.useMemo(()=>{var t;const s=(t=E==null?void 0:E.messages)==null?void 0:t.daily_counts;return Array.isArray(s)?s.map(r=>{const n=typeof(r==null?void 0:r.date)=="string"?r.date:"",h=Number((r==null?void 0:r.total)??0),d=Number((r==null?void 0:r.unread)??0);let l=Number((r==null?void 0:r.read)??0);const i=Number.isFinite(h)?Math.max(0,h):0,f=Number.isFinite(d)?Math.max(0,d):0;(!Number.isFinite(l)||l===0&&i>=f)&&(l=i-f);const R=Math.max(0,Number.isFinite(l)?l:i-f);return{date:n,total:i,unread:f,read:R}}):[]},[E]),ws=c.useMemo(()=>we.some(s=>s.total>0||s.unread>0),[we]),Rs=c.useMemo(()=>de.some(s=>s.total>0||s.unread>0),[de]),Re=c.useMemo(()=>de.map(s=>{const t=s.priority.charAt(0).toUpperCase()+s.priority.slice(1);return{...s,name:a(`messages.priority.${s.priority}`,t),color:is[s.priority]??is.default}}),[de,a]),ze=Ns&&!E,$=c.useMemo(()=>{if(!Array.isArray(Se))return[];const s=F.search.trim().toLowerCase();return Se.filter(t=>F.priority!=="any"&&t.priority!==F.priority||F.scope!=="any"&&(t.scope==="custom"?"custom":"all")!==F.scope||F.unreadOnly&&(t.unread_count??0)===0?!1:s?[t.title,t.content,t.actor_username,t.actor_user_id&&`#${t.actor_user_id}`].filter(Boolean).map(n=>String(n).toLowerCase()).some(n=>n.includes(s)):!0)},[Se,F]),X=c.useMemo(()=>{const s={broadcasts:$.length,targets:0,sent:0,read:0,unread:0};return $.forEach(t=>{s.targets+=t.target_count??0,s.sent+=t.sent_count??0,s.read+=t.read_count??0,s.unread+=t.unread_count??0}),s},[$]),ee=(s,t)=>{A(r=>{const n={...r,[s]:t};return s==="target_users_text"&&typeof t=="string"&&t.trim().length>0&&(n.scope="custom"),n})},le=s=>{Le(t=>({...t,...s})),B(t=>({...t,page:1}))},As=()=>{Le(cs),B(s=>({...s,page:1}))},K=(s,t)=>{De(r=>({...r,[s]:t}))},me=c.useCallback(()=>{A(s=>s.scope==="custom"?s:{...s,scope:"custom"})},[A]),Ve=c.useCallback((s={})=>{const t={},r=m.search.trim();r&&(t.search=r);const n=m.fields.trim();n&&(t.fields=n);const h=m.school.trim();h&&(t.school=h);const d=m.emailSuffix.trim();d&&(t.email_suffix=d),m.status&&m.status!=="any"&&(t.status=m.status),m.isAdmin&&m.isAdmin!=="any"&&(t.is_admin=m.isAdmin);const l=s.limit??m.limit??25,i=Math.max(10,Math.min(500,Number(l)||25));t.limit=i;const f=s.page??1;return t.page=Math.max(1,Number(f)||1),t},[m]),ks=c.useCallback(()=>{const s={},t=m.search.trim(),r=m.school.trim(),n=m.emailSuffix.trim(),h=Math.max(10,Math.min(500,Number(m.limit)||25));return s.limit=h,t&&(s.search=t,m.fields&&m.fields!==te.fields&&(s.fields=m.fields)),r&&(s.school=r),n&&(s.email_suffix=n),m.status&&m.status!=="any"&&(s.status=m.status),m.isAdmin&&m.isAdmin!=="any"&&(s.is_admin=m.isAdmin),s},[m]),Fs=c.useCallback(s=>{if(!s||typeof s!="object")return a("admin.broadcast.recipientFilters.summary.fallback","Custom filter");const t=[];if(s.search&&(t.push(a("admin.broadcast.recipientFilters.summary.search",{value:s.search})),s.fields)){const n=s.fields.split(",").map(h=>h.trim()).filter(Boolean).map(h=>{const d=h==="school_name"?"school":h;return a("admin.broadcast.recipientSearch.fields."+d,d.replace(/_/g," "))});n.length>0&&t.push(a("admin.broadcast.recipientFilters.summary.fields",{fields:n.join(", ")}))}if(s.school&&t.push(a("admin.broadcast.recipientFilters.summary.school",{value:s.school})),s.email_suffix&&t.push(a("admin.broadcast.recipientFilters.summary.emailSuffix",{value:s.email_suffix})),(s.status==="active"||s.status==="inactive")&&t.push(a("admin.broadcast.recipientFilters.summary.status."+s.status,s.status)),s.is_admin==="1"||s.is_admin===1||s.is_admin===!0||s.is_admin==="true"?t.push(a("admin.broadcast.recipientFilters.summary.role.admin")):(s.is_admin==="0"||s.is_admin===0||s.is_admin===!1||s.is_admin==="false")&&t.push(a("admin.broadcast.recipientFilters.summary.role.user")),s.limit&&t.push(a("admin.broadcast.recipientFilters.summary.limit",{count:s.limit})),t.length===0)return a("admin.broadcast.recipientFilters.summary.fallback","Custom filter");const r=a("admin.broadcast.recipientFilters.summary.joiner"," • ");return t.join(r)},[a]),Ae=c.useCallback(async(s={})=>{const t=Ve(s);$e(!0),ve(null);try{const r=await ae.searchBroadcastRecipients(t),n=(r==null?void 0:r.data)??{},h=Array.isArray(n.data)?n.data:[],d=n.pagination??{},l=d.page??t.page??1,i=d.limit??t.limit??m.limit??25,f=!!d.has_more;je({items:h,pagination:{page:l,limit:i,has_more:f}}),Oe(l)}catch(r){ve(r),je(n=>({...n,items:[]}))}finally{$e(!1)}},[Ve,m.limit]),Ps=async()=>{await Ae({page:1})},qe=s=>{if(s==="prev"){const t=Math.max(1,P.pagination.page-1);t!==P.pagination.page&&Ae({page:t});return}P.pagination.has_more&&Ae({page:P.pagination.page+1})},Es=()=>{De(te),je({items:[],pagination:{page:1,has_more:!1,limit:te.limit}}),Oe(1),ve(null)},Ms=c.useCallback(s=>{if(!s||s.id===void 0||s.id===null)return;const t=Number(s.id);!Number.isInteger(t)||t<=0||(me(),Z(r=>{const n=new Map(r);return n.has(t)?n.delete(t):n.set(t,{id:t,username:s.username??null,email:s.email??null,school:s.school??null}),n}))},[me]),ke=c.useCallback((s,t)=>{if(s&&(s.preventDefault(),s.stopPropagation()),!t||t.id===void 0||t.id===null){C.error(a("admin.broadcast.recipientSearch.invalidUser","无法打开该用户信息"));return}const r=Number(t.id);if(!Number.isInteger(r)||r<=0){C.error(a("admin.broadcast.recipientSearch.invalidUser","无法打开该用户信息"));return}j(`/admin/users?userId=${r}`)},[j,a]),Ts=s=>{Z(t=>{const r=new Map(t);return r.delete(s),r})},Is=()=>{Z(new Map)},Ls=()=>{if(!P.items.length){C.error(a("admin.broadcast.recipients.emptySelection","No recipients in current result set."));return}me(),Z(s=>{const t=new Map(s);return P.items.forEach(r=>{const n=Number((r==null?void 0:r.id)??0);Number.isInteger(n)&&n>0&&t.set(n,{id:n,username:r.username??null,email:r.email??null,school:r.school??null})}),t}),C.success(a("admin.broadcast.recipients.addedAll","Recipients added to selection."))},Ds=()=>{if(!ie){C.error(a("admin.broadcast.recipientFilters.requireCondition","Please configure at least one filter condition."));return}me();const s=ks();ne(t=>[...t,s]),C.success(a("admin.broadcast.recipientFilters.added","Filter added to broadcast payload."))},Os=s=>{ne(t=>t.filter((r,n)=>n!==s))},Ke=()=>{const s=d=>{if(!d||typeof d!="string")return d;const l=d.trim(),i=l.toLowerCase();return/(\[announcement\]|\[公告\]|【公告】|\b(公告|announcement|broadcast|boardcast|system|系统)\b)/i.test(i)?l:`[Announcement/公告] ${l}`},t=he.includes(p.priority)?p.priority:"normal",r={title:s(p.title.trim()),content:p.content.trim(),priority:t},n={};if(r.title||(n.title=a("admin.broadcast.validation.titleRequired")),r.content||(n.content=a("admin.broadcast.validation.contentRequired")),he.includes(p.priority)||(n.priority=a("admin.broadcast.validation.priorityInvalid")),p.scope==="custom"){const d=p.target_users_text.trim(),l=new Set(q);G.length>0?G.forEach(i=>l.add(i)):d.length>0&&q.length===0&&(n.target_users_text=a("admin.broadcast.validation.targetsInvalid")),l.size>0&&(r.target_users=Array.from(l)),l.size===0&&V.length===0&&(n.target_users_text=a("admin.broadcast.validation.targetsRequired")),V.length>0&&(r.target_filters=V.map(i=>({...i})))}if(p.scope!=="custom"){const d=new Set;q.length>0&&q.forEach(l=>d.add(l)),G.length>0&&G.forEach(l=>d.add(l)),d.size>0&&(r.target_users=Array.from(d)),V.length>0&&(r.target_filters=V.map(l=>({...l})))}M(n);const h=Object.values(n)[0];return{payload:r,isValid:Object.keys(n).length===0,firstError:h}},We=Qe(s=>ae.broadcastMessage(s),{onSuccess:(s,t)=>{const r=(s==null?void 0:s.data)??{},n=Array.isArray(r.failed_user_ids)?r.failed_user_ids:[],h=Array.isArray(r.invalid_user_ids)?r.invalid_user_ids:[],d={sent:r.sent_count??0,total:r.total_targets??(t!=null&&t.target_users?t.target_users.length:0),failed:n,invalid:h,priority:r.priority??(t==null?void 0:t.priority)??"normal",emailDelivery:r.email_delivery??null};C.success(a("admin.broadcast.sendSuccess",{count:d.sent})),y(null),A(os),M({}),k(d),g({}),Z(new Map),ne([]),Ce()},onError:s=>{var r,n;const t=((n=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:n.error)||(s==null?void 0:s.message)||a("admin.broadcast.sendFailed");C.error(t)}}),ue=Qe((s={})=>ae.flushBroadcastQueue(s),{onSuccess:s=>{var r;const t=Array.isArray((r=s==null?void 0:s.data)==null?void 0:r.processed)?s.data.processed:[];t.length>0?C.success(a("admin.broadcast.history.flushSuccess",{count:t.length})):C(a("admin.broadcast.history.flushEmpty")),Ce()},onError:s=>{var r,n;const t=((n=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:n.error)||(s==null?void 0:s.message)||a("admin.broadcast.history.flushErrorDefault");C.error(a("admin.broadcast.history.flushError",{message:t}))}}),$s=()=>{var n;const{payload:s,isValid:t,firstError:r}=Ke();if(!t){C.error(r??a("admin.broadcast.validation.general"));return}y({title:s.title,content:s.content,priority:s.priority,scope:p.scope,targetCount:p.scope==="custom"?((n=s.target_users)==null?void 0:n.length)??0:null})},Hs=()=>{const{payload:s,isValid:t,firstError:r}=Ke();if(!t){C.error(r??a("admin.broadcast.validation.general"));return}k(null),We.mutate(s)},Us=c.useCallback(()=>{ue.mutate({limit:10})},[ue]),Bs=s=>{g(t=>({...t,[s]:!t[s]}))},zs=()=>{if(!$.length){C.error(a("admin.broadcast.export.empty"));return}try{const s=["id","title","content","priority","scope","targets","sent","read","unread","failed","invalid","actor","created_at","read_users","unread_users"],t=i=>i==null?'""':`"${String(i).replace(/"/g,'""')}"`,r=$.map(i=>{const f=i.actor_username||(i.actor_user_id?`#${i.actor_user_id}`:a("common.unknown")),R=Array.isArray(i.read_users)?i.read_users.map(T=>T.username||`#${T.user_id??"?"}`).join("; "):"",se=Array.isArray(i.unread_users)?i.unread_users.map(T=>T.username||`#${T.user_id??"?"}`).join("; "):"";return[i.id,i.title,i.content,i.priority,i.scope,i.target_count,i.sent_count,i.read_count,i.unread_count,Array.isArray(i.failed_user_ids)?i.failed_user_ids.join(" "):"",Array.isArray(i.invalid_user_ids)?i.invalid_user_ids.join(" "):"",f,i.created_at,R,se].map(t).join(",")}),n=[s.join(","),...r].join(`
`),h=new Blob([n],{type:"text/csv;charset=utf-8;"}),d=window.URL.createObjectURL(h),l=document.createElement("a");l.href=d,l.setAttribute("download",`broadcast-history-${Date.now()}.csv`),document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(d),C.success(a("admin.broadcast.export.success"))}catch{C.error(a("admin.broadcast.export.error"))}},Vs=s=>{g({}),B(t=>({...t,page:s}))},Fe=We.isLoading,Pe=((Ge=b==null?void 0:b.invalid)==null?void 0:Ge.length)??0,Ee=((Ye=b==null?void 0:b.failed)==null?void 0:Ye.length)??0,qs=$.length===0,w=c.useMemo(()=>{if(!(b!=null&&b.emailDelivery))return null;const s=b.emailDelivery;return{status:s.status??"skipped",triggered:!!s.triggered,attempted:s.attempted_recipients??0,successfulChunks:s.successful_chunks??0,failedChunks:s.failed_chunks??0,missing:Array.isArray(s.missing_email_user_ids)?s.missing_email_user_ids:[],failedRecipients:Array.isArray(s.failed_recipient_ids)?s.failed_recipient_ids:[],errors:Array.isArray(s.errors)?s.errors:[]}},[b]),Ks=c.useMemo(()=>{if(!w)return"info";switch(w.status){case"sent":return"success";case"partial":return"warning";case"failed":return"destructive";case"queued":return"info";default:return"info"}},[w]);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:a("admin.broadcast.title")}),e.jsx("p",{className:"text-muted-foreground",children:a("admin.broadcast.description")}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6 space-y-4",children:[Object.keys(v).length>0&&e.jsx(I,{variant:"warning",children:e.jsx(L,{children:a("admin.broadcast.validation.general")})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.broadcast.form.title")}),e.jsx(Q,{value:p.title,onChange:s=>ee("title",s.target.value),error:!!v.title,placeholder:a("admin.broadcast.form.title")}),v.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:v.title})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.broadcast.form.content")}),e.jsx(na,{value:p.content,onChange:s=>ee("content",s.target.value),className:re(v.content&&"border-red-500 focus-visible:ring-red-500"),placeholder:a("admin.broadcast.form.content")}),v.content&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:v.content})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.broadcast.form.priority")}),e.jsx("select",{value:p.priority,onChange:s=>ee("priority",s.target.value),className:re("w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",v.priority&&"border-red-500 focus:ring-red-500"),children:he.map(s=>e.jsx("option",{value:s,children:a(`messages.priority.${s}`)},s))}),v.priority&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:v.priority})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.broadcast.form.scope")}),e.jsxs("select",{value:p.scope,onChange:s=>ee("scope",s.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:a("admin.broadcast.scope.all")}),e.jsx("option",{value:"custom",children:a("admin.broadcast.scope.custom")})]})]})]}),p.scope==="custom"&&e.jsxs("div",{className:"space-y-4 rounded-lg border border-dashed bg-slate-50/60 p-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.broadcast.form.targetUsers")}),e.jsx(Q,{placeholder:a("admin.broadcast.form.targetUsersPlaceholder"),value:p.target_users_text,onChange:s=>ee("target_users_text",s.target.value),error:!!v.target_users_text}),v.target_users_text?e.jsx("p",{className:"mt-1 text-sm text-red-600",children:v.target_users_text}):e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:G.length>0?a("admin.broadcast.helper.customCount",{count:G.length}):a("admin.broadcast.helper.customEmpty")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700",children:a("admin.broadcast.recipients.selected","Selected recipients")}),q.length>0&&e.jsx(N,{variant:"ghost",size:"sm",onClick:Is,children:a("common.clear","Clear")})]}),q.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.broadcast.recipients.none","No individual recipients selected yet.")}):e.jsx("div",{className:"flex flex-wrap gap-2",children:Ne.map(s=>{const t=s.username||s.email||`#${s.id}`;return e.jsxs(W,{variant:"secondary",className:"flex items-center gap-2",children:[e.jsx("span",{children:t}),e.jsx("button",{type:"button",onClick:()=>Ts(s.id),className:"text-xs text-muted-foreground hover:text-red-600","aria-label":a("common.remove","Remove"),children:"×"})]},s.id)})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.recipients.selectedCount","Total selected: {{count}}",{count:q.length})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700",children:a("admin.broadcast.recipientFilters.title","Applied filter groups")}),V.length>0&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>ne([]),children:a("common.clear","Clear")})]}),V.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.broadcast.recipientFilters.none","No filter groups added yet.")}):e.jsx("div",{className:"flex flex-wrap gap-2",children:V.map((s,t)=>e.jsxs(W,{variant:"outline",className:"flex items-center gap-2",children:[e.jsx("span",{children:Fs(s)}),e.jsx("button",{type:"button",onClick:()=>Os(t),className:"text-xs text-muted-foreground hover:text-red-600","aria-label":a("common.remove","Remove"),children:"×"})]},t))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700",children:a("admin.broadcast.recipientSearch.title","Advanced recipient search")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.recipientSearch.description","Filter users by school, email domain or other attributes, then select individuals or add the filter group to this broadcast.")})]}),e.jsx(N,{variant:"outline",size:"sm",onClick:Ds,disabled:!ie,title:ie?void 0:a("admin.broadcast.recipientFilters.hint","Set a condition above to enable this button."),children:a("admin.broadcast.recipientFilters.add","Add filter to broadcast")})]}),!ie&&e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.recipientFilters.hint","Set a condition above to enable this button.")}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-4",children:[e.jsx(Q,{value:m.search,onChange:s=>K("search",s.target.value),placeholder:a("admin.broadcast.recipientSearch.searchPlaceholder","Search text (name, email, school...)")}),e.jsxs("select",{value:m.fields,onChange:s=>K("fields",s.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"username,email,school,location",children:a("admin.broadcast.recipientSearch.fields.all","All key fields")}),e.jsx("option",{value:"email",children:a("admin.broadcast.recipientSearch.fields.email","Email")}),e.jsx("option",{value:"school,school_name",children:a("admin.broadcast.recipientSearch.fields.school","School")}),e.jsx("option",{value:"location",children:a("admin.broadcast.recipientSearch.fields.location","Location")}),e.jsx("option",{value:"username",children:a("admin.broadcast.recipientSearch.fields.username","Username")})]}),e.jsx(Q,{value:m.school,onChange:s=>K("school",s.target.value),placeholder:a("admin.broadcast.recipientSearch.schoolPlaceholder","School contains...")}),e.jsx(Q,{value:m.emailSuffix,onChange:s=>K("emailSuffix",s.target.value),placeholder:a("admin.broadcast.recipientSearch.emailPlaceholder","Email domain e.g. example.com")}),e.jsxs("select",{value:m.status,onChange:s=>K("status",s.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"any",children:a("admin.broadcast.recipientSearch.status.any","Any status")}),e.jsx("option",{value:"active",children:a("admin.broadcast.recipientSearch.status.active","Active")}),e.jsx("option",{value:"inactive",children:a("admin.broadcast.recipientSearch.status.inactive","Inactive")})]}),e.jsxs("select",{value:m.isAdmin,onChange:s=>K("isAdmin",s.target.value),className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"any",children:a("admin.broadcast.recipientSearch.role.any","All roles")}),e.jsx("option",{value:"1",children:a("admin.broadcast.recipientSearch.role.admin","Admins")}),e.jsx("option",{value:"0",children:a("admin.broadcast.recipientSearch.role.user","Regular users")})]}),e.jsx("select",{value:m.limit,onChange:s=>K("limit",Number(s.target.value)||25),className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[10,25,50,100].map(s=>e.jsx("option",{value:s,children:a("admin.broadcast.recipientSearch.limit",{count:s})},s))})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(N,{type:"button",onClick:Ps,disabled:z,children:z?a("common.loading","Loading..."):a("common.search","Search")}),e.jsx(N,{type:"button",variant:"outline",onClick:Ls,disabled:z||P.items.length===0,children:a("admin.broadcast.recipientSearch.addAll","Add visible recipients")}),e.jsx(N,{type:"button",variant:"ghost",onClick:Es,disabled:z,children:a("common.reset","Reset")})]}),He&&e.jsxs(I,{variant:"destructive",children:[e.jsx(L,{children:a("admin.broadcast.recipientSearch.error","Search failed")}),e.jsx(D,{children:He.message??a("common.retry","Please retry later.")})]}),e.jsxs("div",{className:"space-y-3",children:[z&&e.jsx("p",{className:"text-sm text-muted-foreground",children:a("common.loading","Loading...")}),!z&&P.items.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.broadcast.recipientSearch.noResults","No users match the current search conditions.")}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.recipientSearch.resultCount",{count:P.items.length})}),P.items.map(s=>{const t=Number((s==null?void 0:s.id)??0),r=ye.has(t),n=s.username||s.email||`#${t}`,h=typeof(s==null?void 0:s.status)=="string"?s.status.toLowerCase():"",d=h==="active"?a("admin.users.statusActive","活跃"):h==="inactive"?a("admin.users.statusInactive","未激活"):h==="suspended"?a("admin.users.statusSuspended","已暂停"):h||"",l=s==null?void 0:s.is_admin,i=l!=null&&`${l}`!="",f=l===!0||l===1||l==="1"||l==="true";return e.jsxs("label",{className:"flex items-start gap-3 rounded-md border border-gray-200 bg-white p-3 shadow-sm",children:[e.jsx(oa,{checked:r,onCheckedChange:()=>Ms(s)}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs(js,{children:[e.jsx(vs,{asChild:!0,children:e.jsx("span",{className:"cursor-help text-sm font-medium text-gray-800 hover:text-green-600",children:n})}),e.jsx(ys,{className:"w-72",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:n}),e.jsxs("div",{className:"space-y-1 text-xs text-muted-foreground",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[a("admin.broadcast.recipientSearch.hover.userId","用户ID"),":"]})," ","#",t]}),s.email&&e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[a("common.email","邮箱"),":"]})," ",s.email]}),s.school&&e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[a("admin.broadcast.recipientSearch.hover.school","学校"),":"]})," ",s.school]}),s.location&&e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium text-gray-700",children:[a("admin.broadcast.recipientSearch.hover.location","地区"),":"]})," ",s.location]}),(d||i)&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[d&&e.jsx("span",{className:re("inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",h==="active"?"bg-green-100 text-green-800":"bg-amber-100 text-amber-800"),children:d}),i&&e.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-700",children:f?a("admin.users.roleAdmin","管理员"):a("admin.users.roleUser","用户")})]})]})]})})]}),e.jsx(N,{type:"button",size:"sm",variant:"outline",onClick:R=>ke(R,s),children:a("admin.broadcast.recipientSearch.viewProfile","查看用户")})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.email?s.email:a("admin.broadcast.recipientSearch.noEmail","No email on file"),s.school?` • ${s.school}`:""]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["#",t]}),d&&e.jsx("span",{className:h==="active"?"font-medium text-green-600":"font-medium text-amber-700",children:d}),i&&e.jsx("span",{className:"font-medium text-gray-700",children:f?a("admin.users.roleAdmin","管理员"):a("admin.users.roleUser","用户")})]})]})]},t)}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 pt-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.recipientSearch.pageInfo",{page:P.pagination.page})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:()=>qe("prev"),disabled:z||P.pagination.page===1,children:a("common.previous","Previous")}),e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:()=>qe("next"),disabled:z||!P.pagination.has_more,children:a("common.next","Next")})]})]})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(N,{type:"button",variant:"outline",onClick:$s,disabled:Fe,children:a("admin.broadcast.preview")}),e.jsx(N,{type:"button",onClick:Hs,disabled:Fe,children:a(Fe?"common.sending":"admin.broadcast.send")})]})]}),_&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6 space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:a("admin.broadcast.previewPanel")}),e.jsx(W,{variant:"secondary",children:a(`messages.priority.${_.priority}`)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:_.scope==="custom"?a("admin.broadcast.previewTargets.custom",{count:_.targetCount??0}):a("admin.broadcast.previewTargets.all")}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-sm text-gray-500 mr-2",children:[a("admin.broadcast.form.title"),":"]}),e.jsx("span",{className:"font-medium",children:_.title})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-sm text-gray-500 mr-2",children:[a("admin.broadcast.form.content"),":"]}),e.jsx("p",{className:"mt-1 whitespace-pre-wrap text-sm leading-relaxed",children:_.content})]})]}),e.jsxs(I,{className:"mt-4",variant:"info",children:[e.jsx(L,{children:a("admin.broadcast.noticeTitle")}),e.jsx(D,{children:a("admin.broadcast.noticeDesc")})]})]}),b&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:a("admin.broadcast.result.title")}),e.jsx(W,{variant:"outline",children:a(`messages.priority.${b.priority}`)})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(S,{label:a("admin.broadcast.result.sent"),value:b.sent,tone:"success"}),e.jsx(S,{label:a("admin.broadcast.result.targets"),value:b.total}),e.jsx(S,{label:a("admin.broadcast.result.failed"),value:Ee||a("admin.broadcast.result.none"),tone:Ee?"danger":"default"}),e.jsx(S,{label:a("admin.broadcast.result.invalid"),value:Pe||a("admin.broadcast.result.none"),tone:Pe?"warning":"default"})]}),Ee>0&&e.jsxs(I,{variant:"destructive",children:[e.jsx(L,{children:a("admin.broadcast.result.failed")}),e.jsxs(D,{children:[e.jsx("p",{children:a("admin.broadcast.result.failedHint")}),e.jsx("span",{className:"mt-2 block font-mono text-xs",children:b.failed.join(", ")})]})]}),Pe>0&&e.jsxs(I,{variant:"warning",children:[e.jsx(L,{children:a("admin.broadcast.result.invalid")}),e.jsxs(D,{children:[e.jsx("p",{children:a("admin.broadcast.result.invalidHint")}),e.jsx("span",{className:"mt-2 block font-mono text-xs",children:b.invalid.join(", ")})]})]}),w&&e.jsxs(I,{variant:Ks,children:[e.jsx(L,{children:a(`admin.broadcast.email.status.${w.status}`)}),e.jsxs(D,{children:[e.jsx("p",{children:w.status==="queued"?a("admin.broadcast.email.queuedSummary",{count:w.attempted}):a("admin.broadcast.email.summary",{attempted:w.attempted,success:w.successfulChunks,failed:w.failedChunks})}),w.missing.length>0&&e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:[a("admin.broadcast.email.missing",{count:w.missing.length}),e.jsx("span",{className:"ml-1 font-mono",children:w.missing.join(", ")})]}),w.errors.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:a("admin.broadcast.email.errorsTitle")}),e.jsx("ul",{className:"mt-1 space-y-1 text-xs font-mono",children:w.errors.map((s,t)=>e.jsx("li",{children:s},`${s}-${t}`))})]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:a("admin.broadcast.history.title")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.broadcast.history.description")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(N,{variant:"outline",size:"sm",onClick:()=>As(),disabled:oe||Ss,children:a("common.reset")}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>Ce(),disabled:oe,children:a("common.refresh")}),e.jsx(N,{variant:"outline",size:"sm",onClick:Us,disabled:ue.isLoading,children:ue.isLoading?a("admin.broadcast.history.flushLoading"):a("admin.broadcast.history.flushButton")}),e.jsx(N,{size:"sm",onClick:zs,disabled:qs||oe,children:a("admin.broadcast.export.label")})]})]}),Be&&e.jsxs(I,{variant:"destructive",children:[e.jsx(L,{children:a("admin.broadcast.sendFailed")}),e.jsx(D,{children:Be.message??"Failed to load history."})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-5",children:[e.jsx(S,{label:a("admin.broadcast.summary.broadcasts"),value:X.broadcasts}),e.jsx(S,{label:a("admin.broadcast.summary.targets"),value:X.targets}),e.jsx(S,{label:a("admin.broadcast.summary.delivered"),value:X.sent,tone:"success"}),e.jsx(S,{label:a("admin.broadcast.summary.read"),value:X.read}),e.jsx(S,{label:a("admin.broadcast.summary.unread"),value:X.unread,tone:X.unread?"warning":"default"})]}),_s&&e.jsxs(I,{variant:"destructive",children:[e.jsx(L,{children:a("admin.broadcast.analytics.loadFailedTitle","无法加载站内信统计")}),e.jsx(D,{children:(_e==null?void 0:_e.message)??a("common.retry","请稍后重试")})]}),e.jsxs("div",{className:"grid gap-4 xl:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]",children:[e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:a("admin.broadcast.analytics.trendTitle","站内信发送趋势")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.analytics.trendSubtitle","最近30日总发送与未读趋势")})]}),e.jsx(N,{type:"button",size:"sm",variant:"outline",onClick:()=>Cs(),disabled:Ue,children:Ue?a("admin.broadcast.analytics.refreshing","刷新中..."):a("common.refresh","刷新")})]}),e.jsx("div",{className:"mt-4 h-72",children:ze?e.jsx("div",{className:"flex h-full items-center justify-center text-sm text-muted-foreground",children:a("common.loading","加载中...")}):ws?e.jsx(Ze,{children:e.jsxs(la,{data:we,children:[e.jsx(Je,{strokeDasharray:"4 4",stroke:"#e2e8f0"}),e.jsx(es,{dataKey:"date",tickFormatter:s=>{if(!s)return s;const t=new Date(`${s}T00:00:00`);return Number.isNaN(t.getTime())?s:o.format(t)},stroke:"#475569",fontSize:12}),e.jsx(ss,{allowDecimals:!1,stroke:"#475569",fontSize:12}),e.jsx(as,{formatter:s=>u.format(s),labelFormatter:s=>{if(!s)return s;const t=new Date(`${s}T00:00:00`);return Number.isNaN(t.getTime())?s:o.format(t)}}),e.jsx(ts,{}),e.jsx(rs,{type:"monotone",dataKey:"total",stroke:"#2563eb",strokeWidth:2,dot:!1,name:a("admin.broadcast.analytics.totalSeries","总发送")}),e.jsx(rs,{type:"monotone",dataKey:"unread",stroke:"#f97316",strokeWidth:2,dot:!1,name:a("admin.broadcast.analytics.unreadSeries","未读")})]})}):e.jsx("div",{className:"flex h-full items-center justify-center text-sm text-muted-foreground",children:a("admin.broadcast.analytics.trendEmpty","暂无趋势数据")})})]}),e.jsxs("div",{className:"rounded-lg border bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:a("admin.broadcast.analytics.priorityTitle","优先级分布")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.analytics.prioritySubtitle","按消息优先级统计未读情况")})]}),e.jsxs("div",{className:"mt-4 grid gap-3 sm:grid-cols-3",children:[e.jsx(S,{label:a("admin.broadcast.analytics.totalMessages","累计消息"),value:u.format(J.total)}),e.jsx(S,{label:a("admin.broadcast.analytics.readMessages","已读消息"),value:u.format(J.read),tone:"success"}),e.jsx(S,{label:a("admin.broadcast.analytics.unreadMessages","未读消息"),value:u.format(J.unread),tone:J.unread?"warning":"default"})]}),e.jsxs("p",{className:"mt-3 text-xs text-muted-foreground",children:[a("admin.broadcast.analytics.unreadRatio","当前未读率")," ",e.jsx("span",{className:"font-semibold text-orange-500",children:x.format(J.unreadRatio||0)})]}),e.jsx("div",{className:"mt-4 h-64",children:ze?e.jsx("div",{className:"flex h-full items-center justify-center text-sm text-muted-foreground",children:a("common.loading","加载中...")}):Rs?e.jsx(Ze,{children:e.jsxs(ma,{data:Re,layout:"vertical",children:[e.jsx(Je,{strokeDasharray:"4 4",stroke:"#e2e8f0"}),e.jsx(es,{type:"number",allowDecimals:!1,stroke:"#475569",fontSize:12}),e.jsx(ss,{type:"category",dataKey:"name",stroke:"#475569",fontSize:12,width:90}),e.jsx(as,{formatter:s=>u.format(s)}),e.jsx(ts,{}),e.jsx(ns,{dataKey:"total",name:a("admin.broadcast.analytics.totalSeries","总发送"),barSize:14,children:Re.map(s=>e.jsx(da,{fill:s.color},`priority-total-${s.priority}`))}),e.jsx(ns,{dataKey:"unread",name:a("admin.broadcast.analytics.unreadSeries","未读"),barSize:14,fill:"#f97316"})]})}):e.jsx("div",{className:"flex h-full items-center justify-center text-sm text-muted-foreground",children:a("admin.broadcast.analytics.priorityEmpty","暂无按优先级统计数据")})}),e.jsx("div",{className:"mt-4 space-y-2 text-xs text-muted-foreground",children:Re.map(s=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"h-2.5 w-2.5 rounded-full",style:{backgroundColor:s.color}}),e.jsx("span",{className:"font-medium text-gray-700",children:s.name})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:u.format(s.total)}),e.jsxs("span",{className:"text-sky-600",children:[a("admin.broadcast.analytics.unreadLabelShort","未读")," ",u.format(s.unread)]})]})]},s.priority))})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.broadcast.filters.search")}),e.jsx(Q,{value:F.search,onChange:s=>le({search:s.target.value}),placeholder:a("admin.broadcast.filters.searchPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.broadcast.filters.priority")}),e.jsxs("select",{value:F.priority,onChange:s=>le({priority:s.target.value}),className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"any",children:a("common.all")}),he.map(s=>e.jsx("option",{value:s,children:a(`messages.priority.${s}`)},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("admin.broadcast.filters.scope")}),e.jsxs("select",{value:F.scope,onChange:s=>le({scope:s.target.value}),className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"any",children:a("common.all")}),e.jsx("option",{value:"all",children:a("admin.broadcast.scope.all")}),e.jsx("option",{value:"custom",children:a("admin.broadcast.scope.custom")})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ia,{id:"broadcast-unread-toggle",checked:F.unreadOnly,onCheckedChange:s=>le({unreadOnly:!!s})}),e.jsx("label",{htmlFor:"broadcast-unread-toggle",className:"text-sm text-muted-foreground",children:a("admin.broadcast.filters.onlyUnread")})]}),oe?e.jsx("p",{className:"text-sm text-muted-foreground",children:a("common.loading")}):$.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.broadcast.history.empty")}):e.jsx("div",{className:"space-y-4",children:$.map(s=>{const t=!!U[s.id],r=ds(s.read_users??[]),n=ds(s.unread_users??[]),h=s.invalid_user_ids??[],d=s.failed_user_ids??[],l=s.actor_username||(s.actor_user_id?`#${s.actor_user_id}`:a("common.unknown")),i=s.email_delivery??{},f=(i==null?void 0:i.status)??"skipped",R=Array.isArray(i==null?void 0:i.errors)?i.errors:[],se={sent:"secondary",partial:"high",failed:"destructive",queued:"secondary",skipped:"outline"}[f]??"outline";return e.jsxs("div",{className:"rounded-lg border p-5 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-lg font-semibold",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:wa(s.created_at)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a("admin.broadcast.sentBy",{actor:l,id:s.actor_user_id??a("common.unknown")})}),e.jsx("p",{className:"text-sm whitespace-pre-wrap text-muted-foreground",children:s.content})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(W,{variant:"outline",children:a(`messages.priority.${s.priority}`)}),e.jsx(W,{variant:"secondary",children:a(`admin.broadcast.scope.${s.scope==="custom"?"custom":"all"}`)}),e.jsx(W,{variant:se,children:a(`admin.broadcast.email.status.${f}`)})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(S,{label:a("admin.broadcast.result.sent"),value:s.sent_count,tone:"success"}),e.jsx(S,{label:a("admin.broadcast.result.targets"),value:s.target_count}),e.jsx(S,{label:a("admin.broadcast.result.failed"),value:d.length||a("admin.broadcast.result.none"),tone:(d.length??0)>0?"danger":"default"}),e.jsx(S,{label:a("admin.broadcast.result.invalid"),value:h.length||a("admin.broadcast.result.none"),tone:(h.length??0)>0?"warning":"default"})]}),d.length>0&&e.jsxs(I,{variant:"destructive",children:[e.jsx(L,{children:a("admin.broadcast.result.failed")}),e.jsx(D,{children:e.jsx("span",{className:"font-mono text-xs",children:d.join(", ")})})]}),h.length>0&&e.jsxs(I,{variant:"warning",children:[e.jsx(L,{children:a("admin.broadcast.result.invalid")}),e.jsx(D,{children:e.jsx("span",{className:"font-mono text-xs",children:h.join(", ")})})]}),i&&(f!=="sent"||R.length>0||(i.missing_email_user_ids??[]).length>0)&&e.jsxs(I,{variant:f==="failed"?"destructive":f==="partial"?"warning":"info",children:[e.jsx(L,{children:a(`admin.broadcast.email.status.${f}`)}),e.jsxs(D,{children:[e.jsx("p",{children:f==="queued"?a("admin.broadcast.email.queuedSummary",{count:i.attempted_recipients??0}):a("admin.broadcast.email.summary",{attempted:i.attempted_recipients??0,success:i.successful_chunks??0,failed:i.failed_chunks??0})}),Array.isArray(i.missing_email_user_ids)&&i.missing_email_user_ids.length>0&&e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:[a("admin.broadcast.email.missing",{count:i.missing_email_user_ids.length}),e.jsx("span",{className:"ml-1 font-mono",children:i.missing_email_user_ids.join(", ")})]}),R.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:a("admin.broadcast.email.errorsTitle")}),e.jsx("ul",{className:"mt-1 space-y-1 text-xs font-mono",children:R.map((T,Me)=>e.jsx("li",{children:T},`${T}-${Me}`))})]})]})]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>Bs(s.id),children:a(t?"admin.broadcast.history.hideDetails":"admin.broadcast.history.showDetails")}),t&&e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h5",{className:"text-sm font-medium text-green-700",children:[a("admin.broadcast.result.sent")," (",s.read_count??r.list.length,")"]}),e.jsx(ls,{users:r.list,onViewUser:ke,t:a}),r.more>0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.history.more",{count:r.more})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h5",{className:"text-sm font-medium text-yellow-700",children:[a("admin.broadcast.result.unread")," (",s.unread_count??n.list.length,")"]}),e.jsx(ls,{users:n.list,onViewUser:ke,t:a}),n.more>0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:a("admin.broadcast.history.more",{count:n.more})})]})]})]},s.id)})}),e.jsx(ca,{currentPage:ce.page??O.page,totalPages:ce.pages??1,onPageChange:Vs,itemsPerPage:ce.limit??O.limit,totalItems:ce.total??$.length,className:"pt-2"})]})]})}function Ha(){return e.jsx(Ra,{})}export{Ha as default};
