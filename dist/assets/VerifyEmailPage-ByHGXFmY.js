import{j as s}from"./motion-vendor-C11-9Hm-.js";import{h as te,l as se,r as c}from"./react-vendor-CFnAvB5y.js";import{u as ae}from"./index.esm-Dwrm2jdL.js";import{c as ie,u as ne,O as H,P as B,I as U,B as N,d as C,n as u,Q as re}from"./index-CQ91Xfn2.js";import{C as oe,a as ce,b as le,c as ue,d as me}from"./Card-CvB_sIzW.js";import{A as O,a as W}from"./Alert-B9j1D3yi.js";import{T as de}from"./Turnstile-ZpObHXMA.js";import"./i18n-vendor-DK0x1_bH.js";import"./charts-vendor-DJkHj7pX.js";/**
 * @license lucide-react v0.510.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8",key:"12jkf8"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m16 19 2 2 4-4",key:"1b14m6"}]],ve=ie("mail-check",fe),Q=e=>{if(!e)return null;const d=Date.parse(e);return Number.isNaN(d)?null:d},Se=()=>{const{t:e}=ne(),d=te(),[p]=se(),x=p.get("token"),I=p.get("return"),T=t=>typeof window>"u"?null:sessionStorage.getItem(t),_=c.useMemo(()=>{var t;return p.get("email")||T("pending_verification_email")||((t=H.getUser())==null?void 0:t.email)||""},[p]),{register:A,handleSubmit:$,setValue:R,getValues:z,watch:G,formState:{errors:j}}=ae({defaultValues:{email:_,code:""}});c.useEffect(()=>{_&&R("email",_)},[_,R]);const[b,f]=c.useState(!1),[E,J]=c.useState(!1),[K,S]=c.useState(x?"pending":"idle"),[v,o]=c.useState(null),[h,V]=c.useState(()=>Q(T("verification_resend_available_at"))),[X,k]=c.useState(0),q=c.useRef(null),[g,w]=c.useState(""),y=!0,Y=G("email"),M=t=>{const n=t==null?void 0:t.token,r=t==null?void 0:t.user;if(n&&re.setToken(n),r&&H.setUser(r),typeof window<"u"){sessionStorage.removeItem("pending_verification_email"),sessionStorage.removeItem("verification_resend_available_at");const a=sessionStorage.getItem("verification_return_path");sessionStorage.removeItem("verification_return_path"),d(I||a||"/dashboard",{replace:!0})}else d(I||"/dashboard",{replace:!0})};c.useEffect(()=>{if(!h){k(0);return}const t=()=>{const r=h-Date.now();r<=0?(k(0),V(null),typeof window<"u"&&sessionStorage.removeItem("verification_resend_available_at")):k(r)};t();const n=window.setInterval(t,1e3);return()=>window.clearInterval(n)},[h]),c.useEffect(()=>{x&&!E&&(async()=>{var n,r;S("pending"),f(!0),o(null);try{const a=await C.verifyEmail({token:x});if(a.success)u.success(e("auth.verification.tokenSuccess")),M(a.data);else{S("failed");const i=a.message||e("auth.verification.tokenFailed");o({variant:"destructive",message:i}),u.error(i)}}catch(a){S("failed");const i=((r=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:r.message)||a.message||e("auth.verification.tokenFailed");o({variant:"destructive",message:i}),u.error(i)}finally{f(!1),J(!0)}})()},[x,E,e]);const F=()=>{if(y&&!g){const t=e("auth.verification.turnstileRequired");return o({variant:"warning",message:t}),u.error(t),!1}return!0},P=()=>{var t,n;w(""),(n=(t=q.current)==null?void 0:t.reset)==null||n.call(t)},Z=async t=>{var a,i;const n=t.email.trim(),r=t.code.trim();if(!n){o({variant:"warning",message:e("auth.verification.emailRequired")});return}if(!r){o({variant:"warning",message:e("auth.verification.codeRequired")});return}if(F()){f(!0),o(null);try{const l=await C.verifyEmail({email:n,code:r,cf_turnstile_response:g});if(l.success)u.success(e("auth.verification.codeSuccess")),M(l.data);else{const m=l.message||e("auth.verification.codeFailed");o({variant:"destructive",message:m}),u.error(m)}}catch(l){const m=((i=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:i.message)||l.message||e("auth.verification.codeFailed");o({variant:"destructive",message:m}),u.error(m)}finally{P(),f(!1)}}},ee=async()=>{var n,r;const t=z("email").trim();if(!t){o({variant:"warning",message:e("auth.verification.emailRequired")});return}if(F()){f(!0);try{const a=await C.sendVerificationCode({email:t,cf_turnstile_response:g});if(a.success){const i=a.data||{},l=Q(i.verification_resend_available_at);typeof window<"u"&&(sessionStorage.setItem("pending_verification_email",t),i.verification_resend_available_at?sessionStorage.setItem("verification_resend_available_at",i.verification_resend_available_at):sessionStorage.removeItem("verification_resend_available_at")),V(l);const m=a.message||e("auth.verification.resendSuccess");o({variant:"info",message:m}),u.success(m)}else{const i=a.message||e("auth.verification.tokenFailed");o({variant:"destructive",message:i}),u.error(i)}}catch(a){const i=((r=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:r.message)||a.message||e("auth.verification.tokenFailed");o({variant:"destructive",message:i}),u.error(i)}finally{P(),f(!1)}}},L=b||h!==null&&h>Date.now()||y&&!g,D=Math.max(0,Math.ceil(X/1e3));return s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8",children:s.jsx("div",{className:"max-w-md w-full space-y-6",children:s.jsxs(oe,{children:[s.jsxs(ce,{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ve,{className:"h-6 w-6 text-green-600"}),s.jsx(le,{children:e("auth.verification.title")})]}),s.jsx(ue,{children:e("auth.verification.description",{email:Y||e("auth.verification.yourEmail")})})]}),s.jsxs(me,{className:"space-y-4",children:[K==="pending"&&s.jsx(O,{variant:"info",children:s.jsxs(W,{className:"flex items-center gap-2",children:[s.jsx(B,{className:"h-4 w-4 animate-spin"}),e("auth.verification.tokenVerifying")]})}),(v==null?void 0:v.message)&&s.jsx(O,{variant:v.variant||"info",children:s.jsx(W,{children:v.message})}),s.jsxs("form",{onSubmit:$(Z),className:"space-y-4",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",htmlFor:"email",children:e("auth.verification.emailLabel")}),s.jsx(U,{id:"email",type:"email",autoComplete:"email",placeholder:e("auth.verification.emailPlaceholder"),...A("email",{required:e("auth.verification.emailRequired")})}),j.email&&s.jsx("p",{className:"text-sm text-red-600",children:j.email.message})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("label",{className:"text-sm font-medium text-gray-700",htmlFor:"code",children:e("auth.verification.codeLabel")}),s.jsx(U,{id:"code",inputMode:"numeric",maxLength:6,placeholder:"123456",...A("code",{required:e("auth.verification.codeRequired"),pattern:{value:/^\d{6}$/,message:e("auth.verification.codePattern")}})}),j.code&&s.jsx("p",{className:"text-sm text-red-600",children:j.code.message})]}),s.jsx("div",{className:"space-y-2",children:s.jsx(de,{ref:q,className:"flex justify-center",require:y,onVerify:t=>w(t),onExpire:()=>w(""),onError:()=>w("")})}),s.jsx(N,{type:"submit",className:"w-full",disabled:b||y&&!g,children:b?s.jsxs("span",{className:"flex items-center justify-center gap-2",children:[s.jsx(B,{className:"h-4 w-4 animate-spin"}),e("auth.verification.submitting")]}):e("auth.verification.submit")})]}),s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[s.jsx(N,{variant:"outline",onClick:ee,disabled:L,children:L&&D>0?e("auth.verification.resendCountdown",{seconds:D}):e("auth.verification.resend")}),s.jsx(N,{variant:"ghost",onClick:()=>d("/auth/login"),children:e("auth.verification.backToLogin")})]}),s.jsx("p",{className:"text-sm text-gray-500",children:e("auth.verification.helper")})]})]})})})};export{Se as default};
