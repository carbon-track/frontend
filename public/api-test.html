<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 一致性测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #333;
            margin-bottom: 15px;
        }
        .status {
            padding: 8px 16px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>前后端API一致性测试</h1>
    
    <div class="test-section">
        <h2 class="test-title">1. 基础连接测试</h2>
        <button onclick="testConnection()">测试后端连接</button>
        <div id="connection-result"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">2. 认证API测试</h2>
        <button onclick="testLogin()">测试登录API格式</button>
        <button onclick="testRegister()">测试注册API格式</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">3. 碳活动API测试</h2>
        <button onclick="testCarbonCalculate()">测试碳计算API格式</button>
        <button onclick="testCarbonRecord()">测试碳记录API格式</button>
        <div id="carbon-result"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">4. UUID生成测试</h2>
        <button onclick="testUUID()">测试UUID生成</button>
        <div id="uuid-result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';

        // UUID生成函数（从api.js复制）
        const generateUUID = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        function updateResult(elementId, content) {
            document.getElementById(elementId).innerHTML = content;
        }

        async function testConnection() {
            updateResult('connection-result', '<div class="status info">正在测试连接...</div>');
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    updateResult('connection-result', 
                        `<div class="status success">✅ 后端连接成功 (状态码: ${response.status})</div>`
                    );
                } else {
                    updateResult('connection-result', 
                        `<div class="status error">❌ 后端连接失败 (状态码: ${response.status})</div>`
                    );
                }
            } catch (error) {
                updateResult('connection-result', 
                    `<div class="status error">❌ 连接错误: ${error.message}</div>
                     <div class="status info">💡 请确保后端服务运行在 localhost:8000</div>`
                );
            }
        }

        async function testLogin() {
            updateResult('auth-result', '<div class="status info">正在测试登录API格式...</div>');
            
            // 测试请求体格式
            const loginData = {
                email: 'test@example.com',
                password: 'testpassword',
                cf_turnstile_response: 'test-token'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                const responseData = await response.text();
                
                updateResult('auth-result', 
                    `<div class="status info">📝 登录API格式测试</div>
                     <div class="status ${response.status === 422 ? 'success' : 'error'}">
                        ${response.status === 422 ? '✅' : '❌'} 状态码: ${response.status} 
                        ${response.status === 422 ? '(字段验证错误，格式正确)' : ''}
                     </div>
                     <pre>请求体: ${JSON.stringify(loginData, null, 2)}</pre>
                     <pre>响应: ${responseData}</pre>`
                );
            } catch (error) {
                updateResult('auth-result', 
                    `<div class="status error">❌ 登录测试错误: ${error.message}</div>`
                );
            }
        }

        async function testRegister() {
            const registerData = {
                email: 'test@example.com',
                password: 'testpassword',
                name: 'Test User',
                school_id: 1,
                grade: '高一',
                class: '1班',
                cf_turnstile_response: 'test-token'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-ID': generateUUID()
                    },
                    body: JSON.stringify(registerData)
                });

                const responseData = await response.text();
                
                updateResult('auth-result', 
                    document.getElementById('auth-result').innerHTML +
                    `<div class="status info">📝 注册API格式测试</div>
                     <div class="status ${response.status === 422 ? 'success' : 'error'}">
                        ${response.status === 422 ? '✅' : '❌'} 状态码: ${response.status}
                        ${response.status === 422 ? '(字段验证错误，格式正确)' : ''}
                     </div>
                     <pre>请求体: ${JSON.stringify(registerData, null, 2)}</pre>`
                );
            } catch (error) {
                updateResult('auth-result', 
                    document.getElementById('auth-result').innerHTML +
                    `<div class="status error">❌ 注册测试错误: ${error.message}</div>`
                );
            }
        }

        async function testCarbonCalculate() {
            updateResult('carbon-result', '<div class="status info">正在测试碳计算API格式...</div>');
            
            const calculateData = {
                activity_id: 'test-activity-uuid',
                parameters: {
                    data: '100'
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/carbon-track/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token'
                    },
                    body: JSON.stringify(calculateData)
                });

                const responseData = await response.text();
                
                updateResult('carbon-result', 
                    `<div class="status info">📝 碳计算API格式测试</div>
                     <div class="status ${response.status === 401 || response.status === 404 ? 'success' : 'error'}">
                        ${response.status === 401 || response.status === 404 ? '✅' : '❌'} 状态码: ${response.status}
                        ${response.status === 401 ? '(认证错误，格式正确)' : ''}
                        ${response.status === 404 ? '(活动不存在，格式正确)' : ''}
                     </div>
                     <pre>请求体: ${JSON.stringify(calculateData, null, 2)}</pre>`
                );
            } catch (error) {
                updateResult('carbon-result', 
                    `<div class="status error">❌ 碳计算测试错误: ${error.message}</div>`
                );
            }
        }

        async function testCarbonRecord() {
            const recordData = {
                activity_id: 'test-activity-uuid',
                parameters: {
                    data: '100',
                    activity_date: '2024-01-01',
                    notes: 'Test record',
                    uploaded_files: '[]'
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/carbon-track/record`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token',
                        'X-Request-ID': generateUUID()
                    },
                    body: JSON.stringify(recordData)
                });

                const responseData = await response.text();
                
                updateResult('carbon-result', 
                    document.getElementById('carbon-result').innerHTML +
                    `<div class="status info">📝 碳记录API格式测试</div>
                     <div class="status ${response.status === 401 || response.status === 404 ? 'success' : 'error'}">
                        ${response.status === 401 || response.status === 404 ? '✅' : '❌'} 状态码: ${response.status}
                        ${response.status === 401 ? '(认证错误，格式正确)' : ''}
                        ${response.status === 404 ? '(活动不存在，格式正确)' : ''}
                     </div>
                     <pre>请求体: ${JSON.stringify(recordData, null, 2)}</pre>`
                );
            } catch (error) {
                updateResult('carbon-result', 
                    document.getElementById('carbon-result').innerHTML +
                    `<div class="status error">❌ 碳记录测试错误: ${error.message}</div>`
                );
            }
        }

        async function testUUID() {
            updateResult('uuid-result', '<div class="status info">正在测试UUID生成...</div>');
            
            try {
                const uuid1 = generateUUID();
                const uuid2 = generateUUID();
                const uuid3 = generateUUID();
                
                // 验证UUID格式
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
                
                const isValid1 = uuidRegex.test(uuid1);
                const isValid2 = uuidRegex.test(uuid2);
                const isValid3 = uuidRegex.test(uuid3);
                
                const allValid = isValid1 && isValid2 && isValid3;
                const allUnique = uuid1 !== uuid2 && uuid2 !== uuid3 && uuid1 !== uuid3;
                
                updateResult('uuid-result', 
                    `<div class="status ${allValid ? 'success' : 'error'}">
                        ${allValid ? '✅' : '❌'} UUID格式验证: ${allValid ? '通过' : '失败'}
                     </div>
                     <div class="status ${allUnique ? 'success' : 'error'}">
                        ${allUnique ? '✅' : '❌'} UUID唯一性验证: ${allUnique ? '通过' : '失败'}
                     </div>
                     <pre>生成的UUID:
${uuid1}
${uuid2}
${uuid3}</pre>`
                );
            } catch (error) {
                updateResult('uuid-result', 
                    `<div class="status error">❌ UUID测试错误: ${error.message}</div>`
                );
            }
        }
    </script>
</body>
</html>