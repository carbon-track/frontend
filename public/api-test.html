<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API ä¸€è‡´æ€§æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #333;
            margin-bottom: 15px;
        }
        .status {
            padding: 8px 16px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>å‰åç«¯APIä¸€è‡´æ€§æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2 class="test-title">1. åŸºç¡€è¿æ¥æµ‹è¯•</h2>
        <button onclick="testConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
        <div id="connection-result"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">2. è®¤è¯APIæµ‹è¯•</h2>
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•APIæ ¼å¼</button>
        <button onclick="testRegister()">æµ‹è¯•æ³¨å†ŒAPIæ ¼å¼</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">3. ç¢³æ´»åŠ¨APIæµ‹è¯•</h2>
        <button onclick="testCarbonCalculate()">æµ‹è¯•ç¢³è®¡ç®—APIæ ¼å¼</button>
        <button onclick="testCarbonRecord()">æµ‹è¯•ç¢³è®°å½•APIæ ¼å¼</button>
        <div id="carbon-result"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">4. UUIDç”Ÿæˆæµ‹è¯•</h2>
        <button onclick="testUUID()">æµ‹è¯•UUIDç”Ÿæˆ</button>
        <div id="uuid-result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';

        // UUIDç”Ÿæˆå‡½æ•°ï¼ˆä»api.jså¤åˆ¶ï¼‰
        const generateUUID = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        function updateResult(elementId, content) {
            document.getElementById(elementId).innerHTML = content;
        }

        async function testConnection() {
            updateResult('connection-result', '<div class="status info">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>');
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    updateResult('connection-result', 
                        `<div class="status success">âœ… åç«¯è¿æ¥æˆåŠŸ (çŠ¶æ€ç : ${response.status})</div>`
                    );
                } else {
                    updateResult('connection-result', 
                        `<div class="status error">âŒ åç«¯è¿æ¥å¤±è´¥ (çŠ¶æ€ç : ${response.status})</div>`
                    );
                }
            } catch (error) {
                updateResult('connection-result', 
                    `<div class="status error">âŒ è¿æ¥é”™è¯¯: ${error.message}</div>
                     <div class="status info">ğŸ’¡ è¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ localhost:8000</div>`
                );
            }
        }

        async function testLogin() {
            updateResult('auth-result', '<div class="status info">æ­£åœ¨æµ‹è¯•ç™»å½•APIæ ¼å¼...</div>');
            
            // æµ‹è¯•è¯·æ±‚ä½“æ ¼å¼
            const loginData = {
                email: 'test@example.com',
                password: 'testpassword',
                cf_turnstile_response: 'test-token'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                const responseData = await response.text();
                
                updateResult('auth-result', 
                    `<div class="status info">ğŸ“ ç™»å½•APIæ ¼å¼æµ‹è¯•</div>
                     <div class="status ${response.status === 422 ? 'success' : 'error'}">
                        ${response.status === 422 ? 'âœ…' : 'âŒ'} çŠ¶æ€ç : ${response.status} 
                        ${response.status === 422 ? '(å­—æ®µéªŒè¯é”™è¯¯ï¼Œæ ¼å¼æ­£ç¡®)' : ''}
                     </div>
                     <pre>è¯·æ±‚ä½“: ${JSON.stringify(loginData, null, 2)}</pre>
                     <pre>å“åº”: ${responseData}</pre>`
                );
            } catch (error) {
                updateResult('auth-result', 
                    `<div class="status error">âŒ ç™»å½•æµ‹è¯•é”™è¯¯: ${error.message}</div>`
                );
            }
        }

        async function testRegister() {
            const registerData = {
                email: 'test@example.com',
                password: 'testpassword',
                name: 'Test User',
                school_id: 1,
                grade: 'é«˜ä¸€',
                class: '1ç­',
                cf_turnstile_response: 'test-token'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-ID': generateUUID()
                    },
                    body: JSON.stringify(registerData)
                });

                const responseData = await response.text();
                
                updateResult('auth-result', 
                    document.getElementById('auth-result').innerHTML +
                    `<div class="status info">ğŸ“ æ³¨å†ŒAPIæ ¼å¼æµ‹è¯•</div>
                     <div class="status ${response.status === 422 ? 'success' : 'error'}">
                        ${response.status === 422 ? 'âœ…' : 'âŒ'} çŠ¶æ€ç : ${response.status}
                        ${response.status === 422 ? '(å­—æ®µéªŒè¯é”™è¯¯ï¼Œæ ¼å¼æ­£ç¡®)' : ''}
                     </div>
                     <pre>è¯·æ±‚ä½“: ${JSON.stringify(registerData, null, 2)}</pre>`
                );
            } catch (error) {
                updateResult('auth-result', 
                    document.getElementById('auth-result').innerHTML +
                    `<div class="status error">âŒ æ³¨å†Œæµ‹è¯•é”™è¯¯: ${error.message}</div>`
                );
            }
        }

        async function testCarbonCalculate() {
            updateResult('carbon-result', '<div class="status info">æ­£åœ¨æµ‹è¯•ç¢³è®¡ç®—APIæ ¼å¼...</div>');
            
            const calculateData = {
                activity_id: 'test-activity-uuid',
                parameters: {
                    data: '100'
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/carbon-track/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token'
                    },
                    body: JSON.stringify(calculateData)
                });

                const responseData = await response.text();
                
                updateResult('carbon-result', 
                    `<div class="status info">ğŸ“ ç¢³è®¡ç®—APIæ ¼å¼æµ‹è¯•</div>
                     <div class="status ${response.status === 401 || response.status === 404 ? 'success' : 'error'}">
                        ${response.status === 401 || response.status === 404 ? 'âœ…' : 'âŒ'} çŠ¶æ€ç : ${response.status}
                        ${response.status === 401 ? '(è®¤è¯é”™è¯¯ï¼Œæ ¼å¼æ­£ç¡®)' : ''}
                        ${response.status === 404 ? '(æ´»åŠ¨ä¸å­˜åœ¨ï¼Œæ ¼å¼æ­£ç¡®)' : ''}
                     </div>
                     <pre>è¯·æ±‚ä½“: ${JSON.stringify(calculateData, null, 2)}</pre>`
                );
            } catch (error) {
                updateResult('carbon-result', 
                    `<div class="status error">âŒ ç¢³è®¡ç®—æµ‹è¯•é”™è¯¯: ${error.message}</div>`
                );
            }
        }

        async function testCarbonRecord() {
            const recordData = {
                activity_id: 'test-activity-uuid',
                parameters: {
                    data: '100',
                    activity_date: '2024-01-01',
                    notes: 'Test record',
                    uploaded_files: '[]'
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/carbon-track/record`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token',
                        'X-Request-ID': generateUUID()
                    },
                    body: JSON.stringify(recordData)
                });

                const responseData = await response.text();
                
                updateResult('carbon-result', 
                    document.getElementById('carbon-result').innerHTML +
                    `<div class="status info">ğŸ“ ç¢³è®°å½•APIæ ¼å¼æµ‹è¯•</div>
                     <div class="status ${response.status === 401 || response.status === 404 ? 'success' : 'error'}">
                        ${response.status === 401 || response.status === 404 ? 'âœ…' : 'âŒ'} çŠ¶æ€ç : ${response.status}
                        ${response.status === 401 ? '(è®¤è¯é”™è¯¯ï¼Œæ ¼å¼æ­£ç¡®)' : ''}
                        ${response.status === 404 ? '(æ´»åŠ¨ä¸å­˜åœ¨ï¼Œæ ¼å¼æ­£ç¡®)' : ''}
                     </div>
                     <pre>è¯·æ±‚ä½“: ${JSON.stringify(recordData, null, 2)}</pre>`
                );
            } catch (error) {
                updateResult('carbon-result', 
                    document.getElementById('carbon-result').innerHTML +
                    `<div class="status error">âŒ ç¢³è®°å½•æµ‹è¯•é”™è¯¯: ${error.message}</div>`
                );
            }
        }

        async function testUUID() {
            updateResult('uuid-result', '<div class="status info">æ­£åœ¨æµ‹è¯•UUIDç”Ÿæˆ...</div>');
            
            try {
                const uuid1 = generateUUID();
                const uuid2 = generateUUID();
                const uuid3 = generateUUID();
                
                // éªŒè¯UUIDæ ¼å¼
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
                
                const isValid1 = uuidRegex.test(uuid1);
                const isValid2 = uuidRegex.test(uuid2);
                const isValid3 = uuidRegex.test(uuid3);
                
                const allValid = isValid1 && isValid2 && isValid3;
                const allUnique = uuid1 !== uuid2 && uuid2 !== uuid3 && uuid1 !== uuid3;
                
                updateResult('uuid-result', 
                    `<div class="status ${allValid ? 'success' : 'error'}">
                        ${allValid ? 'âœ…' : 'âŒ'} UUIDæ ¼å¼éªŒè¯: ${allValid ? 'é€šè¿‡' : 'å¤±è´¥'}
                     </div>
                     <div class="status ${allUnique ? 'success' : 'error'}">
                        ${allUnique ? 'âœ…' : 'âŒ'} UUIDå”¯ä¸€æ€§éªŒè¯: ${allUnique ? 'é€šè¿‡' : 'å¤±è´¥'}
                     </div>
                     <pre>ç”Ÿæˆçš„UUID:
${uuid1}
${uuid2}
${uuid3}</pre>`
                );
            } catch (error) {
                updateResult('uuid-result', 
                    `<div class="status error">âŒ UUIDæµ‹è¯•é”™è¯¯: ${error.message}</div>`
                );
            }
        }
    </script>
</body>
</html>